
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>AprilTouch</title>
  <meta name="author" content="Andy Wang">

  
  <meta name="description" content="In these days there are many free or paid web templates, especially for bootstrap templates. Recently I integrated a Bootstrap template called Loop &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://climber2002.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="AprilTouch" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-51109944-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">AprilTouch</a></h1>
  
    <h2>My blog about Ruby and iOS development</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:climber2002.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-me">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/26/integrate-web-template-into-rails-4-application/">Integrate Web Template Into Rails 4 Application</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-26T23:07:49+10:30" pubdate data-updated="true">Feb 26<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/26/integrate-web-template-into-rails-4-application/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In these days there are many free or paid web templates, especially for bootstrap templates. Recently I integrated a Bootstrap template called <a href="https://wrapbootstrap.com/theme/loop-agency-and-personal-theme-WB053H4T4">Loop</a> which is bought on <a href="https://wrapbootstrap.com/">WrapBootstrap</a>. Here I will explain some practices and caveats about the integration.</p>

<h2>Location</h2>

<p><img class="left" src="/images/loop.png" width="300" height="300"></p>

<p>After extract the template zip file, we can see the organization is like the  structure on the left. This template actually contains two templates, one for personal and one for Agency, and what I want is for the Agency. We can see that it puts all resource files like javascripts, CSS files and fonts file in folder <em>assets</em>. I want to keep this structure, so it would be easier to upgrade if it releases new version. The best practice for put 3rd-party template is to put it in <strong>vendor/assets</strong>, so I create a folder <strong>loop</strong> under <strong>vendor/assets</strong> and and copy the <em>assets</em> folder to <strong>vendor/assets/loop</strong>, like the following figure,</p>

<p><img class="left" src="/images/loop_copied.png" width="300" height="300"></p>

<p>Notice that I changed the <em>assets</em> folder from the original template and named it <strong>loop</strong>, so when we reference the files under it from browser it will create paths like <em>/assets/loop/js/loop.js</em> because rails will append <em>assets</em> before the resource. This is to make the files in this template not collide with other assets.</p>

<h2>Create index file</h2>

<p>If you read my blog <a href="http://climber2002.github.io/blog/2014/08/17/using-index-files-in-rails-4-assets-pipeline/">Using Index Files in Rails 4 Assets Pipeline</a> before, you should know that the index files should be named <strong>loop.css.scss</strong> and <strong>loop.js</strong>, under foler <strong>vendor/assets/loop</strong>.</p>

<p>They have the following contents,</p>

<figure class='code'><figcaption><span>vendor/assets/loop/loop.css.scss </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="c">/*</span>
</span><span class='line'><span class="c"> *= require loop/css/bootstrap</span>
</span><span class='line'><span class="c"> *= require loop/css/font-awesome</span>
</span><span class='line'><span class="c"> *= require loop/css/main</span>
</span><span class='line'><span class="c"> */</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>vendor/assets/loop/loop.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//= require loop/js/jquery-2.1.0</span>
</span><span class='line'><span class="c1">//= require loop/js/bootstrap.js</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/scrollto/jquery.scrollTo-1.4.3.1-min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/scrollto/jquery.localscroll-1.2.7-min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/easing/jquery.easing.min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/google-map/google-map</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/parallax/jquery.parallax-1.1.3</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/jpreloader/jpreloader.min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/isotope/imagesloaded.pkgd</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/isotope/isotope.pkgd.min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/wow/wow</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/flexslider/jquery.flexslider-min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/magnific/jquery.magnific-popup.min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/supersized/supersized.3.2.7.min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/supersized/supersized.shutter.min</span>
</span><span class='line'><span class="c1">//= require loop/js/loop.js</span>
</span></code></pre></td></tr></table></div></figure>


<p>Basically the index files include all dependent css and javascripts, but pay atthention that their path should start with <em>loop</em> since we have put all assets in <strong>vendor/assets/loop/loop</strong> folder.</p>

<h2>Update CSS files</h2>

<p>In the template&rsquo;s CSS files, there are reference to images such as background image, like following code,</p>

<figure class='code'><figcaption><span>main.css </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">body</span><span class="nc">.fullscreen-image-background</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">background-image</span><span class="o">:</span> <span class="sx">url(&#39;../img/sliders/slider3.png?1393983498&#39;)</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background</span><span class="o">-</span><span class="k">size</span><span class="o">:</span> <span class="n">cover</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-repeat</span><span class="o">:</span> <span class="k">no-repeat</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-position</span><span class="o">:</span> <span class="k">center</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Such url won&rsquo;t work because Rails will precompile those assets in <em>public/assets</em> folder, so we name this file to <em>main.css.scss</em>, and use <strong>image-url</strong> tag, like following,</p>

<figure class='code'><figcaption><span>main.css </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">body</span><span class="nc">.fullscreen-image-background</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">background-image</span><span class="o">:</span> <span class="n">image</span><span class="o">-</span><span class="sx">url(&#39;loop/img/sliders/slider3.png&#39;)</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background</span><span class="o">-</span><span class="k">size</span><span class="o">:</span> <span class="n">cover</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-repeat</span><span class="o">:</span> <span class="k">no-repeat</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-position</span><span class="o">:</span> <span class="k">center</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Update JS files</h2>

<p>Sometimes the JS files also reference image files, like following code in loop.js,</p>

<figure class='code'><figcaption><span>loop.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">slides</span><span class="o">:</span>   <span class="p">[</span>       <span class="c1">// Slideshow Images</span>
</span><span class='line'>              <span class="p">{</span><span class="nx">image</span> <span class="o">:</span> <span class="s1">&#39;assets/img/sliders/slider1.png&#39;</span><span class="p">,</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;&lt;div class=&quot;hero-text&quot;&gt;&lt;h2 class=&quot;hero-heading&quot;&gt;HANDCRAFTED&lt;/h2&gt;&lt;p&gt;Built to provide great visitor experience&lt;/p&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="nx">thumb</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
</span><span class='line'>              <span class="p">{</span><span class="nx">image</span> <span class="o">:</span> <span class="s1">&#39;assets/img/sliders/slider2.png&#39;</span><span class="p">,</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;&lt;div class=&quot;hero-text&quot;&gt;&lt;h2 class=&quot;hero-heading&quot;&gt;PARALLAX&lt;/h2&gt;&lt;p&gt;Scrolling the page is fun with parallax background&lt;/p&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="nx">thumb</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
</span><span class='line'>              <span class="p">{</span><span class="nx">image</span> <span class="o">:</span> <span class="s1">&#39;assets/img/sliders/slider3.png&#39;</span><span class="p">,</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;&lt;div class=&quot;hero-text&quot;&gt;&lt;h2 class=&quot;hero-heading&quot;&gt;BUY ONE FOR TWO&lt;/h2&gt;&lt;p&gt;Buy one to get both of the agency and personal theme&lt;/p&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="nx">thumb</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>For the same reason, after deploy production the JS files can&rsquo;t find the image files also, in such case we should depend on the asset pipeline and change the file to <strong>loop.js.erb</strong>, and use <strong>image_path</strong>.</p>

<figure class='code'><figcaption><span>loop.js.erb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">slides</span><span class="o">:</span>   <span class="p">[</span>       <span class="c1">// Slideshow Images</span>
</span><span class='line'>              <span class="p">{</span><span class="nx">image</span> <span class="o">:</span> <span class="s1">&#39;&lt;%= image_path &#39;</span><span class="nx">loop</span><span class="o">/</span><span class="nx">img</span><span class="o">/</span><span class="nx">sliders</span><span class="o">/</span><span class="nx">slider1</span><span class="p">.</span><span class="nx">png</span><span class="s1">&#39;%&gt;&#39;</span><span class="p">,</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;&lt;div class=&quot;hero-text&quot;&gt;&lt;h2 class=&quot;hero-heading&quot;&gt;HANDCRAFTED&lt;/h2&gt;&lt;p&gt;Built to provide great visitor experience&lt;/p&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="nx">thumb</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
</span><span class='line'>              <span class="p">{</span><span class="nx">image</span> <span class="o">:</span> <span class="s1">&#39;&lt;%= image_path &#39;</span><span class="nx">loop</span><span class="o">/</span><span class="nx">img</span><span class="o">/</span><span class="nx">sliders</span><span class="o">/</span><span class="nx">slider2</span><span class="p">.</span><span class="nx">png</span><span class="s1">&#39;%&gt;&#39;</span><span class="p">,</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;&lt;div class=&quot;hero-text&quot;&gt;&lt;h2 class=&quot;hero-heading&quot;&gt;PARALLAX&lt;/h2&gt;&lt;p&gt;Scrolling the page is fun with parallax background&lt;/p&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="nx">thumb</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
</span><span class='line'>              <span class="p">{</span><span class="nx">image</span> <span class="o">:</span> <span class="s1">&#39;&lt;%= image_path &#39;</span><span class="nx">loop</span><span class="o">/</span><span class="nx">img</span><span class="o">/</span><span class="nx">sliders</span><span class="o">/</span><span class="nx">slider3</span><span class="p">.</span><span class="nx">png</span><span class="s1">&#39;%&gt;&#39;</span><span class="p">,</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;&lt;div class=&quot;hero-text&quot;&gt;&lt;h2 class=&quot;hero-heading&quot;&gt;BUY ONE FOR TWO&lt;/h2&gt;&lt;p&gt;Buy one to get both of the agency and personal theme&lt;/p&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="nx">thumb</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also in our erb files, if we want to reference image files we should use <strong>image_path</strong>.</p>

<h2>Precompile configuration</h2>

<p>By default when we run <strong>rake assets:precompile</strong>, Rails won&rsquo;t precompile the assets in vendor. So we need to add the loop template into configuration, in <strong>application.rb</strong>, we update like following,</p>

<figure class='code'><figcaption><span>application.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">precompile</span> <span class="o">+=</span> <span class="sx">%w(loop.css loop.js loop/*)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So it will precompile index files and all assets in <strong>vendor/assets/loop/loop</strong> folder.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/22/digging-rails-how-rails-finds-your-templates-part-2/">Digging Rails: How Rails Finds Your Templates Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-22T21:24:30+10:30" pubdate data-updated="true">Feb 22<span>nd</span>, 2015</time>
        
         | <a href="/blog/2015/02/22/digging-rails-how-rails-finds-your-templates-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In <a href="http://climber2002.github.io/blog/2015/02/21/how-rails-finds-your-templates-part-1/">last part</a> we introduced that when Rails looks for a template, it firstly populate an options hash by calling <strong>_normalize_render</strong>. And then in the <em>render</em> method, it will call <strong>render_to_body</strong> and pass the options, like the following code,</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/abstract_controller/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">AbstractController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize arguments, options and then delegates render_to_body and</span>
</span><span class='line'>    <span class="c1"># sticks the result in self.response_body.</span>
</span><span class='line'>    <span class="c1"># :api: public</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="n">_normalize_render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">response_body</span> <span class="o">=</span> <span class="n">render_to_body</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">_process_format</span><span class="p">(</span><span class="n">rendered_format</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">rendered_format</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">response_body</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <strong>render_to_body</strong> will select the templated based on the values in options hash. If we check the source code of <strong>AbstractController::Rendering#render_to_body</strong>, it&rsquo;s nothing. Just as usual, it&rsquo;s overridden by other modules.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/abstract_controller/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">AbstractController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Performs the actual template rendering.</span>
</span><span class='line'>    <span class="c1"># :api: public</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render_to_body</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just as last part, we could run <em>ApplicationController.ancestors_that_implement_instance_method</em> to find what classes or modules implement that method, and we will find the following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">00</span><span class="mi">8</span> <span class="o">&gt;</span> <span class="no">ApplicationController</span><span class="o">.</span><span class="n">ancestors_that_implement_instance_method</span><span class="p">(</span><span class="ss">:render_to_body</span><span class="p">)</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Renderers</span><span class="p">,</span> <span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Rendering</span><span class="p">,</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Rendering</span><span class="p">,</span> <span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Rendering</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see three modules implement that method: <em>ActionController::Renderers</em>, <em>ActionController::Rendering</em>, and <em>ActionView::Rendering</em>. Let&rsquo;s look at each of them one by one.</p>

<h2>ActionController::Renderers#render_to_body</h2>

<p>For <em>ActionController::Renderers#render_to_body</em> method, it registers a set of renderers, and then if the options contains the renderer key, then it will call that renderer. If no renderer is found, it just call <em>super</em></p>

<figure class='code'><figcaption><span>rails/actionpack/lib/action_controller/metal/renderers.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Renderers</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render_to_body</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">_render_to_body_with_renderer</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="o">||</span> <span class="k">super</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_render_to_body_with_renderer</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">_renderers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>          <span class="n">_process_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>          <span class="n">method_name</span> <span class="o">=</span> <span class="no">Renderers</span><span class="o">.</span><span class="n">_render_with_renderer_method_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span> <span class="nb">send</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">name</span><span class="p">),</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="kp">nil</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is mainly for calling <strong>render</strong> and pass parameters like :json, :xml, like the following code,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ArticlesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="vi">@articles</span> <span class="o">=</span> <span class="no">Articles</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="vi">@articles</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since <em>:json</em> is a registered renderer in <em>ActionController::Renderers</em>, it will call that renderer. You can also register your own renderer by calling <strong>ActionController::Renderers.add</strong>.</p>

<h2>ActionController::Rendering#render_to_body</h2>

<p>If in <strong>ActionController::Renderers#render_to_body</strong>, it doesn&rsquo;t find a renderer, then it will call <em>super</em>, which is <strong>ActionController::Rendering#render_to_body</strong>. Let&rsquo;s look at what this module does in the method.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/action_controller/metal/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">RENDER_FORMATS_IN_PRIORITY</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:body</span><span class="p">,</span> <span class="ss">:text</span><span class="p">,</span> <span class="ss">:plain</span><span class="p">,</span> <span class="ss">:html</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render_to_body</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>      <span class="k">super</span> <span class="o">||</span> <span class="n">_render_in_priorities</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39; &#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_render_in_priorities</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="no">RENDER_FORMATS_IN_PRIORITY</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">options</span><span class="o">[</span><span class="nb">format</span><span class="o">]</span> <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="kp">nil</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that this method calls <em>super</em> first, it only call <em>_render_in_priorities</em> if <em>super</em> returns nothing.</p>

<p>In <strong>_render_in_priorities</strong> it searches the RENDER_FORMATS_IN_PRIORITY one by one, and return the option value if it finds the format.</p>

<p>In this module when it calls <em>super</em>, it is calling <strong>ActionView::Rendering#render_to_body</strong> method. Let&rsquo;s have a look.</p>

<h2>ActionView::Rendering#render_to_body</h2>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render_to_body</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>      <span class="n">_process_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">_render_template</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Returns an object that is able to render templates.</span>
</span><span class='line'>    <span class="c1"># :api: private</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">view_renderer</span>
</span><span class='line'>      <span class="vi">@_view_renderer</span> <span class="o">||=</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Renderer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">lookup_context</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Find and render a template based on the options given.</span>
</span><span class='line'>      <span class="c1"># :api: private</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">_render_template</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>        <span class="n">variant</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:variant</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">lookup_context</span><span class="o">.</span><span class="n">rendered_format</span> <span class="o">=</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:formats</span><span class="o">]</span>
</span><span class='line'>        <span class="n">lookup_context</span><span class="o">.</span><span class="n">variants</span> <span class="o">=</span> <span class="n">variant</span> <span class="k">if</span> <span class="n">variant</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">view_renderer</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">view_context</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It turns out that here is the the meat we are looking for. The <strong>render_to_body</strong> calls <strong>_render_template</strong>, and for the <strong>_render_template</strong>, it calls **view_renderer.render(view_context, options).</p>

<p>The <em>view_renderer</em> is an instance of <strong>ActionView::Renderer</strong>, and when it&rsquo;s initialized, it&rsquo;s passing a <em>lookup_context</em> object, which is an instance of <strong>ActionView::LookupContext</strong>. The <strong>ActionView::LookupContext</strong> contains all information about looking for a template based on the options. So in next part we will check this class in detail, and check how <strong>LookupContext</strong>, <strong>ViewPaths</strong>, <strong>PathSet</strong> work together to find the template.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/21/how-rails-finds-your-templates-part-1/">Digging Rails: How Rails Finds Your Templates Part 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-21T20:35:52+10:30" pubdate data-updated="true">Feb 21<span>st</span>, 2015</time>
        
         | <a href="/blog/2015/02/21/how-rails-finds-your-templates-part-1/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Have you ever wondered for a Rails application, when you access an action in a controller, how Rails finds the template to render? For example, when the action <em>index</em> in <em>ArticlesController</em> is accessed, by default the template <em>app/views/articles/index.html.erb</em> will be selected and rendered. Recently I&rsquo;m digging the source code of Rails, and I invite you to walk through some source code in ActionPack and ActionView with me. And then I will show how the Rubygem <a href="https://github.com/bwillis/versioncake">versioncake</a> works by modifying the Rails configuration.</p>

<p>In this first part we firstly check how the <strong>render</strong> works. Notice that we check Rails 4.2 source code. If you look at another version, the implementation may be slightly different.</p>

<p>The entry point for the render is from the <strong>AbstractController::Rendering#render</strong> method. The <strong>AbstractController</strong> is a module shared by ActionController and ActionMailer. Since these two modules share a lot of functionalities, Rails extract those same functionalities into <strong>AbstractController</strong>. Let&rsquo;s have a look at this method.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/abstract_controller/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">AbstractController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize arguments, options and then delegates render_to_body and</span>
</span><span class='line'>    <span class="c1"># sticks the result in self.response_body.</span>
</span><span class='line'>    <span class="c1"># :api: public</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="n">_normalize_render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">response_body</span> <span class="o">=</span> <span class="n">render_to_body</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">_process_format</span><span class="p">(</span><span class="n">rendered_format</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">rendered_format</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">response_body</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our controller, we could call <em>render</em> method directly. For example, we can call <em>render &lsquo;new&rsquo;</em> to render the <em>new.html.erb</em> template. Or if we don&rsquo;t call <em>render</em> explicitly, there is a module <strong>ActionController::ImplicitRender</strong> which will call a default render.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/action_controller/metal/implicit_renderer.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionController</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ImplicitRender</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">send_action</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="n">ret</span> <span class="o">=</span> <span class="k">super</span>
</span><span class='line'>      <span class="n">default_render</span> <span class="k">unless</span> <span class="n">performed?</span>
</span><span class='line'>      <span class="n">ret</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">default_render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="n">render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The send_action will be called when the action of a controller is triggered. It first calls super, then if in the action it doesn&rsquo;t render anything, the <em>performed?</em> will return false. So <em>default_render</em> is called. We can see that when call <em>default_render</em> it just calls <em>render</em> without any arguments.</p>

<p>In <strong>AbstractController::Rendering#render</strong> method, it firstly calls <em>_normalize_render</em> then calls <em>render_to_body</em>. The <em>_normalize_render</em> returns an options object which is a Hash. In this part we will examine the <strong>_normalize_render</strong> method to see how the options is generated.</p>

<p>Let&rsquo;s see how <strong>_normalize_render</strong> is implemented.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/abstract_controller/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">AbstractController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize args and options.</span>
</span><span class='line'>    <span class="c1"># :api: private</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="n">_normalize_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="c1">#TODO: remove defined? when we restore AP &lt;=&gt; AV dependency</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">request</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:variant</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">variant</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">_normalize_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We see that it calls <em>_normalize_args</em> and <em>_normalize_options</em> methods. The <em>_normalize_args</em> and <em>_normalize_options</em> have different purposes.</p>

<h3>_normalize_args</h3>

<p>The <strong>_normalize_args</strong> is to convert all args into an options hash. For example when we call <em>render</em> method, we could call like this,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">render</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="ss">status</span><span class="p">:</span> <span class="ss">:ok</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here the first argument &lsquo;new&rsquo; is a String, and <strong>_normalize_args</strong> is responsible to put this first argument in options hash and give it an appropriate key.</p>

<p>Let&rsquo;s see how it&rsquo;s implemented.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/abstract_controller/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">AbstractController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize args by converting render &quot;foo&quot; to render :action =&gt; &quot;foo&quot; and</span>
</span><span class='line'>    <span class="c1"># render &quot;foo/bar&quot; to render :file =&gt; &quot;foo/bar&quot;.</span>
</span><span class='line'>    <span class="c1"># :api: plugin</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_args</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Hash</span>
</span><span class='line'>        <span class="n">action</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">options</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We see that this method by default almost does nothing, if the action is a Hash, it returns action, otherwise if action is for example, a string, it returns the second parameter which is the options hash.</p>

<p>Notice that ApplicationController includes some other modules which override this method, as we will see later.</p>

<h3>_normalize_options</h3>

<p>The <strong>_normalize_options</strong> method is for the modules to include other options. For a Rails application, the ApplicationController extends from <strong>ActionController::Base</strong>, and <strong>ActionController::Base</strong> includes a lot of modules, each module could override this method and add some other options.</p>

<p>Let&rsquo;s firstly check how this method is implemented in <strong>AbstractController::Rendering</strong>.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/abstract_controller/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">AbstractController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize options.</span>
</span><span class='line'>    <span class="c1"># :api: plugin</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>By default this method does nothing. But it will be overridden in other modules.</p>

<h3>Override _normalize_args</h3>

<p>Rails source code is complex, one reason is because there are many modules could override other modules&rsquo;s methods. For example, in a ArticlesController, let&rsquo;s see its ancestors,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">c</span>
</span><span class='line'><span class="no">Loading</span> <span class="n">development</span> <span class="n">environment</span> <span class="p">(</span><span class="no">Rails</span> <span class="mi">4</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="nb">puts</span> <span class="no">ArticlesController</span><span class="o">.</span><span class="n">ancestors</span>
</span><span class='line'><span class="no">ArticlesController</span>
</span><span class='line'><span class="c1">#&lt;Module:0x007f8f0a971800&gt;</span>
</span><span class='line'><span class="no">ApplicationController</span>
</span><span class='line'><span class="c1">#&lt;Module:0x007f8f0a8f93c8&gt;</span>
</span><span class='line'><span class="c1">#&lt;Module:0x007f8f05465118&gt;</span>
</span><span class='line'><span class="c1">#&lt;Module:0x007f8f05465140&gt;</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'><span class="ss">WebConsole</span><span class="p">:</span><span class="ss">:ControllerHelpers</span>
</span><span class='line'><span class="ss">Turbolinks</span><span class="p">:</span><span class="ss">:XHRHeaders</span>
</span><span class='line'><span class="ss">Turbolinks</span><span class="p">:</span><span class="ss">:Cookies</span>
</span><span class='line'><span class="ss">Turbolinks</span><span class="p">:</span><span class="ss">:XDomainBlocker</span>
</span><span class='line'><span class="ss">Turbolinks</span><span class="p">:</span><span class="ss">:Redirection</span>
</span><span class='line'><span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Railties</span><span class="o">::</span><span class="no">ControllerRuntime</span>
</span><span class='line'><span class="ss">ActionDispatch</span><span class="p">:</span><span class="ss">:Routing</span><span class="o">::</span><span class="ss">RouteSet</span><span class="p">:</span><span class="ss">:MountedHelpers</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:ParamsWrapper</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Instrumentation</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Rescue</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:HttpAuthentication</span><span class="o">::</span><span class="ss">Token</span><span class="p">:</span><span class="ss">:ControllerMethods</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:HttpAuthentication</span><span class="o">::</span><span class="ss">Digest</span><span class="p">:</span><span class="ss">:ControllerMethods</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:HttpAuthentication</span><span class="o">::</span><span class="ss">Basic</span><span class="p">:</span><span class="ss">:ControllerMethods</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:DataStreaming</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Streaming</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:ForceSSL</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:RequestForgeryProtection</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Flash</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Cookies</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:StrongParameters</span>
</span><span class='line'><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Rescuable</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:ImplicitRender</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:MimeResponds</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Caching</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Caching</span><span class="o">::</span><span class="no">Fragments</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Caching</span><span class="o">::</span><span class="no">ConfigMethods</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Callbacks</span>
</span><span class='line'><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Callbacks</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:EtagWithTemplateDigest</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:ConditionalGet</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Head</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Renderers</span><span class="o">::</span><span class="no">All</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Renderers</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Rendering</span>
</span><span class='line'><span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Layouts</span>
</span><span class='line'><span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Rendering</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Redirecting</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:RackDelegation</span>
</span><span class='line'><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Benchmarkable</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Logger</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:UrlFor</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:UrlFor</span>
</span><span class='line'><span class="ss">ActionDispatch</span><span class="p">:</span><span class="ss">:Routing</span><span class="o">::</span><span class="no">UrlFor</span>
</span><span class='line'><span class="ss">ActionDispatch</span><span class="p">:</span><span class="ss">:Routing</span><span class="o">::</span><span class="no">PolymorphicRoutes</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:ModelNaming</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:HideActions</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Helpers</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Helpers</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:AssetPaths</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Translation</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Rendering</span>
</span><span class='line'><span class="ss">ActionView</span><span class="p">:</span><span class="ss">:ViewPaths</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Metal</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Configurable</span>
</span><span class='line'><span class="no">Object</span>
</span><span class='line'><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Dependencies</span><span class="o">::</span><span class="no">Loadable</span>
</span><span class='line'><span class="ss">PP</span><span class="p">:</span><span class="ss">:ObjectMixin</span>
</span><span class='line'><span class="ss">JSON</span><span class="p">:</span><span class="ss">:Ext</span><span class="o">::</span><span class="ss">Generator</span><span class="p">:</span><span class="ss">:GeneratorMethods</span><span class="o">::</span><span class="no">Object</span>
</span><span class='line'><span class="no">Kernel</span>
</span><span class='line'><span class="no">BasicObject</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that for a typical controller, it has a lot of ancestors and most of them are modules. All modules after <em>AbstractController::Rendering</em> could override its methods. I have created a gist to check which ancestors implement a method.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Module</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">ancestors_that_implement_instance_method</span><span class="p">(</span><span class="nb">instance_method</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">ancestors</span><span class="o">.</span><span class="n">find_all</span> <span class="k">do</span> <span class="o">|</span><span class="n">ancestor</span><span class="o">|</span>
</span><span class='line'>      <span class="p">(</span><span class="n">ancestor</span><span class="o">.</span><span class="n">instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span> <span class="o">+</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">private_instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">))</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="nb">instance_method</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the above code in a rails console, then you can call <em>ClassName.ancestors_that_implement_instance_method</em> to check what ancestors implement a method.</p>

<p>Let&rsquo;s first see what ancestors override the <em>_normalize_args</em> method,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">c</span>
</span><span class='line'><span class="no">Loading</span> <span class="n">development</span> <span class="n">environment</span> <span class="p">(</span><span class="no">Rails</span> <span class="mi">4</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">013</span> <span class="o">&gt;</span>   <span class="no">ArticlesController</span><span class="o">.</span><span class="n">ancestors_that_implement_instance_method</span><span class="p">(</span><span class="ss">:_normalize_args</span><span class="p">)</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Rendering</span><span class="p">,</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Rendering</span><span class="p">,</span> <span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Rendering</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Two modules override this instance method: <em>ActionView::Rendering</em> and <em>ActionController::Rendering</em>. Let&rsquo;s look them in order from top to down.</p>

<p>Let&rsquo;s look at <em>ActionView::Rendering</em> first,</p>

<figure class='code'><figcaption><span>actionview/lib/action_view/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>    <span class="c1"># Normalize args by converting render &quot;foo&quot; to render :action =&gt; &quot;foo&quot; and</span>
</span><span class='line'>    <span class="c1"># render &quot;foo/bar&quot; to render :template =&gt; &quot;foo/bar&quot;.</span>
</span><span class='line'>    <span class="c1"># :api: private</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_args</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="k">super</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="k">case</span> <span class="n">action</span>
</span><span class='line'>      <span class="k">when</span> <span class="no">NilClass</span>
</span><span class='line'>      <span class="k">when</span> <span class="no">Hash</span>
</span><span class='line'>        <span class="n">options</span> <span class="o">=</span> <span class="n">action</span>
</span><span class='line'>      <span class="k">when</span> <span class="nb">String</span><span class="p">,</span> <span class="no">Symbol</span>
</span><span class='line'>        <span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>        <span class="n">key</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="sc">?/</span><span class="p">)</span> <span class="p">?</span> <span class="ss">:template</span> <span class="p">:</span> <span class="ss">:action</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">action</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:partial</span><span class="o">]</span> <span class="o">=</span> <span class="n">action</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">options</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that for the first argument <em>action</em>, if it&rsquo;s a string and the string include &lsquo;/&rsquo;, the key for this argument is :file, and if it doesn&rsquo;t include &lsquo;/&rsquo;, the key is :action.</p>

<p>So if we call <em>render &lsquo;new&rsquo;</em>, the options will be { action: &lsquo;new&rsquo; }, if we call <em>render &lsquo;articles/new&rsquo;</em>, the options will be { file: &lsquo;articles/new&rsquo; }</p>

<p>Now let&rsquo;s see how <em>ActionController::Rendering</em> overrides this method</p>

<figure class='code'><figcaption><span>actionpack/lib/action_controller/metal/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">ActionController</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>    <span class="c1"># Normalize arguments by catching blocks and setting them on :update.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_args</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{},</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="k">super</span>
</span><span class='line'>      <span class="n">options</span><span class="o">[</span><span class="ss">:update</span><span class="o">]</span> <span class="o">=</span> <span class="n">blk</span> <span class="k">if</span> <span class="nb">block_given?</span>
</span><span class='line'>      <span class="n">options</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that for this override, if the method is passed a block, it will set the block to options[:update]</p>

<h3>Override _normalize_options</h3>

<p>Just like <em>_normalize_args</em>, let&rsquo;s examine what modules override <em>_normalize_options</em>. We can see following modules implement <em>_normalize_options</em>: <em>[ActionController::Rendering, ActionView::Layouts, ActionView::Rendering, AbstractController::Rendering]</em>.</p>

<p>Let&rsquo;s check <em>ActionView::Rendering</em> first,</p>

<figure class='code'><figcaption><span>actionpack/lib/action_controller/metal/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize options.</span>
</span><span class='line'>    <span class="c1"># :api: private</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="k">super</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:partial</span><span class="o">]</span> <span class="o">==</span> <span class="kp">true</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:partial</span><span class="o">]</span> <span class="o">=</span> <span class="n">action_name</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span> <span class="o">&amp;</span> <span class="o">[</span><span class="ss">:partial</span><span class="p">,</span> <span class="ss">:file</span><span class="p">,</span> <span class="ss">:template</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:prefixes</span><span class="o">]</span> <span class="o">||=</span> <span class="n">_prefixes</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">options</span><span class="o">[</span><span class="ss">:template</span><span class="o">]</span> <span class="o">||=</span> <span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:action</span><span class="o">]</span> <span class="o">||</span> <span class="n">action_name</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>      <span class="n">options</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that it addes three options by default,</p>

<ul>
<li>If the options[:partial] is true, then it will set options[:partial] to <em>action_name</em>, the <em>action_name</em> is just the name of the action that is triggered. For example, if the <em>index</em> action of ArticlesController is triggered, <em>action_name</em> will be <em>index</em>.</li>
<li>If the options doesn&rsquo;t include :partial, :file or :template, it set options[:prefixes]. Let&rsquo;s see what&rsquo;s set for this :prefixes in a minute.</li>
<li>It set the options[:template]. It&rsquo;s either passed from the arguments or just use the action_name.</li>
</ul>


<p>So what&rsquo;s in options[:prefixes], let&rsquo;s see how <em>_prefixes</em> method is implemented.</p>

<p>The <strong>AbstractController::Rendering</strong> module includes <strong>ActionView::ViewPaths</strong> module. And <strong>_prefixes</strong> method is implemented there.</p>

<p><strong>ActionView::ViewPaths</strong> is an important module which we will examine in more details in later parts. It&rsquo;s to manage the view paths for controllers. For example, by default Rails will append a view path <strong>#{Rails.root}app/views</strong> so the application knows to search templates in that specific view path.</p>

<p>For now let&rsquo;s just focus on <strong>_prefixes</strong> method.</p>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/view_paths.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ViewPaths</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># The prefixes used in render &quot;foo&quot; shortcuts.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_prefixes</span> <span class="c1"># :nodoc:</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">_prefixes</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <strong>_prefixes</strong> just calls the class method <strong>_prefixes</strong>.</p>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/view_paths.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ViewPaths</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">_prefixes</span> <span class="c1"># :nodoc:</span>
</span><span class='line'>        <span class="vi">@_prefixes</span> <span class="o">||=</span> <span class="k">begin</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">local_prefixes</span> <span class="k">if</span> <span class="n">superclass</span><span class="o">.</span><span class="n">abstract?</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">local_prefixes</span> <span class="o">+</span> <span class="n">superclass</span><span class="o">.</span><span class="n">_prefixes</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Override this method in your controller if you want to change paths prefixes for finding views.</span>
</span><span class='line'>      <span class="c1"># Prefixes defined here will still be added to parents&#39; &lt;tt&gt;._prefixes&lt;/tt&gt;.</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">local_prefixes</span>
</span><span class='line'>        <span class="o">[</span><span class="n">controller_path</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that Rails 4.2 implements that method and handles some deprecated parent prefixes. In above code I omitted that handling for clarity.</p>

<p>This <strong>ActionView::ViewPaths._prefixes</strong> calls recursively. it append local_prefixes with superclass&rsquo;s _prefixes. The <strong>local_prefixes</strong> has just one element: <strong>controller_path</strong>.</p>

<p>The <strong>controller_path</strong> method is very simple, it&rsquo;s implemented in <strong>AbstractController::Base</strong>. For example, for a controller <em>ArticlesController</em>, its controller_path will be <em>articles</em>, and for a controller <em>Articles::CommentsController</em>, its controller_path will be <em>articles/comments</em></p>

<p>So the <strong>_prefixes</strong> method first gets it&rsquo;s parent prefixes, and then prepends the current controller_path to the front.</p>

<p>For example, if our application has a <em>ArticlesController</em>, in our rails controller, we can call the following code to show the <em>_prefixes</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">c</span>
</span><span class='line'><span class="no">Loading</span> <span class="n">development</span> <span class="n">environment</span> <span class="p">(</span><span class="no">Rails</span> <span class="mi">4</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">ArticlesController</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:_prefixes</span><span class="p">)</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;articles&quot;</span><span class="p">,</span> <span class="s2">&quot;application&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We see that the prefixes contains two elements: articles and application. It&rsquo;s because the ApplicationController extends from ActionController::Base, but ActionController::Base is abstract.</p>

<p>So now we can see that for <em>ArticlesController#index</em> action, when we just call <em>render</em> without any arguments, the options will contains following elements,</p>

<ul>
<li><strong>:prefixes</strong> : array [&ldquo;articles&rdquo;, &ldquo;application&rdquo;]</li>
<li><strong>:template</strong> : string &ldquo;index&rdquo;</li>
</ul>


<p>Now let&rsquo;s see next one, how <strong>ActionView::Layouts</strong> overrides <strong>_normalize_options</strong> method,</p>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/layouts.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Layouts</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="c1"># :nodoc:</span>
</span><span class='line'>      <span class="k">super</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">_include_layout?</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>        <span class="n">layout</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:layout</span><span class="p">)</span> <span class="p">{</span> <span class="ss">:default</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:layout</span><span class="o">]</span> <span class="o">=</span> <span class="n">_layout_for_option</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that if the options[:layout] is not set, the default layout is :default. And then options[:layout] is set to the result returned by <em>_layout_for_option</em>.</p>

<p>If you are interested you could check how <strong>_layout_for_options</strong> is implemented. When this module searches for the layout it will search <em>&ldquo;app/views/layouts/#{class_name.underscore}.rb&rdquo;</em> first, if it doesn&rsquo;t found, then it will search super class. Since when a rails application is generated, an application.html.erb will be put in <em>app/views/layouts</em> and since by default all controllers&#8217; parent is ApplicationController, so by default this layout will be used.</p>

<p>Finally let&rsquo;s see how <strong>ActionController::Rendering</strong> overrides <strong>_normalize_options</strong></p>

<figure class='code'><figcaption><span>rails/actionpack/lib/action_controller/metal/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionController</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize both text and status options.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>      <span class="n">_normalize_text</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:html</span><span class="o">]</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:html</span><span class="o">]</span> <span class="o">=</span> <span class="ss">ERB</span><span class="p">:</span><span class="ss">:Util</span><span class="o">.</span><span class="n">html_escape</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:html</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:nothing</span><span class="p">)</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:body</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Utils</span><span class="o">.</span><span class="n">status_code</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">super</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So this method just process :html, :nothing and :status options, which is straight forward.</p>

<p>So finally let&rsquo;s see when we call <em>render</em> in <em>ArticlesController#index</em> without any arguments, the options will contains following values,</p>

<ul>
<li><strong>:prefixes</strong> : array [&ldquo;articles&rdquo;, &ldquo;application&rdquo;]</li>
<li><strong>:template</strong> : string &ldquo;index&rdquo;</li>
<li><strong>:layout</strong>   : A Proc when called will return &ldquo;app/views/layouts/application.html.erb&rdquo;</li>
</ul>


<p>Now we know how the options is normalized. And when Rails determines which template to render, it will extract details from the options. And we will look at how Rails determines template in later parts.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/16/deploy-rails-application-on-ubuntu-14-dot-04-part-3/">Deploy Rails Application on Ubuntu 14.04 Part 3</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-16T21:43:02+10:30" pubdate data-updated="true">Feb 16<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/16/deploy-rails-application-on-ubuntu-14-dot-04-part-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here is the Part 3 of Deploying Rails Application on Ubuntu 14.04, and also the final part. In this part we will explain what the Capistrano template does.</p>

<p>Capistrano is a remote server automation and deployment tool written in Ruby. Capistrano 3 extends Rake DSL with its own set of DSL. I recommend you read the documents on <a href="http://capistranorb.com/">Capistrano website</a>.</p>

<h2>Install Capistrano</h2>

<p>In <strong>Gemfile</strong> we add the following gems,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.1.0&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># rails specific capistrano funcitons</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 1.1.0&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># integrate bundler with capistrano</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-bundler&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># if you are using RBENV</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-rbenv&#39;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 2.0&quot;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <em>capistrano-rails</em>, <em>capistrano-bundler</em>, and <em>capistrano-rbenv</em> are capistrano plugins. Let&rsquo;s focus on capistrano first.</p>

<p>After running <strong>bundle install</strong>, if we run <strong>bundle exec cap install</strong>, it will generate following folders and files, actually when we copy the files from the capistrano template in part 2, it does the same thing.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  Capfile
</span><span class='line'> config
</span><span class='line'>    deploy
</span><span class='line'>       production.rb
</span><span class='line'>       staging.rb
</span><span class='line'>    deploy.rb
</span><span class='line'> lib
</span><span class='line'>     capistrano
</span><span class='line'>             tasks</span></code></pre></td></tr></table></div></figure>


<ul>
<li>In Capfile, It requires all necessary files, and also it includes all customized tasks in <em>lib/capistrano/tasks</em>.</li>
<li>Normally you have a production server and a staging server. So before you deploy new features to production server, you want to deploy to staging server first and after all QA are passed. So in <em>config/deploy.rb</em>, it defines the parameters that apply to all environments, and in <em>config/deploy/production.rb</em> and <em>config/deploy/staging.rb</em> it defines the parameters that apply to the specific environment. When we run <em>bundle exec cap production deploy</em>, it will load <em>config/deploy.rb</em> first, then <em>config/deploy/production.rb</em>, and then run the <strong>deploy</strong> rake task.</li>
</ul>


<h2>Understanding Capistrano</h2>

<p>To understand Capistrano, the best way is to read its source code. Actually it&rsquo;s not that hard as the source code of Capistrano is pretty easy to understand.</p>

<h3>DSL</h3>

<p>Capistrano defines a DSL. For those interested, can check the capistrano source code in folder <em>lib/capistrano/dsl</em></p>

<h4>Set attributes</h4>

<p>You can set some attributes by using <strong>set</strong>, and then later use <strong>fetch</strong> to get the attribute value by key. In our sample application <em>config/deploy.rb</em>, you can see it sets a lot of attributes.</p>

<p>The following code snippets illustrate its use.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s1">&#39;deploy_sample&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span> <span class="ss">:git</span>
</span><span class='line'>
</span><span class='line'><span class="n">fetch</span> <span class="ss">:application</span> <span class="c1"># if :application key doesn&#39;t exist, it will return nil</span>
</span><span class='line'>
</span><span class='line'><span class="n">fetch</span> <span class="ss">:application</span><span class="p">,</span> <span class="s1">&#39;application_name&#39;</span> <span class="c1"># if the :application key doesn&#39;t exist, it will return default value &#39;application_name&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">set_if_empty</span> <span class="ss">:rbenv_type</span><span class="p">,</span> <span class="ss">:user</span> <span class="c1"># set only the :rbenv_type key is not defined</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Server and Roles</h4>

<p>Think about our deployment, at least we need a database server, an application server which is unicorn, and a web server which is Nginx or Apache. Sometimes db, app and web are on the same server, sometimes they are installed on different servers. Capistrano defines these as roles. For example, in our sample application, we define one server which has three roles,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">server</span> <span class="s1">&#39;192.168.22.10&#39;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="sx">%w{web app db}</span><span class="p">,</span> <span class="ss">primary</span><span class="p">:</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>So later if we want to want to do something on the server that acts as web and app role, we could use <strong>roles</strong> or <strong>release_roles</strong> method,</p>

<p>For example, the following code will create directory on the server that act as web and app role,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:directories</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">on</span> <span class="n">release_roles</span> <span class="ss">:web</span><span class="p">,</span> <span class="ss">:app</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">execute</span> <span class="ss">:mkdir</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">shared_path</span><span class="p">,</span> <span class="n">releases_path</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If the <em>web</em> and <em>app</em> role point to two different servers, each server will create the directory. If we use :all, it will get all servers.</p>

<h3>Rake tasks</h3>

<p>Capistrano 3 actually is an extension of Rake tasks. So when we run <strong>bundle exec cap production deploy</strong>, it will run the <strong>deploy</strong> Rake task.</p>

<p>Let&rsquo;s have a look at the definition of the <strong>deploy</strong> task. It&rsquo;s in Capistrano source code <em>/lib/capistrano/tasks/framework.rake</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Deploy a new release.&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">set</span><span class="p">(</span><span class="ss">:deploying</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>  <span class="sx">%w{ starting started</span>
</span><span class='line'><span class="sx">      updating updated</span>
</span><span class='line'><span class="sx">      publishing published</span>
</span><span class='line'><span class="sx">      finishing finished }</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span>
</span><span class='line'>    <span class="n">invoke</span> <span class="s2">&quot;deploy:</span><span class="si">#{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we can see that the <strong>deploy</strong> task runs the following 8 tasks in sequence,
* deploy:starting
* deploy:started
* deploy:updating
* deploy:updated
* deploy:publishing
* deploy:published
* deploy:finishing
* deploy:finished</p>

<p>If you are interested you should check the source code of those tasks. For example, in task <em>deploy:updating</em> it will invoke <em>deploy:symlink:shared</em>, which in turns invokes <em>deploy:symlink:link_files</em>, let&rsquo;s see how this task is implemented</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:symlink</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">desc</span> <span class="s1">&#39;Symlink linked files&#39;</span>
</span><span class='line'>    <span class="n">task</span> <span class="ss">:linked_files</span> <span class="k">do</span>
</span><span class='line'>      <span class="k">next</span> <span class="k">unless</span> <span class="n">any?</span> <span class="ss">:linked_files</span>
</span><span class='line'>      <span class="n">on</span> <span class="n">release_roles</span> <span class="ss">:all</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">execute</span> <span class="ss">:mkdir</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">linked_file_dirs</span><span class="p">(</span><span class="n">release_path</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">fetch</span><span class="p">(</span><span class="ss">:linked_files</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>          <span class="n">target</span> <span class="o">=</span> <span class="n">release_path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>          <span class="n">source</span> <span class="o">=</span> <span class="n">shared_path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">test</span> <span class="s2">&quot;[ -L </span><span class="si">#{</span><span class="n">target</span><span class="si">}</span><span class="s2"> ]&quot;</span>
</span><span class='line'>            <span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;[ -f </span><span class="si">#{</span><span class="n">target</span><span class="si">}</span><span class="s2"> ]&quot;</span>
</span><span class='line'>              <span class="n">execute</span> <span class="ss">:rm</span><span class="p">,</span> <span class="n">target</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>            <span class="n">execute</span> <span class="ss">:ln</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that it will fetch the <em>linked_files</em> property, for our deploy sample application, we have set it to <em>%w{config/database.yml config/secrets.yml}</em>, so for each file, it will created a symbolic link in <em>release_path</em>, which points to the file in <em>shared_path</em>, where is release_path? Let&rsquo;s have a look at Capistrano source code <em>/lib/capistrano/dsl/paths.rb</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">deploy_to</span>
</span><span class='line'>  <span class="n">fetch</span><span class="p">(</span><span class="ss">:deploy_to</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">deploy_path</span>
</span><span class='line'>  <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">current_path</span>
</span><span class='line'>  <span class="n">deploy_path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;current&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">release_path</span>
</span><span class='line'>  <span class="n">fetch</span><span class="p">(</span><span class="ss">:release_path</span><span class="p">,</span> <span class="n">current_path</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the <em>release_path</em> by default is the <em>current_path</em>, which is the sub folder <em>current</em> under <em>deploy_path</em>, which is set by deploy_to. Since in deploy_sample application, we already set <em>deploy_to</em> to &ldquo;/product/#{fetch(:full_app_name)}&rdquo;, so for our case, <em>release_path</em> will be <strong>/product/deploy_sample_production/current</strong>.</p>

<p>For ssh, Capistrano depends on <a href="https://github.com/capistrano/sshkit">sshkit</a>, if you are interested, you could check the documents on its website.</p>

<p>In Capistrano we could customize the deploy process by injecting our own tasks. For example, in config/deploy.rb in our sample application, it defines</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">after</span> <span class="s1">&#39;deploy:symlink:shared&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:compile_assets_locally&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So after the task <em>deploy:symlink:shared</em>, it will run <em>deploy:compile_assets_locally</em>, which is to run <em>rake assets:precompile</em> locally and then upload the compiled assets to the server. You could use <em>before</em> or <em>after</em> to inject tasks before or after other tasks.</p>

<p>So now you should have an idea how Capistrano works. It&rsquo;s just a series of Rake tasks which ssh to the server to execute commands to do the deployment. In my opinion the Capistrano source code is quite easy to understand, you could check more details if you like.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/">Deploy Rails Application on Ubuntu 14.04 Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-09T21:27:23+10:30" pubdate data-updated="true">Feb 9<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In <a href="http://climber2002.github.io/blog/2015/02/08/deploy-rails-application-on-ubuntu-14-dot-04/">Part 1</a> we have installed Nginx PostgreSQL, and also Monit. In this part I will show how to deploy the application through capistrano.</p>

<p>In this part we will execute many commands, some will be executed in the host machine (our Laptop or iMac for example), and some will be executed in the Vagrant VM. I will show different prompt when executing. On host machine the prompt will be like <strong>host:~/rails_projects/deploy_sample$</strong>, and on VM the prompt will be <strong>vagrant@vagrant-ubuntu-trusty-64:~$</strong>, or if we su as deploy, it will be <strong>deploy@vagrant-ubuntu-trusty-64:~$</strong></p>

<h2>Create deploy user</h2>

<p>Just like we use an user <em>postgres</em> to manage our database, we should also use a standalone user to manage our application. We name this user <em>deploy</em>. And now let&rsquo;s create this user.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo adduser --ingroup sudo deploy
</span><span class='line'>Adding user <span class="sb">`</span>deploy<span class="s1">&#39; ...</span>
</span><span class='line'><span class="s1">Adding new user `deploy&#39;</span> <span class="o">(</span>1002<span class="o">)</span> with group <span class="sb">`</span>sudo<span class="s1">&#39; ...</span>
</span><span class='line'><span class="s1">Creating home directory `/home/deploy&#39;</span> ...
</span><span class='line'>Copying files from <span class="sb">`</span>/etc/skel<span class="err">&#39;</span> ...
</span><span class='line'>Enter new UNIX password:
</span><span class='line'>Retype new UNIX password:
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>Changing the user information <span class="k">for </span>deploy
</span><span class='line'>Enter the new value, or press ENTER <span class="k">for </span>the default
</span><span class='line'>  Full Name <span class="o">[]</span>:
</span><span class='line'>  Room Number <span class="o">[]</span>:
</span><span class='line'>  Work Phone <span class="o">[]</span>:
</span><span class='line'>  Home Phone <span class="o">[]</span>:
</span><span class='line'>  Other <span class="o">[]</span>:
</span><span class='line'>Is the information correct? <span class="o">[</span>Y/n<span class="o">]</span> Y
</span></code></pre></td></tr></table></div></figure>


<p>Set a password for <em>deploy</em> user and accept all default options.</p>

<p>Since we already add <em>deploy</em> user to sudo group. It can run sudo commands. However the user needs to input his password when sudo. When we run the capistrano deploy command later, it will run sudo commands. So I want to update this user so that he doesn&rsquo;t need to type password when running sodo commands. For this we need to update the <strong>/etc/sudoers</strong> file. It&rsquo;s recommended to use the application <strong>visudo</strong> to update it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo visodu
</span></code></pre></td></tr></table></div></figure>


<p>Add the following line to this file, and then type <em>Ctrl + O</em> to save it as /etc/sudoers, and type <em>Ctrl + X</em> to exit.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy  <span class="nv">ALL</span><span class="o">=(</span>ALL:ALL<span class="o">)</span> NOPASSWD:ALL
</span></code></pre></td></tr></table></div></figure>


<p>Notice that since we already add <em>deploy</em> user to sudo group, this line should be added under the line <strong>%sudo   ALL=(ALL:ALL) ALL</strong> so it will take effect.</p>

<p>Our deployment organization is like following figure,</p>

<p><img src="/images/deploy_structure.png"></p>

<p>Our host communicates with VM by SSH, and also when the VM sync code from github, it also uses SSH. So we need two public/private keypairs here. One will be generated in VM and used to communicate with Github. And One will be generated in host machine and used to communicate with VM during deployment.</p>

<p>Let&rsquo;s firstly generate a keypair for <em>deploy</em> user in VM. The public key for this keypair will be configured in github so the VM can download code from github.</p>

<p>Let&rsquo;s firstly su as deploy</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>su deploy
</span><span class='line'>Password:
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:/home/vagrant<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we go to the ~/.ssh folder and create a keypair.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:/home/vagrant<span class="nv">$ </span><span class="nb">cd</span> ~
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>mkdir .ssh
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span><span class="nb">cd</span> .ssh
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>ssh-keygen -t rsa -b 4096 -C climber2002@gmail.com
</span></code></pre></td></tr></table></div></figure>


<p>The <em>climber2002@gmail.com</em> is my email, and you should use your email here.</p>

<p>Accept default options, and after generation two files should be created, <strong>id_rsa</strong> and <strong>id_rsa.pub</strong>.</p>

<p>We can run <strong>cat id_rsa.pub</strong> and copy its content, and then configure this key in github.</p>

<p>In github, choose Settings &ndash;> SSH keys &ndash;> Add SSH key, and paste the public key, as the following snapshot.</p>

<p><img src="/images/github_add_ssh_key.png"></p>

<p>Now we need to add the key of our host to the Vagrant VM. Let&rsquo;s see if a key already existed.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host<span class="nv">$ </span>ls -l ~/.ssh
</span><span class='line'>-rw-------  1 andywang  staff  1679 Jun 25  2014 id_rsa
</span><span class='line'>-rw-r--r--  1 andywang  staff   403 Jun 25  2014 id_rsa.pub
</span></code></pre></td></tr></table></div></figure>


<p>Normally you should already have <strong>id_rsa</strong> and <strong>id_rsa.pub</strong>. If not run the <em>ssh-keygen</em> again in host to generate the SSH key.</p>

<p>And then lets copy the content of id_rsa.pub and copy it to VM&rsquo;s <strong>~/.ssh/authorized_keys</strong>. If this file doesn&rsquo;t exist, create it. And then paste the content in id_rsa.pub in this file as a standalone line.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~/.ssh<span class="nv">$ </span>vi authorized_keys
</span></code></pre></td></tr></table></div></figure>


<p>And also I updated the ssh config file <strong>/etc/ssh/sshd_config</strong> and changed the <strong>PasswordAuthentication yes</strong> to <strong>PasswordAuthentication no</strong> so we disable the password authentication, and only use Publickey authentication which is more secure.</p>

<p>After that let&rsquo;s restart ssh service</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~/.ssh<span class="nv">$ </span>sudo service ssh restart
</span></code></pre></td></tr></table></div></figure>


<p>Now from your host server, you should be able to ssh into the Vagrant VM.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host<span class="nv">$ </span>ssh deploy@192.168.22.10
</span><span class='line'>
</span><span class='line'>The authenticity of host <span class="s1">&#39;192.168.22.10 (192.168.22.10)&#39;</span> can<span class="s1">&#39;t be established.</span>
</span><span class='line'><span class="s1">RSA key fingerprint is b1:e4:e0:42:a1:37:0b:04:d3:88:8c:42:15:aa:00:b4.</span>
</span><span class='line'><span class="s1">Are you sure you want to continue connecting (yes/no)? yes</span>
</span><span class='line'><span class="s1">Warning: Permanently added &#39;</span>192.168.22.10<span class="err">&#39;</span> <span class="o">(</span>RSA<span class="o">)</span> to the list of known hosts.
</span><span class='line'>Welcome to Ubuntu 14.04.1 LTS <span class="o">(</span>GNU/Linux 3.13.0-45-generic x86_64<span class="o">)</span>
</span><span class='line'>
</span><span class='line'> * Documentation:  https://help.ubuntu.com/
</span><span class='line'>
</span><span class='line'>  System information as of Mon Feb  9 12:25:47 UTC 2015
</span><span class='line'>
</span><span class='line'>  System load:  0.0               Processes:           96
</span><span class='line'>  Usage of /:   3.1% of 39.34GB   Users logged in:     2
</span><span class='line'>  Memory usage: 33%               IP address <span class="k">for </span>eth0: 10.0.2.15
</span><span class='line'>  Swap usage:   0%                IP address <span class="k">for </span>eth1: 192.168.22.10
</span><span class='line'>
</span><span class='line'>  Graph this data and manage this system at:
</span><span class='line'>    https://landscape.canonical.com/
</span><span class='line'>
</span><span class='line'>  Get cloud support with Ubuntu Advantage Cloud Guest:
</span><span class='line'>    http://www.ubuntu.com/business/services/cloud
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Last login: Mon Feb  9 12:25:48 2015 from 192.168.22.1
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo ls
</span></code></pre></td></tr></table></div></figure>


<h2>Rbenv</h2>

<p>Now we install the Rbenv. We will use <a href="https://github.com/fesplugas/rbenv-installer">Rbenv installer</a> to ease our installation. Since we will use <em>deploy</em> user as our application owner. Make sure you firstly su as <em>deploy</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>curl https://raw.githubusercontent.com/fesplugas/rbenv-installer/master/bin/rbenv-installer | bash
</span></code></pre></td></tr></table></div></figure>


<p>After the installation is complete, add following lines to <em>~/.bashrc</em>, pay attention that you need to add it at the top of the file. Since the script will return if it&rsquo;s not running interactively.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">RBENV_ROOT</span><span class="o">=</span><span class="s2">&quot;${HOME}/.rbenv&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;${RBENV_ROOT}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;${RBENV_ROOT}/bin:${PATH}&quot;</span>
</span><span class='line'>  <span class="nb">eval</span> <span class="s2">&quot;$(rbenv init -)&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>After we run <strong>. ~/.bashrc</strong> to take the change into effect.</p>

<p>Now we need to install some required packages on Ubuntu.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>rbenv bootstrap-ubuntu-12-04
</span></code></pre></td></tr></table></div></figure>


<p>After the necessary packages are installed, lets install Ruby 2.1.4</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>rbenv install 2.1.4
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>rbenv global 2.1.4
</span></code></pre></td></tr></table></div></figure>


<p>This will download and compile Ruby 2.1.4 so it will take some time. Let&rsquo;s grab a cup of coffee~~</p>

<h2>Install bundler</h2>

<p>After installed ruby 2.1.4 let&rsquo;s install bundler</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>gem install bundler
</span></code></pre></td></tr></table></div></figure>


<h2>Create the application directory</h2>

<p>For my application, I want to deploy the application in <strong>/product</strong> folder, so let&rsquo;s create that folder and change the owner to <em>deploy</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo mkdir /product
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo chown -R deploy:sudo /product
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy with Capistrano</h2>

<p>Now we will try to deploy with Capistrano. We will use the <a href="https://github.com/TalkingQuickly/capistrano-3-rails-template">capistrano 3 template</a> to help us. Don&rsquo;t worry if you don&rsquo;t fully understand, I will explain it in next part.</p>

<p>Now firstly let&rsquo;s clone the capistrano template in our host station. For me, both this project and the <em>deploy_sample</em> project are in the same folder which is <em>~/rails_projects</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects<span class="nv">$ </span>git clone https://github.com/TalkingQuickly/capistrano-3-rails-template.git
</span></code></pre></td></tr></table></div></figure>


<p>And then in <em>Gemfile</em> of our <em>deploy_sample</em> project, let&rsquo;s add the necessary gems.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Use Unicorn as the app server</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;unicorn&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.1.0&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># rails specific capistrano funcitons</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 1.1.0&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># integrate bundler with capistrano</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-bundler&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># if you are using RBENV</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-rbenv&#39;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 2.0&quot;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that let&rsquo;s run <strong>bundle install</strong> to install all the gems.</p>

<p>The capistrano 3 templates added some customized tasks, so lets copy all the files from the template to our project.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp ../capistrano-3-rails-template/Capfile .
</span><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp -r ../capistrano-3-rails-template/config/ ./config
</span><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp -r ../capistrano-3-rails-template/lib/ ./lib
</span></code></pre></td></tr></table></div></figure>


<h3>Copy secrets.yml</h3>

<p>The Capistrano templates has some template files in <em>config/shared</em> folder, these files will be copied to a shared folder in VM when we run the task <strong>deploy:setup_config</strong>. Notice that we also want <em>secrets.yml</em> to be in the shared folder, so it won&rsquo;t be committed in our git repository. So let&rsquo;s copy this file into shared folder also. We change the filename to secrets.yml.erb as the task will render the erb file to secrets.yml during setup.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp config/secrets.yml config/deploy/shared/secrets.yml.erb
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to update the <em>config/deploy.rb</em> file as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s1">&#39;deploy_sample&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_user</span><span class="p">,</span> <span class="s1">&#39;deploy&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># setup repo details</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span> <span class="ss">:git</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:repo_url</span><span class="p">,</span> <span class="s1">&#39;git@github.com:climber2002/deploy_sample.git&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># setup rbenv.</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_type</span><span class="p">,</span> <span class="ss">:user</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_ruby</span><span class="p">,</span> <span class="s1">&#39;2.1.4&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_prefix</span><span class="p">,</span> <span class="s2">&quot;RBENV_ROOT=</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> RBENV_VERSION=</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_ruby</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_path</span><span class="p">)</span><span class="si">}</span><span class="s2">/bin/rbenv exec&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_map_bins</span><span class="p">,</span> <span class="sx">%w{rake gem bundle ruby rails}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># how many old releases do we want to keep, not much</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:keep_releases</span><span class="p">,</span> <span class="mi">5</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># files we want symlinking to specific entries in shared</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:linked_files</span><span class="p">,</span> <span class="sx">%w{config/database.yml config/secrets.yml}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># dirs we want symlinking to shared</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:linked_dirs</span><span class="p">,</span> <span class="sx">%w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># what specs should be run before deployment is allowed to</span>
</span><span class='line'><span class="c1"># continue, see lib/capistrano/tasks/run_tests.cap</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:tests</span><span class="p">,</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># which config files should be copied by deploy:setup_config</span>
</span><span class='line'><span class="c1"># see documentation in lib/capistrano/tasks/setup_config.cap</span>
</span><span class='line'><span class="c1"># for details of operations</span>
</span><span class='line'><span class="n">set</span><span class="p">(</span><span class="ss">:config_files</span><span class="p">,</span> <span class="sx">%w(</span>
</span><span class='line'><span class="sx">  nginx.conf</span>
</span><span class='line'><span class="sx">  database.example.yml</span>
</span><span class='line'><span class="sx">  log_rotation</span>
</span><span class='line'><span class="sx">  monit</span>
</span><span class='line'><span class="sx">  unicorn.rb</span>
</span><span class='line'><span class="sx">  unicorn_init.sh</span>
</span><span class='line'><span class="sx">  secrets.yml</span>
</span><span class='line'><span class="sx">)</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># which config files should be made executable after copying</span>
</span><span class='line'><span class="c1"># by deploy:setup_config</span>
</span><span class='line'><span class="n">set</span><span class="p">(</span><span class="ss">:executable_config_files</span><span class="p">,</span> <span class="sx">%w(</span>
</span><span class='line'><span class="sx">  unicorn_init.sh</span>
</span><span class='line'><span class="sx">)</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1"># files which need to be symlinked to other parts of the</span>
</span><span class='line'><span class="c1"># filesystem. For example nginx virtualhosts, log rotation</span>
</span><span class='line'><span class="c1"># init scripts etc. The full_app_name variable isn&#39;t</span>
</span><span class='line'><span class="c1"># available at this point so we use a custom template </span>
</span><span class='line'><span class="c1"># tag and then add it at run time.</span>
</span><span class='line'><span class="n">set</span><span class="p">(</span><span class="ss">:symlinks</span><span class="p">,</span> <span class="o">[</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;nginx.conf&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/nginx/sites-enabled/&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;unicorn_init.sh&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/init.d/unicorn_&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;log_rotation&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/logrotate.d/&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;monit&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/monit/conf.d/.conf&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># this:</span>
</span><span class='line'><span class="c1"># http://www.capistranorb.com/documentation/getting-started/flow/</span>
</span><span class='line'><span class="c1"># is worth reading for a quick overview of what tasks are called</span>
</span><span class='line'><span class="c1"># and when for `cap stage deploy`</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># make sure we&#39;re deploying what we think we&#39;re deploying</span>
</span><span class='line'>  <span class="n">before</span> <span class="ss">:deploy</span><span class="p">,</span> <span class="s2">&quot;deploy:check_revision&quot;</span>
</span><span class='line'>  <span class="c1"># only allow a deploy with passing tests to deployed</span>
</span><span class='line'>  <span class="n">before</span> <span class="ss">:deploy</span><span class="p">,</span> <span class="s2">&quot;deploy:run_tests&quot;</span>
</span><span class='line'>  <span class="c1"># compile assets locally then rsync</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:symlink:shared&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:compile_assets_locally&#39;</span>
</span><span class='line'>  <span class="n">after</span> <span class="ss">:finishing</span><span class="p">,</span> <span class="s1">&#39;deploy:cleanup&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># remove the default nginx configuration as it will tend</span>
</span><span class='line'>  <span class="c1"># to conflict with our configs.</span>
</span><span class='line'>  <span class="n">before</span> <span class="s1">&#39;deploy:setup_config&#39;</span><span class="p">,</span> <span class="s1">&#39;nginx:remove_default_vhost&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># reload nginx to it will pick up any modified vhosts from</span>
</span><span class='line'>  <span class="c1"># setup_config</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:setup_config&#39;</span><span class="p">,</span> <span class="s1">&#39;nginx:reload&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Restart monit so it will pick up any monit configurations</span>
</span><span class='line'>  <span class="c1"># we&#39;ve added</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:setup_config&#39;</span><span class="p">,</span> <span class="s1">&#39;monit:restart&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># As of Capistrano 3.1, the `deploy:restart` task is not called</span>
</span><span class='line'>  <span class="c1"># automatically.</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:publishing&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:restart&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We changed the following things,
1. We changed the <em>application</em> to <strong>deploy_sample</strong>, which is our application name
2. We changed <em>repo_url</em> to <strong>git@github.com:climber2002/deploy_sample.git</strong>, which is our git repository
3. We changed the <em>rbenv_type</em> from <strong>:system</strong> to <strong>:user</strong>, and <em>rbenv_ruby</em> to <strong>2.1.4</strong>, which is the version we installed just now
4. We changed the <em>linked_files</em> to add secrets.yml, the linked files will be stored in share folder but they will be created a symbolic link in config folder.
5. We changed the config_files to add secrets.yml, since we also want to copy this file to shared folder.</p>

<p>Now let&rsquo;s update <em>config/deploy/production.rb</em> file as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:stage</span><span class="p">,</span> <span class="ss">:production</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This is used in the Nginx VirtualHost to specify which domains</span>
</span><span class='line'><span class="c1"># the app should appear on. If you don&#39;t yet have DNS setup, you&#39;ll</span>
</span><span class='line'><span class="c1"># need to create entries in your local Hosts file for testing.</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:server_name</span><span class="p">,</span> <span class="s2">&quot;www.example.com example.com&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># used in case we&#39;re deploying multiple versions of the same</span>
</span><span class='line'><span class="c1"># app side by side. Also provides quick sanity checks when looking</span>
</span><span class='line'><span class="c1"># at filepaths</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:full_app_name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:application</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:stage</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">server</span> <span class="s1">&#39;192.168.22.10&#39;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="sx">%w{web app db}</span><span class="p">,</span> <span class="ss">primary</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/product/</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:full_app_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># dont try and infer something as important as environment from</span>
</span><span class='line'><span class="c1"># stage name.</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rails_env</span><span class="p">,</span> <span class="ss">:production</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># number of unicorn workers, this will be reflected in</span>
</span><span class='line'><span class="c1"># the unicorn.rb and the monit configs</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:unicorn_worker_count</span><span class="p">,</span> <span class="mi">5</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># whether we&#39;re using ssl or not, used for building nginx</span>
</span><span class='line'><span class="c1"># config file</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:enable_ssl</span><span class="p">,</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>We changed following things for this file
1. We changed the <em>server</em> to <strong>192.168.22.10</strong>, which is our VM IP address.
2. We changed <em>deploy_to</em> to <strong>/product/#{fetch(:full_app_name)}</strong> since we want to deploy to <strong>/product</strong> folder.</p>

<p>During real deployment you should also change the <em>server_name</em> to the correct domain name for your server.</p>

<p>Now let&rsquo;s run the command to setup deploy.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>bundle <span class="nb">exec </span>cap production deploy:setup_config
</span></code></pre></td></tr></table></div></figure>


<p>This step will copy all shared folders to <strong>/product/deploy_sample_production/shared/config</strong> folder, let&rsquo;s check that folder in our VM,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~/.ssh<span class="nv">$ </span><span class="nb">cd</span> /product/deploy_sample_production/shared/config
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:/product/deploy_sample_production/shared/config<span class="nv">$ </span>ls -l
</span><span class='line'>total 28
</span><span class='line'>-rw-r----- 1 deploy sudo  203 Feb 10 04:45 database.example.yml
</span><span class='line'>-rw-r----- 1 deploy sudo  188 Feb 10 04:45 log_rotation
</span><span class='line'>-rw-r----- 1 deploy sudo 2629 Feb 10 04:45 monit
</span><span class='line'>-rw-r----- 1 deploy sudo  645 Feb 10 04:45 nginx.conf
</span><span class='line'>-rw-r----- 1 deploy sudo  935 Feb 10 04:45 secrets.yml
</span><span class='line'>-rwxr-x--x 1 deploy sudo 2001 Feb 10 04:45 unicorn_init.sh
</span><span class='line'>-rw-r----- 1 deploy sudo 1333 Feb 10 04:45 unicorn.rb
</span></code></pre></td></tr></table></div></figure>


<p>We can see that some files are copied to the <strong>/product/deploy_sample_production/shared/config</strong> folder. Now we need to update the database.yml and secrets.yml.</p>

<p>For database.yml, let&rsquo;s firstly copy the database.example.yml to database.yml</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:/product/deploy_sample_production/shared/config<span class="nv">$ </span>cp database.example.yml database.yml
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:/product/deploy_sample_production/shared/config<span class="nv">$ </span>vi database.yml
</span></code></pre></td></tr></table></div></figure>


<p>We changed the content as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgresql</span>
</span><span class='line'>  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5000</span>
</span><span class='line'>  <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">utf8</span>
</span><span class='line'>  <span class="l-Scalar-Plain">reconnect</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deploy_sample_production</span>
</span><span class='line'>  <span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deploy_sample</span>
</span><span class='line'>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">secret</span>
</span><span class='line'>  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>  <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5432</span>
</span></code></pre></td></tr></table></div></figure>


<p>We set the username and password to the value we created in Part 1, and also we set host to localhost since we installed database and application on same server.</p>

<p>Now we need to update secrets.yml, firstly lets generate a secret from our project folder</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>rake secret
</span><span class='line'>9f529340b1a34f223cb7a6fd2cf0d0d039ed5d03fe3d2b2787cc712585ffcee22e14e6136486356b12f383bc48f231896d556da131bd8c8d8bcf17bbc9ef7048
</span></code></pre></td></tr></table></div></figure>


<p>Now we copy this value to secrets.yml, of course you can also use an environment variable. After update our secrets.yml look like this,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">75b397c3479019e0d5b2c7e3f57660c501369ffa4232958bcde366dc08e86b2f227fb1a57e172eccafc37fcfd5616909d4105d0d07069a4d061abf58a5745eef</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">351180e5d983a83fa207f7df16e8509ad55910bab6d4e7a9e94dd3e80f8385fc8d8f5b1101fd2e565d2a0afb340917ac245d2ef69e00686e6eb6044ad92b3104</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Do not keep production secrets in the repository,</span>
</span><span class='line'><span class="c1"># instead read values from the environment.</span>
</span><span class='line'><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9f529340b1a34f223cb7a6fd2cf0d0d039ed5d03fe3d2b2787cc712585ffcee22e14e6136486356b12f383bc48f231896d556da131bd8c8d8bcf17bbc9ef7048</span>
</span></code></pre></td></tr></table></div></figure>


<p>the production:secret_key_base is set to the value we just created.</p>

<p>Now all preparation has been done, now let&rsquo;s do the deploy!</p>

<p>Let&rsquo;s run following command,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>bundle <span class="nb">exec </span>cap production deploy
</span></code></pre></td></tr></table></div></figure>


<p>If everything runs correctly, after a long logs the deployment should be successful. And from your browser you can access <a href="http://192.168.22.10/articles">http://192.168.22.10/articles</a> to see the Article scaffold we&rsquo;ve created.</p>

<p><img src="/images/deploy_sample.png"></p>

<h2>Summary</h2>

<p>In this part we&rsquo;ve introduced the steps to deploy by using Capistrano 3. And we utilized a Capistrano template. But you may be wondering what Capistrano has done for us. So in next part I will introduct what has been done in this template.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/08/deploy-rails-application-on-ubuntu-14-dot-04/">Deploy Rails Application on Ubuntu 14.04 Part 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-08T22:03:52+10:30" pubdate data-updated="true">Feb 8<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/08/deploy-rails-application-on-ubuntu-14-dot-04/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In <a href="http://climber2002.github.io/blog/2014/09/07/depoly-a-rails-4-application-on-an-amazon-ec2-server/">one of my previous post</a> I described how to do the deployment manually on an Amazon EC2 server. And in this new series of posts I want to introduce how to deploy a Ruby on Rails 4.2 application on a Ubuntu 14.04 server from start to finish. I know there are lots of tutorials on the internet and even several books on deploying rails, however they are either outdated or not very clear how to do the deployment step by step. So in this series I will try to describe as clear as possible for each step.</p>

<p>In this first part I will describe how to install the web server and database. Here I will use Nginx, Unicorn and PostgreSQL.</p>

<h2>Application</h2>

<p>To demonstrate the deployment, I will create a sample Rails 4.2 application called deploy_sample.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails _4.2_ new deploy_sample -d postgresql
</span></code></pre></td></tr></table></div></figure>


<p>And then I update the .gitignore file to exclude database.yml and secrets.yml from committing to repository.</p>

<p>Add the following lines to .gitignore</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/config/database.yml
</span><span class='line'>/config/secrets.yml</span></code></pre></td></tr></table></div></figure>


<p>And then we copy the database.yml and secrets.yml to an example yml so let&rsquo;s say if your colleagues need to work on this project, they could copy the example yml back and set their configurations.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cp ./config/database.yml ./config/database.example.yml
</span><span class='line'><span class="nv">$ </span>cp ./config/secrets.yml ./config/secrets.example.yml
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s init the git repository and commit our project.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git init
</span><span class='line'><span class="nv">$ </span>git add .
</span><span class='line'><span class="nv">$ </span>git commit -m <span class="s1">&#39;initial commit&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will use github as our remote repository, so let&rsquo;s create a repository on github. And then follow its instructions, let&rsquo;s push the project.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git remote add origin https://github.com/climber2002/deploy_sample.git
</span><span class='line'>git push -u origin master
</span></code></pre></td></tr></table></div></figure>


<p>After that if we refresh the repository on github, we could see the content that we have committed, like the following snapshot.</p>

<p><img src="/images/deploy_sample_github.png"></p>

<p>Now let&rsquo;s create some models, for simplicity I will just create a model called <strong>Article</strong> using scaffold.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bundle <span class="nb">exec </span>rails generate scaffold Article title content:text
</span></code></pre></td></tr></table></div></figure>


<p>We can run the migrations and test the application is ok from accessing *<a href="http://localhost:3000*">http://localhost:3000*</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bundle <span class="nb">exec </span>rake db:create
</span><span class='line'>bundle <span class="nb">exec </span>rake db:migrate
</span><span class='line'>bundle <span class="nb">exec </span>rails s
</span></code></pre></td></tr></table></div></figure>


<p>After we can commit our changes,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git add .
</span><span class='line'>git commit -m <span class="s1">&#39;add Article scaffold&#39;</span>
</span><span class='line'>git push origin master
</span></code></pre></td></tr></table></div></figure>


<p>Now this sample application will be used for our deployment</p>

<h2>Vagrant</h2>

<p>For demonstration I will use Vagrant to create a VM. But it should apply to any VPS too. Firstly you should install VirtualBox and Vagrant. The installation should be straight forward.</p>

<p>Then we create an empty folder in <strong>~/Sites</strong> and init the Vagrant.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir ~/Sites/deploy_sample_vagrant
</span><span class='line'><span class="nb">cd</span> ~/Sites/deploy_sample_vagrant/
</span><span class='line'>vagrant init <span class="s1">&#39;ubuntu/trusty64&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The vagrant init command creates a new file called Vagantfile. This file is configured to use Ubuntu 14.04 LTS server, codenamed trusty.</p>

<p>And I want to assign this VM a private IP address, so we can access it from host server later. So open the Vagrantfile and add the following line.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>config.vm.network "private_network", ip: "192.168.22.10"</span></code></pre></td></tr></table></div></figure>


<p>It assigns the IP address &ldquo;192.168.22.10&rdquo; to the VM. Later we can see that we can access the nginx by using this IP address.</p>

<p>Now in this folder we could type <strong>vagrant up</strong> to start the VM. If it&rsquo;s the first time it will take some time as it needs to download the VM image from the internet.</p>

<p>After the VM is up, we could type <strong>vagrant ssh</strong> to ssh into the VM. Notice the prompt will change. If you are not sure whether you are in host server or the VM, just check the prompt.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~$</span></code></pre></td></tr></table></div></figure>


<h2>Install Basic Software</h2>

<p>After our VM is up we could install some basic software.</p>

<p>So in the VM, we type following commands,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get -y update
</span><span class='line'>sudo apt-get -y install curl wget unzip git ack-grep htop vim tmux software-properties-common
</span></code></pre></td></tr></table></div></figure>


<h2>Nginx</h2>

<p>Now let&rsquo;s install Nginx. As the default Nginx distribution may be out of date, let&rsquo;s add Nginx repository and install it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo add-apt-repository ppa:nginx/stable
</span><span class='line'>sudo apt-get -y update
</span><span class='line'>sudo apt-get -y install nginx
</span></code></pre></td></tr></table></div></figure>


<p>After installation Nginx should start automatically. We could check its status by executing <strong>sudo service nginx status</strong>. And we could also access <a href="http://192.168.22.10">http://192.168.22.10</a> from our browser.</p>

<p><img src="/images/nginx.png"></p>

<h2>PostgreSQL</h2>

<p>Now let&rsquo;s install PostgreSQL. And again we add another repository.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo add-apt-repository ppa:pitti/postgresql
</span><span class='line'>sudo apt-get -y update
</span><span class='line'>sudo apt-get -y install postgresql libpq-dev
</span></code></pre></td></tr></table></div></figure>


<p>The libpq-dev library is needed for building the &lsquo;pg&rsquo; rubygem.</p>

<p>Installing PostgreSQL will create a user named &lsquo;postgres&rsquo;. This user is the owner of PostgreSQL.</p>

<p>Let&rsquo;s create a password for postgres.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo passwd postgres
</span><span class='line'>Enter new UNIX password:
</span><span class='line'>Retype new UNIX password:
</span><span class='line'>passwd: password updated successfully
</span></code></pre></td></tr></table></div></figure>


<p>In PostgreSQL the user is represented by a Role. Now let&rsquo;s create a role named <em>deploy_sample</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo -u postgres psql
</span><span class='line'>
</span><span class='line'><span class="nv">postgres</span><span class="o">=</span><span class="c"># create user deploy_sample with password &#39;secret&#39;;</span>
</span><span class='line'>CREATE ROLE
</span><span class='line'><span class="nv">postgres</span><span class="o">=</span><span class="c"># create database deploy_sample_production owner deploy_sample;</span>
</span><span class='line'>CREATE DATABASE
</span><span class='line'><span class="nv">postgres</span><span class="o">=</span><span class="c"># \q</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above lines will create a user <em>deploy_sample</em> and a database <em>deploy_sample_production</em> and set deploy_sample as its owner. The last command <em>\q</em> is to exit psql.</p>

<h2>Monit</h2>

<p>In next part we will use <a href="https://github.com/TalkingQuickly/capistrano-3-rails-template">capistrano template</a> for our deployment. And in that template it will also deploy <a href="http://mmonit.com/monit/">Monit</a>. According to its official website, &ldquo;Monit is a small Open Source utility for managing and monitoring Unix systems. Monit conducts automatic maintenance and repair and can execute meaningful causal actions in error situations.&rdquo;</p>

<p>So let&rsquo;s also install that.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get -y install monit
</span></code></pre></td></tr></table></div></figure>


<p>After installation we can run <strong>sudo service monit status</strong> to confirm that monit service is already started.</p>

<h2>Nodejs</h2>

<p>We need a Javascript runtime so we are going to install Nodejs.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get -y install nodejs
</span></code></pre></td></tr></table></div></figure>


<h2>Summary</h2>

<p>In this part we setup a VM server and installed Nginx and PostgreSQL. In next part we will see how to deploy our rails app by using capistrano.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/07/install-and-configure-postgresql-on-ubuntu-14-dot-04/">Configure Customized Data Directory for Postgresql on Ubuntu 14.04</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-07T20:01:19+10:30" pubdate data-updated="true">Feb 7<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/07/install-and-configure-postgresql-on-ubuntu-14-dot-04/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>PostgreSQL</strong> is a very popular database in Rails world. Here I describe how to install and configure it on Ubuntu 14.04 server.</p>

<h2>Install</h2>

<p>Using apt-get to install PostgreSQL is very simple. Just execute the following two commands,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get install postgresql postgresql-contrib
</span></code></pre></td></tr></table></div></figure>


<p>Here on my server it will install PostgreSQL 9.3.</p>

<p>During the installation a user named &lsquo;postgres&rsquo; will be created automatically and this user is used to start postgresql.</p>

<p>So we should change the password of user &lsquo;postgres&rsquo;.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo passwd postgres
</span><span class='line'>Enter new UNIX password:
</span><span class='line'>Retype new UNIX password:
</span><span class='line'>passwd: password updated successfully
</span></code></pre></td></tr></table></div></figure>


<p>The installation will put configuration files in <strong>/etc/postgresql/9.3/main</strong> by default.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:/etc/postgresql/9.3/main<span class="nv">$ </span>ls -la
</span><span class='line'>total 56
</span><span class='line'>drwxr-xr-x 2 postgres postgres  4096 Feb  7 09:26 .
</span><span class='line'>drwxr-xr-x 3 postgres postgres  4096 Feb  7 09:26 ..
</span><span class='line'>-rw-r--r-- 1 postgres postgres   315 Feb  7 09:26 environment
</span><span class='line'>-rw-r--r-- 1 postgres postgres   143 Feb  7 09:26 pg_ctl.conf
</span><span class='line'>-rw-r----- 1 postgres postgres  4649 Feb  7 09:26 pg_hba.conf
</span><span class='line'>-rw-r----- 1 postgres postgres  1636 Feb  7 09:26 pg_ident.conf
</span><span class='line'>-rw-r--r-- 1 postgres postgres 20687 Feb  7 09:26 postgresql.conf
</span><span class='line'>-rw-r--r-- 1 postgres postgres   378 Feb  7 09:26 start.conf
</span></code></pre></td></tr></table></div></figure>


<h2>Configure new data directory</h2>

<p>Sometimes to improve performance, we want put postgres data files in its own disk. For example, we may mount a disk in folder <strong>/database</strong> and we want to put all postgres data file there. So let&rsquo;s do that.</p>

<p>Suppose the <strong>/database</strong> folder already exists. We need to change its owner to postgres firstly.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo chown -R postgres:postgres /database
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to initialize this folder as a data folder</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>su postgres
</span><span class='line'><span class="nv">$ </span>/usr/lib/postgresql/9.3/bin/initdb -D /database
</span></code></pre></td></tr></table></div></figure>


<p>We must su as postgres first since this user also owns the server process.</p>

<p>Now let&rsquo;s stop server by running <strong>sudo service postgresql stop</strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo service postgresql stop
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to update the file <strong>/etc/postgresql/9.3/main/postgresql.conf</strong>,</p>

<p>change <strong>data_directory = &lsquo;/var/lib/postgresql/9.3/main&rsquo;</strong> to <strong>data_directory = &lsquo;/database&rsquo;</strong></p>

<p>PS: You need to stop the server first before updating the data_directory location. Otherwise the stop will fail and you need to kill the process manually.</p>

<p>After update the configuration file we need to restart postgresql server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo service postgresql start
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/22/capybara-integration-tests-with-jquery-selectize/">Capybara Integration Tests With JQuery Selectize</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-22T22:30:13+09:30" pubdate data-updated="true">Sep 22<span>nd</span>, 2014</time>
        
         | <a href="/blog/2014/09/22/capybara-integration-tests-with-jquery-selectize/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently in one of my projects I utilized a popular JQuery plugin called <a href="http://brianreavis.github.io/selectize.js/">Selectize</a>. And I need to do Integration tests by using Capybara. Here is how to simulate some general events of Selectize.</p>

<p>Firstly I use poltergeist Javascript driver, so in my <strong>rails_helper.rb</strong> it has following configurations,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Capybara</span><span class="o">.</span><span class="n">javascript_driver</span> <span class="o">=</span> <span class="ss">:poltergeist</span>
</span><span class='line'>
</span><span class='line'><span class="no">Capybara</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="ss">:prefer_exact</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">ignore_hidden_elements</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/selectize.png"></p>

<p>When a input box is selectized like the figure above, we can check it generates following DOM structure in our HTML,</p>

<p> <img src="/images/selectize_code.png"></p>

<p> The input &lsquo;#properties-input&rsquo; is our original input, it&rsquo;s set &lsquo;display: none&rsquo; css property, and Selectize replaces it with another input, and the &lsquo;div.item&rsquo; contains the items that we already selected, the &lsquo;div.selectize-dropdown&rsquo; is shown as a dropdown when we click the input and lets us to choose another item.</p>

<p> So if we needs to select an item, we could do like this,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">within</span><span class="p">(</span><span class="ss">:xpath</span><span class="p">,</span> <span class="s2">&quot;//input[@id=&#39;properties-input&#39;]/..&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">first</span><span class="p">(</span><span class="s1">&#39;div.selectize-input&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span>
</span><span class='line'>  <span class="n">find</span><span class="p">(</span><span class="s1">&#39;div.option&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Screen Size&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here I use a xpath to find the parent of the input box that we selectized, and then within this parent we click the &lsquo;div.selectize-input&rsquo;, and the dropdown will show and we run <code>find('div.option', :text =&gt; 'Screen Size').click</code> to click the item that contains the text &lsquo;Screen Size&rsquo;.</p>

<p>Selectize also provides Ajax support, when you type something in the input, it could send Ajax requests to server to populate the items. So here we simulate the input,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">within</span><span class="p">(</span><span class="ss">:xpath</span><span class="p">,</span> <span class="s2">&quot;//input[@id=&#39;properties-input&#39;]/..&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">first</span><span class="p">(</span><span class="s1">&#39;div.selectize-input input&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is to simulate input a &lsquo;u&rsquo; character in the input, and if you configure the <strong>load</strong> option, it will send a Ajax request to the server to populate the items.</p>

<p>I&rsquo;ve created a <strong>SelectizeHelpers</strong> class to simulate some common events,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">SelectizeHelpers</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">selectize_click</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">selectize_within</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">first</span><span class="p">(</span><span class="s1">&#39;div.selectize-input&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">select_option</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">selectize_within</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">first</span><span class="p">(</span><span class="s1">&#39;div.selectize-input&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span>
</span><span class='line'>      <span class="n">find</span><span class="p">(</span><span class="s1">&#39;div.option&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">click</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set_text</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">selectize_within</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">first</span><span class="p">(</span><span class="s1">&#39;div.selectize-input input&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">selectize_within</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">within</span><span class="p">(</span><span class="ss">:xpath</span><span class="p">,</span> <span class="s2">&quot;//input[@id=&#39;</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&#39;]/..&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="k">yield</span> <span class="k">if</span> <span class="nb">block_given?</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">include</span> <span class="no">SelectizeHelpers</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:feature</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>selectize_click(id)</code> is to click the selectize input, the <code>select_option</code> is to select an option whose text matches the <strong>text</strong>. And <code>set_text</code> is to set some text in the input.</p>

<p>For the methods above, the <strong>id</strong> we should pass the id of the input that we apply the selectize.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/07/depoly-a-rails-4-application-on-an-amazon-ec2-server/">Depoly a Rails 4 Application on an Amazon EC2 Server</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-07T17:45:05+09:30" pubdate data-updated="true">Sep 7<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/09/07/depoly-a-rails-4-application-on-an-amazon-ec2-server/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this blog I will list the steps needed to deploy a Rails 4 application on an Amazon EC2 server. The OS is Ubuntu Server 14.04 LTS, the database is Postgresql and the web server is Unicorn + Ngnix. Previously I mainly deploy the project on Engine Yard. But this time I need to deploy it on a server manually.</p>

<h2>Updating And Preparing The Operating System</h2>

<h3>Update the Operating System</h3>

<p>Firstly we need to update our OS by running following command,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get update
</span></code></pre></td></tr></table></div></figure>


<h3>Change locale file</h3>

<p>In some cases on my server it shows the following warnings,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>perl: warning: Setting locale failed.   
</span><span class='line'>perl: warning: Please check that your locale settings:   
</span><span class='line'>        LANGUAGE = "en_US:en",   
</span><span class='line'>        LC_ALL = (unset),   
</span><span class='line'>        LC_MESSAGES = "en_US.UTF-8",   
</span><span class='line'>        LANG = "en_US.UTF-8"   
</span><span class='line'>    are supported and installed on your system.</span></code></pre></td></tr></table></div></figure>


<p>The solution is to edit the <strong>/etc/default/locale</strong> and add the following contents,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>LC_ALL=en_US.UTF-8
</span><span class='line'>LANG=en_US.UTF-8</span></code></pre></td></tr></table></div></figure>


<h3>Install the necessary packages</h3>

<p>Next we need to install the following necessary packages by running,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install build-essential openssl libreadline6 libreadline6-dev zlib1g zlib1g-dev libssl-dev git-core python-software-properties nodejs libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev automake libtool bison pkg-config
</span></code></pre></td></tr></table></div></figure>


<p>The <em>python-software-properties</em> allows us to easily manage your distribution and independent software vendor software sources. It will be useful when we install Postgresql and Nginx.</p>

<p>The <em>nodejs</em> is a Javascript runtime for Rails.</p>

<h2>Install rbenv</h2>

<p>Now we need to install a Ruby runtime. I choose rbenv instead of rvm, which is more lightweight for production.</p>

<p>Let&rsquo;s install rbenv by running the following command,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl https://raw.githubusercontent.com/fesplugas/rbenv-installer/master/bin/rbenv-installer | bash
</span></code></pre></td></tr></table></div></figure>


<p>After installation, following its instructions, add the following content at the top of ~/.bash_profile</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">RBENV_ROOT</span><span class="o">=</span><span class="s2">&quot;${HOME}/.rbenv&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;${RBENV_ROOT}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;${RBENV_ROOT}/bin:${PATH}&quot;</span>
</span><span class='line'>  <span class="nb">eval</span> <span class="s2">&quot;$(rbenv init -)&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that run <code>source ~/.bash_profile</code> to make the changed effective.</p>

<p>Now we install Ruby 2.1.2 and make it global by running following commands,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rbenv install 2.1.2 --verbose
</span><span class='line'>rbenv rehash
</span><span class='line'>rbenv global 2.1.2
</span></code></pre></td></tr></table></div></figure>


<p>The install could take a while so grab a cup of coffee.</p>

<p>After Ruby 2.1.2 is installed, we can install bundler by typing,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem install bundler
</span><span class='line'>rbenv rehash
</span></code></pre></td></tr></table></div></figure>


<h2>Install Nginx</h2>

<p>Now let&rsquo;s install Nginx. Let&rsquo;s add the repository of Nginx by typing following command,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-add-repository ppa:nginx/stable
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to invoke <code>sudo apt-get update</code> again since we added a new software source.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get update
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s install Nginx by invoking,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install nginx
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s check Nginx status by typing</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo service nginx status
</span></code></pre></td></tr></table></div></figure>


<p>If it&rsquo;s not running, we can start it by running following command,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo service nginx start
</span></code></pre></td></tr></table></div></figure>


<h2>Install Unicorn</h2>

<p>Now we need to install unicorn if you haven&rsquo;t done so.</p>

<p>Add <code>gem 'unicorn'</code> in your <strong>Gemfile</strong> and run <code>bundle install</code>.</p>

<p>And after that you can run <code>unicorn_rails</code> to start it. The default port of unicorn is 8080.</p>

<p>And then create unicorn config file <strong>config/unicorn.rb</strong> which has following contents,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">working_directory</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;../..&quot;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'><span class="n">worker_processes</span> <span class="mi">5</span>
</span><span class='line'><span class="n">listen</span> <span class="s2">&quot;/tmp/unicorn.sock&quot;</span>
</span><span class='line'><span class="n">timeout</span> <span class="mi">30</span>
</span><span class='line'><span class="n">pid</span> <span class="s2">&quot;/tmp/unicorn_xhoppe.pid&quot;</span>
</span><span class='line'><span class="n">stdout_path</span> <span class="s2">&quot;/data/xhoppe/log/unicorn.log&quot;</span>
</span><span class='line'><span class="n">stderr_path</span> <span class="s2">&quot;/data/xhoppe/log/unicorn.log&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we set worker_processes to 5, and in the server our application will be at <strong>/data/xhoppe</strong>. And the stdout_path and stderr_path are set to <strong>/data/xhoppe/log/unicorn.log</strong>.</p>

<h2>Install Postgresql</h2>

<p>Now let&rsquo;s install Postgresql.</p>

<p>I want to install Postgresql 9.3 but the Postgresql version in default repository is 9.1. So we install Postgresql 9.3 by typing following commands, <a href="http://wiki.postgresql.org/wiki/Apt">refer here</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install wget ca-certificates
</span><span class='line'>wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get upgrade
</span><span class='line'>sudo apt-get install postgresql-9.3 pgadmin3 libpq-dev
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s create a Postgresql role, open psql by running <code>sudo su -c psql postgres</code> and type following commands,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>create role xhoppe with password 'xhoppe_secret';
</span><span class='line'>alter role xhoppe createdb;
</span><span class='line'>alter role xhoppe WITH LOGIN;</span></code></pre></td></tr></table></div></figure>


<h2>Nginx config file</h2>

<p>And then update the <strong>/etc/nginx/sites-enabled/default</strong> file,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>upstream unicorn {
</span><span class='line'> server unix:/tmp/unicorn.sock fail_timeout=0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>server {
</span><span class='line'>  listen 80 default_server;
</span><span class='line'>
</span><span class='line'>  root /data/xhoppe/public;
</span><span class='line'>
</span><span class='line'>  error_page 404 /data/xhoppe/public/404.html;
</span><span class='line'>  error_page 500 502 503 504 /data/xhoppe/public/500.html;
</span><span class='line'>
</span><span class='line'>  location / {
</span><span class='line'>    try_files $uri/index.html $uri @unicorn;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  location @unicorn {
</span><span class='line'>    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class='line'>    proxy_set_header Host $http_host;
</span><span class='line'>    proxy_redirect off;
</span><span class='line'>    proxy_pass http://unicorn;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>The upstream unicorn matches the <code>listen "/tmp/unicorn.sock"</code> in config/unicorn.rb</p>

<p>After that, we need to run <code>service nginx restart</code> to restart nginx.</p>

<h2>Clone project</h2>

<p>Now we use git clone to clone our project in <strong>/data/xhoppe</strong></p>

<p>First we define a <strong>/data/xhoppe/env.sh</strong> which defines some environments,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>XHOPPE_DATABASE_PASSWORD=secret
</span><span class='line'>export XHOPPE_DATABASE_PASSWORD
</span><span class='line'>
</span><span class='line'>SECRET_KEY_BASE=9a5a0316a...
</span><span class='line'>export SECRET_KEY_BASE</span></code></pre></td></tr></table></div></figure>


<p>The <strong>XHOPPE_DATABASE_PASSWORD</strong> is the production database&rsquo;s password. And the SECRET_KEY_BASE is for rails session, which is generated by running <code>rake secret</code>.</p>

<p>After that we can run <code>source env.sh</code> to set these environment variables.</p>

<h2>Running the project.</h2>

<p>Now we can run the project by running</p>

<p><code>unicorn -c config/unicorn.rb -E production -D</code></p>

<p>Now we can access the website from our browser.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/26/digging-rails-how-rails-initializes-itself-part-2/">Digging Rails : How Rails Initializes Itself Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-26T19:51:23+09:30" pubdate data-updated="true">Aug 26<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/08/26/digging-rails-how-rails-initializes-itself-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In <a href="/blog/2014/08/24/digging-rails-how-rails-initializes-itself/">last post</a> we discussed the initialization process when a Rails application starts. And we disucssed in <em>config/environment.rb</em> it calls <code>Rails.application.initialize!</code> to initialize the application. And in this blog we will have a detailed examination what has been done in this method.</p>

<p>Let&rsquo;s have a look what&rsquo;s in that method,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/application.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Engine</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Initialize the application passing the given group. By default, the</span>
</span><span class='line'>    <span class="c1"># group is :default</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize!</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="ss">:default</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>      <span class="k">raise</span> <span class="s2">&quot;Application has been already initialized.&quot;</span> <span class="k">if</span> <span class="vi">@initialized</span>
</span><span class='line'>      <span class="n">run_initializers</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@initialized</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>      <span class="nb">self</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>we can see that it just calls the <code>run_initializers</code> method, this method is actually an instance method in a module called <em>Rails::Initializable</em>. The <em>Rails::Application</em> has following hirarchy,</p>

<p><img src="/images/initializable.png" width="200" height="250"></p>

<p>At the bottom is our Sample::Application class defined in config/application.rb. Its super class is Rails::Application which inherits from Rails::Engine. And Rails::Engine&rsquo;s parent is Rails::Railtie. The <em>Rails::Railtie</em> includes the module <em>Rails::Initializable</em>. The <code>run_initializers</code> method is defined in that module. The Railtie is to manage the initialization and configuration of each module. In Rails each module such as Active Record, Active Support has its own Railtie class which inherits from <em>Rails::Railtie</em>. After this blog you should understand the main functionality of the Railtie.</p>

<p>Let&rsquo;s have a look at the module <em>Rails::Initializable</em>. This module provides a set of methods to manage the order of initialization.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Initializable</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>      <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="no">ClassMethods</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">run_initializers</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="ss">:default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@ran</span><span class="p">)</span>
</span><span class='line'>      <span class="n">initializers</span><span class="o">.</span><span class="n">tsort_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">initializer</span><span class="o">|</span>
</span><span class='line'>        <span class="n">initializer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">initializer</span><span class="o">.</span><span class="n">belongs_to?</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="vi">@ran</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initializers</span>
</span><span class='line'>      <span class="vi">@initializers</span> <span class="o">||=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">initializers_for</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initializers</span>
</span><span class='line'>        <span class="vi">@initializers</span> <span class="o">||=</span> <span class="no">Collection</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initializers_chain</span>
</span><span class='line'>        <span class="n">initializers</span> <span class="o">=</span> <span class="no">Collection</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>        <span class="nb">ancestors</span><span class="o">.</span><span class="n">reverse_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span>
</span><span class='line'>          <span class="k">next</span> <span class="k">unless</span> <span class="n">klass</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:initializers</span><span class="p">)</span>
</span><span class='line'>          <span class="n">initializers</span> <span class="o">=</span> <span class="n">initializers</span> <span class="o">+</span> <span class="n">klass</span><span class="o">.</span><span class="n">initializers</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">initializers</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initializers_for</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
</span><span class='line'>        <span class="no">Collection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">initializers_chain</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span> <span class="p">})</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initializer</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
</span><span class='line'>        <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;A block must be passed when defining an initializer&quot;</span> <span class="k">unless</span> <span class="n">blk</span>
</span><span class='line'>        <span class="n">opts</span><span class="o">[</span><span class="ss">:after</span><span class="o">]</span> <span class="o">||=</span> <span class="n">initializers</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">name</span> <span class="k">unless</span> <span class="n">initializers</span><span class="o">.</span><span class="n">empty?</span> <span class="o">||</span> <span class="n">initializers</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:before</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">initializers</span> <span class="o">&lt;&lt;</span> <span class="no">Initializer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If a class includes this module, it can call the class method <code>initializer</code> to register a initializer to a class instance variable <code>@initializers</code>. This method accepts three parameters: the name, an option hash which you can define the order of the initializer, and a block, this block accepts one parameter which is normally our <code>Rails.application</code> instance.</p>

<p>Let&rsquo;s check the definition of the <em>Initializer</em> class.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Initializable</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Initializer</span>
</span><span class='line'>      <span class="kp">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:block</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:group</span><span class="o">]</span> <span class="o">||=</span> <span class="ss">:default</span>
</span><span class='line'>        <span class="vi">@name</span><span class="p">,</span> <span class="vi">@context</span><span class="p">,</span> <span class="vi">@options</span><span class="p">,</span> <span class="vi">@block</span> <span class="o">=</span> <span class="nb">name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">block</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">before</span>
</span><span class='line'>        <span class="vi">@options</span><span class="o">[</span><span class="ss">:before</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">after</span>
</span><span class='line'>        <span class="vi">@options</span><span class="o">[</span><span class="ss">:after</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">belongs_to?</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@options</span><span class="o">[</span><span class="ss">:group</span><span class="o">]</span> <span class="o">==</span> <span class="n">group</span> <span class="o">||</span> <span class="vi">@options</span><span class="o">[</span><span class="ss">:group</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:all</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@context</span><span class="o">.</span><span class="n">instance_exec</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">self</span> <span class="k">if</span> <span class="vi">@context</span>
</span><span class='line'>        <span class="no">Initializer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="vi">@options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the <code>initialize</code> method, it accepts a <em>context</em> object, notice that in <em>Rails::Initializable</em>, the <code>initializer</code> class method pass context as nil. But later a initializer could call <code>bind</code> to generate a new initializer with the context bind to an object. So if a class includes Rails::Initializable, its <code>@initializers</code> class instance variable contains a list of <em>initializer templates</em>. And these initializer templates could be instantiated by bind to a context object. And then pay attention that when a class includes <em>Rails::Initializable</em> module, it also has a <code>initializers</code> instance method, this method actually gets all initializer templates from itself and its ancestors and pass itself as the context.</p>

<p>Let&rsquo;s write some classes to verify how <em>Rails::Initializable</em> works. I created a file <em>parent.rb</em> in app/models which has following contents,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/parent.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Parent</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Initializable</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">initializer</span> <span class="s1">&#39;config2&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">config2</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">initializer</span> <span class="s1">&#39;config1&#39;</span><span class="p">,</span> <span class="ss">before</span><span class="p">:</span> <span class="s1">&#39;config2&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">config1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">config2</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;config2 in </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">config1</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;config1 in </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inspect</span>
</span><span class='line'>    <span class="s1">&#39;parent&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This class Parent is a normal class which includes <em>Rails::Initializable</em>. Two initializers are defined: <em>config2</em> and <em>config1</em>. Although we defined <em>config1</em> after <em>config2</em>, but we passed <code>before: 'config2'</code> when initialize <em>config1</em>.</p>

<p>Now let&rsquo;s open a rails console. The Parent should have a class method which returns all initializers. Let&rsquo;s print the names of the initializers.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>andywang@Andys-MacBook-Pro sample$ rails c
</span><span class='line'>Loading development environment (Rails 4.2.0.beta1)
</span><span class='line'>2.0.0-p353 :001 > Parent.initializers.map(&:name)
</span><span class='line'> => ["config2", "config1"]</span></code></pre></td></tr></table></div></figure>


<p>And the initializers in the class act as a template, their instance variable <em>@context</em> is nil. Let&rsquo;s verify that by printing the <em>@context</em> instance variable, we can see they are nil.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :006 >   Parent.initializers.map { |initializer| initializer.instance_variable_get('@context') }
</span><span class='line'> => [nil, nil]</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s create an instance of Parent. We can see that the instance also has an instance method called <em>initializers</em>. Let&rsquo;s print the name,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :008 >   parent = Parent.new
</span><span class='line'> => parent 
</span><span class='line'>2.0.0-p353 :009 > parent.initializers.map(&:name)
</span><span class='line'> => ["config2", "config1"]</span></code></pre></td></tr></table></div></figure>


<p>Just now we said that the initializers in the class are like a template, and for the initializers in the object instance, we can think that the initializers are <em>instantiated</em> by setting the <em>@context</em> instance variable. We can verify that by printing the instance variable of all initializers.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :011 >   parent.initializers.map { |initializer| initializer.instance_variable_get('@context') }
</span><span class='line'> => [parent, parent]</span></code></pre></td></tr></table></div></figure>


<p>We can see that the <em>@context</em> has been set to the <em>parent</em> object.</p>

<p>And if we call the <em>run_initializers</em> method,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :013 >   parent.run_initializers
</span><span class='line'>config1 in Parent
</span><span class='line'>config2 in Parent
</span><span class='line'> => true</span></code></pre></td></tr></table></div></figure>


<p>Notice two things here, first the config1 is executed before the config2. And secondly notice why we can call the <em>config1</em> and <em>config2</em> methods in the initializer block? Because when the initializers are run, the <em>self</em> object in the block is set to the <em>@context</em> instance variable. Since our context object is <em>parent</em>, and <em>config1</em> and <em>config2</em> are instance methods of this object, of course we can call it.</p>

<p>Now let&rsquo;s create a subclass Child1 which inherits from Parent, and in this class it defines another initializer whose name is <em>config_in_child1</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/child1.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Child1</span> <span class="o">&lt;</span> <span class="no">Parent</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">initializer</span> <span class="s1">&#39;config_in_child1&#39;</span><span class="p">,</span> <span class="ss">after</span><span class="p">:</span> <span class="s1">&#39;config2&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;config in child1&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inspect</span>
</span><span class='line'>    <span class="s2">&quot;child1&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s restart our console and try to create an instance of Child1 and call <em>run_initializers</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>andywang@Andys-MacBook-Pro sample$ rails c
</span><span class='line'>Loading development environment (Rails 4.2.0.beta1)
</span><span class='line'>2.0.0-p353 :001 > child1 = Child1.new
</span><span class='line'> => child1 
</span><span class='line'>2.0.0-p353 :002 > child1.run_initializers
</span><span class='line'>config1 in Child1
</span><span class='line'>config2 in Child1
</span><span class='line'>config in child1
</span><span class='line'> => true</span></code></pre></td></tr></table></div></figure>


<p>We can see that when an instance run its initializers, it will run the initializers in its ancestors first, from top to bottom. Here the two initializers <em>config1</em> and <em>config2</em> are executed first, then it&rsquo;s <em>config_in_child1</em> in Child1 class.</p>

<p>Now let&rsquo;s create another class Child2 also has an initializer, similar as Child1.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/child2.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Child2</span> <span class="o">&lt;</span> <span class="no">Parent</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">initializer</span> <span class="s1">&#39;config_in_child2&#39;</span><span class="p">,</span> <span class="ss">after</span><span class="p">:</span> <span class="s1">&#39;config2&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;config in child2&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inspect</span>
</span><span class='line'>    <span class="s2">&quot;child2&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then let&rsquo;s create one <em>App</em> class which combines one instance of Child1 and Child2.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/app.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">App</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Initializable</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="vi">@child1</span> <span class="o">=</span> <span class="no">Child1</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@child2</span> <span class="o">=</span> <span class="no">Child2</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initializers</span>
</span><span class='line'>    <span class="vi">@child1</span><span class="o">.</span><span class="n">initializers</span> <span class="o">+</span> <span class="vi">@child2</span><span class="o">.</span><span class="n">initializers</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This class has two instance variables <em>@child1</em> and <em>@child2</em>, which is an instance of Child1 and Child2 separately. This class also includes <em>Rails::Initializable</em>, but it overrides the <em>initializers</em> method to return the intializers of both <em>@child1</em> and <em>@child2</em>. Now let&rsquo;s open a new rails console, and create one instance of App and call <code>run_initializers</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>andywang@Andys-MacBook-Pro sample$ rails c
</span><span class='line'>Loading development environment (Rails 4.2.0.beta1)
</span><span class='line'>2.0.0-p353 :001 > app = App.new
</span><span class='line'> => #&lt;App:0x007fed06691540 @child1=child1, @child2=child2> 
</span><span class='line'>2.0.0-p353 :002 > app.run_initializers
</span><span class='line'>config1 in Child1
</span><span class='line'>config1 in Child2
</span><span class='line'>config2 in Child1
</span><span class='line'>config2 in Child2
</span><span class='line'>config in child1
</span><span class='line'>config in child2
</span><span class='line'> => true</span></code></pre></td></tr></table></div></figure>


<p>We can see that when we run <code>app.run_initializers</code>, it runs all initializers in @child1 and @child2. And also the order is maintained. All config1 initializers are executed before config2 initializers.</p>

<p>The <em>Rails::Application</em> class also overrides the <em>initializers</em> method like the <em>App</em> class above. It maintains a list of Railties and run the <code>Rails.application.initialize!</code> method is called, it run all Railties&#8217; initializers.</p>

<p>And we could open a rails console to display all initializers and its associated binding context.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :003 > pp Rails.application.initializers.tsort.map {|initializer| [initializer.name, initializer.instance_variable_get("@context").class]}
</span><span class='line'>[[:set_load_path, Coffee::Rails::Engine],
</span><span class='line'> [:set_load_path, Jquery::Rails::Engine],
</span><span class='line'> [:set_load_path, Turbolinks::Engine],
</span><span class='line'> [:set_load_path, WebConsole::Engine],
</span><span class='line'> [:set_load_path, Sample::Application],
</span><span class='line'> [:set_autoload_paths, Coffee::Rails::Engine],
</span><span class='line'> [:set_autoload_paths, Jquery::Rails::Engine],
</span><span class='line'> [:set_autoload_paths, Turbolinks::Engine],
</span><span class='line'> [:set_autoload_paths, WebConsole::Engine],
</span><span class='line'> [:set_autoload_paths, Sample::Application],
</span><span class='line'> [:add_routing_paths, Coffee::Rails::Engine],
</span><span class='line'> [:add_routing_paths, Jquery::Rails::Engine],
</span><span class='line'> ....</span></code></pre></td></tr></table></div></figure>


<p>This is a very long list. Actually by default there is 108 initializers. If you are interested you can check the Rails source code to see which initializer does what. For example, the :set_load_path is to set the $LOAD_PATH global. So each engine has a chance to modify the load path.</p>

<p>So after this blog you should have a general idea what Rails has done when it calls <code>Rails.application.initialize!</code></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/02/26/integrate-web-template-into-rails-4-application/">integrate web template into rails 4 application</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/22/digging-rails-how-rails-finds-your-templates-part-2/">Digging Rails: How Rails finds your templates Part 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/21/how-rails-finds-your-templates-part-1/">Digging Rails: How Rails finds your templates Part 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/16/deploy-rails-application-on-ubuntu-14-dot-04-part-3/">Deploy Rails Application on Ubuntu 14.04 Part 3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/">Deploy Rails Application on Ubuntu 14.04 Part 2</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Andy Wang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'climber2002';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
