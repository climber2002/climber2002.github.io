
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>AprilTouch</title>
  <meta name="author" content="Andy Wang">

  
  <meta name="description" content="Recently I need to call Google Content API to access Google Merchant Center by using Ruby. I googled on the internet but didn&rsquo;t find useful &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://climber2002.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="AprilTouch" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-51109944-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">AprilTouch</a></h1>
  
    <h2>My blog about Ruby and iOS development</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:climber2002.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-me">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/14/calling-google-content-api-for-shopping-by-using-ruby/">Calling Google Content API for Shopping by Using Ruby</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-06-14T19:53:40+09:30" pubdate data-updated="true">Jun 14<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/06/14/calling-google-content-api-for-shopping-by-using-ruby/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I need to call Google Content API to access Google Merchant Center by using Ruby. I googled on the internet but didn&rsquo;t find useful links, and also the google-api-client gem doesn&rsquo;t contain a lot of examples. Thanks David Tzau for his <a href="https://smallmeansbig.wordpress.com/2014/12/06/how-to-call-a-google-api-using-a-service-account-part-2-of-2/">excellent blog</a>, however he uses Python, and in this blog I will show how to call Google Content API by using Ruby.</p>

<h2>Create the Client ID for a Service Account</h2>

<p>In my application I will use Service Account, which means that the application doesn&rsquo;t redirect to the Google login page and asks the user to login, instead the application calls the Content API on behalf of the Service Account. This step is the same as David&rsquo;s blog, so I&rsquo;ll copy &amp; paste here shamelessly.</p>

<p>So let&rsquo;s create a Service Account in Google Developer Console. Go to the <a href="https://console.developers.google.com/">Google Developer Console</a> and navigate to the “Credentials” menu under “API’s and Auth”.  From there click on “Create new Client ID”:</p>

<p><img src="/images/create_service_account_1.jpg"></p>

<p>Select the “Service Account” option:</p>

<p><img src="/images/create_service_account_2.jpg"></p>

<p>As soon as you create the Service Account, the system will generate a Client ID, email address, and a public/private key pair.  The private key is immediately downloaded to your browser.  Save this private key safely somewhere.  There is a password that comes with this private key that you will need later.  The password is “notasecret” and is the same for every private key that is generated.</p>

<p><img src="/images/create_service_account_3.jpg"></p>

<p>You will notice a client ID and email address are also created for the Service Account you just created.  Make note of the email address as you will need this later:</p>

<p><img src="/images/create_service_account_4.jpg"></p>

<h2>Granting Permissions inside Google Merchant Center for the Client ID</h2>

<p>This next step is very important and is not called out very clearly in Google’s documentation and is very easy to miss.   Just because you can digitally sign JWT’s and Google’s authentication server can verify your application is calling on behalf of the Service Account, it doesn’t mean your application can access just any account’s data behind the API whether that be Google Analytics, Google Merchant Center, Adwords, etc.   In this example we are going have our program call the Content API for Shopping to retrieve a product from the corresponding Google Merchant Center account.</p>

<p>Login to the corresponding Google Merchant Center Account and navigate to the “Users” menu under “Settings”.  Enter the Service Account email address here and grant it “Standard” access.</p>

<p><img src="/images/create_service_account_5.jpg"></p>

<h2>Add google-api-client Gem</h2>

<p>To calling Google Content API, we need to add <strong>google-api-client</strong> Gem into our Gemfile.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s2">&quot;google-api-client&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then run <strong>bundle install</strong></p>

<h2>Get Google::APIClient</h2>

<p>To calling Google Content API, we need an <strong>Google::APIClient</strong> instance.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">key</span> <span class="o">=</span> <span class="ss">Google</span><span class="p">:</span><span class="ss">:APIClient</span><span class="o">::</span><span class="no">PKCS12</span><span class="o">.</span><span class="n">load_key</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/config/content_api.p12&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;notasecret&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">asserter</span> <span class="o">=</span> <span class="ss">Google</span><span class="p">:</span><span class="ss">:APIClient</span><span class="o">::</span><span class="no">JWTAsserter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;GOOGLE_CONTENT_API_CLIENT_ID&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;https://www.googleapis.com/auth/content&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="ss">Google</span><span class="p">:</span><span class="ss">:APIClient</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span><span class='line'>  <span class="ss">:application_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Your App&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:application_version</span> <span class="o">=&gt;</span> <span class="s1">&#39;1.0.0&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">client</span><span class="o">.</span><span class="n">authorization</span> <span class="o">=</span> <span class="n">asserter</span><span class="o">.</span><span class="n">authorize</span>
</span><span class='line'><span class="n">content</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">discovered_api</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;v2&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remember the private key file we downloaded when we create the Service Account? I saved the file in #{Rails.root}/config with file name <em>content_api.p12</em> (<strong>If your repository is an open source repository, you should not put this file in your repository as it&rsquo;s very sensitive</strong>).</p>

<p>On line 1, it load the key from the content_api.p12, and on line 3 it creates an asserter instance. The ENV[&lsquo;GOOGLE_CONTENT_API_CLIENT_ID&rsquo;] is the Client ID as indicated in the following snapshot. Also you should not put this information in your repository if your repository is public. For my project I put it in a yml file and when the application loads, it will set the key/value in the yml file as environment variables.</p>

<p><img src="/images/client_id.png"></p>

<p>On line 6 it creates a <strong>Google::APIClient</strong> instance, and on line 9 it sets the authorization.</p>

<p>On line 10, it calls <em>client.discovered_api</em> to get the content api, we will use this object to dictate which api we will call when we call the api, as will show in following sections.</p>

<h2>Calling Content API</h2>

<h3>Request</h3>

<p>To call Google Content API, normally we would call the <strong>Google::APIClient#execute</strong> method. This method accepts a Hash parameter, and the Hash normally contains the following options,</p>

<h4><strong>:api_method</strong></h4>

<p>The <strong>:api_method</strong> indicates which API we would like to call. Normally we set this option by calling the <em>content</em> object we got above. To know which API to call, take a look at the <a href="https://developers.google.com/shopping-content/v2">Google Content API reference</a>.</p>

<p>For example, to call the <strong>Accounts: insert</strong> API, as the figure below, we should set <strong>:api_method</strong> to <strong>content.accounts.insert</strong></p>

<p><img src="/images/client_api.png"></p>

<h4><strong>:parameters</strong></h4>

<p>The <strong>parameters</strong> should be a hash, it indicates the path parameters in the request URL, for example, the <strong>Accounts: insert</strong> API expects a <em>merchantId</em> param, so to call this API, it should set the parameters to { :merchantId => merchant_id }. Notice that the parameter key is camel case, which doesn&rsquo;t conform to Ruby convention.</p>

<h4><strong>:body_object</strong></h4>

<p>If the API contains a body, we should put the body in the <strong>:body_object</strong> option. The <strong>:body_object</strong> should be a Hash, what it contains depends on the specific API.</p>

<p>For example, to create an Account with name &lsquo;my_account&rsquo;, we should set the :body_object as a hash like this,</p>

<p>:body_object => { :name => &lsquo;my_account&rsquo; }</p>

<h3>Response</h3>

<p>When call the <strong>execute</strong> method, it returns us a response, we should call <strong>response.data?</strong> to check if the response contains any data. And if the API is failed, we can check response.data[&lsquo;error&rsquo;]. If the API calling is successful, we can check the documentation to see what the response data contains.For example, for Accounts Insert, if successful it will returns a <a href="https://developers.google.com/shopping-content/v2/reference/v2/accounts#resource">Accounts resource</a>, so we can call <strong>response.data[&lsquo;id&rsquo;]</strong> to get the ID of the created Account.</p>

<h2>Examples</h2>

<p>Now we give some examples as following. In the examples, the client is a <strong>Google::APIClient</strong> instance. Normally you should wrap this <em>client</em> instance in a class, and make the methods as instance methods of the class.</p>

<h3>Create Merchant Center sub-Account</h3>

<p>To create a sub-Account, and also give an email as the admin, we will call the following API,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create_merchant_center_account</span><span class="p">(</span><span class="n">parent_merchant_id</span><span class="p">,</span> <span class="n">account_name</span><span class="p">,</span> <span class="n">admin_email</span><span class="p">)</span>
</span><span class='line'>  <span class="n">client</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="ss">:api_method</span> <span class="o">=&gt;</span> <span class="n">content</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">insert</span><span class="p">,</span> <span class="ss">:parameters</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:merchantId</span> <span class="o">=&gt;</span> <span class="n">parent_merchant_id</span> <span class="p">},</span>
</span><span class='line'>    <span class="ss">:body_object</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">account_name</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:users</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="p">{</span> <span class="ss">:emailAddress</span> <span class="o">=&gt;</span> <span class="n">admin_email</span><span class="p">,</span> <span class="ss">:admin</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span><span class="o">]</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This method will create a new sub-Account under the parent_merchant_id, and set the admin_email as the admin of the created sub-Account.</p>

<h3>Delete sub-Account</h3>

<p>To delete a sub-Account, call the method like following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">delete_merchant_center_account</span><span class="p">(</span><span class="n">parent_merchant_id</span><span class="p">,</span> <span class="n">account_id</span><span class="p">)</span>
</span><span class='line'>  <span class="n">client</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="ss">:api_method</span> <span class="o">=&gt;</span> <span class="n">content</span><span class="o">.</span><span class="n">accounts</span><span class="o">.</span><span class="n">delete</span><span class="p">,</span> <span class="ss">:parameters</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:merchantId</span> <span class="o">=&gt;</span> <span class="n">parent_merchant_id</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">accountId</span><span class="p">:</span> <span class="n">account_id</span> <span class="p">})</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It will delete the sub-Account whose ID is account_id from the parent_merchant_id.</p>

<h3>Create a feed</h3>

<p>To create a feed, call the API like following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create_merchant_center_feed</span><span class="p">(</span><span class="n">merchant_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</span><span class='line'>  <span class="n">client</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="ss">:api_method</span> <span class="o">=&gt;</span> <span class="n">content</span><span class="o">.</span><span class="n">datafeeds</span><span class="o">.</span><span class="n">insert</span><span class="p">,</span> <span class="ss">:parameters</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:merchantId</span> <span class="o">=&gt;</span>   <span class="n">merchant_id</span> <span class="p">},</span>
</span><span class='line'>    <span class="ss">:body_object</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:contentLanguage</span> <span class="o">=&gt;</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="ss">:contentType</span> <span class="o">=&gt;</span> <span class="s1">&#39;products&#39;</span><span class="p">,</span> <span class="ss">:fileName</span> <span class="o">=&gt;</span> <span class="n">filename</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:attributeLanguage</span> <span class="o">=&gt;</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">filename</span><span class="p">,</span> <span class="ss">:targetCountry</span> <span class="o">=&gt;</span> <span class="s1">&#39;AU&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:fetchSchedule</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:fetchUrl</span> <span class="o">=&gt;</span> <span class="n">url</span><span class="p">,</span> <span class="ss">:hour</span> <span class="o">=&gt;</span> <span class="mi">8</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above method will create a feed which targets Australia and the language is english. And we set the fetch schedule as 8am of the day.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/06/digging-rails-how-rails-finds-your-templates-part-4/">Digging Rails: How Rails Finds Your Templates Part 4</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-06T19:08:37+09:30" pubdate data-updated="true">Apr 6<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/04/06/digging-rails-how-rails-finds-your-templates-part-4/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this part we will continue our exploration of how Rails finds your templates. If you need a refresh, here is <a href="http://climber2002.github.io/blog/2015/02/21/how-rails-finds-your-templates-part-1/">Part1</a>, <a href="http://climber2002.github.io/blog/2015/02/22/digging-rails-how-rails-finds-your-templates-part-2/">Part 2</a> and <a href="http://climber2002.github.io/blog/2015/03/22/digging-rails-how-rails-finds-your-templates-part-3/">Part 3</a>.</p>

<p>In <a href="http://climber2002.github.io/blog/2015/03/22/digging-rails-how-rails-finds-your-templates-part-3/">last part</a> we saw that <strong>ActionView::LookupContext#find_template</strong> is just a delegation to <strong>ActionView::PathSet#find</strong>. So let&rsquo;s check what <strong>ActionView::PathSet#find</strong> is doing.</p>

<h2>ActionView::PathSet</h2>

<p>From the class name of <strong>PathSet</strong> we can get an idea that this class is to manage a set of pathes, where the templates are stored. Let&rsquo;s have a look at the definition of this class.</p>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/path_set.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>  <span class="c1"># = Action View PathSet</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># This class is used to store and access paths in Action View. A number of</span>
</span><span class='line'>  <span class="c1"># operations are defined so that you can search among the paths in this</span>
</span><span class='line'>  <span class="c1"># set and also perform operations on other +PathSet+ objects.</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># A +LookupContext+ will use a +PathSet+ to store the paths in its context.</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">PathSet</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Enumerable</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">attr_reader</span> <span class="ss">:paths</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">delegate</span> <span class="ss">:[]</span><span class="p">,</span> <span class="ss">:include?</span><span class="p">,</span> <span class="ss">:pop</span><span class="p">,</span> <span class="ss">:size</span><span class="p">,</span> <span class="ss">:each</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:paths</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">paths</span> <span class="o">=</span> <span class="o">[]</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@paths</span> <span class="o">=</span> <span class="n">typecast</span> <span class="n">paths</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="n">find_all</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">first</span> <span class="o">||</span> <span class="k">raise</span><span class="p">(</span><span class="no">MissingTemplate</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">find_all</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prefixes</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="n">prefixes</span> <span class="o">=</span> <span class="o">[</span><span class="n">prefixes</span><span class="o">]</span> <span class="k">if</span> <span class="nb">String</span> <span class="o">===</span> <span class="n">prefixes</span>
</span><span class='line'>      <span class="n">prefixes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prefix</span><span class="o">|</span>
</span><span class='line'>        <span class="n">paths</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">resolver</span><span class="o">|</span>
</span><span class='line'>          <span class="n">templates</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">templates</span> <span class="k">unless</span> <span class="n">templates</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="o">[]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">exists?</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="n">find_all</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">typecast</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span class='line'>      <span class="n">paths</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">path</span>
</span><span class='line'>        <span class="k">when</span> <span class="no">Pathname</span><span class="p">,</span> <span class="nb">String</span>
</span><span class='line'>          <span class="no">OptimizedFileSystemResolver</span><span class="o">.</span><span class="n">new</span> <span class="n">path</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">path</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>We can see that the <strong>initialize</strong> method accepts a <em>paths</em> param, which is normally an array of strings. And in <strong>initialize</strong> method, it will call the typecast the <em>paths</em> and then store the typecasted value in <em>@paths</em> instance variable</li>
<li>for each element in the <em>paths</em>, the <strong>typecast</strong> method will convert it to an <strong>OptimizedFileSystemResolver</strong> instance.</li>
<li>The <strong>find_all</strong> method will interate each resolver instance in <em>paths</em> and return the first value which is not empty</li>
<li>The <strong>find</strong> method just delegates to <strong>find_all</strong> method, if it can&rsquo;t find a template, it will raise <em>MissingTemplate</em> exception.</li>
</ul>


<p>In <strong>LookupContext</strong> class, we can see how the <strong>ActionView::PathSet</strong> instance is created.</p>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/lookup_context.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">LookupContext</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Helpers related to template lookup using the lookup context information.</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">ViewPaths</span>
</span><span class='line'>      <span class="kp">attr_reader</span> <span class="ss">:view_paths</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Whenever setting view paths, makes a copy so that we can manipulate them in</span>
</span><span class='line'>      <span class="c1"># instance objects as we wish.</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">view_paths</span><span class="o">=</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@view_paths</span> <span class="o">=</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:PathSet</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">Array</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">include</span> <span class="no">ViewPaths</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <strong>view_paths=</strong> method is defind in module <strong>ActionView::LookupContext::ViewPaths</strong> and <strong>ActionView::LookupContext</strong> includes this module. We can see that the when calling <strong>view_paths=</strong> method, an instance of <strong>ActionView::PathSet</strong> will be created and set to the <strong>@view_paths</strong> instance variable of <strong>ActionView::LookupContext</strong>.</p>

<p>So how this <strong>view_paths=</strong> method is called? It&rsquo;s in <strong>ActionView::LookupContext#initialize</strong> method.</p>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/lookup_context.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">LookupContext</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">view_paths</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">prefixes</span> <span class="o">=</span> <span class="o">[]</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@details</span><span class="p">,</span> <span class="vi">@details_key</span> <span class="o">=</span> <span class="p">{},</span> <span class="kp">nil</span>
</span><span class='line'>      <span class="vi">@skip_default_locale</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>      <span class="vi">@cache</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>      <span class="vi">@prefixes</span> <span class="o">=</span> <span class="n">prefixes</span>
</span><span class='line'>      <span class="vi">@rendered_format</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">view_paths</span> <span class="o">=</span> <span class="n">view_paths</span>
</span><span class='line'>      <span class="n">initialize_details</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the <strong>view_paths</strong> is passed to <strong>ActionView::LookupContext</strong> instances in <strong>initialize</strong>. And in <strong>ActionView::ViewPaths</strong> it initializes <strong>ActionView::LookupContext</strong>.</p>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/view_paths.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ViewPaths</span>
</span><span class='line'>    <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">class_attribute</span> <span class="ss">:_view_paths</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">_view_paths</span> <span class="o">=</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:PathSet</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">_view_paths</span><span class="o">.</span><span class="n">freeze</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># LookupContext is the object responsible to hold all information required to lookup</span>
</span><span class='line'>    <span class="c1"># templates, i.e. view paths and details. Check ActionView::LookupContext for more</span>
</span><span class='line'>    <span class="c1"># information.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">lookup_context</span>
</span><span class='line'>      <span class="vi">@_lookup_context</span> <span class="o">||=</span>
</span><span class='line'>        <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:LookupContext</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">_view_paths</span><span class="p">,</span> <span class="n">details_for_lookup</span><span class="p">,</span> <span class="n">_prefixes</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">append_view_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>      <span class="n">lookup_context</span><span class="o">.</span><span class="n">view_paths</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">prepend_view_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>      <span class="n">lookup_context</span><span class="o">.</span><span class="n">view_paths</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="c1"># Append a path to the list of view paths for this controller.</span>
</span><span class='line'>      <span class="c1">#</span>
</span><span class='line'>      <span class="c1"># ==== Parameters</span>
</span><span class='line'>      <span class="c1"># * &lt;tt&gt;path&lt;/tt&gt; - If a String is provided, it gets converted into</span>
</span><span class='line'>      <span class="c1">#   the default view path. You may also provide a custom view path</span>
</span><span class='line'>      <span class="c1">#   (see ActionView::PathSet for more information)</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">append_view_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">_view_paths</span> <span class="o">=</span> <span class="n">view_paths</span> <span class="o">+</span> <span class="nb">Array</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Prepend a path to the list of view paths for this controller.</span>
</span><span class='line'>      <span class="c1">#</span>
</span><span class='line'>      <span class="c1"># ==== Parameters</span>
</span><span class='line'>      <span class="c1"># * &lt;tt&gt;path&lt;/tt&gt; - If a String is provided, it gets converted into</span>
</span><span class='line'>      <span class="c1">#   the default view path. You may also provide a custom view path</span>
</span><span class='line'>      <span class="c1">#   (see ActionView::PathSet for more information)</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">prepend_view_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">_view_paths</span> <span class="o">=</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:PathSet</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">Array</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="n">view_paths</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># A list of all of the default view paths for this controller.</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">view_paths</span>
</span><span class='line'>        <span class="n">_view_paths</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This <strong>ActionView::ViewPaths</strong> will be included in a controller class. We can see that by default the <em>view_paths</em> is an empty array. But it provides <em>append_view_path</em> and <em>prepend_view_path</em> to add a view path at the end or the front of view paths. Notice that the <strong>prepend_view_path</strong> and <strong>append_view_path</strong> are defined both as class methods and instance methods.</p>

<p>So how the view path is initialized? Actually it&rsquo;s in <strong>Rails::Engine</strong> class.</p>

<figure class='code'><figcaption><span>rails/railties/lib/rails/engine.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Engine</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">initializer</span> <span class="ss">:add_view_paths</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">views</span> <span class="o">=</span> <span class="n">paths</span><span class="o">[</span><span class="s2">&quot;app/views&quot;</span><span class="o">].</span><span class="n">existent</span>
</span><span class='line'>      <span class="k">unless</span> <span class="n">views</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>        <span class="no">ActiveSupport</span><span class="o">.</span><span class="n">on_load</span><span class="p">(</span><span class="ss">:action_controller</span><span class="p">){</span> <span class="n">prepend_view_path</span><span class="p">(</span><span class="n">views</span><span class="p">)</span> <span class="k">if</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="ss">:prepend_view_path</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>        <span class="no">ActiveSupport</span><span class="o">.</span><span class="n">on_load</span><span class="p">(</span><span class="ss">:action_mailer</span><span class="p">){</span> <span class="n">prepend_view_path</span><span class="p">(</span><span class="n">views</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>a initializer defines a code block which will be called during application startup. So when load :action_controller it will call <strong>prepend_view_path</strong> and the view_paths contains only one element, which is the <strong>app/views</strong> folder in your rails application.</p>

<h1>OptimizedFileSystemResolver</h1>

<p><img class="left" src="/images/resolver.png" width="300" height="500"></p>

<p>Now understand how <strong>ActionView::PathSet</strong> is initialized, and we also know that in <em>find</em> method it actually delegates to the resolver. So let&rsquo;s see how the resolver implements the method.</p>

<p>The Resolver is to resolve a template when passing the details. The class relationship is as the above diagram,</p>

<p>We can see that by default the resolver used in <strong>ActionView::PathSet</strong>, which is <strong>ActionView::OptimizedFileSystemResolver</strong>, extends from <strong>ActionView::FileSystemResolver</strong>, which in terms extends from <strong>ActionView::PathResolver</strong>, which extends from <strong>ActionView::Resolver</strong>, which is the base class for all resolvers.</p>

<p>The base class <strong>ActionView::Resolver</strong> provides some common functionalities such as caching for all sub-class resolvers. However here I will focus on <strong>ActionView::PathResolver</strong>, which implements the logic how to find a template in a path.</p>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/template/resolver.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">PathResolver</span> <span class="o">&lt;</span> <span class="no">Resolver</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">EXTENSIONS</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:locale</span> <span class="o">=&gt;</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="ss">:formats</span> <span class="o">=&gt;</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="ss">:variants</span> <span class="o">=&gt;</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="ss">:handlers</span> <span class="o">=&gt;</span> <span class="s2">&quot;.&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="no">DEFAULT_PATTERN</span> <span class="o">=</span> <span class="s2">&quot;:prefix/:action{.:locale,}{.:formats,}{+:variants,}{.:handlers,}&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@pattern</span> <span class="o">=</span> <span class="n">pattern</span> <span class="o">||</span> <span class="no">DEFAULT_PATTERN</span>
</span><span class='line'>      <span class="k">super</span><span class="p">()</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">find_templates</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">partial</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
</span><span class='line'>      <span class="n">path</span> <span class="o">=</span> <span class="no">Path</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">partial</span><span class="p">)</span>
</span><span class='line'>      <span class="n">query</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">details</span><span class="o">[</span><span class="ss">:formats</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">formats</span><span class="p">)</span>
</span><span class='line'>      <span class="n">query</span> <span class="o">=</span> <span class="n">build_query</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">template_paths</span> <span class="o">=</span> <span class="n">find_template_paths</span> <span class="n">query</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">template_paths</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">template</span><span class="o">|</span>
</span><span class='line'>        <span class="n">handler</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">variant</span> <span class="o">=</span> <span class="n">extract_handler_and_format_and_variant</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">formats</span><span class="p">)</span>
</span><span class='line'>        <span class="n">contents</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">binread</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="no">Template</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">template</span><span class="p">),</span> <span class="n">handler</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:virtual_path</span> <span class="o">=&gt;</span> <span class="n">path</span><span class="o">.</span><span class="n">virtual</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:format</span>       <span class="o">=&gt;</span> <span class="nb">format</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:variant</span>      <span class="o">=&gt;</span> <span class="n">variant</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:updated_at</span>   <span class="o">=&gt;</span> <span class="n">mtime</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">find_template_paths</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span class='line'>      <span class="no">Dir</span><span class="o">[</span><span class="n">query</span><span class="o">].</span><span class="n">reject</span> <span class="p">{</span> <span class="o">|</span><span class="n">filename</span><span class="o">|</span>
</span><span class='line'>        <span class="no">File</span><span class="o">.</span><span class="n">directory?</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>          <span class="c1"># deals with case-insensitive file systems.</span>
</span><span class='line'>          <span class="o">!</span><span class="no">File</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="ss">File</span><span class="p">:</span><span class="ss">:FNM_EXTGLOB</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Helper for building query glob string based on resolver&#39;s pattern.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">build_query</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
</span><span class='line'>      <span class="n">query</span> <span class="o">=</span> <span class="vi">@pattern</span><span class="o">.</span><span class="n">dup</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">prefix</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s2">&quot;&quot;</span> <span class="p">:</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">escape_entry</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span><span class="si">}</span><span class="se">\\</span><span class="s2">1&quot;</span>
</span><span class='line'>      <span class="n">query</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/\:prefix(\/)?/</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">partial</span> <span class="o">=</span> <span class="n">escape_entry</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">partial?</span> <span class="p">?</span> <span class="s2">&quot;_</span><span class="si">#{</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">:</span> <span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>      <span class="n">query</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/\:action/</span><span class="p">,</span> <span class="n">partial</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">details</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">ext</span><span class="p">,</span> <span class="n">variants</span><span class="o">|</span>
</span><span class='line'>        <span class="n">query</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/\:</span><span class="si">#{</span><span class="n">ext</span><span class="si">}</span><span class="sr">/</span><span class="p">,</span> <span class="s2">&quot;{</span><span class="si">#{</span><span class="n">variants</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">uniq</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">}&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="vi">@path</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">escape_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</span><span class='line'>      <span class="n">entry</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/[*?{}\[\]]/</span><span class="p">,</span> <span class="s1">&#39;\\\\\\&amp;&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The most important methods are <strong>build_query</strong> and <strong>find_template_paths</strong>.</p>

<ul>
<li>The <strong>PathResolver</strong> will use a pattern to search templates in path, and by default the pattern is DEFAULT_PATTERN</li>
<li><strong>build_query</strong>: This method is to build a query from the path and details. Remember in <a href="http://climber2002.github.io/blog/2015/03/22/digging-rails-how-rails-finds-your-templates-part-3/">last part</a>, <strong>ActionView::AbstractRenderer#extract_details</strong> will extract details from options. For example, for an index action in Articles controller, the query will be</li>
</ul>


<p><strong>articles/index{.en,}{.html,}{+:variants,}{.haml,}</strong></p>

<p>For this query, in <strong>find_template_paths</strong> it will call <strong>Dir[query]</strong>, which is actually an alias to glob which is to expand the query. For example, for the above query, {p, q} matchs either p, or q. So for example for <em>{.en,}</em> it could either match .en or an empty string. So if we define a template <strong>articles/index.html.haml</strong>, it will match the query. For more information, consult <a href="http://ruby-doc.org/core-2.2.0/Dir.html#method-c-glob">Ruby doc</a>.</p>

<p>So for each matched template, in <strong>query</strong> method it will create a <strong>Template</strong> to wrap the template file.</p>

<h2>Summary</h2>

<p>So in summary here we can see that the flow for Rails to find a template is as following,</p>

<ol>
<li>Rails initializes a set of Paths for resolve templates, by default it contains only one path <em>app/views</em></li>
<li>When an action of a controller is accessed, the render will be called either explicitly or implicitly.</li>
<li>Rails will extract the prefixes, action and some details from the options passed to <em>render</em>,</li>
<li>Rails find the template by search in the path set using a query composed from prefixes, action and details.</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/30/book-review-sql-performance-explained-everything-developers-need-to-know-about-sql-performance/">Book Review: SQL Performance Explained Everything Developers Need to Know About SQL Performance</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-30T21:22:56+10:30" pubdate data-updated="true">Mar 30<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/03/30/book-review-sql-performance-explained-everything-developers-need-to-know-about-sql-performance/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="left" src="/images/SQL_Performance_Explained.jpg" width="300" height="500"></p>

<p>Before I worked in a large company which has its own DBAs. Yes I know SQL,I know Stored Procedures and I think I know something about indexes, but for database performance tuning, we always delegate the task to the DBA. And currently I work in a small company which doesn&rsquo;t have a specific DBA role, so developers have to be DBA (Full Stack right?). So for learning something about database performance tuning, I bought this book. Oh I really love it and I learned so many things in one week!</p>

<p>This book talks about indexes and only one type of indexes: B-Tree. It firstly starts with the basics of index and the WHERE clause. And then proceed to join, clustering, sorting and grouping, and also partial results and modifying data. After reading this book, you should have a firm understanding how indexes work and I&rsquo;m sure that this is needed for every Rails developer. As I totally agree the author&rsquo;s claim, that SQL performance tuning is not just a DBA task but a developer&rsquo;s task, as the performance is related to business logic and only developers understand that. And also we should think performance from design, and it&rsquo;s not an afterthought.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/29/customize-devise-to-support-subdomain-authentication/">Customize Devise to Support Multitenancy Authentication</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-29T21:13:21+10:30" pubdate data-updated="true">Mar 29<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/03/29/customize-devise-to-support-subdomain-authentication/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>PS: There are simpler solutions for Devise multitenancy authentication, such as <a href="http://railscasts.com/episodes/388-multitenancy-with-scopes">RailsCasts</a> and <a href="http://www.sitepoint.com/basecamp-like-subdomains-with-devise/">this blog</a>, but customizing Devise gave me an excuse to explore the source code of Warden and Devise though :).</p>

<p>Last year I read the book <a href="https://leanpub.com/multi-tenancy-rails">Multitenancy with Rails</a> written by Ryan Bigg. In the book when he implements the authentication for the multi-tenancy, he uses <a href="https://github.com/hassox/warden">Warden</a> instead of Devise, cause using Devise will need a lot of customization. And Recently I need to implement this multi-tenancy authentication for a Rails application, and I want to use Devise, so I checked the source code of Warden and Devise and found a way to customize Devise to do it.</p>

<p>In my application, I have two models, <strong>Merchant</strong> and <strong>User</strong>, one user can be the owner of one or more merchant, so they are a has_and_belongs_to_many relationship.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Merchant</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">EXCLUDED_SUBDOMAINS</span> <span class="o">=</span> <span class="sx">%w(admin www administrator admins owner)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">validates_exclusion_of</span> <span class="ss">:subdomain</span><span class="p">,</span> <span class="k">in</span><span class="p">:</span> <span class="no">EXCLUDED_SUBDOMAINS</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">message</span><span class="p">:</span> <span class="s2">&quot;is not allowed. Please choose another subdomain&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">validates_format_of</span> <span class="ss">:subdomain</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="sr">/\A[\w\-]+\Z/i</span><span class="p">,</span> <span class="n">allow_blank</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">message</span><span class="p">:</span> <span class="s2">&quot;is not allowed. Please choose another subdomain.&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:subdomain</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">uniqueness</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mount_uploader</span> <span class="ss">:avatar</span><span class="p">,</span> <span class="no">AvatarUploader</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">before_validation</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">subdomain</span> <span class="o">=</span> <span class="n">subdomain</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">downcase</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">has_and_belongs_to_many</span> <span class="ss">:owners</span><span class="p">,</span> <span class="n">class_name</span><span class="p">:</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">join_table</span><span class="p">:</span> <span class="s1">&#39;merchants_owners&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">owner?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="kp">false</span> <span class="k">unless</span> <span class="n">user</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>    <span class="o">!!</span><span class="n">owners</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each merchant can access its web interface through a subdomain URL. In model <strong>Merchant</strong> there is a unique attribute <strong>subdomain</strong>, this will be used for subdomain. For example, one merchant&rsquo;s subdomain is <em>skywatch</em>, then the URL for this merchant is <a href="http://skywatch.xhop.pe">http://skywatch.xhop.pe</a> . And for the authentication, a user can login this URL only if he is this merchant&rsquo;s owner.</p>

<p>And in <strong>Merchant</strong> class we defined an instance method <strong>owner?</strong> of check if a user is owner of a merchant.</p>

<h2>Subdomain Routes Configuration</h2>

<p>For all controllers related to a merchant, I put the controllers under a module <strong>Merchant</strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">constraints</span><span class="p">(</span><span class="ss">Constraints</span><span class="p">:</span><span class="ss">:SubdomainRequired</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">root</span> <span class="s1">&#39;merchant/dashboard#index&#39;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:merchant_root</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">namespace</span> <span class="ss">:merchant</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">resources</span> <span class="s1">&#39;products&#39;</span>
</span><span class='line'>    <span class="c1"># and other resources</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We set a constraint <strong>Constraints::SubdomainRequired</strong> to match merchant&rsquo;s routes.</p>

<figure class='code'><figcaption><span>lib/constraints/subdomain_required.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Constraints</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">SubdomainRequired</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">matches?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span class='line'>      <span class="n">request</span><span class="o">.</span><span class="n">subdomain</span><span class="o">.</span><span class="n">present?</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">.</span><span class="n">subdomain</span> <span class="o">!=</span> <span class="s2">&quot;www&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So only when the request has a subdomain and the subdomain is not <em>www</em>, then it will match merchants&#8217; routes.</p>

<h2>Warden and Devise</h2>

<p>Warden is a <a href="http://rack.github.io/">Rack</a> middleware which provides authentication for web applications. You can register <em>Strategies</em> in Warden to define how to authenticate a user.</p>

<h3>Strategies</h3>

<p>For example, the following is to add a <strong>:password</strong> strategy in Warden</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Warden</span><span class="p">:</span><span class="ss">:Strategies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:password</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">valid?</span>
</span><span class='line'>    <span class="n">params</span><span class="o">[</span><span class="s1">&#39;username&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="n">params</span><span class="o">[</span><span class="s1">&#39;password&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">authenticate!</span>
</span><span class='line'>    <span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="s1">&#39;username&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="s1">&#39;password&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">u</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="nb">fail</span><span class="o">!</span><span class="p">(</span><span class="s2">&quot;Could not log in&quot;</span><span class="p">)</span> <span class="p">:</span> <span class="n">success!</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>When register a strategy, you should provide a name(<strong>:password</strong> as above), and an object or block, the object should implement two methods,</p>

<ul>
<li><p><strong>valid?</strong>: It’s optional to declare a valid? method, and if you don’t declare it, the strategy will always be run. If you do declare it though, the strategy will only be tried if #valid? evaluates to true. This could be used to check if all necessary parameters are valid in the request</p></li>
<li><p><strong>authenticate!</strong>: This is where the work of actually authenticating the request steps in. Here’s where the logic for authenticating your requests occurs.</p></li>
</ul>


<p>You have a number of request related methods available.</p>

<ul>
<li>request # Rack::Request object</li>
<li>session # The session object for the request</li>
<li>params # The parameters of the request</li>
<li>env # The Rack env object</li>
</ul>


<p>There are also a number of actions you can take in your strategy.</p>

<ul>
<li>halt! # halts cascading of strategies. Makes this one the last one processed</li>
<li>pass # ignore this strategy. It is not required to call this and this is only sugar</li>
<li>success! # Supply success! with a user object to log in a user. Causes a halt!</li>
<li>fail! # Sets the strategy to fail. Causes a halt!</li>
<li>redirect! # redirect to another url. You can supply it with params to be encoded and also options. Causes a halt!</li>
<li>custom! # return a custom rack array to be handed back untouched. Causes a halt!
There’s a couple of misc things to do too:</li>
</ul>


<p>headers # set headers to respond with relevant to the strategy
errors # provides access to an errors object. Here you can put in errors relating to authentication</p>

<p>For more information check <a href="https://github.com/hassox/warden/wiki/Strategies">the Warden documents</a>.</p>

<h3>Scope</h3>

<p>After configuring Strategies in Warden, you can set the strategies to scopes. Warden can use different strategies on different scopes, and the scopes are independent and not interfere each other. For example, you can configure two scopes :user and :admin, some resources are protected in :user scope and other advanced resources are protected in :admin scope. If you authenticated :user scope, it still needs authentication for :admin scope for advanced resources. For more details check <a href="https://github.com/hassox/warden/wiki/Scopes">Warden Wiki</a></p>

<h3>Devise</h3>

<p>Devise depends on Warden, and it registers a Strategy <strong>database_authenticatable</strong> by default,</p>

<figure class='code'><figcaption><span>devise/lib/devise/strategies/database_authenticatable.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Devise</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Strategies</span>
</span><span class='line'>    <span class="c1"># Default strategy for signing in a user, based on their email and password in the database.</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">DatabaseAuthenticatable</span> <span class="o">&lt;</span> <span class="no">Authenticatable</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">authenticate!</span>
</span><span class='line'>        <span class="n">resource</span>  <span class="o">=</span> <span class="n">valid_password?</span> <span class="o">&amp;&amp;</span> <span class="n">mapping</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">find_for_database_authentication</span><span class="p">(</span><span class="n">authentication_hash</span><span class="p">)</span>
</span><span class='line'>        <span class="n">encrypted</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">validate</span><span class="p">(</span><span class="n">resource</span><span class="p">){</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="kp">true</span><span class="p">;</span> <span class="n">resource</span><span class="o">.</span><span class="n">valid_password?</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>          <span class="n">resource</span><span class="o">.</span><span class="n">after_database_authentication</span>
</span><span class='line'>          <span class="n">success!</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mapping</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span> <span class="k">if</span> <span class="o">!</span><span class="n">encrypted</span> <span class="o">&amp;&amp;</span> <span class="no">Devise</span><span class="o">.</span><span class="n">paranoid</span>
</span><span class='line'>        <span class="nb">fail</span><span class="p">(</span><span class="ss">:not_found_in_database</span><span class="p">)</span> <span class="k">unless</span> <span class="n">resource</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="ss">Warden</span><span class="p">:</span><span class="ss">:Strategies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:database_authenticatable</span><span class="p">,</span>
</span><span class='line'><span class="ss">Devise</span><span class="p">:</span><span class="ss">:Strategies</span><span class="o">::</span><span class="no">DatabaseAuthenticatable</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <strong>Devise::Strategies::DatabaseAuthenticatable</strong> extends from <strong>Devise::Strategies::Authentiatable</strong>, which provides some methods for common authenticate behavior. If you are interested you could check Devise&rsquo;s source code. In above code, we can see that firstly it finds the <em>resource</em> from authentication_hash, for our case, the <em>resource</em> will be a <strong>User</strong> instance, and then if validate resource&rsquo;s password successfully, it calls <em>success!</em>, otherwise it calls <em>fail</em>.</p>

<h2>Customize Devise Strategy</h2>

<p>So for our case, we should not only check if the user&rsquo;s username and password are valid, but also we must check if the user is an owner of the merchant.</p>

<p>Let&rsquo;s create class called <strong>Devise::Strategies::DatabaseAuthenticatableForMerchantOwner</strong>, we put this class in <strong>lib</strong> folder,</p>

<figure class='code'><figcaption><span>lib/devise/strategies/database_authenticatable_for_merchant_owner.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Devise</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Strategies</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">class</span> <span class="nc">DatabaseAuthenticatableForMerchantOwner</span> <span class="o">&lt;</span> <span class="no">Authenticatable</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># This code is mostly copied from Devise, but except the authentication of devise</span>
</span><span class='line'>      <span class="c1"># the class includes this module should define a method &#39;custom_validate(resource)&#39; to</span>
</span><span class='line'>      <span class="c1"># provide other validates, for example if the resource is admin, or if th resource is </span>
</span><span class='line'>      <span class="c1"># an owner of a merchant etc..</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">authenticate!</span>
</span><span class='line'>        <span class="n">resource</span>  <span class="o">=</span> <span class="n">valid_password?</span> <span class="o">&amp;&amp;</span> <span class="n">mapping</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">find_for_database_authentication</span><span class="p">(</span><span class="n">authentication_hash</span><span class="p">)</span>
</span><span class='line'>        <span class="n">encrypted</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">validate</span><span class="p">(</span><span class="n">resource</span><span class="p">){</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="kp">true</span><span class="p">;</span> <span class="n">resource</span><span class="o">.</span><span class="n">valid_password?</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="p">}</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>          <span class="n">custom_validate</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
</span><span class='line'>            <span class="n">resource</span><span class="o">.</span><span class="n">after_database_authentication</span>
</span><span class='line'>            <span class="n">success!</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">mapping</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span> <span class="k">if</span> <span class="o">!</span><span class="n">encrypted</span> <span class="o">&amp;&amp;</span> <span class="no">Devise</span><span class="o">.</span><span class="n">paranoid</span>
</span><span class='line'>          <span class="nb">fail</span><span class="p">(</span><span class="ss">:not_found_in_database</span><span class="p">)</span>
</span><span class='line'>          <span class="n">halt!</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">custom_validate</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
</span><span class='line'>        <span class="n">merchant</span> <span class="o">=</span> <span class="n">get_merchant</span>
</span><span class='line'>        <span class="k">return</span> <span class="kp">false</span> <span class="k">unless</span> <span class="n">merchant</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>        <span class="n">merchant</span><span class="o">.</span><span class="n">owner?</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">get_merchant</span>
</span><span class='line'>        <span class="no">Merchant</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">subdomain</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">subdomain</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <strong>authenticate!</strong> method is almost copied from <strong>Devise::Strategies::DatabaseAuthenticatable</strong>, however, after <em>validate(resource)</em> it also calls method <strong>custom_validate</strong>, and in <strong>custom_validate</strong> it will get the merchant from the request&rsquo;s subdomain and test if the resource(which is a user) is the merchant&rsquo;s owner.</p>

<p>PS: It&rsquo;s not a good practice to copy devise souce code here, I will update this blog if I find a better way.</p>

<h2>Register our new strategy</h2>

<p>Now we need to register this new strategy. After we installed the Devise gem, it will create a file <strong>config/initializers/devise.rb</strong>, so let&rsquo;s update this file,</p>

<figure class='code'><figcaption><span>lib/devise/strategies/database_authenticatable_for_merchant_owner.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">warden</span> <span class="k">do</span> <span class="o">|</span><span class="n">manager</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;devise/strategies/database_authenticatable_for_merchant_owner&#39;</span>
</span><span class='line'>  <span class="ss">Warden</span><span class="p">:</span><span class="ss">:Strategies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:database_authenticatable_for_merchant_owner</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">Devise</span><span class="p">:</span><span class="ss">:Strategies</span><span class="o">::</span><span class="no">DatabaseAuthenticatableForMerchantOwner</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">manager</span><span class="o">.</span><span class="n">default_strategies</span><span class="p">(</span><span class="ss">:scope</span> <span class="o">=&gt;</span> <span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span> <span class="ss">:database_authenticatable</span>
</span><span class='line'>  <span class="n">manager</span><span class="o">.</span><span class="n">default_strategies</span><span class="p">(</span><span class="ss">:scope</span> <span class="o">=&gt;</span> <span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">push</span> <span class="ss">:database_authenticatable_for_merchant_owner</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we need to require the file explicitly. And then we add the strategy :database_authenticatable_for_merchant_owner.</p>

<p>And in the routes.rb, when we call</p>

<figure class='code'><figcaption><span>config/routes.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">devise_for</span> <span class="ss">:users</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Devise will define a scope <strong>:user</strong> in Warden, and it will add the :database_authenticatable in the default_strategies list. Since we want to use :database_authenticatable_for_merchant_owner strategy, we delete :database_authenticatable and push :database_authenticatable_for_merchant_owner</p>

<p>After this, our application will use :database_authenticatable_for_merchant_owner and support Multitenancy authentication.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/22/digging-rails-how-rails-finds-your-templates-part-3/">Digging Rails: How Rails Finds Your Templates Part 3</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-22T19:37:18+10:30" pubdate data-updated="true">Mar 22<span>nd</span>, 2015</time>
        
         | <a href="/blog/2015/03/22/digging-rails-how-rails-finds-your-templates-part-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Long time no see! In <a href="http://climber2002.github.io/blog/2015/02/22/digging-rails-how-rails-finds-your-templates-part-2/">last part</a> we have shown that the template is rendered through <strong>ActionView::Renderer#render</strong> method, so in this part we will check this class in detail.</p>

<p>Now let&rsquo;s check this class,</p>

<h2>ActionView::Renderer</h2>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/renderer/renderer.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># This is the main entry point for rendering. It basically delegates</span>
</span><span class='line'>  <span class="c1"># to other objects like TemplateRenderer and PartialRenderer which</span>
</span><span class='line'>  <span class="c1"># actually renders the template.</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># The Renderer will parse the options from the +render+ or +render_body+</span>
</span><span class='line'>  <span class="c1"># method and render a partial or a template based on the options. The</span>
</span><span class='line'>  <span class="c1"># +TemplateRenderer+ and +PartialRenderer+ objects are wrappers which do all</span>
</span><span class='line'>  <span class="c1"># the setup and logic necessary to render a view and a new object is created</span>
</span><span class='line'>  <span class="c1"># each time +render+ is called.</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Renderer</span>
</span><span class='line'>    <span class="kp">attr_accessor</span> <span class="ss">:lookup_context</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">lookup_context</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@lookup_context</span> <span class="o">=</span> <span class="n">lookup_context</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Main render entry point shared by AV and AC.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="ss">:partial</span><span class="p">)</span>
</span><span class='line'>        <span class="n">render_partial</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">render_template</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Direct accessor to template rendering.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render_template</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>      <span class="no">TemplateRenderer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@lookup_context</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This class is initialized with a lookup_context, which is of class <strong>ActionView::LookupContext</strong>. And when the <strong>render</strong> method is called, for a normal template, the <em>options</em> has no <em>:partial</em> key, so <strong>render_template</strong> is called. We can see that the <strong>render_template</strong> method is actually creates an instance of <strong>TemplateRenderer</strong> and calls its <strong>render</strong> method.</p>

<p>So let&rsquo;s have a look at this <strong>TemplateRenderer</strong> class,</p>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/renderer/template_renderer.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">TemplateRenderer</span> <span class="o">&lt;</span> <span class="no">AbstractRenderer</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@view</span>    <span class="o">=</span> <span class="n">context</span>
</span><span class='line'>      <span class="vi">@details</span> <span class="o">=</span> <span class="n">extract_details</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">template</span> <span class="o">=</span> <span class="n">determine_template</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">prepend_formats</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">formats</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="vi">@lookup_context</span><span class="o">.</span><span class="n">rendered_format</span> <span class="o">||=</span> <span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">first</span> <span class="o">||</span> <span class="n">formats</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">options</span><span class="o">[</span><span class="ss">:layout</span><span class="o">]</span><span class="p">,</span> <span class="n">options</span><span class="o">[</span><span class="ss">:locals</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Determine the template to be rendered using the given options.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">determine_template</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">keys</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="ss">:locals</span><span class="p">)</span> <span class="p">?</span> <span class="n">options</span><span class="o">[</span><span class="ss">:locals</span><span class="o">].</span><span class="n">keys</span> <span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="ss">:body</span><span class="p">)</span>
</span><span class='line'>        <span class="ss">Template</span><span class="p">:</span><span class="ss">:Text</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:body</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="ss">:text</span><span class="p">)</span>
</span><span class='line'>        <span class="ss">Template</span><span class="p">:</span><span class="ss">:Text</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:text</span><span class="o">]</span><span class="p">,</span> <span class="n">formats</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="ss">:plain</span><span class="p">)</span>
</span><span class='line'>        <span class="ss">Template</span><span class="p">:</span><span class="ss">:Text</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:plain</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="ss">:html</span><span class="p">)</span>
</span><span class='line'>        <span class="ss">Template</span><span class="p">:</span><span class="ss">:HTML</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:html</span><span class="o">]</span><span class="p">,</span> <span class="n">formats</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="ss">:file</span><span class="p">)</span>
</span><span class='line'>        <span class="n">with_fallbacks</span> <span class="p">{</span> <span class="n">find_template</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:file</span><span class="o">]</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="vi">@details</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="ss">:inline</span><span class="p">)</span>
</span><span class='line'>        <span class="n">handler</span> <span class="o">=</span> <span class="no">Template</span><span class="o">.</span><span class="n">handler_for_extension</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;erb&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="no">Template</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:inline</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;inline template&quot;</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="n">keys</span><span class="p">)</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="ss">:template</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:template</span><span class="o">].</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:render</span><span class="p">)</span>
</span><span class='line'>          <span class="n">options</span><span class="o">[</span><span class="ss">:template</span><span class="o">]</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">find_template</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:template</span><span class="o">]</span><span class="p">,</span> <span class="n">options</span><span class="o">[</span><span class="ss">:prefixes</span><span class="o">]</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="vi">@details</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;You invoked render but did not give any of :partial, :template, :inline, :file, :plain, :text or :body option.&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This class extends from <strong>ActionView::AbstractRenderer</strong>, and the template is determined by the <strong>determinate_template</strong> method, we can see that this method checks some keys in <em>options</em> hash, for example <em>:body</em>, <em>:text</em>, etc. And last one it checks the <strong>:template</strong> key. From <a href="http://climber2002.github.io/blog/2015/02/21/how-rails-finds-your-templates-part-1/">Part 1</a> we already knew that if the <strong>:template</strong> key is not set explicitly, the <strong>options[:template]</strong> will be the action name. And <strong>options[:prefixes]</strong> is an array. For example, when the <em>index</em> action of <em>ArticlesController</em> is accessed, the <em>:template</em> and <em>:prefixes</em> will be,</p>

<ul>
<li><strong>:prefixes</strong> : array [“articles”, “application”]</li>
<li><strong>:template</strong> : string “index”</li>
</ul>


<p>So the template is found by calling <strong>find_template</strong> method, and this method is defined in super class <strong>ActionView::AbstractRenderer</strong>, and let&rsquo;s have a look at this class.</p>

<h2>ActionView::AbstractRenderer</h2>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/renderer/abstract_renderer.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">AbstractRenderer</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">delegate</span> <span class="ss">:find_template</span><span class="p">,</span> <span class="ss">:template_exists?</span><span class="p">,</span> <span class="ss">:with_fallbacks</span><span class="p">,</span> <span class="ss">:with_layout_format</span><span class="p">,</span> <span class="ss">:formats</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="ss">:@lookup_context</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">lookup_context</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@lookup_context</span> <span class="o">=</span> <span class="n">lookup_context</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render</span>
</span><span class='line'>      <span class="k">raise</span> <span class="no">NotImplementedError</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">extract_details</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@lookup_context</span><span class="o">.</span><span class="n">registered_details</span><span class="o">.</span><span class="n">each_with_object</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">details</span><span class="o">|</span>
</span><span class='line'>        <span class="n">value</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">details</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that the <strong>find_template</strong> method actually is delegated to <strong>lookup_context</strong>, we will check this method later, but remember that when <strong>find_template</strong> method is called, it is passed a <em>details</em> object, which is returned by the <strong>extract_details</strong> method.</p>

<p>Check the <strong>extract_details</strong> method above, we can see that this method returns a hash. It get the <em>registered_details</em> from the <em>lookup_context</em> and then check if the options contains the key, if yes, the result hush will be the options value for that key(tranformed to an array).</p>

<p>So what&rsquo;s in this <strong>ActionView::LookupContext#registered_details</strong>? Let&rsquo;s check that.</p>

<h2>ActionView::LookupContext#registered_details</h2>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/lookup_context.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># LookupContext is the object responsible to hold all information required to lookup</span>
</span><span class='line'>  <span class="c1"># templates, i.e. view paths and details. The LookupContext is also responsible to</span>
</span><span class='line'>  <span class="c1"># generate a key, given to view paths, used in the resolver cache lookup. Since</span>
</span><span class='line'>  <span class="c1"># this key is generated just once during the request, it speeds up all cache accesses.</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">LookupContext</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mattr_accessor</span> <span class="ss">:registered_details</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">registered_details</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">register_detail</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">registered_details</span> <span class="o">&lt;&lt;</span> <span class="nb">name</span>
</span><span class='line'>      <span class="kp">initialize</span> <span class="o">=</span> <span class="n">registered_details</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;@details[:</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">] = details[:</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">] || default_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">Accessors</span><span class="o">.</span><span class="n">send</span> <span class="ss">:define_method</span><span class="p">,</span> <span class="ss">:&quot;default_</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="ss">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
</span><span class='line'>      <span class="no">Accessors</span><span class="o">.</span><span class="n">module_eval</span> <span class="o">&lt;&lt;-</span><span class="no">METHOD</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">,</span> <span class="bp">__LINE__</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'><span class="sh">        def #{name}</span>
</span><span class='line'><span class="sh">          @details.fetch(:#{name}, [])</span>
</span><span class='line'><span class="sh">        end</span>
</span><span class='line'>
</span><span class='line'><span class="sh">        def #{name}=(value)</span>
</span><span class='line'><span class="sh">          value = value.present? ? Array(value) : default_#{name}</span>
</span><span class='line'><span class="sh">          _set_detail(:#{name}, value) if value != @details[:#{name}]</span>
</span><span class='line'><span class="sh">        end</span>
</span><span class='line'>
</span><span class='line'><span class="sh">        remove_possible_method :initialize_details</span>
</span><span class='line'><span class="sh">        def initialize_details(details)</span>
</span><span class='line'><span class="sh">          #{initialize.join(&quot;\n&quot;)}</span>
</span><span class='line'><span class="sh">        end</span>
</span><span class='line'><span class="no">      METHOD</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Holds accessors for the registered details.</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">Accessors</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">register_detail</span><span class="p">(</span><span class="ss">:locale</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">locales</span> <span class="o">=</span> <span class="o">[</span><span class="no">I18n</span><span class="o">.</span><span class="n">locale</span><span class="o">]</span>
</span><span class='line'>      <span class="n">locales</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="no">I18n</span><span class="o">.</span><span class="n">fallbacks</span><span class="o">[</span><span class="no">I18n</span><span class="o">.</span><span class="n">locale</span><span class="o">]</span><span class="p">)</span> <span class="k">if</span> <span class="no">I18n</span><span class="o">.</span><span class="n">respond_to?</span> <span class="ss">:fallbacks</span>
</span><span class='line'>      <span class="n">locales</span> <span class="o">&lt;&lt;</span> <span class="no">I18n</span><span class="o">.</span><span class="n">default_locale</span>
</span><span class='line'>      <span class="n">locales</span><span class="o">.</span><span class="n">uniq!</span>
</span><span class='line'>      <span class="n">locales</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">register_detail</span><span class="p">(</span><span class="ss">:formats</span><span class="p">)</span> <span class="p">{</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Base</span><span class="o">.</span><span class="n">default_formats</span> <span class="o">||</span> <span class="o">[</span><span class="ss">:html</span><span class="p">,</span> <span class="ss">:text</span><span class="p">,</span> <span class="ss">:js</span><span class="p">,</span> <span class="ss">:css</span><span class="p">,</span>  <span class="ss">:xml</span><span class="p">,</span> <span class="ss">:json</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">register_detail</span><span class="p">(</span><span class="ss">:variants</span><span class="p">)</span> <span class="p">{</span> <span class="o">[]</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">register_detail</span><span class="p">(</span><span class="ss">:handlers</span><span class="p">){</span> <span class="ss">Template</span><span class="p">:</span><span class="ss">:Handlers</span><span class="o">.</span><span class="n">extensions</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that it has a module attribute <strong>registered_details</strong>, which is an array, whose elements is the detail name.</p>

<p>For example, in a rails console we can call <strong>ActionView::LookupContext.registered_details</strong> to see the default detail keys.</p>

<p><img class="left" src="/images/details.png"></p>

<p>We can see that by default it registered 4 details: :locale, :formats, :variants and :handlers, just as in above code, the <strong>register_detail</strong> is called 4 times and passed those details keys one by one.</p>

<p>And also the class maintains an instance variable called <strong>@details</strong> which is a hash. The key of this hash is the detail key, the value normally is an array which is the detail value initialized from <strong>initialize_details</strong>. (We will talk about <strong>initialize_details</strong> later)</p>

<p>Each time the <strong>register_detail</strong> is called, it will add several instance methods to the class. For example, when passed <em>:locale</em> to the method, it will define following methods,</p>

<ul>
<li><strong>default_locale</strong> : returns the default locale which is the result returned from the passed block.</li>
<li><strong>locale</strong>: which returns the locale value stored in instance variable <strong>@details</strong></li>
<li><strong>locale=</strong>: which sets the locale value to <strong>@details</strong>.</li>
</ul>


<p>And also each time the registered_detail is called, the <strong>initialize_details</strong> will be redefined. For example, when firstly calling <strong>register_detail(:locale)</strong>, the <strong>initialize_details</strong> will be like following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">LookupContext</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize_details</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@details</span><span class="o">[</span><span class="ss">:locale</span><span class="o">]</span> <span class="o">=</span> <span class="n">details</span><span class="o">[</span><span class="ss">:locale</span><span class="o">]</span> <span class="o">||</span> <span class="n">default_locale</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then when <strong>register_detail(:formats)</strong> is called, the <strong>initialize_details</strong> will be redefined like following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">LookupContext</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize_details</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@details</span><span class="o">[</span><span class="ss">:locale</span><span class="o">]</span> <span class="o">=</span> <span class="n">details</span><span class="o">[</span><span class="ss">:locale</span><span class="o">]</span> <span class="o">||</span> <span class="n">default_locale</span>
</span><span class='line'>      <span class="vi">@details</span><span class="o">[</span><span class="ss">:formats</span><span class="o">]</span> <span class="o">=</span> <span class="n">details</span><span class="o">[</span><span class="ss">:formats</span><span class="o">]</span> <span class="o">||</span> <span class="n">default_formats</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the <strong>initialize_details</strong> is just to get the details values from <em>details</em> for each registered detail key, if the key is not found, it will set the default detail values.</p>

<h2>ActionView::LookupContext#find_template</h2>

<p>Now let&rsquo;s check the <strong>ActionView::LookupContext#find_template</strong> method.</p>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/lookup_context.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">LookupContext</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">include</span> <span class="no">ViewPaths</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Helpers related to template lookup using the lookup context information.</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">ViewPaths</span>
</span><span class='line'>      <span class="kp">attr_reader</span> <span class="ss">:view_paths</span><span class="p">,</span> <span class="ss">:html_fallback_for_js</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Whenever setting view paths, makes a copy so that we can manipulate them in</span>
</span><span class='line'>      <span class="c1"># instance objects as we wish.</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">view_paths</span><span class="o">=</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@view_paths</span> <span class="o">=</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:PathSet</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">Array</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">prefixes</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span> <span class="n">partial</span> <span class="o">=</span> <span class="kp">false</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>        <span class="vi">@view_paths</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">*</span><span class="n">args_for_lookup</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">,</span> <span class="n">partial</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">options</span><span class="p">))</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="k">alias</span> <span class="ss">:find_template</span> <span class="ss">:find</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">find_all</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">prefixes</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span> <span class="n">partial</span> <span class="o">=</span> <span class="kp">false</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>        <span class="vi">@view_paths</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="o">*</span><span class="n">args_for_lookup</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">,</span> <span class="n">partial</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">options</span><span class="p">))</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">exists?</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">prefixes</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span> <span class="n">partial</span> <span class="o">=</span> <span class="kp">false</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>        <span class="vi">@view_paths</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="o">*</span><span class="n">args_for_lookup</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">,</span> <span class="n">partial</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">options</span><span class="p">))</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="k">alias</span> <span class="ss">:template_exists?</span> <span class="ss">:exists?</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Adds fallbacks to the view paths. Useful in cases when you are rendering</span>
</span><span class='line'>      <span class="c1"># a :file.</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">with_fallbacks</span>
</span><span class='line'>        <span class="n">added_resolvers</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">fallbacks</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">resolver</span><span class="o">|</span>
</span><span class='line'>          <span class="k">next</span> <span class="k">if</span> <span class="n">view_paths</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">resolver</span><span class="p">)</span>
</span><span class='line'>          <span class="n">view_paths</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">resolver</span><span class="p">)</span>
</span><span class='line'>          <span class="n">added_resolvers</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="k">yield</span>
</span><span class='line'>      <span class="k">ensure</span>
</span><span class='line'>        <span class="n">added_resolvers</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">view_paths</span><span class="o">.</span><span class="n">pop</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">args_for_lookup</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">,</span> <span class="n">partial</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">details_options</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>        <span class="nb">name</span><span class="p">,</span> <span class="n">prefixes</span> <span class="o">=</span> <span class="n">normalize_name</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">)</span>
</span><span class='line'>        <span class="n">details</span><span class="p">,</span> <span class="n">details_key</span> <span class="o">=</span> <span class="n">detail_args_for</span><span class="p">(</span><span class="n">details_options</span><span class="p">)</span>
</span><span class='line'>        <span class="o">[</span><span class="nb">name</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">,</span> <span class="n">partial</span> <span class="o">||</span> <span class="kp">false</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">details_key</span><span class="p">,</span> <span class="n">keys</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Compute details hash and key according to user options (e.g. passed from #render).</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">detail_args_for</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="vi">@details</span><span class="p">,</span> <span class="n">details_key</span> <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">empty?</span> <span class="c1"># most common path.</span>
</span><span class='line'>        <span class="n">user_details</span> <span class="o">=</span> <span class="vi">@details</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="vi">@cache</span>
</span><span class='line'>          <span class="n">details_key</span> <span class="o">=</span> <span class="no">DetailsKey</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_details</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">details_key</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">[</span><span class="n">user_details</span><span class="p">,</span> <span class="n">details_key</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Support legacy foo.erb names even though we now ignore .erb</span>
</span><span class='line'>      <span class="c1"># as well as incorrectly putting part of the path in the template</span>
</span><span class='line'>      <span class="c1"># name instead of the prefix.</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">normalize_name</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>        <span class="n">prefixes</span> <span class="o">=</span> <span class="n">prefixes</span><span class="o">.</span><span class="n">presence</span>
</span><span class='line'>        <span class="n">parts</span>    <span class="o">=</span> <span class="nb">name</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">parts</span><span class="o">.</span><span class="n">shift</span> <span class="k">if</span> <span class="n">parts</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>        <span class="nb">name</span>     <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">pop</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nb">name</span><span class="p">,</span> <span class="n">prefixes</span> <span class="o">||</span> <span class="o">[</span><span class="s2">&quot;&quot;</span><span class="o">]</span> <span class="k">if</span> <span class="n">parts</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">parts</span>    <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">prefixes</span> <span class="o">=</span> <span class="n">prefixes</span> <span class="p">?</span> <span class="n">prefixes</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">parts</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span> <span class="p">:</span> <span class="o">[</span><span class="n">parts</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nb">name</span><span class="p">,</span> <span class="n">prefixes</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <strong>find_template</strong> is implemented in module <strong>ActionView::LookupContext::ViewPaths</strong>, and <strong>ActionView::LookupContext</strong> includes this module. We can see that <strong>find_template</strong> is just an alias of method <strong>find</strong>. The <strong>find</strong> method delegats to <em>@view_paths</em>, which is an instance of <strong>ActionView::PathSet</strong>. So we need to understand what <strong>ActionView::PathSet#find</strong> is doing. Actually the <strong>ActionView::PathSet#find</strong> will delegate the <em>find</em> to a set of <strong>PathResolver</strong>, which we will check in next part.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/26/integrate-web-template-into-rails-4-application/">Integrate Web Template Into Rails 4 Application</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-26T23:07:49+10:30" pubdate data-updated="true">Feb 26<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/26/integrate-web-template-into-rails-4-application/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In these days there are many free or paid web templates, especially for bootstrap templates. Recently I integrated a Bootstrap template called <a href="https://wrapbootstrap.com/theme/loop-agency-and-personal-theme-WB053H4T4">Loop</a> which is bought on <a href="https://wrapbootstrap.com/">WrapBootstrap</a>. Here I will explain some practices and caveats about the integration.</p>

<h2>Location</h2>

<p><img class="left" src="/images/loop.png" width="300" height="300"></p>

<p>After extract the template zip file, we can see the organization is like the  structure on the left. This template actually contains two templates, one for personal and one for Agency, and what I want is for the Agency. We can see that it puts all resource files like javascripts, CSS files and fonts file in folder <em>assets</em>. I want to keep this structure, so it would be easier to upgrade if it releases new version. The best practice for put 3rd-party template is to put it in <strong>vendor/assets</strong>, so I create a folder <strong>loop</strong> under <strong>vendor/assets</strong> and and copy the <em>assets</em> folder to <strong>vendor/assets/loop</strong>, like the following figure,</p>

<p><img class="left" src="/images/loop_copied.png" width="300" height="300"></p>

<p>Notice that I changed the <em>assets</em> folder from the original template and named it <strong>loop</strong>, so when we reference the files under it from browser it will create paths like <em>/assets/loop/js/loop.js</em> because rails will append <em>assets</em> before the resource. This is to make the files in this template not collide with other assets.</p>

<h2>Create index file</h2>

<p>If you read my blog <a href="http://climber2002.github.io/blog/2014/08/17/using-index-files-in-rails-4-assets-pipeline/">Using Index Files in Rails 4 Assets Pipeline</a> before, you should know that the index files should be named <strong>loop.css.scss</strong> and <strong>loop.js</strong>, under foler <strong>vendor/assets/loop</strong>.</p>

<p>They have the following contents,</p>

<figure class='code'><figcaption><span>vendor/assets/loop/loop.css.scss </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="c">/*</span>
</span><span class='line'><span class="c"> *= require loop/css/bootstrap</span>
</span><span class='line'><span class="c"> *= require loop/css/font-awesome</span>
</span><span class='line'><span class="c"> *= require loop/css/main</span>
</span><span class='line'><span class="c"> */</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>vendor/assets/loop/loop.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//= require loop/js/jquery-2.1.0</span>
</span><span class='line'><span class="c1">//= require loop/js/bootstrap.js</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/scrollto/jquery.scrollTo-1.4.3.1-min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/scrollto/jquery.localscroll-1.2.7-min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/easing/jquery.easing.min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/google-map/google-map</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/parallax/jquery.parallax-1.1.3</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/jpreloader/jpreloader.min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/isotope/imagesloaded.pkgd</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/isotope/isotope.pkgd.min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/wow/wow</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/flexslider/jquery.flexslider-min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/magnific/jquery.magnific-popup.min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/supersized/supersized.3.2.7.min</span>
</span><span class='line'><span class="c1">//= require loop/js/plugins/supersized/supersized.shutter.min</span>
</span><span class='line'><span class="c1">//= require loop/js/loop.js</span>
</span></code></pre></td></tr></table></div></figure>


<p>Basically the index files include all dependent css and javascripts, but pay atthention that their path should start with <em>loop</em> since we have put all assets in <strong>vendor/assets/loop/loop</strong> folder.</p>

<h2>Update CSS files</h2>

<p>In the template&rsquo;s CSS files, there are reference to images such as background image, like following code,</p>

<figure class='code'><figcaption><span>main.css </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">body</span><span class="nc">.fullscreen-image-background</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">background-image</span><span class="o">:</span> <span class="sx">url(&#39;../img/sliders/slider3.png?1393983498&#39;)</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background</span><span class="o">-</span><span class="k">size</span><span class="o">:</span> <span class="n">cover</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-repeat</span><span class="o">:</span> <span class="k">no-repeat</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-position</span><span class="o">:</span> <span class="k">center</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Such url won&rsquo;t work because Rails will precompile those assets in <em>public/assets</em> folder, so we name this file to <em>main.css.scss</em>, and use <strong>image-url</strong> tag, like following,</p>

<figure class='code'><figcaption><span>main.css </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">body</span><span class="nc">.fullscreen-image-background</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">background-image</span><span class="o">:</span> <span class="n">image</span><span class="o">-</span><span class="sx">url(&#39;loop/img/sliders/slider3.png&#39;)</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background</span><span class="o">-</span><span class="k">size</span><span class="o">:</span> <span class="n">cover</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-repeat</span><span class="o">:</span> <span class="k">no-repeat</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-position</span><span class="o">:</span> <span class="k">center</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Update JS files</h2>

<p>Sometimes the JS files also reference image files, like following code in loop.js,</p>

<figure class='code'><figcaption><span>loop.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">slides</span><span class="o">:</span>   <span class="p">[</span>       <span class="c1">// Slideshow Images</span>
</span><span class='line'>              <span class="p">{</span><span class="nx">image</span> <span class="o">:</span> <span class="s1">&#39;assets/img/sliders/slider1.png&#39;</span><span class="p">,</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;&lt;div class=&quot;hero-text&quot;&gt;&lt;h2 class=&quot;hero-heading&quot;&gt;HANDCRAFTED&lt;/h2&gt;&lt;p&gt;Built to provide great visitor experience&lt;/p&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="nx">thumb</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
</span><span class='line'>              <span class="p">{</span><span class="nx">image</span> <span class="o">:</span> <span class="s1">&#39;assets/img/sliders/slider2.png&#39;</span><span class="p">,</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;&lt;div class=&quot;hero-text&quot;&gt;&lt;h2 class=&quot;hero-heading&quot;&gt;PARALLAX&lt;/h2&gt;&lt;p&gt;Scrolling the page is fun with parallax background&lt;/p&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="nx">thumb</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
</span><span class='line'>              <span class="p">{</span><span class="nx">image</span> <span class="o">:</span> <span class="s1">&#39;assets/img/sliders/slider3.png&#39;</span><span class="p">,</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;&lt;div class=&quot;hero-text&quot;&gt;&lt;h2 class=&quot;hero-heading&quot;&gt;BUY ONE FOR TWO&lt;/h2&gt;&lt;p&gt;Buy one to get both of the agency and personal theme&lt;/p&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="nx">thumb</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>For the same reason, after deploy production the JS files can&rsquo;t find the image files also, in such case we should depend on the asset pipeline and change the file to <strong>loop.js.erb</strong>, and use <strong>image_path</strong>.</p>

<figure class='code'><figcaption><span>loop.js.erb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">slides</span><span class="o">:</span>   <span class="p">[</span>       <span class="c1">// Slideshow Images</span>
</span><span class='line'>              <span class="p">{</span><span class="nx">image</span> <span class="o">:</span> <span class="s1">&#39;&lt;%= image_path &#39;</span><span class="nx">loop</span><span class="o">/</span><span class="nx">img</span><span class="o">/</span><span class="nx">sliders</span><span class="o">/</span><span class="nx">slider1</span><span class="p">.</span><span class="nx">png</span><span class="s1">&#39;%&gt;&#39;</span><span class="p">,</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;&lt;div class=&quot;hero-text&quot;&gt;&lt;h2 class=&quot;hero-heading&quot;&gt;HANDCRAFTED&lt;/h2&gt;&lt;p&gt;Built to provide great visitor experience&lt;/p&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="nx">thumb</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
</span><span class='line'>              <span class="p">{</span><span class="nx">image</span> <span class="o">:</span> <span class="s1">&#39;&lt;%= image_path &#39;</span><span class="nx">loop</span><span class="o">/</span><span class="nx">img</span><span class="o">/</span><span class="nx">sliders</span><span class="o">/</span><span class="nx">slider2</span><span class="p">.</span><span class="nx">png</span><span class="s1">&#39;%&gt;&#39;</span><span class="p">,</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;&lt;div class=&quot;hero-text&quot;&gt;&lt;h2 class=&quot;hero-heading&quot;&gt;PARALLAX&lt;/h2&gt;&lt;p&gt;Scrolling the page is fun with parallax background&lt;/p&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="nx">thumb</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
</span><span class='line'>              <span class="p">{</span><span class="nx">image</span> <span class="o">:</span> <span class="s1">&#39;&lt;%= image_path &#39;</span><span class="nx">loop</span><span class="o">/</span><span class="nx">img</span><span class="o">/</span><span class="nx">sliders</span><span class="o">/</span><span class="nx">slider3</span><span class="p">.</span><span class="nx">png</span><span class="s1">&#39;%&gt;&#39;</span><span class="p">,</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;&lt;div class=&quot;hero-text&quot;&gt;&lt;h2 class=&quot;hero-heading&quot;&gt;BUY ONE FOR TWO&lt;/h2&gt;&lt;p&gt;Buy one to get both of the agency and personal theme&lt;/p&gt;&lt;/div&gt;&#39;</span><span class="p">,</span> <span class="nx">thumb</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also in our erb files, if we want to reference image files we should use <strong>image_path</strong>.</p>

<h2>Precompile configuration</h2>

<p>By default when we run <strong>rake assets:precompile</strong>, Rails won&rsquo;t precompile the assets in vendor. So we need to add the loop template into configuration, in <strong>application.rb</strong>, we update like following,</p>

<figure class='code'><figcaption><span>application.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">precompile</span> <span class="o">+=</span> <span class="sx">%w(loop.css loop.js loop/*)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So it will precompile index files and all assets in <strong>vendor/assets/loop/loop</strong> folder.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/22/digging-rails-how-rails-finds-your-templates-part-2/">Digging Rails: How Rails Finds Your Templates Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-22T21:24:30+10:30" pubdate data-updated="true">Feb 22<span>nd</span>, 2015</time>
        
         | <a href="/blog/2015/02/22/digging-rails-how-rails-finds-your-templates-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In <a href="http://climber2002.github.io/blog/2015/02/21/how-rails-finds-your-templates-part-1/">last part</a> we introduced that when Rails looks for a template, it firstly populate an options hash by calling <strong>_normalize_render</strong>. And then in the <em>render</em> method, it will call <strong>render_to_body</strong> and pass the options, like the following code,</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/abstract_controller/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">AbstractController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize arguments, options and then delegates render_to_body and</span>
</span><span class='line'>    <span class="c1"># sticks the result in self.response_body.</span>
</span><span class='line'>    <span class="c1"># :api: public</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="n">_normalize_render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">response_body</span> <span class="o">=</span> <span class="n">render_to_body</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">_process_format</span><span class="p">(</span><span class="n">rendered_format</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">rendered_format</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">response_body</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <strong>render_to_body</strong> will select the templated based on the values in options hash. If we check the source code of <strong>AbstractController::Rendering#render_to_body</strong>, it&rsquo;s nothing. Just as usual, it&rsquo;s overridden by other modules.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/abstract_controller/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">AbstractController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Performs the actual template rendering.</span>
</span><span class='line'>    <span class="c1"># :api: public</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render_to_body</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just as last part, we could run <em>ApplicationController.ancestors_that_implement_instance_method</em> to find what classes or modules implement that method, and we will find the following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">00</span><span class="mi">8</span> <span class="o">&gt;</span> <span class="no">ApplicationController</span><span class="o">.</span><span class="n">ancestors_that_implement_instance_method</span><span class="p">(</span><span class="ss">:render_to_body</span><span class="p">)</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Renderers</span><span class="p">,</span> <span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Rendering</span><span class="p">,</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Rendering</span><span class="p">,</span> <span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Rendering</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see three modules implement that method: <em>ActionController::Renderers</em>, <em>ActionController::Rendering</em>, and <em>ActionView::Rendering</em>. Let&rsquo;s look at each of them one by one.</p>

<h2>ActionController::Renderers#render_to_body</h2>

<p>For <em>ActionController::Renderers#render_to_body</em> method, it registers a set of renderers, and then if the options contains the renderer key, then it will call that renderer. If no renderer is found, it just call <em>super</em></p>

<figure class='code'><figcaption><span>rails/actionpack/lib/action_controller/metal/renderers.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Renderers</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render_to_body</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">_render_to_body_with_renderer</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="o">||</span> <span class="k">super</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_render_to_body_with_renderer</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">_renderers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>          <span class="n">_process_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>          <span class="n">method_name</span> <span class="o">=</span> <span class="no">Renderers</span><span class="o">.</span><span class="n">_render_with_renderer_method_name</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span> <span class="nb">send</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">name</span><span class="p">),</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="kp">nil</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is mainly for calling <strong>render</strong> and pass parameters like :json, :xml, like the following code,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ArticlesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="vi">@articles</span> <span class="o">=</span> <span class="no">Articles</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="vi">@articles</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since <em>:json</em> is a registered renderer in <em>ActionController::Renderers</em>, it will call that renderer. You can also register your own renderer by calling <strong>ActionController::Renderers.add</strong>.</p>

<h2>ActionController::Rendering#render_to_body</h2>

<p>If in <strong>ActionController::Renderers#render_to_body</strong>, it doesn&rsquo;t find a renderer, then it will call <em>super</em>, which is <strong>ActionController::Rendering#render_to_body</strong>. Let&rsquo;s look at what this module does in the method.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/action_controller/metal/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">RENDER_FORMATS_IN_PRIORITY</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:body</span><span class="p">,</span> <span class="ss">:text</span><span class="p">,</span> <span class="ss">:plain</span><span class="p">,</span> <span class="ss">:html</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render_to_body</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>      <span class="k">super</span> <span class="o">||</span> <span class="n">_render_in_priorities</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39; &#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_render_in_priorities</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="no">RENDER_FORMATS_IN_PRIORITY</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">options</span><span class="o">[</span><span class="nb">format</span><span class="o">]</span> <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="kp">nil</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that this method calls <em>super</em> first, it only call <em>_render_in_priorities</em> if <em>super</em> returns nothing.</p>

<p>In <strong>_render_in_priorities</strong> it searches the RENDER_FORMATS_IN_PRIORITY one by one, and return the option value if it finds the format.</p>

<p>In this module when it calls <em>super</em>, it is calling <strong>ActionView::Rendering#render_to_body</strong> method. Let&rsquo;s have a look.</p>

<h2>ActionView::Rendering#render_to_body</h2>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render_to_body</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>      <span class="n">_process_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">_render_template</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Returns an object that is able to render templates.</span>
</span><span class='line'>    <span class="c1"># :api: private</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">view_renderer</span>
</span><span class='line'>      <span class="vi">@_view_renderer</span> <span class="o">||=</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Renderer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">lookup_context</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Find and render a template based on the options given.</span>
</span><span class='line'>      <span class="c1"># :api: private</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">_render_template</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>        <span class="n">variant</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:variant</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">lookup_context</span><span class="o">.</span><span class="n">rendered_format</span> <span class="o">=</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:formats</span><span class="o">]</span>
</span><span class='line'>        <span class="n">lookup_context</span><span class="o">.</span><span class="n">variants</span> <span class="o">=</span> <span class="n">variant</span> <span class="k">if</span> <span class="n">variant</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">view_renderer</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">view_context</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It turns out that here is the the meat we are looking for. The <strong>render_to_body</strong> calls <strong>_render_template</strong>, and for the <strong>_render_template</strong>, it calls <strong>view_renderer.render(view_context, options)</strong>.</p>

<p>The <em>view_renderer</em> is an instance of <strong>ActionView::Renderer</strong>, and when it&rsquo;s initialized, it&rsquo;s passing a <em>lookup_context</em> object, which is an instance of <strong>ActionView::LookupContext</strong>. The <strong>ActionView::LookupContext</strong> contains all information about looking for a template based on the options. So in next part we will check this class in detail, and check how <strong>LookupContext</strong>, <strong>ViewPaths</strong>, <strong>PathSet</strong> work together to find the template.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/21/how-rails-finds-your-templates-part-1/">Digging Rails: How Rails Finds Your Templates Part 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-21T20:35:52+10:30" pubdate data-updated="true">Feb 21<span>st</span>, 2015</time>
        
         | <a href="/blog/2015/02/21/how-rails-finds-your-templates-part-1/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Have you ever wondered for a Rails application, when you access an action in a controller, how Rails finds the template to render? For example, when the action <em>index</em> in <em>ArticlesController</em> is accessed, by default the template <em>app/views/articles/index.html.erb</em> will be selected and rendered. Recently I&rsquo;m digging the source code of Rails, and I invite you to walk through some source code in ActionPack and ActionView with me. And then I will show how the Rubygem <a href="https://github.com/bwillis/versioncake">versioncake</a> works by modifying the Rails configuration.</p>

<p>In this first part we firstly check how the <strong>render</strong> works. Notice that we check Rails 4.2 source code. If you look at another version, the implementation may be slightly different.</p>

<p>The entry point for the render is from the <strong>AbstractController::Rendering#render</strong> method. The <strong>AbstractController</strong> is a module shared by ActionController and ActionMailer. Since these two modules share a lot of functionalities, Rails extract those same functionalities into <strong>AbstractController</strong>. Let&rsquo;s have a look at this method.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/abstract_controller/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">AbstractController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize arguments, options and then delegates render_to_body and</span>
</span><span class='line'>    <span class="c1"># sticks the result in self.response_body.</span>
</span><span class='line'>    <span class="c1"># :api: public</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="n">_normalize_render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">response_body</span> <span class="o">=</span> <span class="n">render_to_body</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">_process_format</span><span class="p">(</span><span class="n">rendered_format</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">rendered_format</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">response_body</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our controller, we could call <em>render</em> method directly. For example, we can call <em>render &lsquo;new&rsquo;</em> to render the <em>new.html.erb</em> template. Or if we don&rsquo;t call <em>render</em> explicitly, there is a module <strong>ActionController::ImplicitRender</strong> which will call a default render.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/action_controller/metal/implicit_renderer.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionController</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ImplicitRender</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">send_action</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="n">ret</span> <span class="o">=</span> <span class="k">super</span>
</span><span class='line'>      <span class="n">default_render</span> <span class="k">unless</span> <span class="n">performed?</span>
</span><span class='line'>      <span class="n">ret</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">default_render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="n">render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The send_action will be called when the action of a controller is triggered. It first calls super, then if in the action it doesn&rsquo;t render anything, the <em>performed?</em> will return false. So <em>default_render</em> is called. We can see that when call <em>default_render</em> it just calls <em>render</em> without any arguments.</p>

<p>In <strong>AbstractController::Rendering#render</strong> method, it firstly calls <em>_normalize_render</em> then calls <em>render_to_body</em>. The <em>_normalize_render</em> returns an options object which is a Hash. In this part we will examine the <strong>_normalize_render</strong> method to see how the options is generated.</p>

<p>Let&rsquo;s see how <strong>_normalize_render</strong> is implemented.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/abstract_controller/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">AbstractController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize args and options.</span>
</span><span class='line'>    <span class="c1"># :api: private</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="n">_normalize_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="c1">#TODO: remove defined? when we restore AP &lt;=&gt; AV dependency</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">request</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:variant</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">variant</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">_normalize_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We see that it calls <em>_normalize_args</em> and <em>_normalize_options</em> methods. The <em>_normalize_args</em> and <em>_normalize_options</em> have different purposes.</p>

<h3>_normalize_args</h3>

<p>The <strong>_normalize_args</strong> is to convert all args into an options hash. For example when we call <em>render</em> method, we could call like this,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">render</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="ss">status</span><span class="p">:</span> <span class="ss">:ok</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here the first argument &lsquo;new&rsquo; is a String, and <strong>_normalize_args</strong> is responsible to put this first argument in options hash and give it an appropriate key.</p>

<p>Let&rsquo;s see how it&rsquo;s implemented.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/abstract_controller/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">AbstractController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize args by converting render &quot;foo&quot; to render :action =&gt; &quot;foo&quot; and</span>
</span><span class='line'>    <span class="c1"># render &quot;foo/bar&quot; to render :file =&gt; &quot;foo/bar&quot;.</span>
</span><span class='line'>    <span class="c1"># :api: plugin</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_args</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Hash</span>
</span><span class='line'>        <span class="n">action</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">options</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We see that this method by default almost does nothing, if the action is a Hash, it returns action, otherwise if action is for example, a string, it returns the second parameter which is the options hash.</p>

<p>Notice that ApplicationController includes some other modules which override this method, as we will see later.</p>

<h3>_normalize_options</h3>

<p>The <strong>_normalize_options</strong> method is for the modules to include other options. For a Rails application, the ApplicationController extends from <strong>ActionController::Base</strong>, and <strong>ActionController::Base</strong> includes a lot of modules, each module could override this method and add some other options.</p>

<p>Let&rsquo;s firstly check how this method is implemented in <strong>AbstractController::Rendering</strong>.</p>

<figure class='code'><figcaption><span>rails/actionpack/lib/abstract_controller/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">AbstractController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize options.</span>
</span><span class='line'>    <span class="c1"># :api: plugin</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>By default this method does nothing. But it will be overridden in other modules.</p>

<h3>Override _normalize_args</h3>

<p>Rails source code is complex, one reason is because there are many modules could override other modules&rsquo;s methods. For example, in a ArticlesController, let&rsquo;s see its ancestors,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">c</span>
</span><span class='line'><span class="no">Loading</span> <span class="n">development</span> <span class="n">environment</span> <span class="p">(</span><span class="no">Rails</span> <span class="mi">4</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="nb">puts</span> <span class="no">ArticlesController</span><span class="o">.</span><span class="n">ancestors</span>
</span><span class='line'><span class="no">ArticlesController</span>
</span><span class='line'><span class="c1">#&lt;Module:0x007f8f0a971800&gt;</span>
</span><span class='line'><span class="no">ApplicationController</span>
</span><span class='line'><span class="c1">#&lt;Module:0x007f8f0a8f93c8&gt;</span>
</span><span class='line'><span class="c1">#&lt;Module:0x007f8f05465118&gt;</span>
</span><span class='line'><span class="c1">#&lt;Module:0x007f8f05465140&gt;</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'><span class="ss">WebConsole</span><span class="p">:</span><span class="ss">:ControllerHelpers</span>
</span><span class='line'><span class="ss">Turbolinks</span><span class="p">:</span><span class="ss">:XHRHeaders</span>
</span><span class='line'><span class="ss">Turbolinks</span><span class="p">:</span><span class="ss">:Cookies</span>
</span><span class='line'><span class="ss">Turbolinks</span><span class="p">:</span><span class="ss">:XDomainBlocker</span>
</span><span class='line'><span class="ss">Turbolinks</span><span class="p">:</span><span class="ss">:Redirection</span>
</span><span class='line'><span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Railties</span><span class="o">::</span><span class="no">ControllerRuntime</span>
</span><span class='line'><span class="ss">ActionDispatch</span><span class="p">:</span><span class="ss">:Routing</span><span class="o">::</span><span class="ss">RouteSet</span><span class="p">:</span><span class="ss">:MountedHelpers</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:ParamsWrapper</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Instrumentation</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Rescue</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:HttpAuthentication</span><span class="o">::</span><span class="ss">Token</span><span class="p">:</span><span class="ss">:ControllerMethods</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:HttpAuthentication</span><span class="o">::</span><span class="ss">Digest</span><span class="p">:</span><span class="ss">:ControllerMethods</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:HttpAuthentication</span><span class="o">::</span><span class="ss">Basic</span><span class="p">:</span><span class="ss">:ControllerMethods</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:DataStreaming</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Streaming</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:ForceSSL</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:RequestForgeryProtection</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Flash</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Cookies</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:StrongParameters</span>
</span><span class='line'><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Rescuable</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:ImplicitRender</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:MimeResponds</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Caching</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Caching</span><span class="o">::</span><span class="no">Fragments</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Caching</span><span class="o">::</span><span class="no">ConfigMethods</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Callbacks</span>
</span><span class='line'><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Callbacks</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:EtagWithTemplateDigest</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:ConditionalGet</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Head</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Renderers</span><span class="o">::</span><span class="no">All</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Renderers</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Rendering</span>
</span><span class='line'><span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Layouts</span>
</span><span class='line'><span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Rendering</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Redirecting</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:RackDelegation</span>
</span><span class='line'><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Benchmarkable</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Logger</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:UrlFor</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:UrlFor</span>
</span><span class='line'><span class="ss">ActionDispatch</span><span class="p">:</span><span class="ss">:Routing</span><span class="o">::</span><span class="no">UrlFor</span>
</span><span class='line'><span class="ss">ActionDispatch</span><span class="p">:</span><span class="ss">:Routing</span><span class="o">::</span><span class="no">PolymorphicRoutes</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:ModelNaming</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:HideActions</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Helpers</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Helpers</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:AssetPaths</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Translation</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Rendering</span>
</span><span class='line'><span class="ss">ActionView</span><span class="p">:</span><span class="ss">:ViewPaths</span>
</span><span class='line'><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Metal</span>
</span><span class='line'><span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Configurable</span>
</span><span class='line'><span class="no">Object</span>
</span><span class='line'><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Dependencies</span><span class="o">::</span><span class="no">Loadable</span>
</span><span class='line'><span class="ss">PP</span><span class="p">:</span><span class="ss">:ObjectMixin</span>
</span><span class='line'><span class="ss">JSON</span><span class="p">:</span><span class="ss">:Ext</span><span class="o">::</span><span class="ss">Generator</span><span class="p">:</span><span class="ss">:GeneratorMethods</span><span class="o">::</span><span class="no">Object</span>
</span><span class='line'><span class="no">Kernel</span>
</span><span class='line'><span class="no">BasicObject</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that for a typical controller, it has a lot of ancestors and most of them are modules. All modules after <em>AbstractController::Rendering</em> could override its methods. I have created a gist to check which ancestors implement a method.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Module</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">ancestors_that_implement_instance_method</span><span class="p">(</span><span class="nb">instance_method</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">ancestors</span><span class="o">.</span><span class="n">find_all</span> <span class="k">do</span> <span class="o">|</span><span class="n">ancestor</span><span class="o">|</span>
</span><span class='line'>      <span class="p">(</span><span class="n">ancestor</span><span class="o">.</span><span class="n">instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span> <span class="o">+</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">private_instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">))</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="nb">instance_method</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the above code in a rails console, then you can call <em>ClassName.ancestors_that_implement_instance_method</em> to check what ancestors implement a method.</p>

<p>Let&rsquo;s first see what ancestors override the <em>_normalize_args</em> method,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">c</span>
</span><span class='line'><span class="no">Loading</span> <span class="n">development</span> <span class="n">environment</span> <span class="p">(</span><span class="no">Rails</span> <span class="mi">4</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">013</span> <span class="o">&gt;</span>   <span class="no">ArticlesController</span><span class="o">.</span><span class="n">ancestors_that_implement_instance_method</span><span class="p">(</span><span class="ss">:_normalize_args</span><span class="p">)</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Rendering</span><span class="p">,</span> <span class="ss">ActionView</span><span class="p">:</span><span class="ss">:Rendering</span><span class="p">,</span> <span class="ss">AbstractController</span><span class="p">:</span><span class="ss">:Rendering</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Two modules override this instance method: <em>ActionView::Rendering</em> and <em>ActionController::Rendering</em>. Let&rsquo;s look them in order from top to down.</p>

<p>Let&rsquo;s look at <em>ActionView::Rendering</em> first,</p>

<figure class='code'><figcaption><span>actionview/lib/action_view/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>    <span class="c1"># Normalize args by converting render &quot;foo&quot; to render :action =&gt; &quot;foo&quot; and</span>
</span><span class='line'>    <span class="c1"># render &quot;foo/bar&quot; to render :template =&gt; &quot;foo/bar&quot;.</span>
</span><span class='line'>    <span class="c1"># :api: private</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_args</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="k">super</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="k">case</span> <span class="n">action</span>
</span><span class='line'>      <span class="k">when</span> <span class="no">NilClass</span>
</span><span class='line'>      <span class="k">when</span> <span class="no">Hash</span>
</span><span class='line'>        <span class="n">options</span> <span class="o">=</span> <span class="n">action</span>
</span><span class='line'>      <span class="k">when</span> <span class="nb">String</span><span class="p">,</span> <span class="no">Symbol</span>
</span><span class='line'>        <span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>        <span class="n">key</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="sc">?/</span><span class="p">)</span> <span class="p">?</span> <span class="ss">:template</span> <span class="p">:</span> <span class="ss">:action</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">action</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:partial</span><span class="o">]</span> <span class="o">=</span> <span class="n">action</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">options</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that for the first argument <em>action</em>, if it&rsquo;s a string and the string include &lsquo;/&rsquo;, the key for this argument is :file, and if it doesn&rsquo;t include &lsquo;/&rsquo;, the key is :action.</p>

<p>So if we call <em>render &lsquo;new&rsquo;</em>, the options will be { action: &lsquo;new&rsquo; }, if we call <em>render &lsquo;articles/new&rsquo;</em>, the options will be { file: &lsquo;articles/new&rsquo; }</p>

<p>Now let&rsquo;s see how <em>ActionController::Rendering</em> overrides this method</p>

<figure class='code'><figcaption><span>actionpack/lib/action_controller/metal/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">ActionController</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>    <span class="c1"># Normalize arguments by catching blocks and setting them on :update.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_args</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{},</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="k">super</span>
</span><span class='line'>      <span class="n">options</span><span class="o">[</span><span class="ss">:update</span><span class="o">]</span> <span class="o">=</span> <span class="n">blk</span> <span class="k">if</span> <span class="nb">block_given?</span>
</span><span class='line'>      <span class="n">options</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that for this override, if the method is passed a block, it will set the block to options[:update]</p>

<h3>Override _normalize_options</h3>

<p>Just like <em>_normalize_args</em>, let&rsquo;s examine what modules override <em>_normalize_options</em>. We can see following modules implement <em>_normalize_options</em>: <em>[ActionController::Rendering, ActionView::Layouts, ActionView::Rendering, AbstractController::Rendering]</em>.</p>

<p>Let&rsquo;s check <em>ActionView::Rendering</em> first,</p>

<figure class='code'><figcaption><span>actionpack/lib/action_controller/metal/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize options.</span>
</span><span class='line'>    <span class="c1"># :api: private</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="k">super</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:partial</span><span class="o">]</span> <span class="o">==</span> <span class="kp">true</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:partial</span><span class="o">]</span> <span class="o">=</span> <span class="n">action_name</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">keys</span> <span class="o">&amp;</span> <span class="o">[</span><span class="ss">:partial</span><span class="p">,</span> <span class="ss">:file</span><span class="p">,</span> <span class="ss">:template</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:prefixes</span><span class="o">]</span> <span class="o">||=</span> <span class="n">_prefixes</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">options</span><span class="o">[</span><span class="ss">:template</span><span class="o">]</span> <span class="o">||=</span> <span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:action</span><span class="o">]</span> <span class="o">||</span> <span class="n">action_name</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>      <span class="n">options</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that it addes three options by default,</p>

<ul>
<li>If the options[:partial] is true, then it will set options[:partial] to <em>action_name</em>, the <em>action_name</em> is just the name of the action that is triggered. For example, if the <em>index</em> action of ArticlesController is triggered, <em>action_name</em> will be <em>index</em>.</li>
<li>If the options doesn&rsquo;t include :partial, :file or :template, it set options[:prefixes]. Let&rsquo;s see what&rsquo;s set for this :prefixes in a minute.</li>
<li>It set the options[:template]. It&rsquo;s either passed from the arguments or just use the action_name.</li>
</ul>


<p>So what&rsquo;s in options[:prefixes], let&rsquo;s see how <em>_prefixes</em> method is implemented.</p>

<p>The <strong>AbstractController::Rendering</strong> module includes <strong>ActionView::ViewPaths</strong> module. And <strong>_prefixes</strong> method is implemented there.</p>

<p><strong>ActionView::ViewPaths</strong> is an important module which we will examine in more details in later parts. It&rsquo;s to manage the view paths for controllers. For example, by default Rails will append a view path <strong>#{Rails.root}app/views</strong> so the application knows to search templates in that specific view path.</p>

<p>For now let&rsquo;s just focus on <strong>_prefixes</strong> method.</p>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/view_paths.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ViewPaths</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># The prefixes used in render &quot;foo&quot; shortcuts.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_prefixes</span> <span class="c1"># :nodoc:</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">_prefixes</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <strong>_prefixes</strong> just calls the class method <strong>_prefixes</strong>.</p>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/view_paths.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ViewPaths</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">_prefixes</span> <span class="c1"># :nodoc:</span>
</span><span class='line'>        <span class="vi">@_prefixes</span> <span class="o">||=</span> <span class="k">begin</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">local_prefixes</span> <span class="k">if</span> <span class="n">superclass</span><span class="o">.</span><span class="n">abstract?</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">local_prefixes</span> <span class="o">+</span> <span class="n">superclass</span><span class="o">.</span><span class="n">_prefixes</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Override this method in your controller if you want to change paths prefixes for finding views.</span>
</span><span class='line'>      <span class="c1"># Prefixes defined here will still be added to parents&#39; &lt;tt&gt;._prefixes&lt;/tt&gt;.</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">local_prefixes</span>
</span><span class='line'>        <span class="o">[</span><span class="n">controller_path</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that Rails 4.2 implements that method and handles some deprecated parent prefixes. In above code I omitted that handling for clarity.</p>

<p>This <strong>ActionView::ViewPaths._prefixes</strong> calls recursively. it append local_prefixes with superclass&rsquo;s _prefixes. The <strong>local_prefixes</strong> has just one element: <strong>controller_path</strong>.</p>

<p>The <strong>controller_path</strong> method is very simple, it&rsquo;s implemented in <strong>AbstractController::Base</strong>. For example, for a controller <em>ArticlesController</em>, its controller_path will be <em>articles</em>, and for a controller <em>Articles::CommentsController</em>, its controller_path will be <em>articles/comments</em></p>

<p>So the <strong>_prefixes</strong> method first gets it&rsquo;s parent prefixes, and then prepends the current controller_path to the front.</p>

<p>For example, if our application has a <em>ArticlesController</em>, in our rails controller, we can call the following code to show the <em>_prefixes</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="n">c</span>
</span><span class='line'><span class="no">Loading</span> <span class="n">development</span> <span class="n">environment</span> <span class="p">(</span><span class="no">Rails</span> <span class="mi">4</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">p353</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">ArticlesController</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:_prefixes</span><span class="p">)</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;articles&quot;</span><span class="p">,</span> <span class="s2">&quot;application&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We see that the prefixes contains two elements: articles and application. It&rsquo;s because the ApplicationController extends from ActionController::Base, but ActionController::Base is abstract.</p>

<p>So now we can see that for <em>ArticlesController#index</em> action, when we just call <em>render</em> without any arguments, the options will contains following elements,</p>

<ul>
<li><strong>:prefixes</strong> : array [&ldquo;articles&rdquo;, &ldquo;application&rdquo;]</li>
<li><strong>:template</strong> : string &ldquo;index&rdquo;</li>
</ul>


<p>Now let&rsquo;s see next one, how <strong>ActionView::Layouts</strong> overrides <strong>_normalize_options</strong> method,</p>

<figure class='code'><figcaption><span>rails/actionview/lib/action_view/layouts.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionView</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Layouts</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="c1"># :nodoc:</span>
</span><span class='line'>      <span class="k">super</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">_include_layout?</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>        <span class="n">layout</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:layout</span><span class="p">)</span> <span class="p">{</span> <span class="ss">:default</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:layout</span><span class="o">]</span> <span class="o">=</span> <span class="n">_layout_for_option</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that if the options[:layout] is not set, the default layout is :default. And then options[:layout] is set to the result returned by <em>_layout_for_option</em>.</p>

<p>If you are interested you could check how <strong>_layout_for_options</strong> is implemented. When this module searches for the layout it will search <em>&ldquo;app/views/layouts/#{class_name.underscore}.rb&rdquo;</em> first, if it doesn&rsquo;t found, then it will search super class. Since when a rails application is generated, an application.html.erb will be put in <em>app/views/layouts</em> and since by default all controllers&#8217; parent is ApplicationController, so by default this layout will be used.</p>

<p>Finally let&rsquo;s see how <strong>ActionController::Rendering</strong> overrides <strong>_normalize_options</strong></p>

<figure class='code'><figcaption><span>rails/actionpack/lib/action_controller/metal/rendering.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActionController</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Rendering</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Normalize both text and status options.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_normalize_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>      <span class="n">_normalize_text</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:html</span><span class="o">]</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:html</span><span class="o">]</span> <span class="o">=</span> <span class="ss">ERB</span><span class="p">:</span><span class="ss">:Util</span><span class="o">.</span><span class="n">html_escape</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:html</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:nothing</span><span class="p">)</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:body</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Utils</span><span class="o">.</span><span class="n">status_code</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">super</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So this method just process :html, :nothing and :status options, which is straight forward.</p>

<p>So finally let&rsquo;s see when we call <em>render</em> in <em>ArticlesController#index</em> without any arguments, the options will contains following values,</p>

<ul>
<li><strong>:prefixes</strong> : array [&ldquo;articles&rdquo;, &ldquo;application&rdquo;]</li>
<li><strong>:template</strong> : string &ldquo;index&rdquo;</li>
<li><strong>:layout</strong>   : A Proc when called will return &ldquo;app/views/layouts/application.html.erb&rdquo;</li>
</ul>


<p>Now we know how the options is normalized. And when Rails determines which template to render, it will extract details from the options. And we will look at how Rails determines template in later parts.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/16/deploy-rails-application-on-ubuntu-14-dot-04-part-3/">Deploy Rails Application on Ubuntu 14.04 Part 3</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-16T21:43:02+10:30" pubdate data-updated="true">Feb 16<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/16/deploy-rails-application-on-ubuntu-14-dot-04-part-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here is the Part 3 of Deploying Rails Application on Ubuntu 14.04, and also the final part. In this part we will explain what the Capistrano template does.</p>

<p>Capistrano is a remote server automation and deployment tool written in Ruby. Capistrano 3 extends Rake DSL with its own set of DSL. I recommend you read the documents on <a href="http://capistranorb.com/">Capistrano website</a>.</p>

<h2>Install Capistrano</h2>

<p>In <strong>Gemfile</strong> we add the following gems,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.1.0&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># rails specific capistrano funcitons</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 1.1.0&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># integrate bundler with capistrano</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-bundler&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># if you are using RBENV</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-rbenv&#39;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 2.0&quot;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <em>capistrano-rails</em>, <em>capistrano-bundler</em>, and <em>capistrano-rbenv</em> are capistrano plugins. Let&rsquo;s focus on capistrano first.</p>

<p>After running <strong>bundle install</strong>, if we run <strong>bundle exec cap install</strong>, it will generate following folders and files, actually when we copy the files from the capistrano template in part 2, it does the same thing.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├──  Capfile
</span><span class='line'>├── config
</span><span class='line'>│   ├── deploy
</span><span class='line'>│   │   ├── production.rb
</span><span class='line'>│   │   └── staging.rb
</span><span class='line'>│   └── deploy.rb
</span><span class='line'>└── lib
</span><span class='line'>    └── capistrano
</span><span class='line'>            └── tasks</span></code></pre></td></tr></table></div></figure>


<ul>
<li>In Capfile, It requires all necessary files, and also it includes all customized tasks in <em>lib/capistrano/tasks</em>.</li>
<li>Normally you have a production server and a staging server. So before you deploy new features to production server, you want to deploy to staging server first and after all QA are passed. So in <em>config/deploy.rb</em>, it defines the parameters that apply to all environments, and in <em>config/deploy/production.rb</em> and <em>config/deploy/staging.rb</em> it defines the parameters that apply to the specific environment. When we run <em>bundle exec cap production deploy</em>, it will load <em>config/deploy.rb</em> first, then <em>config/deploy/production.rb</em>, and then run the <strong>deploy</strong> rake task.</li>
</ul>


<h2>Understanding Capistrano</h2>

<p>To understand Capistrano, the best way is to read its source code. Actually it&rsquo;s not that hard as the source code of Capistrano is pretty easy to understand.</p>

<h3>DSL</h3>

<p>Capistrano defines a DSL. For those interested, can check the capistrano source code in folder <em>lib/capistrano/dsl</em></p>

<h4>Set attributes</h4>

<p>You can set some attributes by using <strong>set</strong>, and then later use <strong>fetch</strong> to get the attribute value by key. In our sample application <em>config/deploy.rb</em>, you can see it sets a lot of attributes.</p>

<p>The following code snippets illustrate its use.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s1">&#39;deploy_sample&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span> <span class="ss">:git</span>
</span><span class='line'>
</span><span class='line'><span class="n">fetch</span> <span class="ss">:application</span> <span class="c1"># if :application key doesn&#39;t exist, it will return nil</span>
</span><span class='line'>
</span><span class='line'><span class="n">fetch</span> <span class="ss">:application</span><span class="p">,</span> <span class="s1">&#39;application_name&#39;</span> <span class="c1"># if the :application key doesn&#39;t exist, it will return default value &#39;application_name&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">set_if_empty</span> <span class="ss">:rbenv_type</span><span class="p">,</span> <span class="ss">:user</span> <span class="c1"># set only the :rbenv_type key is not defined</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Server and Roles</h4>

<p>Think about our deployment, at least we need a database server, an application server which is unicorn, and a web server which is Nginx or Apache. Sometimes db, app and web are on the same server, sometimes they are installed on different servers. Capistrano defines these as roles. For example, in our sample application, we define one server which has three roles,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">server</span> <span class="s1">&#39;192.168.22.10&#39;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="sx">%w{web app db}</span><span class="p">,</span> <span class="ss">primary</span><span class="p">:</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>So later if we want to want to do something on the server that acts as web and app role, we could use <strong>roles</strong> or <strong>release_roles</strong> method,</p>

<p>For example, the following code will create directory on the server that act as web and app role,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:directories</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">on</span> <span class="n">release_roles</span> <span class="ss">:web</span><span class="p">,</span> <span class="ss">:app</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">execute</span> <span class="ss">:mkdir</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">shared_path</span><span class="p">,</span> <span class="n">releases_path</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If the <em>web</em> and <em>app</em> role point to two different servers, each server will create the directory. If we use :all, it will get all servers.</p>

<h3>Rake tasks</h3>

<p>Capistrano 3 actually is an extension of Rake tasks. So when we run <strong>bundle exec cap production deploy</strong>, it will run the <strong>deploy</strong> Rake task.</p>

<p>Let&rsquo;s have a look at the definition of the <strong>deploy</strong> task. It&rsquo;s in Capistrano source code <em>/lib/capistrano/tasks/framework.rake</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Deploy a new release.&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">set</span><span class="p">(</span><span class="ss">:deploying</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>  <span class="sx">%w{ starting started</span>
</span><span class='line'><span class="sx">      updating updated</span>
</span><span class='line'><span class="sx">      publishing published</span>
</span><span class='line'><span class="sx">      finishing finished }</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span>
</span><span class='line'>    <span class="n">invoke</span> <span class="s2">&quot;deploy:</span><span class="si">#{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we can see that the <strong>deploy</strong> task runs the following 8 tasks in sequence,
* deploy:starting
* deploy:started
* deploy:updating
* deploy:updated
* deploy:publishing
* deploy:published
* deploy:finishing
* deploy:finished</p>

<p>If you are interested you should check the source code of those tasks. For example, in task <em>deploy:updating</em> it will invoke <em>deploy:symlink:shared</em>, which in turns invokes <em>deploy:symlink:link_files</em>, let&rsquo;s see how this task is implemented</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:symlink</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">desc</span> <span class="s1">&#39;Symlink linked files&#39;</span>
</span><span class='line'>    <span class="n">task</span> <span class="ss">:linked_files</span> <span class="k">do</span>
</span><span class='line'>      <span class="k">next</span> <span class="k">unless</span> <span class="n">any?</span> <span class="ss">:linked_files</span>
</span><span class='line'>      <span class="n">on</span> <span class="n">release_roles</span> <span class="ss">:all</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">execute</span> <span class="ss">:mkdir</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">linked_file_dirs</span><span class="p">(</span><span class="n">release_path</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">fetch</span><span class="p">(</span><span class="ss">:linked_files</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>          <span class="n">target</span> <span class="o">=</span> <span class="n">release_path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>          <span class="n">source</span> <span class="o">=</span> <span class="n">shared_path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">test</span> <span class="s2">&quot;[ -L </span><span class="si">#{</span><span class="n">target</span><span class="si">}</span><span class="s2"> ]&quot;</span>
</span><span class='line'>            <span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;[ -f </span><span class="si">#{</span><span class="n">target</span><span class="si">}</span><span class="s2"> ]&quot;</span>
</span><span class='line'>              <span class="n">execute</span> <span class="ss">:rm</span><span class="p">,</span> <span class="n">target</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>            <span class="n">execute</span> <span class="ss">:ln</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that it will fetch the <em>linked_files</em> property, for our deploy sample application, we have set it to <em>%w{config/database.yml config/secrets.yml}</em>, so for each file, it will created a symbolic link in <em>release_path</em>, which points to the file in <em>shared_path</em>, where is release_path? Let&rsquo;s have a look at Capistrano source code <em>/lib/capistrano/dsl/paths.rb</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">deploy_to</span>
</span><span class='line'>  <span class="n">fetch</span><span class="p">(</span><span class="ss">:deploy_to</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">deploy_path</span>
</span><span class='line'>  <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">current_path</span>
</span><span class='line'>  <span class="n">deploy_path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;current&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">release_path</span>
</span><span class='line'>  <span class="n">fetch</span><span class="p">(</span><span class="ss">:release_path</span><span class="p">,</span> <span class="n">current_path</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the <em>release_path</em> by default is the <em>current_path</em>, which is the sub folder <em>current</em> under <em>deploy_path</em>, which is set by deploy_to. Since in deploy_sample application, we already set <em>deploy_to</em> to &ldquo;/product/#{fetch(:full_app_name)}&rdquo;, so for our case, <em>release_path</em> will be <strong>/product/deploy_sample_production/current</strong>.</p>

<p>For ssh, Capistrano depends on <a href="https://github.com/capistrano/sshkit">sshkit</a>, if you are interested, you could check the documents on its website.</p>

<p>In Capistrano we could customize the deploy process by injecting our own tasks. For example, in config/deploy.rb in our sample application, it defines</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">after</span> <span class="s1">&#39;deploy:symlink:shared&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:compile_assets_locally&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So after the task <em>deploy:symlink:shared</em>, it will run <em>deploy:compile_assets_locally</em>, which is to run <em>rake assets:precompile</em> locally and then upload the compiled assets to the server. You could use <em>before</em> or <em>after</em> to inject tasks before or after other tasks.</p>

<p>So now you should have an idea how Capistrano works. It&rsquo;s just a series of Rake tasks which ssh to the server to execute commands to do the deployment. In my opinion the Capistrano source code is quite easy to understand, you could check more details if you like.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/">Deploy Rails Application on Ubuntu 14.04 Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-09T21:27:23+10:30" pubdate data-updated="true">Feb 9<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In <a href="http://climber2002.github.io/blog/2015/02/08/deploy-rails-application-on-ubuntu-14-dot-04/">Part 1</a> we have installed Nginx PostgreSQL, and also Monit. In this part I will show how to deploy the application through capistrano.</p>

<p>In this part we will execute many commands, some will be executed in the host machine (our Laptop or iMac for example), and some will be executed in the Vagrant VM. I will show different prompt when executing. On host machine the prompt will be like <strong>host:~/rails_projects/deploy_sample$</strong>, and on VM the prompt will be <strong>vagrant@vagrant-ubuntu-trusty-64:~$</strong>, or if we su as deploy, it will be <strong>deploy@vagrant-ubuntu-trusty-64:~$</strong></p>

<h2>Create deploy user</h2>

<p>Just like we use an user <em>postgres</em> to manage our database, we should also use a standalone user to manage our application. We name this user <em>deploy</em>. And now let&rsquo;s create this user.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo adduser --ingroup sudo deploy
</span><span class='line'>Adding user <span class="sb">`</span>deploy<span class="s1">&#39; ...</span>
</span><span class='line'><span class="s1">Adding new user `deploy&#39;</span> <span class="o">(</span>1002<span class="o">)</span> with group <span class="sb">`</span>sudo<span class="s1">&#39; ...</span>
</span><span class='line'><span class="s1">Creating home directory `/home/deploy&#39;</span> ...
</span><span class='line'>Copying files from <span class="sb">`</span>/etc/skel<span class="err">&#39;</span> ...
</span><span class='line'>Enter new UNIX password:
</span><span class='line'>Retype new UNIX password:
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>Changing the user information <span class="k">for </span>deploy
</span><span class='line'>Enter the new value, or press ENTER <span class="k">for </span>the default
</span><span class='line'>  Full Name <span class="o">[]</span>:
</span><span class='line'>  Room Number <span class="o">[]</span>:
</span><span class='line'>  Work Phone <span class="o">[]</span>:
</span><span class='line'>  Home Phone <span class="o">[]</span>:
</span><span class='line'>  Other <span class="o">[]</span>:
</span><span class='line'>Is the information correct? <span class="o">[</span>Y/n<span class="o">]</span> Y
</span></code></pre></td></tr></table></div></figure>


<p>Set a password for <em>deploy</em> user and accept all default options.</p>

<p>Since we already add <em>deploy</em> user to sudo group. It can run sudo commands. However the user needs to input his password when sudo. When we run the capistrano deploy command later, it will run sudo commands. So I want to update this user so that he doesn&rsquo;t need to type password when running sodo commands. For this we need to update the <strong>/etc/sudoers</strong> file. It&rsquo;s recommended to use the application <strong>visudo</strong> to update it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo visodu
</span></code></pre></td></tr></table></div></figure>


<p>Add the following line to this file, and then type <em>Ctrl + O</em> to save it as /etc/sudoers, and type <em>Ctrl + X</em> to exit.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy  <span class="nv">ALL</span><span class="o">=(</span>ALL:ALL<span class="o">)</span> NOPASSWD:ALL
</span></code></pre></td></tr></table></div></figure>


<p>Notice that since we already add <em>deploy</em> user to sudo group, this line should be added under the line <strong>%sudo   ALL=(ALL:ALL) ALL</strong> so it will take effect.</p>

<p>Our deployment organization is like following figure,</p>

<p><img src="/images/deploy_structure.png"></p>

<p>Our host communicates with VM by SSH, and also when the VM sync code from github, it also uses SSH. So we need two public/private keypairs here. One will be generated in VM and used to communicate with Github. And One will be generated in host machine and used to communicate with VM during deployment.</p>

<p>Let&rsquo;s firstly generate a keypair for <em>deploy</em> user in VM. The public key for this keypair will be configured in github so the VM can download code from github.</p>

<p>Let&rsquo;s firstly su as deploy</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>su deploy
</span><span class='line'>Password:
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:/home/vagrant<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we go to the ~/.ssh folder and create a keypair.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:/home/vagrant<span class="nv">$ </span><span class="nb">cd</span> ~
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>mkdir .ssh
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span><span class="nb">cd</span> .ssh
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>ssh-keygen -t rsa -b 4096 -C climber2002@gmail.com
</span></code></pre></td></tr></table></div></figure>


<p>The <em>climber2002@gmail.com</em> is my email, and you should use your email here.</p>

<p>Accept default options, and after generation two files should be created, <strong>id_rsa</strong> and <strong>id_rsa.pub</strong>.</p>

<p>We can run <strong>cat id_rsa.pub</strong> and copy its content, and then configure this key in github.</p>

<p>In github, choose Settings &ndash;> SSH keys &ndash;> Add SSH key, and paste the public key, as the following snapshot.</p>

<p><img src="/images/github_add_ssh_key.png"></p>

<p>Now we need to add the key of our host to the Vagrant VM. Let&rsquo;s see if a key already existed.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host<span class="nv">$ </span>ls -l ~/.ssh
</span><span class='line'>-rw-------  1 andywang  staff  1679 Jun 25  2014 id_rsa
</span><span class='line'>-rw-r--r--  1 andywang  staff   403 Jun 25  2014 id_rsa.pub
</span></code></pre></td></tr></table></div></figure>


<p>Normally you should already have <strong>id_rsa</strong> and <strong>id_rsa.pub</strong>. If not run the <em>ssh-keygen</em> again in host to generate the SSH key.</p>

<p>And then lets copy the content of id_rsa.pub and copy it to VM&rsquo;s <strong>~/.ssh/authorized_keys</strong>. If this file doesn&rsquo;t exist, create it. And then paste the content in id_rsa.pub in this file as a standalone line.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~/.ssh<span class="nv">$ </span>vi authorized_keys
</span></code></pre></td></tr></table></div></figure>


<p>And also I updated the ssh config file <strong>/etc/ssh/sshd_config</strong> and changed the <strong>PasswordAuthentication yes</strong> to <strong>PasswordAuthentication no</strong> so we disable the password authentication, and only use Publickey authentication which is more secure.</p>

<p>After that let&rsquo;s restart ssh service</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~/.ssh<span class="nv">$ </span>sudo service ssh restart
</span></code></pre></td></tr></table></div></figure>


<p>Now from your host server, you should be able to ssh into the Vagrant VM.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host<span class="nv">$ </span>ssh deploy@192.168.22.10
</span><span class='line'>
</span><span class='line'>The authenticity of host <span class="s1">&#39;192.168.22.10 (192.168.22.10)&#39;</span> can<span class="s1">&#39;t be established.</span>
</span><span class='line'><span class="s1">RSA key fingerprint is b1:e4:e0:42:a1:37:0b:04:d3:88:8c:42:15:aa:00:b4.</span>
</span><span class='line'><span class="s1">Are you sure you want to continue connecting (yes/no)? yes</span>
</span><span class='line'><span class="s1">Warning: Permanently added &#39;</span>192.168.22.10<span class="err">&#39;</span> <span class="o">(</span>RSA<span class="o">)</span> to the list of known hosts.
</span><span class='line'>Welcome to Ubuntu 14.04.1 LTS <span class="o">(</span>GNU/Linux 3.13.0-45-generic x86_64<span class="o">)</span>
</span><span class='line'>
</span><span class='line'> * Documentation:  https://help.ubuntu.com/
</span><span class='line'>
</span><span class='line'>  System information as of Mon Feb  9 12:25:47 UTC 2015
</span><span class='line'>
</span><span class='line'>  System load:  0.0               Processes:           96
</span><span class='line'>  Usage of /:   3.1% of 39.34GB   Users logged in:     2
</span><span class='line'>  Memory usage: 33%               IP address <span class="k">for </span>eth0: 10.0.2.15
</span><span class='line'>  Swap usage:   0%                IP address <span class="k">for </span>eth1: 192.168.22.10
</span><span class='line'>
</span><span class='line'>  Graph this data and manage this system at:
</span><span class='line'>    https://landscape.canonical.com/
</span><span class='line'>
</span><span class='line'>  Get cloud support with Ubuntu Advantage Cloud Guest:
</span><span class='line'>    http://www.ubuntu.com/business/services/cloud
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Last login: Mon Feb  9 12:25:48 2015 from 192.168.22.1
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo ls
</span></code></pre></td></tr></table></div></figure>


<h2>Rbenv</h2>

<p>Now we install the Rbenv. We will use <a href="https://github.com/fesplugas/rbenv-installer">Rbenv installer</a> to ease our installation. Since we will use <em>deploy</em> user as our application owner. Make sure you firstly su as <em>deploy</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>curl https://raw.githubusercontent.com/fesplugas/rbenv-installer/master/bin/rbenv-installer | bash
</span></code></pre></td></tr></table></div></figure>


<p>After the installation is complete, add following lines to <em>~/.bashrc</em>, pay attention that you need to add it at the top of the file. Since the script will return if it&rsquo;s not running interactively.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">RBENV_ROOT</span><span class="o">=</span><span class="s2">&quot;${HOME}/.rbenv&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;${RBENV_ROOT}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;${RBENV_ROOT}/bin:${PATH}&quot;</span>
</span><span class='line'>  <span class="nb">eval</span> <span class="s2">&quot;$(rbenv init -)&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>After we run <strong>. ~/.bashrc</strong> to take the change into effect.</p>

<p>Now we need to install some required packages on Ubuntu.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>rbenv bootstrap-ubuntu-12-04
</span></code></pre></td></tr></table></div></figure>


<p>After the necessary packages are installed, lets install Ruby 2.1.4</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>rbenv install 2.1.4
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>rbenv global 2.1.4
</span></code></pre></td></tr></table></div></figure>


<p>This will download and compile Ruby 2.1.4 so it will take some time. Let&rsquo;s grab a cup of coffee~~</p>

<h2>Install bundler</h2>

<p>After installed ruby 2.1.4 let&rsquo;s install bundler</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>gem install bundler
</span></code></pre></td></tr></table></div></figure>


<h2>Create the application directory</h2>

<p>For my application, I want to deploy the application in <strong>/product</strong> folder, so let&rsquo;s create that folder and change the owner to <em>deploy</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo mkdir /product
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo chown -R deploy:sudo /product
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy with Capistrano</h2>

<p>Now we will try to deploy with Capistrano. We will use the <a href="https://github.com/TalkingQuickly/capistrano-3-rails-template">capistrano 3 template</a> to help us. Don&rsquo;t worry if you don&rsquo;t fully understand, I will explain it in next part.</p>

<p>Now firstly let&rsquo;s clone the capistrano template in our host station. For me, both this project and the <em>deploy_sample</em> project are in the same folder which is <em>~/rails_projects</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects<span class="nv">$ </span>git clone https://github.com/TalkingQuickly/capistrano-3-rails-template.git
</span></code></pre></td></tr></table></div></figure>


<p>And then in <em>Gemfile</em> of our <em>deploy_sample</em> project, let&rsquo;s add the necessary gems.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Use Unicorn as the app server</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;unicorn&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.1.0&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># rails specific capistrano funcitons</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 1.1.0&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># integrate bundler with capistrano</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-bundler&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># if you are using RBENV</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-rbenv&#39;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 2.0&quot;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that let&rsquo;s run <strong>bundle install</strong> to install all the gems.</p>

<p>The capistrano 3 templates added some customized tasks, so lets copy all the files from the template to our project.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp ../capistrano-3-rails-template/Capfile .
</span><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp -r ../capistrano-3-rails-template/config/ ./config
</span><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp -r ../capistrano-3-rails-template/lib/ ./lib
</span></code></pre></td></tr></table></div></figure>


<h3>Copy secrets.yml</h3>

<p>The Capistrano templates has some template files in <em>config/shared</em> folder, these files will be copied to a shared folder in VM when we run the task <strong>deploy:setup_config</strong>. Notice that we also want <em>secrets.yml</em> to be in the shared folder, so it won&rsquo;t be committed in our git repository. So let&rsquo;s copy this file into shared folder also. We change the filename to secrets.yml.erb as the task will render the erb file to secrets.yml during setup.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp config/secrets.yml config/deploy/shared/secrets.yml.erb
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to update the <em>config/deploy.rb</em> file as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s1">&#39;deploy_sample&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_user</span><span class="p">,</span> <span class="s1">&#39;deploy&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># setup repo details</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span> <span class="ss">:git</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:repo_url</span><span class="p">,</span> <span class="s1">&#39;git@github.com:climber2002/deploy_sample.git&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># setup rbenv.</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_type</span><span class="p">,</span> <span class="ss">:user</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_ruby</span><span class="p">,</span> <span class="s1">&#39;2.1.4&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_prefix</span><span class="p">,</span> <span class="s2">&quot;RBENV_ROOT=</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> RBENV_VERSION=</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_ruby</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_path</span><span class="p">)</span><span class="si">}</span><span class="s2">/bin/rbenv exec&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_map_bins</span><span class="p">,</span> <span class="sx">%w{rake gem bundle ruby rails}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># how many old releases do we want to keep, not much</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:keep_releases</span><span class="p">,</span> <span class="mi">5</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># files we want symlinking to specific entries in shared</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:linked_files</span><span class="p">,</span> <span class="sx">%w{config/database.yml config/secrets.yml}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># dirs we want symlinking to shared</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:linked_dirs</span><span class="p">,</span> <span class="sx">%w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># what specs should be run before deployment is allowed to</span>
</span><span class='line'><span class="c1"># continue, see lib/capistrano/tasks/run_tests.cap</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:tests</span><span class="p">,</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># which config files should be copied by deploy:setup_config</span>
</span><span class='line'><span class="c1"># see documentation in lib/capistrano/tasks/setup_config.cap</span>
</span><span class='line'><span class="c1"># for details of operations</span>
</span><span class='line'><span class="n">set</span><span class="p">(</span><span class="ss">:config_files</span><span class="p">,</span> <span class="sx">%w(</span>
</span><span class='line'><span class="sx">  nginx.conf</span>
</span><span class='line'><span class="sx">  database.example.yml</span>
</span><span class='line'><span class="sx">  log_rotation</span>
</span><span class='line'><span class="sx">  monit</span>
</span><span class='line'><span class="sx">  unicorn.rb</span>
</span><span class='line'><span class="sx">  unicorn_init.sh</span>
</span><span class='line'><span class="sx">  secrets.yml</span>
</span><span class='line'><span class="sx">)</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># which config files should be made executable after copying</span>
</span><span class='line'><span class="c1"># by deploy:setup_config</span>
</span><span class='line'><span class="n">set</span><span class="p">(</span><span class="ss">:executable_config_files</span><span class="p">,</span> <span class="sx">%w(</span>
</span><span class='line'><span class="sx">  unicorn_init.sh</span>
</span><span class='line'><span class="sx">)</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1"># files which need to be symlinked to other parts of the</span>
</span><span class='line'><span class="c1"># filesystem. For example nginx virtualhosts, log rotation</span>
</span><span class='line'><span class="c1"># init scripts etc. The full_app_name variable isn&#39;t</span>
</span><span class='line'><span class="c1"># available at this point so we use a custom template </span>
</span><span class='line'><span class="c1"># tag and then add it at run time.</span>
</span><span class='line'><span class="n">set</span><span class="p">(</span><span class="ss">:symlinks</span><span class="p">,</span> <span class="o">[</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;nginx.conf&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/nginx/sites-enabled/&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;unicorn_init.sh&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/init.d/unicorn_&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;log_rotation&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/logrotate.d/&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;monit&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/monit/conf.d/.conf&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># this:</span>
</span><span class='line'><span class="c1"># http://www.capistranorb.com/documentation/getting-started/flow/</span>
</span><span class='line'><span class="c1"># is worth reading for a quick overview of what tasks are called</span>
</span><span class='line'><span class="c1"># and when for `cap stage deploy`</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># make sure we&#39;re deploying what we think we&#39;re deploying</span>
</span><span class='line'>  <span class="n">before</span> <span class="ss">:deploy</span><span class="p">,</span> <span class="s2">&quot;deploy:check_revision&quot;</span>
</span><span class='line'>  <span class="c1"># only allow a deploy with passing tests to deployed</span>
</span><span class='line'>  <span class="n">before</span> <span class="ss">:deploy</span><span class="p">,</span> <span class="s2">&quot;deploy:run_tests&quot;</span>
</span><span class='line'>  <span class="c1"># compile assets locally then rsync</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:symlink:shared&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:compile_assets_locally&#39;</span>
</span><span class='line'>  <span class="n">after</span> <span class="ss">:finishing</span><span class="p">,</span> <span class="s1">&#39;deploy:cleanup&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># remove the default nginx configuration as it will tend</span>
</span><span class='line'>  <span class="c1"># to conflict with our configs.</span>
</span><span class='line'>  <span class="n">before</span> <span class="s1">&#39;deploy:setup_config&#39;</span><span class="p">,</span> <span class="s1">&#39;nginx:remove_default_vhost&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># reload nginx to it will pick up any modified vhosts from</span>
</span><span class='line'>  <span class="c1"># setup_config</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:setup_config&#39;</span><span class="p">,</span> <span class="s1">&#39;nginx:reload&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Restart monit so it will pick up any monit configurations</span>
</span><span class='line'>  <span class="c1"># we&#39;ve added</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:setup_config&#39;</span><span class="p">,</span> <span class="s1">&#39;monit:restart&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># As of Capistrano 3.1, the `deploy:restart` task is not called</span>
</span><span class='line'>  <span class="c1"># automatically.</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:publishing&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:restart&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We changed the following things,
1. We changed the <em>application</em> to <strong>deploy_sample</strong>, which is our application name
2. We changed <em>repo_url</em> to <strong>git@github.com:climber2002/deploy_sample.git</strong>, which is our git repository
3. We changed the <em>rbenv_type</em> from <strong>:system</strong> to <strong>:user</strong>, and <em>rbenv_ruby</em> to <strong>2.1.4</strong>, which is the version we installed just now
4. We changed the <em>linked_files</em> to add secrets.yml, the linked files will be stored in share folder but they will be created a symbolic link in config folder.
5. We changed the config_files to add secrets.yml, since we also want to copy this file to shared folder.</p>

<p>Now let&rsquo;s update <em>config/deploy/production.rb</em> file as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:stage</span><span class="p">,</span> <span class="ss">:production</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This is used in the Nginx VirtualHost to specify which domains</span>
</span><span class='line'><span class="c1"># the app should appear on. If you don&#39;t yet have DNS setup, you&#39;ll</span>
</span><span class='line'><span class="c1"># need to create entries in your local Hosts file for testing.</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:server_name</span><span class="p">,</span> <span class="s2">&quot;www.example.com example.com&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># used in case we&#39;re deploying multiple versions of the same</span>
</span><span class='line'><span class="c1"># app side by side. Also provides quick sanity checks when looking</span>
</span><span class='line'><span class="c1"># at filepaths</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:full_app_name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:application</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:stage</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">server</span> <span class="s1">&#39;192.168.22.10&#39;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="sx">%w{web app db}</span><span class="p">,</span> <span class="ss">primary</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/product/</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:full_app_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># dont try and infer something as important as environment from</span>
</span><span class='line'><span class="c1"># stage name.</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rails_env</span><span class="p">,</span> <span class="ss">:production</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># number of unicorn workers, this will be reflected in</span>
</span><span class='line'><span class="c1"># the unicorn.rb and the monit configs</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:unicorn_worker_count</span><span class="p">,</span> <span class="mi">5</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># whether we&#39;re using ssl or not, used for building nginx</span>
</span><span class='line'><span class="c1"># config file</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:enable_ssl</span><span class="p">,</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>We changed following things for this file
1. We changed the <em>server</em> to <strong>192.168.22.10</strong>, which is our VM IP address.
2. We changed <em>deploy_to</em> to <strong>/product/#{fetch(:full_app_name)}</strong> since we want to deploy to <strong>/product</strong> folder.</p>

<p>During real deployment you should also change the <em>server_name</em> to the correct domain name for your server.</p>

<p>Now let&rsquo;s run the command to setup deploy.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>bundle <span class="nb">exec </span>cap production deploy:setup_config
</span></code></pre></td></tr></table></div></figure>


<p>This step will copy all shared folders to <strong>/product/deploy_sample_production/shared/config</strong> folder, let&rsquo;s check that folder in our VM,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~/.ssh<span class="nv">$ </span><span class="nb">cd</span> /product/deploy_sample_production/shared/config
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:/product/deploy_sample_production/shared/config<span class="nv">$ </span>ls -l
</span><span class='line'>total 28
</span><span class='line'>-rw-r----- 1 deploy sudo  203 Feb 10 04:45 database.example.yml
</span><span class='line'>-rw-r----- 1 deploy sudo  188 Feb 10 04:45 log_rotation
</span><span class='line'>-rw-r----- 1 deploy sudo 2629 Feb 10 04:45 monit
</span><span class='line'>-rw-r----- 1 deploy sudo  645 Feb 10 04:45 nginx.conf
</span><span class='line'>-rw-r----- 1 deploy sudo  935 Feb 10 04:45 secrets.yml
</span><span class='line'>-rwxr-x--x 1 deploy sudo 2001 Feb 10 04:45 unicorn_init.sh
</span><span class='line'>-rw-r----- 1 deploy sudo 1333 Feb 10 04:45 unicorn.rb
</span></code></pre></td></tr></table></div></figure>


<p>We can see that some files are copied to the <strong>/product/deploy_sample_production/shared/config</strong> folder. Now we need to update the database.yml and secrets.yml.</p>

<p>For database.yml, let&rsquo;s firstly copy the database.example.yml to database.yml</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:/product/deploy_sample_production/shared/config<span class="nv">$ </span>cp database.example.yml database.yml
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:/product/deploy_sample_production/shared/config<span class="nv">$ </span>vi database.yml
</span></code></pre></td></tr></table></div></figure>


<p>We changed the content as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgresql</span>
</span><span class='line'>  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5000</span>
</span><span class='line'>  <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">utf8</span>
</span><span class='line'>  <span class="l-Scalar-Plain">reconnect</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deploy_sample_production</span>
</span><span class='line'>  <span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deploy_sample</span>
</span><span class='line'>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">secret</span>
</span><span class='line'>  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>  <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5432</span>
</span></code></pre></td></tr></table></div></figure>


<p>We set the username and password to the value we created in Part 1, and also we set host to localhost since we installed database and application on same server.</p>

<p>Now we need to update secrets.yml, firstly lets generate a secret from our project folder</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>rake secret
</span><span class='line'>9f529340b1a34f223cb7a6fd2cf0d0d039ed5d03fe3d2b2787cc712585ffcee22e14e6136486356b12f383bc48f231896d556da131bd8c8d8bcf17bbc9ef7048
</span></code></pre></td></tr></table></div></figure>


<p>Now we copy this value to secrets.yml, of course you can also use an environment variable. After update our secrets.yml look like this,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">75b397c3479019e0d5b2c7e3f57660c501369ffa4232958bcde366dc08e86b2f227fb1a57e172eccafc37fcfd5616909d4105d0d07069a4d061abf58a5745eef</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">351180e5d983a83fa207f7df16e8509ad55910bab6d4e7a9e94dd3e80f8385fc8d8f5b1101fd2e565d2a0afb340917ac245d2ef69e00686e6eb6044ad92b3104</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Do not keep production secrets in the repository,</span>
</span><span class='line'><span class="c1"># instead read values from the environment.</span>
</span><span class='line'><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9f529340b1a34f223cb7a6fd2cf0d0d039ed5d03fe3d2b2787cc712585ffcee22e14e6136486356b12f383bc48f231896d556da131bd8c8d8bcf17bbc9ef7048</span>
</span></code></pre></td></tr></table></div></figure>


<p>the production:secret_key_base is set to the value we just created.</p>

<p>Now all preparation has been done, now let&rsquo;s do the deploy!</p>

<p>Let&rsquo;s run following command,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>bundle <span class="nb">exec </span>cap production deploy
</span></code></pre></td></tr></table></div></figure>


<p>If everything runs correctly, after a long logs the deployment should be successful. And from your browser you can access <a href="http://192.168.22.10/articles">http://192.168.22.10/articles</a> to see the Article scaffold we&rsquo;ve created.</p>

<p><img src="/images/deploy_sample.png"></p>

<h2>Summary</h2>

<p>In this part we&rsquo;ve introduced the steps to deploy by using Capistrano 3. And we utilized a Capistrano template. But you may be wondering what Capistrano has done for us. So in next part I will introduct what has been done in this template.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/06/14/calling-google-content-api-for-shopping-by-using-ruby/">Calling Google Content API for shopping by using Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/06/digging-rails-how-rails-finds-your-templates-part-4/">Digging Rails: How Rails finds your templates Part 4</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/30/book-review-sql-performance-explained-everything-developers-need-to-know-about-sql-performance/">Book Review: SQL Performance Explained Everything Developers Need to Know about SQL Performance</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/29/customize-devise-to-support-subdomain-authentication/">Customize Devise to support Multitenancy authentication</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/22/digging-rails-how-rails-finds-your-templates-part-3/">Digging Rails: How Rails finds your templates Part 3</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Andy Wang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'climber2002';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
