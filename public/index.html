
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>AprilTouch</title>
  <meta name="author" content="Andy Wang">

  
  <meta name="description" content="In Part 1 we have installed Nginx PostgreSQL, and also Monit. In this part I will show how to deploy the application through capistrano. In this part &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://climber2002.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="AprilTouch" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-51109944-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">AprilTouch</a></h1>
  
    <h2>My blog about Ruby and iOS development</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:climber2002.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/">Deploy Rails Application on Ubuntu 14.04 Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-09T21:27:23+10:30" pubdate data-updated="true">Feb 9<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In <a href="http://climber2002.github.io/blog/2015/02/08/deploy-rails-application-on-ubuntu-14-dot-04/">Part 1</a> we have installed Nginx PostgreSQL, and also Monit. In this part I will show how to deploy the application through capistrano.</p>

<p>In this part we will execute many commands, some will be executed in the host machine (our Laptop or iMac for example), and some will be executed in the Vagrant VM. I will show different prompt when executing. On host machine the prompt will be like <strong>host:~/rails_projects/deploy_sample$</strong>, and on VM the prompt will be <strong>vagrant@vagrant-ubuntu-trusty-64:~$</strong>, or if we su as deploy, it will be <strong>deploy@vagrant-ubuntu-trusty-64:~$</strong></p>

<h1>Create deploy user</h1>

<p>Just like we use an user <em>postgres</em> to manage our database, we should also use a standalone user to manage our application. We name this user <em>deploy</em>. And now let&rsquo;s create this user.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo adduser --ingroup sudo deploy
</span><span class='line'>Adding user <span class="sb">`</span>deploy<span class="s1">&#39; ...</span>
</span><span class='line'><span class="s1">Adding new user `deploy&#39;</span> <span class="o">(</span>1002<span class="o">)</span> with group <span class="sb">`</span>sudo<span class="s1">&#39; ...</span>
</span><span class='line'><span class="s1">Creating home directory `/home/deploy&#39;</span> ...
</span><span class='line'>Copying files from <span class="sb">`</span>/etc/skel<span class="err">&#39;</span> ...
</span><span class='line'>Enter new UNIX password:
</span><span class='line'>Retype new UNIX password:
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>Changing the user information <span class="k">for </span>deploy
</span><span class='line'>Enter the new value, or press ENTER <span class="k">for </span>the default
</span><span class='line'>  Full Name <span class="o">[]</span>:
</span><span class='line'>  Room Number <span class="o">[]</span>:
</span><span class='line'>  Work Phone <span class="o">[]</span>:
</span><span class='line'>  Home Phone <span class="o">[]</span>:
</span><span class='line'>  Other <span class="o">[]</span>:
</span><span class='line'>Is the information correct? <span class="o">[</span>Y/n<span class="o">]</span> Y
</span></code></pre></td></tr></table></div></figure>


<p>Set a password for <em>deploy</em> user and accept all default options.</p>

<p>Since we already add <em>deploy</em> user to sudo group. It can run sudo commands. However the user needs to input his password. When we run the capistrano deploy command later, it will run sudo commands. So I want to update this user so he doesn&rsquo;t need to type password when run sodo commands. For this we need to update the <strong>/etc/sudoers</strong> file. It&rsquo;s recommended to use the application <strong>visudo</strong> to update it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo visodu
</span></code></pre></td></tr></table></div></figure>


<p>Add the following line to this file, and then type <em>Ctrl + O</em> to save it as /etc/sudoers, and type <em>Ctrl + X</em> to exit.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy  <span class="nv">ALL</span><span class="o">=(</span>ALL:ALL<span class="o">)</span> NOPASSWD:ALL
</span></code></pre></td></tr></table></div></figure>


<p>Notice that since we already add <em>deploy</em> user to sudo group, this line should be added under the line <strong>%sudo   ALL=(ALL:ALL) ALL</strong> so it will take effect.</p>

<p>Our deployment organization is like following figure,</p>

<p><img src="/images/deploy_structure.png"></p>

<p>Our host communicates with VM by SSH, and also when the VM sync code from github, it also uses SSH. So we need two public/private keypairs here.</p>

<p>Let&rsquo;s firstly generate a keypair for <em>deploy</em> user in VM. The public key for this keypair will be configured in github so the VM can download code from github.</p>

<p>Let&rsquo;s firstly su as deploy</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>su deploy
</span><span class='line'>Password:
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:/home/vagrant<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we go to the ~/.ssh folder and create a keypair.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:/home/vagrant<span class="nv">$ </span><span class="nb">cd</span> ~
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>mkdir .ssh
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span><span class="nb">cd</span> .ssh
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>ssh-keygen -t rsa -b 4096 -C climber2002@gmail.com
</span></code></pre></td></tr></table></div></figure>


<p>Accept default options, and after generation two files should be created, <strong>id_rsa</strong> and <strong>id_rsa.pub</strong>.</p>

<p>We can run <strong>cat id_rsa.pub</strong> and copy its content, and then configure this key in github.</p>

<p>In github, choose Settings &ndash;> SSH keys &ndash;> Add SSH key, and paste the public key, as the following snapshot.</p>

<p><img src="/images/github_add_ssh_key.png"></p>

<p>Now we need to add the key of our host to the Vagrant VM.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host<span class="nv">$ </span>ls -l ~/.ssh
</span><span class='line'>-rw-------  1 andywang  staff  1679 Jun 25  2014 id_rsa
</span><span class='line'>-rw-r--r--  1 andywang  staff   403 Jun 25  2014 id_rsa.pub
</span></code></pre></td></tr></table></div></figure>


<p>Normally you should already have <strong>id_rsa</strong> and <strong>id_rsa.pub</strong>. If not run the <em>ssh-keygen</em> again in host to generate the SSH key.</p>

<p>And then lets copy the content of id_rsa.pub and copy it to VM&rsquo;s <strong>~/.ssh/authorized_keys</strong>. If this file doesn&rsquo;t exist, create it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~/.ssh<span class="nv">$ </span>vi authorized_keys
</span></code></pre></td></tr></table></div></figure>


<p>And also I updated the ssh config file <strong>/etc/ssh/sshd_config</strong> and changed the <strong>PasswordAuthentication yes</strong> to <strong>PasswordAuthentication no</strong> so we disable the password authentication.</p>

<p>After that let&rsquo;s restart ssh service</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~/.ssh<span class="nv">$ </span>sudo service ssh restart
</span></code></pre></td></tr></table></div></figure>


<p>Now from your host server, you should be able to ssh into the Vagrant VM.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host<span class="nv">$ </span>ssh deploy@192.168.22.10
</span><span class='line'>
</span><span class='line'>The authenticity of host <span class="s1">&#39;192.168.22.10 (192.168.22.10)&#39;</span> can<span class="s1">&#39;t be established.</span>
</span><span class='line'><span class="s1">RSA key fingerprint is b1:e4:e0:42:a1:37:0b:04:d3:88:8c:42:15:aa:00:b4.</span>
</span><span class='line'><span class="s1">Are you sure you want to continue connecting (yes/no)? yes</span>
</span><span class='line'><span class="s1">Warning: Permanently added &#39;</span>192.168.22.10<span class="err">&#39;</span> <span class="o">(</span>RSA<span class="o">)</span> to the list of known hosts.
</span><span class='line'>Welcome to Ubuntu 14.04.1 LTS <span class="o">(</span>GNU/Linux 3.13.0-45-generic x86_64<span class="o">)</span>
</span><span class='line'>
</span><span class='line'> * Documentation:  https://help.ubuntu.com/
</span><span class='line'>
</span><span class='line'>  System information as of Mon Feb  9 12:25:47 UTC 2015
</span><span class='line'>
</span><span class='line'>  System load:  0.0               Processes:           96
</span><span class='line'>  Usage of /:   3.1% of 39.34GB   Users logged in:     2
</span><span class='line'>  Memory usage: 33%               IP address <span class="k">for </span>eth0: 10.0.2.15
</span><span class='line'>  Swap usage:   0%                IP address <span class="k">for </span>eth1: 192.168.22.10
</span><span class='line'>
</span><span class='line'>  Graph this data and manage this system at:
</span><span class='line'>    https://landscape.canonical.com/
</span><span class='line'>
</span><span class='line'>  Get cloud support with Ubuntu Advantage Cloud Guest:
</span><span class='line'>    http://www.ubuntu.com/business/services/cloud
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Last login: Mon Feb  9 12:25:48 2015 from 192.168.22.1
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo ls
</span></code></pre></td></tr></table></div></figure>


<h1>Rbenv</h1>

<p>Now we install the Rbenv. We will use <a href="https://github.com/fesplugas/rbenv-installer">Rbenv installer</a> to ease our installation. Since we will use <em>deploy</em> user as our application owner. Make sure you firstly su as <em>deploy</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>curl https://raw.githubusercontent.com/fesplugas/rbenv-installer/master/bin/rbenv-installer | bash
</span></code></pre></td></tr></table></div></figure>


<p>After the installation is complete, add following lines to <em>~/.bashrc</em>, pay attention that you need to add it at the top of the file. Since the script will return if it&rsquo;s not running interactively.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">RBENV_ROOT</span><span class="o">=</span><span class="s2">&quot;${HOME}/.rbenv&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;${RBENV_ROOT}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;${RBENV_ROOT}/bin:${PATH}&quot;</span>
</span><span class='line'>  <span class="nb">eval</span> <span class="s2">&quot;$(rbenv init -)&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>After we run <strong>. ~/.bashrc</strong> to take the change into effect.</p>

<p>Now we need to install some required packages on Ubuntu.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>rbenv bootstrap-ubuntu-12-04
</span></code></pre></td></tr></table></div></figure>


<p>After the necessary packages are installed, lets install Ruby 2.1.4</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>rbenv install 2.1.4
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>rbenv global 2.1.4
</span></code></pre></td></tr></table></div></figure>


<p>This will download and compile Ruby 2.1.4 so it will take some time. Let&rsquo;s grab a cup of coffee~~</p>

<h1>Install bundler</h1>

<p>After installed ruby 2.1.4 let&rsquo;s install bundler</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>gem install bundler
</span></code></pre></td></tr></table></div></figure>


<h1>Create the application directory</h1>

<p>For my application, I want to deploy the application in <strong>/product</strong> folder, so let&rsquo;s create that folder and change the owner to <em>deploy</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo mkdir /product
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo chown -R deploy:sudo /product
</span></code></pre></td></tr></table></div></figure>


<h1>Deploy with Capistrano</h1>

<p>Now we will try to deploy with Capistrano. We will use the <a href="https://github.com/TalkingQuickly/capistrano-3-rails-template">capistrano 3 template</a> to help us. Don&rsquo;t worry if you don&rsquo;t fully understand, I will explain it in next part.</p>

<p>Now firstly let&rsquo;s clone the capistrano template in our host station. For me, both this project and the <em>deploy_sample</em> project are in the same folder which is <em>~/rails_projects</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects<span class="nv">$ </span>git clone https://github.com/TalkingQuickly/capistrano-3-rails-template.git
</span></code></pre></td></tr></table></div></figure>


<p>And then in <em>Gemfile</em> of our <em>deploy_sample</em> project, let&rsquo;s add the necessary gems.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Use Unicorn as the app server</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;unicorn&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.1.0&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># rails specific capistrano funcitons</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 1.1.0&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># integrate bundler with capistrano</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-bundler&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># if you are using RBENV</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-rbenv&#39;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 2.0&quot;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that let&rsquo;s run <strong>bundle install</strong> to install all the gems.</p>

<p>The capistrano 3 templates added some customized tasks, so lets copy all the files from the template to our project.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp ../capistrano-3-rails-template/Capfile .
</span><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp -r ../capistrano-3-rails-template/config/ ./config
</span><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp -r ../capistrano-3-rails-template/lib/ ./lib
</span></code></pre></td></tr></table></div></figure>


<h2>Copy secrets.yml</h2>

<p>The Capistrano templates has some template files in <em>config/shared</em> folder, these files will be copied to a shared folder in VM when we run the task <strong>deploy:setup_config</strong>. Notice that we also want <em>secrets.yml</em> to be in the shared folder, so it won&rsquo;t be committed in our git repository. So let&rsquo;s copy this file into shared folder also. We change the filename to secrets.yml.erb as the task will render the erb file to secrets.yml during setup.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp config/secrets.yml config/deploy/shared/secrets.yml.erb
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to update the <em>config/deploy.rb</em> file as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s1">&#39;deploy_sample&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_user</span><span class="p">,</span> <span class="s1">&#39;deploy&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># setup repo details</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span> <span class="ss">:git</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:repo_url</span><span class="p">,</span> <span class="s1">&#39;git@github.com:climber2002/deploy_sample.git&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># setup rbenv.</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_type</span><span class="p">,</span> <span class="ss">:user</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_ruby</span><span class="p">,</span> <span class="s1">&#39;2.1.4&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_prefix</span><span class="p">,</span> <span class="s2">&quot;RBENV_ROOT=</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> RBENV_VERSION=</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_ruby</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_path</span><span class="p">)</span><span class="si">}</span><span class="s2">/bin/rbenv exec&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_map_bins</span><span class="p">,</span> <span class="sx">%w{rake gem bundle ruby rails}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># how many old releases do we want to keep, not much</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:keep_releases</span><span class="p">,</span> <span class="mi">5</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># files we want symlinking to specific entries in shared</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:linked_files</span><span class="p">,</span> <span class="sx">%w{config/database.yml config/secrets.yml}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># dirs we want symlinking to shared</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:linked_dirs</span><span class="p">,</span> <span class="sx">%w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># what specs should be run before deployment is allowed to</span>
</span><span class='line'><span class="c1"># continue, see lib/capistrano/tasks/run_tests.cap</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:tests</span><span class="p">,</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># which config files should be copied by deploy:setup_config</span>
</span><span class='line'><span class="c1"># see documentation in lib/capistrano/tasks/setup_config.cap</span>
</span><span class='line'><span class="c1"># for details of operations</span>
</span><span class='line'><span class="n">set</span><span class="p">(</span><span class="ss">:config_files</span><span class="p">,</span> <span class="sx">%w(</span>
</span><span class='line'><span class="sx">  nginx.conf</span>
</span><span class='line'><span class="sx">  database.example.yml</span>
</span><span class='line'><span class="sx">  log_rotation</span>
</span><span class='line'><span class="sx">  monit</span>
</span><span class='line'><span class="sx">  unicorn.rb</span>
</span><span class='line'><span class="sx">  unicorn_init.sh</span>
</span><span class='line'><span class="sx">  secrets.yml</span>
</span><span class='line'><span class="sx">)</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># which config files should be made executable after copying</span>
</span><span class='line'><span class="c1"># by deploy:setup_config</span>
</span><span class='line'><span class="n">set</span><span class="p">(</span><span class="ss">:executable_config_files</span><span class="p">,</span> <span class="sx">%w(</span>
</span><span class='line'><span class="sx">  unicorn_init.sh</span>
</span><span class='line'><span class="sx">)</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1"># files which need to be symlinked to other parts of the</span>
</span><span class='line'><span class="c1"># filesystem. For example nginx virtualhosts, log rotation</span>
</span><span class='line'><span class="c1"># init scripts etc. The full_app_name variable isn&#39;t</span>
</span><span class='line'><span class="c1"># available at this point so we use a custom template </span>
</span><span class='line'><span class="c1"># tag and then add it at run time.</span>
</span><span class='line'><span class="n">set</span><span class="p">(</span><span class="ss">:symlinks</span><span class="p">,</span> <span class="o">[</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;nginx.conf&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/nginx/sites-enabled/&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;unicorn_init.sh&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/init.d/unicorn_&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;log_rotation&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/logrotate.d/&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;monit&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/monit/conf.d/.conf&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># this:</span>
</span><span class='line'><span class="c1"># http://www.capistranorb.com/documentation/getting-started/flow/</span>
</span><span class='line'><span class="c1"># is worth reading for a quick overview of what tasks are called</span>
</span><span class='line'><span class="c1"># and when for `cap stage deploy`</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># make sure we&#39;re deploying what we think we&#39;re deploying</span>
</span><span class='line'>  <span class="n">before</span> <span class="ss">:deploy</span><span class="p">,</span> <span class="s2">&quot;deploy:check_revision&quot;</span>
</span><span class='line'>  <span class="c1"># only allow a deploy with passing tests to deployed</span>
</span><span class='line'>  <span class="n">before</span> <span class="ss">:deploy</span><span class="p">,</span> <span class="s2">&quot;deploy:run_tests&quot;</span>
</span><span class='line'>  <span class="c1"># compile assets locally then rsync</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:symlink:shared&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:compile_assets_locally&#39;</span>
</span><span class='line'>  <span class="n">after</span> <span class="ss">:finishing</span><span class="p">,</span> <span class="s1">&#39;deploy:cleanup&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># remove the default nginx configuration as it will tend</span>
</span><span class='line'>  <span class="c1"># to conflict with our configs.</span>
</span><span class='line'>  <span class="n">before</span> <span class="s1">&#39;deploy:setup_config&#39;</span><span class="p">,</span> <span class="s1">&#39;nginx:remove_default_vhost&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># reload nginx to it will pick up any modified vhosts from</span>
</span><span class='line'>  <span class="c1"># setup_config</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:setup_config&#39;</span><span class="p">,</span> <span class="s1">&#39;nginx:reload&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Restart monit so it will pick up any monit configurations</span>
</span><span class='line'>  <span class="c1"># we&#39;ve added</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:setup_config&#39;</span><span class="p">,</span> <span class="s1">&#39;monit:restart&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># As of Capistrano 3.1, the `deploy:restart` task is not called</span>
</span><span class='line'>  <span class="c1"># automatically.</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:publishing&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:restart&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We changed the following things,
1. We changed the <em>application</em> to <strong>deploy_sample</strong>, which is our application name
2. We changed <em>repo_url</em> to <strong>git@github.com:climber2002/deploy_sample.git</strong>, which is our git repository
3. We changed the <em>rbenv_type</em> from <strong>:system</strong> to <strong>:user</strong>, and <em>rbenv_ruby</em> to <strong>2.1.4</strong>, which is the version we installed just now
4. We changed the <em>linked_files</em> to add secrets.yml, the linked files will be stored in share folder but they will be created a symbolic link in config folder.
5. We changed the config_files to add secrets.yml, since we also want to copy this file to shared folder.</p>

<p>Now let&rsquo;s update <em>config/deploy/production.rb</em> file as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:stage</span><span class="p">,</span> <span class="ss">:production</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This is used in the Nginx VirtualHost to specify which domains</span>
</span><span class='line'><span class="c1"># the app should appear on. If you don&#39;t yet have DNS setup, you&#39;ll</span>
</span><span class='line'><span class="c1"># need to create entries in your local Hosts file for testing.</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:server_name</span><span class="p">,</span> <span class="s2">&quot;www.example.com example.com&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># used in case we&#39;re deploying multiple versions of the same</span>
</span><span class='line'><span class="c1"># app side by side. Also provides quick sanity checks when looking</span>
</span><span class='line'><span class="c1"># at filepaths</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:full_app_name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:application</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:stage</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">server</span> <span class="s1">&#39;192.168.22.10&#39;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="sx">%w{web app db}</span><span class="p">,</span> <span class="ss">primary</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/product/</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:full_app_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># dont try and infer something as important as environment from</span>
</span><span class='line'><span class="c1"># stage name.</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rails_env</span><span class="p">,</span> <span class="ss">:production</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># number of unicorn workers, this will be reflected in</span>
</span><span class='line'><span class="c1"># the unicorn.rb and the monit configs</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:unicorn_worker_count</span><span class="p">,</span> <span class="mi">5</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># whether we&#39;re using ssl or not, used for building nginx</span>
</span><span class='line'><span class="c1"># config file</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:enable_ssl</span><span class="p">,</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>We changed following things for this file
1. We changed the <em>server</em> to <strong>192.168.22.10</strong>, which is our VM IP address.
2. We changed <em>deploy_to</em> to <strong>/product/#{fetch(:full_app_name)}</strong> since we want to deploy to <strong>/product</strong> folder.</p>

<p>During real deployment you should also change the <em>server_name</em> to the correct domain name for your server.</p>

<p>Now let&rsquo;s run the command to setup deploy.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>bundle <span class="nb">exec </span>cap production deploy:setup_config
</span></code></pre></td></tr></table></div></figure>


<p>This step will copy all shared folders to <strong>/product/deploy_sample_production/shared/config</strong> folder, let&rsquo;s check that folder in our VM,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~/.ssh<span class="nv">$ </span><span class="nb">cd</span> /product/deploy_sample_production/shared/config
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:/product/deploy_sample_production/shared/config<span class="nv">$ </span>ls -l
</span><span class='line'>total 28
</span><span class='line'>-rw-r----- 1 deploy sudo  203 Feb 10 04:45 database.example.yml
</span><span class='line'>-rw-r----- 1 deploy sudo  188 Feb 10 04:45 log_rotation
</span><span class='line'>-rw-r----- 1 deploy sudo 2629 Feb 10 04:45 monit
</span><span class='line'>-rw-r----- 1 deploy sudo  645 Feb 10 04:45 nginx.conf
</span><span class='line'>-rw-r----- 1 deploy sudo  935 Feb 10 04:45 secrets.yml
</span><span class='line'>-rwxr-x--x 1 deploy sudo 2001 Feb 10 04:45 unicorn_init.sh
</span><span class='line'>-rw-r----- 1 deploy sudo 1333 Feb 10 04:45 unicorn.rb
</span></code></pre></td></tr></table></div></figure>


<p>We can see that some files are copied to the <strong>/product/deploy_sample_production/shared/config</strong> folder. Now we need to update the database.yml and secrets.yml.</p>

<p>For database.yml, let&rsquo;s firstly copy the database.example.yml to database.yml</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:/product/deploy_sample_production/shared/config<span class="nv">$ </span>cp database.example.yml database.yml
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:/product/deploy_sample_production/shared/config<span class="nv">$ </span>vi database.yml
</span></code></pre></td></tr></table></div></figure>


<p>We changed the content as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgresql</span>
</span><span class='line'>  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5000</span>
</span><span class='line'>  <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">utf8</span>
</span><span class='line'>  <span class="l-Scalar-Plain">reconnect</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deploy_sample_production</span>
</span><span class='line'>  <span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deploy_sample</span>
</span><span class='line'>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">secret</span>
</span><span class='line'>  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>  <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5432</span>
</span></code></pre></td></tr></table></div></figure>


<p>We set the username and password to the value we created in Part 1, and also we set host to localhost since we installed database and application on same server.</p>

<p>Now we need to update secrets.yml, firstly lets generate a secret from our project folder</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>rake secret
</span><span class='line'>9f529340b1a34f223cb7a6fd2cf0d0d039ed5d03fe3d2b2787cc712585ffcee22e14e6136486356b12f383bc48f231896d556da131bd8c8d8bcf17bbc9ef7048
</span></code></pre></td></tr></table></div></figure>


<p>Now we copy this value to secrets.yml, of course you can also use an environment variable. After update our secrets.yml look like this,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">75b397c3479019e0d5b2c7e3f57660c501369ffa4232958bcde366dc08e86b2f227fb1a57e172eccafc37fcfd5616909d4105d0d07069a4d061abf58a5745eef</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">351180e5d983a83fa207f7df16e8509ad55910bab6d4e7a9e94dd3e80f8385fc8d8f5b1101fd2e565d2a0afb340917ac245d2ef69e00686e6eb6044ad92b3104</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Do not keep production secrets in the repository,</span>
</span><span class='line'><span class="c1"># instead read values from the environment.</span>
</span><span class='line'><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9f529340b1a34f223cb7a6fd2cf0d0d039ed5d03fe3d2b2787cc712585ffcee22e14e6136486356b12f383bc48f231896d556da131bd8c8d8bcf17bbc9ef7048</span>
</span></code></pre></td></tr></table></div></figure>


<p>the production:secret_key_base is set to the value we just created.</p>

<p>Now all preparation has been done, now let&rsquo;s do the deploy!</p>

<p>Let&rsquo;s run following command,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>bundle <span class="nb">exec </span>cap production deploy
</span></code></pre></td></tr></table></div></figure>


<p>If everything runs correctly, after a long logs the deployment should be successful. And from your browser you can access <a href="http://192.168.22.10/articles">http://192.168.22.10/articles</a> to see the Article scaffold we&rsquo;ve created.</p>

<p><img src="/images/deploy_sample.png"></p>

<h1>Summary</h1>

<p>In this part we&rsquo;ve introduced the steps to deploy by using Capistrano 3. And we utilized a Capistrano template. But you may be wondering what Capistrano has done for us. So in next part I will introduct what has been done in this template.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/08/deploy-rails-application-on-ubuntu-14-dot-04/">Deploy Rails Application on Ubuntu 14.04 Part 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-08T22:03:52+10:30" pubdate data-updated="true">Feb 8<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/08/deploy-rails-application-on-ubuntu-14-dot-04/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In <a href="http://climber2002.github.io/blog/2014/09/07/depoly-a-rails-4-application-on-an-amazon-ec2-server/">one of my previous post</a> I described how to do the deployment manually on an Amazon EC2 server. And in this new series of posts I want to introduce how to deploy a Ruby on Rails 4.2 application on a Ubuntu 14.04 server from start to finish. I know there are lots of tutorials on the internet and even several books on deploying rails, however they are either outdated or not very clear how to do the deployment step by step. So in this series I will try to describe as clear as possible for each step.</p>

<p>In this first part I will describe how to install the web server and database. Here I will use Nginx, Unicorn and PostgreSQL.</p>

<h1>Application</h1>

<p>To demonstrate the deployment, I will create a sample Rails 4.2 application called deploy_sample.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails _4.2_ new deploy_sample -d postgresql
</span></code></pre></td></tr></table></div></figure>


<p>And then I update the .gitignore file to exclude database.yml and secrets.yml from committing to repository.</p>

<p>Add the following lines to .gitignore</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/config/database.yml
</span><span class='line'>/config/secrets.yml</span></code></pre></td></tr></table></div></figure>


<p>And then we copy the database.yml and secrets.yml to an example yml so let&rsquo;s say if your colleagues need to work on this project, they could copy the example yml back and set their configurations.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cp ./config/database.yml ./config/database.example.yml
</span><span class='line'><span class="nv">$ </span>cp ./config/secrets.yml ./config/secrets.example.yml
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s init the git repository and commit our project.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git init
</span><span class='line'><span class="nv">$ </span>git add .
</span><span class='line'><span class="nv">$ </span>git commit -m <span class="s1">&#39;initial commit&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will use github as our remote repository, so let&rsquo;s create a repository on github. And then follow its instructions, let&rsquo;s push the project.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git remote add origin https://github.com/climber2002/deploy_sample.git
</span><span class='line'>git push -u origin master
</span></code></pre></td></tr></table></div></figure>


<p>After that if we refresh the repository on github, we could see the content that we have committed, like the following snapshot.</p>

<p><img src="/images/deploy_sample_github.png"></p>

<p>Now let&rsquo;s create some models, for simplicity I will just create a model called <strong>Article</strong> using scaffold.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bundle <span class="nb">exec </span>rails generate scaffold Article title content:text
</span></code></pre></td></tr></table></div></figure>


<p>We can run the migrations and test the application is ok from accessing *<a href="http://localhost:3000*">http://localhost:3000*</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bundle <span class="nb">exec </span>rake db:create
</span><span class='line'>bundle <span class="nb">exec </span>rake db:migrate
</span><span class='line'>bundle <span class="nb">exec </span>rails s
</span></code></pre></td></tr></table></div></figure>


<p>After we can commit our changes,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git add .
</span><span class='line'>git commit -m <span class="s1">&#39;add Article scaffold&#39;</span>
</span><span class='line'>git push origin master
</span></code></pre></td></tr></table></div></figure>


<p>Now this sample application will be used for our deployment</p>

<h1>Vagrant</h1>

<p>For demonstration I will use Vagrant to create a VM. But it should apply to any VPS too. Firstly you should install VirtualBox and Vagrant. The installation should be straight forward.</p>

<p>Then we create an empty folder in <strong>~/Sites</strong> and init the Vagrant.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir ~/Sites/deploy_sample_vagrant
</span><span class='line'><span class="nb">cd</span> ~/Sites/deploy_sample_vagrant/
</span><span class='line'>vagrant init <span class="s1">&#39;ubuntu/trusty64&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The vagrant init command creates a new file called Vagantfile. This file is configured to use Ubuntu 14.04 LTS server, codenamed “trusty”.</p>

<p>And I want to assign this VM a private IP address, so we can access it from host server later. So open the Vagrantfile and add the following line.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>config.vm.network "private_network", ip: "192.168.22.10"</span></code></pre></td></tr></table></div></figure>


<p>It assigns the IP address &ldquo;192.168.22.10&rdquo; to the VM. Later we can see that we can access the nginx by using this IP address.</p>

<p>Now in this folder we could type <strong>vagrant up</strong> to start the VM. If it&rsquo;s the first time it will take some time as it needs to download the VM image from the internet.</p>

<p>After the VM is up, we could type <strong>vagrant ssh</strong> to ssh into the VM. Notice the prompt will change. If you are not sure whether you are in host server or the VM, just check the prompt.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~$</span></code></pre></td></tr></table></div></figure>


<h1>Install Basic Software</h1>

<p>After our VM is up we could install some basic software.</p>

<p>So in the VM, we type following commands,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get -y update
</span><span class='line'>sudo apt-get -y install curl wget unzip git ack-grep htop vim tmux software-properties-common
</span></code></pre></td></tr></table></div></figure>


<h1>Nginx</h1>

<p>Now let&rsquo;s install Nginx. As the default Nginx distribution may be out of date, let&rsquo;s add Nginx repository and install it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo add-apt-repository ppa:nginx/stable
</span><span class='line'>sudo apt-get -y update
</span><span class='line'>sudo apt-get -y install nginx
</span></code></pre></td></tr></table></div></figure>


<p>After installation Nginx should start automatically. We could check its status by executing <strong>sudo service nginx status</strong>. And we could also access <a href="http://192.168.22.10">http://192.168.22.10</a> from our browser.</p>

<p><img src="/images/nginx.png"></p>

<h1>PostgreSQL</h1>

<p>Now let&rsquo;s install PostgreSQL. And again we add another repository.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo add-apt-repository ppa:pitti/postgresql
</span><span class='line'>sudo apt-get -y update
</span><span class='line'>sudo apt-get -y install postgresql libpq-dev
</span></code></pre></td></tr></table></div></figure>


<p>The libpq-dev library is needed for building the &lsquo;pg&rsquo; rubygem.</p>

<p>Installing PostgreSQL will create a user named &lsquo;postgres&rsquo;. This user is the owner of PostgreSQL.</p>

<p>Let&rsquo;s create a password for postgres.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo passwd postgres
</span><span class='line'>Enter new UNIX password:
</span><span class='line'>Retype new UNIX password:
</span><span class='line'>passwd: password updated successfully
</span></code></pre></td></tr></table></div></figure>


<p>In PostgreSQL the user is represented by a Role. Now let&rsquo;s create a role named <em>deploy_sample</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo -u postgres psql
</span><span class='line'>
</span><span class='line'><span class="nv">postgres</span><span class="o">=</span><span class="c"># create user deploy_sample with password &#39;secret&#39;;</span>
</span><span class='line'>CREATE ROLE
</span><span class='line'><span class="nv">postgres</span><span class="o">=</span><span class="c"># create database deploy_sample_production owner deploy_sample;</span>
</span><span class='line'>CREATE DATABASE
</span><span class='line'><span class="nv">postgres</span><span class="o">=</span><span class="c"># \q</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above lines will create a user <em>deploy_sample</em> and a database <em>deploy_sample_production</em> and set deploy_sample as its owner. The last command <em>\q</em> is to exit psql.</p>

<h1>Monit</h1>

<p>In next part we will use <a href="https://github.com/TalkingQuickly/capistrano-3-rails-template">capistrano template</a> for our deployment. And in that template it will also deploy <a href="http://mmonit.com/monit/">Monit</a>. According to its official website, &ldquo;Monit is a small Open Source utility for managing and monitoring Unix systems. Monit conducts automatic maintenance and repair and can execute meaningful causal actions in error situations.&rdquo;</p>

<p>So let&rsquo;s also install that.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get -y install monit
</span></code></pre></td></tr></table></div></figure>


<p>After installation we can run <strong>sudo service monit status</strong> to confirm that monit service is already started.</p>

<h1>Nodejs</h1>

<p>We need a Javascript runtime so we are going to install Nodejs.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get -y install nodejs
</span></code></pre></td></tr></table></div></figure>


<h1>Summary</h1>

<p>In this part we setup a VM server and installed Nginx and PostgreSQL. In next part we will see how to deploy our rails app by using capistrano.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/07/install-and-configure-postgresql-on-ubuntu-14-dot-04/">Change Data Files Location on Ubuntu 14.04</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-07T20:01:19+10:30" pubdate data-updated="true">Feb 7<span>th</span>, 2015</time>
        
         | <a href="/blog/2015/02/07/install-and-configure-postgresql-on-ubuntu-14-dot-04/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>PostgreSQL</strong> is a very popular database in Rails world. Here I describe how to install and configure it on Ubuntu 14.04 server.</p>

<h1>Install</h1>

<p>Using apt-get to install PostgreSQL is very simple. Just execute the following two commands,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get install postgresql postgresql-contrib
</span></code></pre></td></tr></table></div></figure>


<p>Here on my server it will install PostgreSQL 9.3.</p>

<p>During the installation a user named &lsquo;postgres&rsquo; will be created automatically and this user is used to start postgresql.</p>

<p>So we should change the password of user &lsquo;postgres&rsquo;.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo passwd postgres
</span><span class='line'>Enter new UNIX password:
</span><span class='line'>Retype new UNIX password:
</span><span class='line'>passwd: password updated successfully
</span></code></pre></td></tr></table></div></figure>


<p>The installation will put configuration files in <strong>/etc/postgresql/9.3/main</strong> by default.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:/etc/postgresql/9.3/main<span class="nv">$ </span>ls -la
</span><span class='line'>total 56
</span><span class='line'>drwxr-xr-x 2 postgres postgres  4096 Feb  7 09:26 .
</span><span class='line'>drwxr-xr-x 3 postgres postgres  4096 Feb  7 09:26 ..
</span><span class='line'>-rw-r--r-- 1 postgres postgres   315 Feb  7 09:26 environment
</span><span class='line'>-rw-r--r-- 1 postgres postgres   143 Feb  7 09:26 pg_ctl.conf
</span><span class='line'>-rw-r----- 1 postgres postgres  4649 Feb  7 09:26 pg_hba.conf
</span><span class='line'>-rw-r----- 1 postgres postgres  1636 Feb  7 09:26 pg_ident.conf
</span><span class='line'>-rw-r--r-- 1 postgres postgres 20687 Feb  7 09:26 postgresql.conf
</span><span class='line'>-rw-r--r-- 1 postgres postgres   378 Feb  7 09:26 start.conf
</span></code></pre></td></tr></table></div></figure>


<h1>Configure new data directory</h1>

<p>Sometimes to improve performance, we want put postgres data files in its own disk. For example, we may mount a disk in folder <strong>/database</strong> and we want to put all postgres data file there. So let&rsquo;s do that.</p>

<p>Suppose the <strong>/database</strong> folder already exists. We need to change its owner to postgres firstly.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo chown -R postgres:postgres /database
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to initialize this folder as a data folder</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>su postgres
</span><span class='line'><span class="nv">$ </span>/usr/lib/postgresql/9.3/bin/initdb -D /database
</span></code></pre></td></tr></table></div></figure>


<p>We must su as postgres first since this user also owns the server process.</p>

<p>Now let&rsquo;s stop server by running <strong>sudo service postgresql stop</strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo service postgresql stop
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to update the file <strong>/etc/postgresql/9.3/main/postgresql.conf</strong>,</p>

<p>change <strong>data_directory = &lsquo;/var/lib/postgresql/9.3/main&rsquo;</strong> to <strong>data_directory = &lsquo;/database&rsquo;</strong></p>

<p>PS: You need to stop the server first before updating the data_directory location. Otherwise the stop will fail and you need to kill the process manually.</p>

<p>After update the configuration file we need to restart postgresql server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo service postgresql start
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/22/capybara-integration-tests-with-jquery-selectize/">Capybara Integration Tests With JQuery Selectize</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-22T22:30:13+09:30" pubdate data-updated="true">Sep 22<span>nd</span>, 2014</time>
        
         | <a href="/blog/2014/09/22/capybara-integration-tests-with-jquery-selectize/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently in one of my projects I utilized a popular JQuery plugin called <a href="http://brianreavis.github.io/selectize.js/">Selectize</a>. And I need to do Integration tests by using Capybara. Here is how to simulate some general events of Selectize.</p>

<p>Firstly I use poltergeist Javascript driver, so in my <strong>rails_helper.rb</strong> it has following configurations,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Capybara</span><span class="o">.</span><span class="n">javascript_driver</span> <span class="o">=</span> <span class="ss">:poltergeist</span>
</span><span class='line'>
</span><span class='line'><span class="no">Capybara</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="ss">:prefer_exact</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">ignore_hidden_elements</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/selectize.png"></p>

<p>When a input box is selectized like the figure above, we can check it generates following DOM structure in our HTML,</p>

<p> <img src="/images/selectize_code.png"></p>

<p> The input &lsquo;#properties-input&rsquo; is our original input, it&rsquo;s set &lsquo;display: none&rsquo; css property, and Selectize replaces it with another input, and the &lsquo;div.item&rsquo; contains the items that we already selected, the &lsquo;div.selectize-dropdown&rsquo; is shown as a dropdown when we click the input and lets us to choose another item.</p>

<p> So if we needs to select an item, we could do like this,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">within</span><span class="p">(</span><span class="ss">:xpath</span><span class="p">,</span> <span class="s2">&quot;//input[@id=&#39;properties-input&#39;]/..&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">first</span><span class="p">(</span><span class="s1">&#39;div.selectize-input&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span>
</span><span class='line'>  <span class="n">find</span><span class="p">(</span><span class="s1">&#39;div.option&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Screen Size&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here I use a xpath to find the parent of the input box that we selectized, and then within this parent we click the &lsquo;div.selectize-input&rsquo;, and the dropdown will show and we run <code>find('div.option', :text =&gt; 'Screen Size').click</code> to click the item that contains the text &lsquo;Screen Size&rsquo;.</p>

<p>Selectize also provides Ajax support, when you type something in the input, it could send Ajax requests to server to populate the items. So here we simulate the input,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">within</span><span class="p">(</span><span class="ss">:xpath</span><span class="p">,</span> <span class="s2">&quot;//input[@id=&#39;properties-input&#39;]/..&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">first</span><span class="p">(</span><span class="s1">&#39;div.selectize-input input&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is to simulate input a &lsquo;u&rsquo; character in the input, and if you configure the <strong>load</strong> option, it will send a Ajax request to the server to populate the items.</p>

<p>I&rsquo;ve created a <strong>SelectizeHelpers</strong> class to simulate some common events,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">SelectizeHelpers</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">selectize_click</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">selectize_within</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">first</span><span class="p">(</span><span class="s1">&#39;div.selectize-input&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">select_option</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">selectize_within</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">first</span><span class="p">(</span><span class="s1">&#39;div.selectize-input&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span>
</span><span class='line'>      <span class="n">find</span><span class="p">(</span><span class="s1">&#39;div.option&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">click</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set_text</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">selectize_within</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">first</span><span class="p">(</span><span class="s1">&#39;div.selectize-input input&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">selectize_within</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">within</span><span class="p">(</span><span class="ss">:xpath</span><span class="p">,</span> <span class="s2">&quot;//input[@id=&#39;</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&#39;]/..&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="k">yield</span> <span class="k">if</span> <span class="nb">block_given?</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">include</span> <span class="no">SelectizeHelpers</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:feature</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>selectize_click(id)</code> is to click the selectize input, the <code>select_option</code> is to select an option whose text matches the <strong>text</strong>. And <code>set_text</code> is to set some text in the input.</p>

<p>For the methods above, the <strong>id</strong> we should pass the id of the input that we apply the selectize.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/07/depoly-a-rails-4-application-on-an-amazon-ec2-server/">Depoly a Rails 4 Application on an Amazon EC2 Server</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-07T17:45:05+09:30" pubdate data-updated="true">Sep 7<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/09/07/depoly-a-rails-4-application-on-an-amazon-ec2-server/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this blog I will list the steps needed to deploy a Rails 4 application on an Amazon EC2 server. The OS is Ubuntu Server 14.04 LTS, the database is Postgresql and the web server is Unicorn + Ngnix. Previously I mainly deploy the project on Engine Yard. But this time I need to deploy it on a server manually.</p>

<h2>Updating And Preparing The Operating System</h2>

<h3>Update the Operating System</h3>

<p>Firstly we need to update our OS by running following command,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get update
</span></code></pre></td></tr></table></div></figure>


<h3>Change locale file</h3>

<p>In some cases on my server it shows the following warnings,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>perl: warning: Setting locale failed.   
</span><span class='line'>perl: warning: Please check that your locale settings:   
</span><span class='line'>        LANGUAGE = "en_US:en",   
</span><span class='line'>        LC_ALL = (unset),   
</span><span class='line'>        LC_MESSAGES = "en_US.UTF-8",   
</span><span class='line'>        LANG = "en_US.UTF-8"   
</span><span class='line'>    are supported and installed on your system.</span></code></pre></td></tr></table></div></figure>


<p>The solution is to edit the <strong>/etc/default/locale</strong> and add the following contents,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>LC_ALL=en_US.UTF-8
</span><span class='line'>LANG=en_US.UTF-8</span></code></pre></td></tr></table></div></figure>


<h3>Install the necessary packages</h3>

<p>Next we need to install the following necessary packages by running,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install build-essential openssl libreadline6 libreadline6-dev zlib1g zlib1g-dev libssl-dev git-core python-software-properties nodejs libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev automake libtool bison pkg-config
</span></code></pre></td></tr></table></div></figure>


<p>The <em>python-software-properties</em> allows us to easily manage your distribution and independent software vendor software sources. It will be useful when we install Postgresql and Nginx.</p>

<p>The <em>nodejs</em> is a Javascript runtime for Rails.</p>

<h2>Install rbenv</h2>

<p>Now we need to install a Ruby runtime. I choose rbenv instead of rvm, which is more lightweight for production.</p>

<p>Let&rsquo;s install rbenv by running the following command,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl https://raw.githubusercontent.com/fesplugas/rbenv-installer/master/bin/rbenv-installer | bash
</span></code></pre></td></tr></table></div></figure>


<p>After installation, following its instructions, add the following content at the top of ~/.bash_profile</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">RBENV_ROOT</span><span class="o">=</span><span class="s2">&quot;${HOME}/.rbenv&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;${RBENV_ROOT}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;${RBENV_ROOT}/bin:${PATH}&quot;</span>
</span><span class='line'>  <span class="nb">eval</span> <span class="s2">&quot;$(rbenv init -)&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that run <code>source ~/.bash_profile</code> to make the changed effective.</p>

<p>Now we install Ruby 2.1.2 and make it global by running following commands,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rbenv install 2.1.2 --verbose
</span><span class='line'>rbenv rehash
</span><span class='line'>rbenv global 2.1.2
</span></code></pre></td></tr></table></div></figure>


<p>The install could take a while so grab a cup of coffee.</p>

<p>After Ruby 2.1.2 is installed, we can install bundler by typing,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem install bundler
</span><span class='line'>rbenv rehash
</span></code></pre></td></tr></table></div></figure>


<h2>Install Nginx</h2>

<p>Now let&rsquo;s install Nginx. Let&rsquo;s add the repository of Nginx by typing following command,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-add-repository ppa:nginx/stable
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to invoke <code>sudo apt-get update</code> again since we added a new software source.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get update
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s install Nginx by invoking,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install nginx
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s check Nginx status by typing</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo service nginx status
</span></code></pre></td></tr></table></div></figure>


<p>If it&rsquo;s not running, we can start it by running following command,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo service nginx start
</span></code></pre></td></tr></table></div></figure>


<h2>Install Unicorn</h2>

<p>Now we need to install unicorn if you haven&rsquo;t done so.</p>

<p>Add <code>gem 'unicorn'</code> in your <strong>Gemfile</strong> and run <code>bundle install</code>.</p>

<p>And after that you can run <code>unicorn_rails</code> to start it. The default port of unicorn is 8080.</p>

<p>And then create unicorn config file <strong>config/unicorn.rb</strong> which has following contents,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">working_directory</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;../..&quot;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'><span class="n">worker_processes</span> <span class="mi">5</span>
</span><span class='line'><span class="n">listen</span> <span class="s2">&quot;/tmp/unicorn.sock&quot;</span>
</span><span class='line'><span class="n">timeout</span> <span class="mi">30</span>
</span><span class='line'><span class="n">pid</span> <span class="s2">&quot;/tmp/unicorn_xhoppe.pid&quot;</span>
</span><span class='line'><span class="n">stdout_path</span> <span class="s2">&quot;/data/xhoppe/log/unicorn.log&quot;</span>
</span><span class='line'><span class="n">stderr_path</span> <span class="s2">&quot;/data/xhoppe/log/unicorn.log&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we set worker_processes to 5, and in the server our application will be at <strong>/data/xhoppe</strong>. And the stdout_path and stderr_path are set to <strong>/data/xhoppe/log/unicorn.log</strong>.</p>

<h2>Install Postgresql</h2>

<p>Now let&rsquo;s install Postgresql.</p>

<p>I want to install Postgresql 9.3 but the Postgresql version in default repository is 9.1. So we install Postgresql 9.3 by typing following commands, <a href="http://wiki.postgresql.org/wiki/Apt">refer here</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install wget ca-certificates
</span><span class='line'>wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get upgrade
</span><span class='line'>sudo apt-get install postgresql-9.3 pgadmin3 libpq-dev
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s create a Postgresql role, open psql by running <code>sudo su -c psql postgres</code> and type following commands,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>create role xhoppe with password 'xhoppe_secret';
</span><span class='line'>alter role xhoppe createdb;
</span><span class='line'>alter role xhoppe WITH LOGIN;</span></code></pre></td></tr></table></div></figure>


<h2>Nginx config file</h2>

<p>And then update the <strong>/etc/nginx/sites-enabled/default</strong> file,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>upstream unicorn {
</span><span class='line'> server unix:/tmp/unicorn.sock fail_timeout=0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>server {
</span><span class='line'>  listen 80 default_server;
</span><span class='line'>
</span><span class='line'>  root /data/xhoppe/public;
</span><span class='line'>
</span><span class='line'>  error_page 404 /data/xhoppe/public/404.html;
</span><span class='line'>  error_page 500 502 503 504 /data/xhoppe/public/500.html;
</span><span class='line'>
</span><span class='line'>  location / {
</span><span class='line'>    try_files $uri/index.html $uri @unicorn;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  location @unicorn {
</span><span class='line'>    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class='line'>    proxy_set_header Host $http_host;
</span><span class='line'>    proxy_redirect off;
</span><span class='line'>    proxy_pass http://unicorn;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>The upstream unicorn matches the <code>listen "/tmp/unicorn.sock"</code> in config/unicorn.rb</p>

<p>After that, we need to run <code>service nginx restart</code> to restart nginx.</p>

<h2>Clone project</h2>

<p>Now we use git clone to clone our project in <strong>/data/xhoppe</strong></p>

<p>First we define a <strong>/data/xhoppe/env.sh</strong> which defines some environments,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>XHOPPE_DATABASE_PASSWORD=secret
</span><span class='line'>export XHOPPE_DATABASE_PASSWORD
</span><span class='line'>
</span><span class='line'>SECRET_KEY_BASE=9a5a0316a...
</span><span class='line'>export SECRET_KEY_BASE</span></code></pre></td></tr></table></div></figure>


<p>The <strong>XHOPPE_DATABASE_PASSWORD</strong> is the production database&rsquo;s password. And the SECRET_KEY_BASE is for rails session, which is generated by running <code>rake secret</code>.</p>

<p>After that we can run <code>source env.sh</code> to set these environment variables.</p>

<h2>Running the project.</h2>

<p>Now we can run the project by running</p>

<p><code>unicorn -c config/unicorn.rb -E production -D</code></p>

<p>Now we can access the website from our browser.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/26/digging-rails-how-rails-initializes-itself-part-2/">Digging Rails : How Rails Initializes Itself Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-26T19:51:23+09:30" pubdate data-updated="true">Aug 26<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/08/26/digging-rails-how-rails-initializes-itself-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In <a href="/blog/2014/08/24/digging-rails-how-rails-initializes-itself/">last post</a> we discussed the initialization process when a Rails application starts. And we disucssed in <em>config/environment.rb</em> it calls <code>Rails.application.initialize!</code> to initialize the application. And in this blog we will have a detailed examination what has been done in this method.</p>

<p>Let&rsquo;s have a look what&rsquo;s in that method,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/application.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Engine</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Initialize the application passing the given group. By default, the</span>
</span><span class='line'>    <span class="c1"># group is :default</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize!</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="ss">:default</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>      <span class="k">raise</span> <span class="s2">&quot;Application has been already initialized.&quot;</span> <span class="k">if</span> <span class="vi">@initialized</span>
</span><span class='line'>      <span class="n">run_initializers</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@initialized</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>      <span class="nb">self</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>we can see that it just calls the <code>run_initializers</code> method, this method is actually an instance method in a module called <em>Rails::Initializable</em>. The <em>Rails::Application</em> has following hirarchy,</p>

<p><img src="/images/initializable.png" width="200" height="250"></p>

<p>At the bottom is our Sample::Application class defined in config/application.rb. Its super class is Rails::Application which inherits from Rails::Engine. And Rails::Engine&rsquo;s parent is Rails::Railtie. The <em>Rails::Railtie</em> includes the module <em>Rails::Initializable</em>. The <code>run_initializers</code> method is defined in that module. The Railtie is to manage the initialization and configuration of each module. In Rails each module such as Active Record, Active Support has its own Railtie class which inherits from <em>Rails::Railtie</em>. After this blog you should understand the main functionality of the Railtie.</p>

<p>Let&rsquo;s have a look at the module <em>Rails::Initializable</em>. This module provides a set of methods to manage the order of initialization.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Initializable</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>      <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="no">ClassMethods</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">run_initializers</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="ss">:default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@ran</span><span class="p">)</span>
</span><span class='line'>      <span class="n">initializers</span><span class="o">.</span><span class="n">tsort_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">initializer</span><span class="o">|</span>
</span><span class='line'>        <span class="n">initializer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">initializer</span><span class="o">.</span><span class="n">belongs_to?</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="vi">@ran</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initializers</span>
</span><span class='line'>      <span class="vi">@initializers</span> <span class="o">||=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">initializers_for</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initializers</span>
</span><span class='line'>        <span class="vi">@initializers</span> <span class="o">||=</span> <span class="no">Collection</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initializers_chain</span>
</span><span class='line'>        <span class="n">initializers</span> <span class="o">=</span> <span class="no">Collection</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>        <span class="nb">ancestors</span><span class="o">.</span><span class="n">reverse_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span>
</span><span class='line'>          <span class="k">next</span> <span class="k">unless</span> <span class="n">klass</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:initializers</span><span class="p">)</span>
</span><span class='line'>          <span class="n">initializers</span> <span class="o">=</span> <span class="n">initializers</span> <span class="o">+</span> <span class="n">klass</span><span class="o">.</span><span class="n">initializers</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">initializers</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initializers_for</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
</span><span class='line'>        <span class="no">Collection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">initializers_chain</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span> <span class="p">})</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initializer</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
</span><span class='line'>        <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;A block must be passed when defining an initializer&quot;</span> <span class="k">unless</span> <span class="n">blk</span>
</span><span class='line'>        <span class="n">opts</span><span class="o">[</span><span class="ss">:after</span><span class="o">]</span> <span class="o">||=</span> <span class="n">initializers</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">name</span> <span class="k">unless</span> <span class="n">initializers</span><span class="o">.</span><span class="n">empty?</span> <span class="o">||</span> <span class="n">initializers</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:before</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">initializers</span> <span class="o">&lt;&lt;</span> <span class="no">Initializer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If a class includes this module, it can call the class method <code>initializer</code> to register a initializer to a class instance variable <code>@initializers</code>. This method accepts three parameters: the name, an option hash which you can define the order of the initializer, and a block, this block accepts one parameter which is normally our <code>Rails.application</code> instance.</p>

<p>Let&rsquo;s check the definition of the <em>Initializer</em> class.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Initializable</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Initializer</span>
</span><span class='line'>      <span class="kp">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:block</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:group</span><span class="o">]</span> <span class="o">||=</span> <span class="ss">:default</span>
</span><span class='line'>        <span class="vi">@name</span><span class="p">,</span> <span class="vi">@context</span><span class="p">,</span> <span class="vi">@options</span><span class="p">,</span> <span class="vi">@block</span> <span class="o">=</span> <span class="nb">name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">block</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">before</span>
</span><span class='line'>        <span class="vi">@options</span><span class="o">[</span><span class="ss">:before</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">after</span>
</span><span class='line'>        <span class="vi">@options</span><span class="o">[</span><span class="ss">:after</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">belongs_to?</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@options</span><span class="o">[</span><span class="ss">:group</span><span class="o">]</span> <span class="o">==</span> <span class="n">group</span> <span class="o">||</span> <span class="vi">@options</span><span class="o">[</span><span class="ss">:group</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:all</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@context</span><span class="o">.</span><span class="n">instance_exec</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">self</span> <span class="k">if</span> <span class="vi">@context</span>
</span><span class='line'>        <span class="no">Initializer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="vi">@options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the <code>initialize</code> method, it accepts a <em>context</em> object, notice that in <em>Rails::Initializable</em>, the <code>initializer</code> class method pass context as nil. But later a initializer could call <code>bind</code> to generate a new initializer with the context bind to an object. So if a class includes Rails::Initializable, its <code>@initializers</code> class instance variable contains a list of <em>initializer templates</em>. And these initializer templates could be instantiated by bind to a context object. And then pay attention that when a class includes <em>Rails::Initializable</em> module, it also has a <code>initializers</code> instance method, this method actually gets all initializer templates from itself and its ancestors and pass itself as the context.</p>

<p>Let&rsquo;s write some classes to verify how <em>Rails::Initializable</em> works. I created a file <em>parent.rb</em> in app/models which has following contents,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/parent.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Parent</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Initializable</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">initializer</span> <span class="s1">&#39;config2&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">config2</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">initializer</span> <span class="s1">&#39;config1&#39;</span><span class="p">,</span> <span class="ss">before</span><span class="p">:</span> <span class="s1">&#39;config2&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">config1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">config2</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;config2 in </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">config1</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;config1 in </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inspect</span>
</span><span class='line'>    <span class="s1">&#39;parent&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This class Parent is a normal class which includes <em>Rails::Initializable</em>. Two initializers are defined: <em>config2</em> and <em>config1</em>. Although we defined <em>config1</em> after <em>config2</em>, but we passed <code>before: 'config2'</code> when initialize <em>config1</em>.</p>

<p>Now let&rsquo;s open a rails console. The Parent should have a class method which returns all initializers. Let&rsquo;s print the names of the initializers.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>andywang@Andys-MacBook-Pro sample$ rails c
</span><span class='line'>Loading development environment (Rails 4.2.0.beta1)
</span><span class='line'>2.0.0-p353 :001 > Parent.initializers.map(&:name)
</span><span class='line'> => ["config2", "config1"]</span></code></pre></td></tr></table></div></figure>


<p>And the initializers in the class act as a template, their instance variable <em>@context</em> is nil. Let&rsquo;s verify that by printing the <em>@context</em> instance variable, we can see they are nil.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :006 >   Parent.initializers.map { |initializer| initializer.instance_variable_get('@context') }
</span><span class='line'> => [nil, nil]</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s create an instance of Parent. We can see that the instance also has an instance method called <em>initializers</em>. Let&rsquo;s print the name,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :008 >   parent = Parent.new
</span><span class='line'> => parent 
</span><span class='line'>2.0.0-p353 :009 > parent.initializers.map(&:name)
</span><span class='line'> => ["config2", "config1"]</span></code></pre></td></tr></table></div></figure>


<p>Just now we said that the initializers in the class are like a template, and for the initializers in the object instance, we can think that the initializers are <em>instantiated</em> by setting the <em>@context</em> instance variable. We can verify that by printing the instance variable of all initializers.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :011 >   parent.initializers.map { |initializer| initializer.instance_variable_get('@context') }
</span><span class='line'> => [parent, parent]</span></code></pre></td></tr></table></div></figure>


<p>We can see that the <em>@context</em> has been set to the <em>parent</em> object.</p>

<p>And if we call the <em>run_initializers</em> method,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :013 >   parent.run_initializers
</span><span class='line'>config1 in Parent
</span><span class='line'>config2 in Parent
</span><span class='line'> => true</span></code></pre></td></tr></table></div></figure>


<p>Notice two things here, first the config1 is executed before the config2. And secondly notice why we can call the <em>config1</em> and <em>config2</em> methods in the initializer block? Because when the initializers are run, the <em>self</em> object in the block is set to the <em>@context</em> instance variable. Since our context object is <em>parent</em>, and <em>config1</em> and <em>config2</em> are instance methods of this object, of course we can call it.</p>

<p>Now let&rsquo;s create a subclass Child1 which inherits from Parent, and in this class it defines another initializer whose name is <em>config_in_child1</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/child1.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Child1</span> <span class="o">&lt;</span> <span class="no">Parent</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">initializer</span> <span class="s1">&#39;config_in_child1&#39;</span><span class="p">,</span> <span class="ss">after</span><span class="p">:</span> <span class="s1">&#39;config2&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;config in child1&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inspect</span>
</span><span class='line'>    <span class="s2">&quot;child1&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s restart our console and try to create an instance of Child1 and call <em>run_initializers</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>andywang@Andys-MacBook-Pro sample$ rails c
</span><span class='line'>Loading development environment (Rails 4.2.0.beta1)
</span><span class='line'>2.0.0-p353 :001 > child1 = Child1.new
</span><span class='line'> => child1 
</span><span class='line'>2.0.0-p353 :002 > child1.run_initializers
</span><span class='line'>config1 in Child1
</span><span class='line'>config2 in Child1
</span><span class='line'>config in child1
</span><span class='line'> => true</span></code></pre></td></tr></table></div></figure>


<p>We can see that when an instance run its initializers, it will run the initializers in its ancestors first, from top to bottom. Here the two initializers <em>config1</em> and <em>config2</em> are executed first, then it&rsquo;s <em>config_in_child1</em> in Child1 class.</p>

<p>Now let&rsquo;s create another class Child2 also has an initializer, similar as Child1.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/child2.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Child2</span> <span class="o">&lt;</span> <span class="no">Parent</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">initializer</span> <span class="s1">&#39;config_in_child2&#39;</span><span class="p">,</span> <span class="ss">after</span><span class="p">:</span> <span class="s1">&#39;config2&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;config in child2&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inspect</span>
</span><span class='line'>    <span class="s2">&quot;child2&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then let&rsquo;s create one <em>App</em> class which combines one instance of Child1 and Child2.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/app.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">App</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Initializable</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="vi">@child1</span> <span class="o">=</span> <span class="no">Child1</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@child2</span> <span class="o">=</span> <span class="no">Child2</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initializers</span>
</span><span class='line'>    <span class="vi">@child1</span><span class="o">.</span><span class="n">initializers</span> <span class="o">+</span> <span class="vi">@child2</span><span class="o">.</span><span class="n">initializers</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This class has two instance variables <em>@child1</em> and <em>@child2</em>, which is an instance of Child1 and Child2 separately. This class also includes <em>Rails::Initializable</em>, but it overrides the <em>initializers</em> method to return the intializers of both <em>@child1</em> and <em>@child2</em>. Now let&rsquo;s open a new rails console, and create one instance of App and call <code>run_initializers</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>andywang@Andys-MacBook-Pro sample$ rails c
</span><span class='line'>Loading development environment (Rails 4.2.0.beta1)
</span><span class='line'>2.0.0-p353 :001 > app = App.new
</span><span class='line'> => #&lt;App:0x007fed06691540 @child1=child1, @child2=child2> 
</span><span class='line'>2.0.0-p353 :002 > app.run_initializers
</span><span class='line'>config1 in Child1
</span><span class='line'>config1 in Child2
</span><span class='line'>config2 in Child1
</span><span class='line'>config2 in Child2
</span><span class='line'>config in child1
</span><span class='line'>config in child2
</span><span class='line'> => true</span></code></pre></td></tr></table></div></figure>


<p>We can see that when we run <code>app.run_initializers</code>, it runs all initializers in @child1 and @child2. And also the order is maintained. All config1 initializers are executed before config2 initializers.</p>

<p>The <em>Rails::Application</em> class also overrides the <em>initializers</em> method like the <em>App</em> class above. It maintains a list of Railties and run the <code>Rails.application.initialize!</code> method is called, it run all Railties&#8217; initializers.</p>

<p>And we could open a rails console to display all initializers and its associated binding context.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :003 > pp Rails.application.initializers.tsort.map {|initializer| [initializer.name, initializer.instance_variable_get("@context").class]}
</span><span class='line'>[[:set_load_path, Coffee::Rails::Engine],
</span><span class='line'> [:set_load_path, Jquery::Rails::Engine],
</span><span class='line'> [:set_load_path, Turbolinks::Engine],
</span><span class='line'> [:set_load_path, WebConsole::Engine],
</span><span class='line'> [:set_load_path, Sample::Application],
</span><span class='line'> [:set_autoload_paths, Coffee::Rails::Engine],
</span><span class='line'> [:set_autoload_paths, Jquery::Rails::Engine],
</span><span class='line'> [:set_autoload_paths, Turbolinks::Engine],
</span><span class='line'> [:set_autoload_paths, WebConsole::Engine],
</span><span class='line'> [:set_autoload_paths, Sample::Application],
</span><span class='line'> [:add_routing_paths, Coffee::Rails::Engine],
</span><span class='line'> [:add_routing_paths, Jquery::Rails::Engine],
</span><span class='line'> ....</span></code></pre></td></tr></table></div></figure>


<p>This is a very long list. Actually by default there is 108 initializers. If you are interested you can check the Rails source code to see which initializer does what. For example, the :set_load_path is to set the $LOAD_PATH global. So each engine has a chance to modify the load path.</p>

<p>So after this blog you should have a general idea what Rails has done when it calls <code>Rails.application.initialize!</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/24/digging-rails-how-rails-initializes-itself/">Digging Rails - How Rails Initializes Itself</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-24T17:35:26+09:30" pubdate data-updated="true">Aug 24<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/08/24/digging-rails-how-rails-initializes-itself/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I&rsquo;m reading the Rails source code and I wanna create a series of blogs to talk about it. Today I&rsquo;m going to introduct the initialization process of Rails. Just notice that I use the latest Rails 4.2.0 beta1 code for analysis. If you use Rails 4.1 or earlier, the code may be different (actually it is).</p>

<h2>bin/rails</h2>

<p>When we run <em>rails s</em> in a Rails application folder, it will call into the bin/rails script. This script has following contents,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'>  <span class="nb">load</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;../spring&quot;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">LoadError</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="no">APP_PATH</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../../config/application&#39;</span><span class="p">,</span>  <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../config/boot&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails/commands&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Firstly it tries to call the <em>spring</em> script which is an application preloader to speed up development by keeping our application in the background. And then it defines the APP_PATH constant, which points to the <strong>&lt;app_root>/config/application</strong>, and next it requires the config/boot.rb.</p>

<h2>config/boot.rb</h2>

<p>The config/boot.rb has following contents,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;BUNDLE_GEMFILE&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../../Gemfile&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;bundler/setup&#39;</span> <span class="c1"># Set up gems listed in the Gemfile.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since Rails uses <a href="http://bundler.io/">Bundler</a> to manage the rubygems, it defines a Gemfile which declares all dependencies of the application. The <code>ENV['BUNDLE_GEMFILE']</code> is set to the path of this Gemfile, and <code>require 'bundler/setup'</code> is calling Bundler to resolve the load paths of your Gem dependencies.</p>

<h2>rails/command.rb</h2>

<p>The <em>rails</em> next requires &lsquo;rails/commands&rsquo;, and let&rsquo;s have a look at that file,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/commands.rb</span>
</span><span class='line'>
</span><span class='line'><span class="no">ARGV</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;--help&#39;</span> <span class="k">if</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>
</span><span class='line'><span class="n">aliases</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;g&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;generate&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;d&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;destroy&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;c&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;console&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;s&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;db&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;dbconsole&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;r&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;runner&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">command</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">shift</span>
</span><span class='line'><span class="n">command</span> <span class="o">=</span> <span class="n">aliases</span><span class="o">[</span><span class="n">command</span><span class="o">]</span> <span class="o">||</span> <span class="n">command</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails/commands/commands_tasks&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="ss">Rails</span><span class="p">:</span><span class="ss">:CommandsTasks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="p">)</span><span class="o">.</span><span class="n">run_command!</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that when we pass <em>s</em> or <em>server</em> to the <em>rails</em> script, it will set <em>command</em> to <em>server</em> and then create an instance of Rails::CommandsTasks and call its <code>run_command!</code> instance method.</p>

<h2>rails/commands/commands_tasks.rb</h2>

<p>The rails/commands/commands_tasks defines the <code>Rails::CommandsTasks</code> class, let&rsquo;s check the important part of this class,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/commands/commands_tasks.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">CommandsTasks</span>
</span><span class='line'>    <span class="kp">attr_reader</span> <span class="ss">:argv</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">COMMAND_WHITELIST</span> <span class="o">=</span> <span class="sx">%w(plugin generate destroy console server dbconsole runner new version help)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@argv</span> <span class="o">=</span> <span class="n">argv</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">run_command!</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="n">command</span> <span class="o">=</span> <span class="n">parse_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="no">COMMAND_WHITELIST</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">send</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">write_error_message</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">parse_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">command</span>
</span><span class='line'>        <span class="k">when</span> <span class="s1">&#39;--version&#39;</span><span class="p">,</span> <span class="s1">&#39;-v&#39;</span>
</span><span class='line'>          <span class="s1">&#39;version&#39;</span>
</span><span class='line'>        <span class="k">when</span> <span class="s1">&#39;--help&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span>
</span><span class='line'>          <span class="s1">&#39;help&#39;</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">command</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the <code>run_command!</code> instance method, it checks that if the COMMAND_WHITELIST includes the command passed, then it will just invoke an instance method whose method name matches the <em>command</em> parameter. So in our case, if we passed <em>server</em> it will invoke the <code>server</code> method, which we show below,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/commands/commands_tasks.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">CommandsTasks</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">server</span>
</span><span class='line'>      <span class="n">set_application_directory!</span>
</span><span class='line'>      <span class="n">require_command!</span><span class="p">(</span><span class="s2">&quot;server&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Server</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
</span><span class='line'>        <span class="c1"># We need to require application after the server sets environment,</span>
</span><span class='line'>        <span class="c1"># otherwise the --environment option given to the server won&#39;t propagate.</span>
</span><span class='line'>        <span class="nb">require</span> <span class="no">APP_PATH</span>
</span><span class='line'>        <span class="no">Dir</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
</span><span class='line'>        <span class="n">server</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that it creates a Rails::Server instance and then require our application file which is already defined in APP_PATH.</p>

<p>Let&rsquo;s first have a look at the config/application.rb</p>

<h2>config/application.rb</h2>

<p>The config/application.rb has following contents,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config/application.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../boot&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails/all&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Require the gems listed in Gemfile, including any gems</span>
</span><span class='line'><span class="c1"># you&#39;ve limited to :test, :development, or :production.</span>
</span><span class='line'><span class="no">Bundler</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="o">*</span><span class="no">Rails</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Sample</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Application</span>
</span><span class='line'>    <span class="c1"># Settings in config/environments/* take precedence over those specified here.</span>
</span><span class='line'>    <span class="c1"># Application configuration should go into files in config/initializers</span>
</span><span class='line'>    <span class="c1"># -- all .rb files in that directory are automatically loaded.</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Set Time.zone default to the specified zone and make Active Record auto-convert to this zone.</span>
</span><span class='line'>    <span class="c1"># Run &quot;rake -D time&quot; for a list of tasks for finding time zone names. Default is UTC.</span>
</span><span class='line'>    <span class="c1"># config.time_zone = &#39;Central Time (US &amp; Canada)&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># The default locale is :en and all translations from config/locales/*.rb,yml are auto loaded.</span>
</span><span class='line'>    <span class="c1"># config.i18n.load_path += Dir[Rails.root.join(&#39;my&#39;, &#39;locales&#39;, &#39;*.{rb,yml}&#39;).to_s]</span>
</span><span class='line'>    <span class="c1"># config.i18n.default_locale = :de</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># For not swallow errors in after_commit/after_rollback callbacks.</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">raise_in_transactional_callbacks</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Firstly it requires the config/boot.rb, since above this file is already required by rails script, the require has no effect here.</p>

<p>Next it requires the &lsquo;rails/all&rsquo;, this file has following contents, it just load the railtie of each module. Each module has its own railtie, which is to manage the initialization and configuration. We will talk about railties in another blog so I&rsquo;ll not explain here.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/all.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;rails&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">%w(</span>
</span><span class='line'><span class="sx">  active_record</span>
</span><span class='line'><span class="sx">  action_controller</span>
</span><span class='line'><span class="sx">  action_view</span>
</span><span class='line'><span class="sx">  action_mailer</span>
</span><span class='line'><span class="sx">  active_job</span>
</span><span class='line'><span class="sx">  rails/test_unit</span>
</span><span class='line'><span class="sx">  sprockets</span>
</span><span class='line'><span class="sx">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">framework</span><span class="o">|</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">framework</span><span class="si">}</span><span class="s2">/railtie&quot;</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="no">LoadError</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then next it requires the gems we defined in Gemfile by calling <code>Bundler.require</code>. And next our application class is defined. Since I named my application as <em>sample</em>, the class is in <code>Sample</code> Module.</p>

<p>The Sample::Application extends from Rails::Application. After this class is defined the <code>Rails.application</code> will be set to an instance of Sample::Application. Why? Let&rsquo;s have a look at <code>Rails</code> module.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="vi">@application</span> <span class="o">=</span> <span class="vi">@app_class</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">attr_writer</span> <span class="ss">:application</span>
</span><span class='line'>    <span class="kp">attr_accessor</span> <span class="ss">:app_class</span><span class="p">,</span> <span class="ss">:cache</span><span class="p">,</span> <span class="ss">:logger</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">application</span>
</span><span class='line'>      <span class="vi">@application</span> <span class="o">||=</span> <span class="p">(</span><span class="n">app_class</span><span class="o">.</span><span class="n">instance</span> <span class="k">if</span> <span class="n">app_class</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that it defines two instance variables in Rails&rsquo;s singleton class, <em>@application</em> and <em>@app_class</em>. And after the app_class is defined, the <em>Rails.application</em> returns the <em>@application</em> if it&rsquo;s already defined, if not, it will call <em>app_class.instance</em> to create an instance.</p>

<p>So when does the Rails.app_class is defined? Let&rsquo;s have a look at the Rails::Application class.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/application.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Engine</span>
</span><span class='line'>    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">inherited</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>        <span class="k">super</span>
</span><span class='line'>        <span class="no">Rails</span><span class="o">.</span><span class="n">app_class</span> <span class="o">=</span> <span class="n">base</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that if there is a class inherits it, it will set the Rails.app_class to the inherited class, in our case Sample::Application. So after class Sample::Application is defined, the Rails.app_class is set, and then if we call <code>Rails.application</code>, the application instance will be initialized.</p>

<p>Notice that the <code>new</code> method in Rails::Application is set to private, so we can only call <code>instance</code> to generate an instance. And this instance is a singleton, which is reasonable since one Rails application should have only one application instance.</p>

<h2>Rails::Server</h2>

<p>After the application instance is instantiated, we go back to Rails::CommandsTasks#server method, it will call <code>Dir.chdir(Rails.application.root)</code> to go to application root folder, and then call <code>server.start</code>. Let&rsquo;s have a look how the Rails::Server is defined.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/commands/server.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Server</span> <span class="o">&lt;</span> <span class="o">::</span><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Server</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
</span><span class='line'>      <span class="k">super</span>
</span><span class='line'>      <span class="n">set_environment</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">start</span>
</span><span class='line'>      <span class="n">print_boot_information</span>
</span><span class='line'>      <span class="nb">trap</span><span class="p">(</span><span class="ss">:INT</span><span class="p">)</span> <span class="p">{</span> <span class="nb">exit</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">create_tmp_directories</span>
</span><span class='line'>      <span class="n">log_to_stdout</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:log_stdout</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">super</span>
</span><span class='line'>    <span class="k">ensure</span>
</span><span class='line'>      <span class="c1"># The &#39;-h&#39; option calls exit before @options is set.</span>
</span><span class='line'>      <span class="c1"># If we call &#39;options&#39; with it unset, we get double help banners.</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s1">&#39;Exiting&#39;</span> <span class="k">unless</span> <span class="vi">@options</span> <span class="o">&amp;&amp;</span> <span class="n">options</span><span class="o">[</span><span class="ss">:daemonize</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># TODO: this is no longer required but we keep it for the moment to support older config.ru files.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">app</span>
</span><span class='line'>      <span class="vi">@app</span> <span class="o">||=</span> <span class="k">begin</span>
</span><span class='line'>        <span class="n">app</span> <span class="o">=</span> <span class="k">super</span>
</span><span class='line'>        <span class="n">app</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:to_app</span><span class="p">)</span> <span class="p">?</span> <span class="n">app</span><span class="o">.</span><span class="n">to_app</span> <span class="p">:</span> <span class="n">app</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that Rails::Server extends from ::Rack::Server. <a href="http://rack.github.io/">Rack</a> is a specification which defines an interface between the web server and application. To support Rack, you need to define an <em>app</em> object, it has a <code>call</code> method, which takes the environment hash as a parameter, and returning an Array with three elements:</p>

<ul>
<li>The HTTP response code</li>
<li>A Hash of headers</li>
<li>The response body, which must respond to each</li>
</ul>


<p>Although this interface is very simple, you can configure middleware around the app and intercept the request and response.</p>

<p>Rack is also a <a href="https://github.com/rack/rack">rubygem</a>. It provides a set of middleware such as logging, set content length in HTTP response, etc. And it also defines a simple DSL to configure the middleware and app, the config file has <em>ru</em> extension and Rack will load a file called <em>config.ru</em> by default.</p>

<p>Let&rsquo;s have a look at the ::Rack::Server class,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Rack</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Server</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">attr_writer</span> <span class="ss">:options</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@options</span> <span class="o">=</span> <span class="n">options</span>
</span><span class='line'>      <span class="vi">@app</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:app</span><span class="o">]</span> <span class="k">if</span> <span class="n">options</span> <span class="o">&amp;&amp;</span> <span class="n">options</span><span class="o">[</span><span class="ss">:app</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">app</span>
</span><span class='line'>      <span class="vi">@app</span> <span class="o">||=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:builder</span><span class="o">]</span> <span class="p">?</span> <span class="n">build_app_from_string</span> <span class="p">:</span> <span class="n">build_app_and_options_from_config</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">start</span> <span class="o">&amp;</span><span class="n">blk</span>
</span><span class='line'>      <span class="c1"># ...</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">server</span><span class="o">.</span><span class="n">run</span> <span class="n">wrapped_app</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">server</span>
</span><span class='line'>      <span class="vi">@_server</span> <span class="o">||=</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:server</span><span class="o">]</span><span class="p">)</span> <span class="o">||</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">build_app_and_options_from_config</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">!::</span><span class="no">File</span><span class="o">.</span><span class="n">exist?</span> <span class="n">options</span><span class="o">[</span><span class="ss">:config</span><span class="o">]</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;configuration </span><span class="si">#{</span><span class="n">options</span><span class="o">[</span><span class="ss">:config</span><span class="o">]</span><span class="si">}</span><span class="s2"> not found&quot;</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">app</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Builder</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">options</span><span class="o">[</span><span class="ss">:config</span><span class="o">]</span><span class="p">,</span> <span class="n">opt_parser</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">merge!</span> <span class="n">options</span>
</span><span class='line'>        <span class="n">app</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">build_app_from_string</span>
</span><span class='line'>        <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Builder</span><span class="o">.</span><span class="n">new_from_string</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">options</span><span class="o">[</span><span class="ss">:builder</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">wrapped_app</span>
</span><span class='line'>        <span class="vi">@wrapped_app</span> <span class="o">||=</span> <span class="n">build_app</span> <span class="n">app</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I only leave the relevant code here and omitted some parts such as option parsing. We can see that the <code>start</code> method creates a <code>@_server</code> instance variable which is a handler represents the web server interface, it has a <code>run</code> method which accepts the <em>app</em>. The <em>app</em> is the Rack app object we mentioned above, it&rsquo;s an object which reponds to <code>call</code> method which accepts an environment hash and returns an array with 3 elements: the HTTP status code, response HTTP headers and the body.</p>

<p>The <code>wrapped_app</code> calls the <code>build_app</code> method which just wraps some default middleware around the app. And the <code>app</code> method actually sets the <code>@app</code> instance variable, which is actually read from the config.ru file (by <code>build_app_from_string</code> method).</p>

<h2>config.ru</h2>

<p>Every rails application has a <em>config.ru</em> file at root folder. Let&rsquo;s have a look at that file,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># This file is used by Rack-based servers to start the application.</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../config/environment&#39;</span><span class="p">,</span>  <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'><span class="n">run</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span>
</span></code></pre></td></tr></table></div></figure>


<p>This file is actually a ruby file, it first requires the <em>config/environment.rb</em> file and then calls <code>run Rails.application</code>. The <code>run</code> method is defined in Rack DSL, and it accepts the app object. So we can imagine that if we call <code>Rails.application.respond_to?(:call)</code> it should return true.</p>

<h2>config/environment.rb</h2>

<p>Let&rsquo;s have a look what&rsquo;s inside config/environment.rb.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Load the Rails application.</span>
</span><span class='line'><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../application&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Initialize the Rails application.</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">initialize!</span>
</span></code></pre></td></tr></table></div></figure>


<p>It just requires <em>config/application.rb</em> (which we already required) and then initialize the application by calling <code>Rails.application.initialize!</code>. After that the initialization process is finished and the <code>Rails.application</code> could be used as Rack application.</p>

<p>In this part we had a detailed look at the Rails initialization process and we will dig into Railties and <code>Rails.application.initialize!</code> in following series.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/17/using-index-files-in-rails-4-assets-pipeline/">Using Index Files in Rails 4 Assets Pipeline</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-17T21:15:28+09:30" pubdate data-updated="true">Aug 17<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/08/17/using-index-files-in-rails-4-assets-pipeline/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I bought a website template from <a href="https://wrapbootstrap.com/theme/tshop-responsive-e-commerce-template-WB002S263">WrapBootstrap</a> and I wanna itegrate this into a Spree website I&rsquo;m working on. According to the documents of <a href="http://edgeguides.rubyonrails.org/asset_pipeline.html">Asset Pipeline</a> and the <a href="http://railscasts.com/episodes/279-understanding-the-asset-pipeline">RailsCasts</a>. I put the stylesheets and javascripts of this template into the folder #{Rails.root}/vendor/assets/tshop. So for example, I can access a stylesheet at #{Rails.root}/vendor/assets/tshop/stylesheets/style.css from the url <a href="http://localhost:3000/assets/stylesheets/style.css">http://localhost:3000/assets/stylesheets/style.css</a></p>

<p>My folder structure is like following figure,</p>

<p><img src="/images/rails_vendor_folder.png"></p>

<p>According to the <a href="http://edgeguides.rubyonrails.org/asset_pipeline.html#using-index-files">Rails documents</a>, I should create a file index.js and index.css under #{Rails.root}/vendor/assets/tshop, but that doesn&rsquo;t work for me. Actually I named the files as tshop.js and tshop.css.scss, as the figure above. So in the application.css and application.js I chould load the tshop library by calling,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="c">/*</span>
</span><span class='line'><span class="c"> ...</span>
</span><span class='line'><span class="c"> *= require tshop</span>
</span><span class='line'><span class="c"> ...</span>
</span><span class='line'><span class="c"> */</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p> and</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'> <span class="c1">//= require tshop</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in the tshop.css.scss, I could load the file #{Rails.root}/vendor/assets/tshop/stylesheets/style.css by using following code,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="c">/*</span>
</span><span class='line'><span class="c"> ...</span>
</span><span class='line'><span class="c"> *= require stylesheets/style</span>
</span><span class='line'><span class="c"> ...</span>
</span><span class='line'><span class="c"> */</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p> And in tshop.js, the file #{Rails.root}/vendor/assets/tshop/javascripts/script.js could be loaded by following code,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'> <span class="c1">//= require javascripts/script</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the templates, I need to change the background image url, for example, in style.css,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.parallax-image-2</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">background</span><span class="o">:</span> <span class="sx">url(&quot;/assets/stylesheets/parallax/people-collage.jpg&quot;)</span> <span class="k">fixed</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-attachment</span><span class="o">:</span> <span class="k">fixed</span><span class="p">;</span><span class="c">/* IE FIX */</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This image file will be in #{Rails.root}/vendor/assets/tshop/stylesheets/parallax/people-collage.jpg.</p>

<p>Here are the organization I used for my Rails 4 application. The point is to use <em>library.css</em> and <em>library.js</em> to name the index files instead of index.css and index.js.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/26/integrate-postgis-and-google-maps-in-rails-part-2/">Integrate PostGIS and Google Maps in Rails Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-26T00:19:16+09:30" pubdate data-updated="true">May 26<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/05/26/integrate-postgis-and-google-maps-in-rails-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here is the Part 2 of <em>Integrate PostGIS and Google maps in Rails</em>, in this part we will render the provinces of Gabon on Google map. Unlike Part 1 the GeoJSON data is fetched from a static file, in this part we will see how to fetch data from PostGIS and encode them into GeoJSON directly. The result is like the following figure, the 9 provinces are rendered on the map, and when the user put his mouse over one province, that area will be highlighted, and also on the top right there is a label which shows the name of the province that is highlighted.</p>

<p><img src="/images/province_highlighted.png"></p>

<h2>Create the Province model</h2>

<p>The first thing we need to do is to create a <strong>Province</strong> model. Like how we created the <strong>Country</strong> model in part 1, we create a <strong>Province</strong> model, and then import the data in shape file into our PostGIS database. The main part in the migration is as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ImportProvincesFromShp</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="n">from_shp_sql</span> <span class="o">=</span> <span class="sb">`shp2pgsql -c -g geom -W LATIN1 -s 4326 </span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;shpfiles&#39;</span><span class="p">,</span> <span class="s1">&#39;GAB_adm1.shp&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb"> provinces_ref`</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Province</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">execute</span> <span class="n">from_shp_sql</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span>
</span><span class='line'><span class="sh">          insert into provinces(name, geom) </span>
</span><span class='line'><span class="sh">            select name_1, geom from provinces_ref</span>
</span><span class='line'><span class="no">      SQL</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">drop_table</span> <span class="ss">:provinces_ref</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="no">Province</span><span class="o">.</span><span class="n">delete_all</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The province data is in shape file <em>GAB_adm1.shp</em>, and we fetch the province name and geometry from the shape file and import them into <em>provinces</em> table (In the shape file province name is stored as attribute <em>name_1</em>).</p>

<h2>Encode the feature</h2>

<p>Now we need to fetch data from database and encode them as GeoJSON. GeoJSON is a JSON format for encoding geographic data structures. The following example is stolen from <a href="http://geojson.org/">the GeoJSON website</a>. We can see that in addition to the geometry data, the JSON can also encode additional properties.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Point&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">125.6</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">]</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Dinagat Islands&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will mainly use the <em>rgeo-geojson</em> gem to do the encoding. In <em>rgeo-geojson</em> gem, it converts a geometry type to a feature and then encode the feature to a hash, and then the hash can be rendered as a JSON.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">province</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">factory</span> <span class="o">=</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">::</span><span class="no">EntityFactory</span><span class="o">.</span><span class="n">instance</span>
</span><span class='line'><span class="n">feature</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">feature</span> <span class="n">province</span><span class="o">.</span><span class="n">geom</span>
</span><span class='line'><span class="nb">hash</span> <span class="o">=</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">.</span><span class="n">encode</span> <span class="n">feature</span>
</span><span class='line'><span class="nb">puts</span> <span class="nb">hash</span><span class="o">.</span><span class="n">to_json</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>We create a Concern named <strong>Featurable</strong>, which will add a <em>featurable</em> class method into the class which includes it. So for example in <strong>Province</strong> class, we include the <strong>Featurable</strong> like following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Province</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Featurable</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">featurable</span> <span class="ss">:geom</span><span class="p">,</span> <span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The featurable accepts two parameters, the first is mandatory, which is the name of the attribute which contains the geometry data, the second parameter is an optional array of attribute names, when encoding it as GeoJSON, those attributes will be encoded as attributes. Here we encode the <em>name</em> attribute as the property of the feature. Now the <strong>Province</strong> class will have a instance method named <strong>to_feature</strong>, which returns a RGeo::GeoJSON::Feature.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">province</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">feature</span> <span class="o">=</span> <span class="n">province</span><span class="o">.</span><span class="n">to_feature</span>
</span><span class='line'><span class="nb">puts</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result will display as following, it includes the name as its property and also has an id.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;geometry&quot;</span><span class="p">:{</span>
</span><span class='line'>    <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;MultiPolygon&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;coordinates&quot;</span><span class="p">:[[[[</span><span class="mf">9.499305999999933</span><span class="p">,</span><span class="mf">0.10763800000000856</span><span class="p">],</span>
</span><span class='line'>        <span class="err">......</span><span class="p">,[</span><span class="mf">9.748417000000074</span><span class="p">,</span><span class="mf">1.0649910000000773</span><span class="p">]]]]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;properties&quot;</span><span class="p">:{</span>
</span><span class='line'>    <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Estuaire&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s have a look at how <strong>Featurable</strong> is implemented.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Featurable</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">featurable</span> <span class="n">geom_attr_name</span><span class="p">,</span> <span class="n">property_names</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>      <span class="n">define_method</span> <span class="ss">:to_feature</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">factory</span> <span class="o">=</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">::</span><span class="no">EntityFactory</span><span class="o">.</span><span class="n">instance</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">property_names</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="n">property_names</span><span class="p">)</span>
</span><span class='line'>        <span class="n">properties</span> <span class="o">=</span> <span class="n">property_names</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">property_name</span><span class="o">|</span>
</span><span class='line'>          <span class="nb">hash</span><span class="o">[</span><span class="n">property_name</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span> <span class="o">=</span> <span class="n">read_attribute</span><span class="p">(</span><span class="n">property_name</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">hash</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">factory</span><span class="o">.</span><span class="n">feature</span> <span class="n">read_attribute</span><span class="p">(</span><span class="n">geom_attr_name</span><span class="p">),</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">properties</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># turns a collection of models to a feature collection</span>
</span><span class='line'>    <span class="c1"># All models in the collection should implement the to_feature method</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">to_feature_collection</span> <span class="n">models</span>
</span><span class='line'>      <span class="n">factory</span> <span class="o">=</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">::</span><span class="no">EntityFactory</span><span class="o">.</span><span class="n">instance</span>
</span><span class='line'>      <span class="n">features</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_feature</span><span class="p">)</span>
</span><span class='line'>      <span class="n">factory</span><span class="o">.</span><span class="n">feature_collection</span> <span class="n">features</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the implementation of <em>featurable</em> class method, when this method is called, the class will call <em>define_method</em> to define an instance method called <em>to_feature</em> and from line 9 to 13 it will generates a hash named <em>properties</em> whose key is the property name and value is the property value. And then on line 14 it calls the <em>RGeo::GeoJSON::EntityFactory#feature</em> method to create the feature and return it.</p>

<p>On line 21 it defines another class method called <em>to_feature_collection</em>, this is to convert a collection of models to a feature collection, for example the following code shows how to encode all 9 provinces as a feature collection.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">provinces</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'><span class="n">feature_collection</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">to_feature_collection</span> <span class="n">provinces</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Provinces Controller</h2>

<p>Now let&rsquo;s create a <strong>ProvincesController</strong> to render all 9 provinces as GeoJSON.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ProvincesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>      <span class="vi">@provinces</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>        <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">feature_collection</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">to_feature_collection</span> <span class="vi">@provinces</span>
</span><span class='line'>          <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">feature_collection</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">format</span><span class="o">.</span><span class="n">html</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that the <em>index</em> method responds to two formats, in the json format it will call <em>Province.to_feature_collection</em> to create the feature collection, and then calls <em>RGeo::GeoJSON.encode(feature_collection)</em> to encode the feature as a hash, and last calls <em>render</em> to render the hash as a JSON string.</p>

<p>In the <em>views/provinces/index.html.erb</em>, the main part is as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//Create an info box for displaying names</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">infoBox</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">infoBox</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;div id=&#39;info-box&#39;&gt;&lt;/div&gt;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">ControlPosition</span><span class="p">.</span><span class="nx">RIGHT_TOP</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">infoBox</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;mouseover&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">revertStyle</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#info-box&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">feature</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">));</span>
</span><span class='line'>  <span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">overrideStyle</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">feature</span><span class="p">,</span> <span class="p">{</span> <span class="nx">fillColor</span><span class="o">:</span> <span class="s1">&#39;red&#39;</span> <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;mouseout&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
</span><span class='line'>  <span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">revertStyle</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">feature</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span> <span class="nx">fillColor</span><span class="o">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">strokeWeight</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>From line 2 to line 4 it creates an info box at the RIGHT TOP to display province name. And from line 6 to line 10 it adds a <em>mouseover</em> event listener, so when the mouse is over the province region, it set the text of the info box to the <em>name</em> property of the feature. And on line 12 it defines a <em>mouseout</em> event listener so the style is reverted when the mouse is out of the province region.</p>

<p>So in this part we showed how to fetch geometry data from PostGIS database and render them on google map. The source code for this part is at <a href="https://github.com/climber2002/schoolpro/tree/part2">github</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/18/postgis-and-google-maps-in-rails-part-1/">PostGIS and Google Maps in Rails Part 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-18T23:23:32+09:30" pubdate data-updated="true">May 18<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/05/18/postgis-and-google-maps-in-rails-part-1/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I need to work on a Rails project which is to manage the public and private schools in Gabon, a small country in Africa. And I need to integrate PostGIS and Google maps. I will create a series of blogs to share what I have done, and I will point out some common gotchas while integrate Rails with PostGIS and Google maps.</p>

<h2>Books and Blogs</h2>

<p>To work on PostGIS and Google Maps of course you need to learn them. This series is not a complete tutorial. To study PostGIS, the definite reference is <em>PostGIS in Action</em> by Regina O. Obe and Leo S. Hsu. Currently the second edition is in MEAP state and you can buy the ebook at <a href="http://manning.com/obe2/">manning website</a>. To study Google maps, the documentation at <a href="https://developers.google.com/maps/documentation/javascript/tutorial">google website</a> is already awesome, but if you prefer a book form, the book <em>Google Maps JavaScript API Cookbook</em> by Alper Dincer and Balkan Uraz is a good choice, which you can buy the kindle version at <a href="http://www.amazon.com/Google-Maps-JavaScript-API-Cookbook-ebook/dp/B00HJR6RD6">amazon</a></p>

<p>In the project to integrate PostGIS with Rails, I utilized some rubygems from RGeo. The original author of those rubygems, Daniel Azuma, has created a series of articles on <a href="http://daniel-azuma.com/articles/georails">his website</a>, which is very helpful. Actually this series has been inspired from his works.</p>

<h2>Let&rsquo;s start</h2>

<p>In this first blog I&rsquo;ll describe how to create a rails project and how to create migrations to import GIS data from shape files to our database.</p>

<h2>Install</h2>

<p>To work on PostGIS of course you need to install it first. If you work on a Mac OS environment like me, using the <a href="http://postgresapp.com/">PostgreSQL App</a> is the easiest way. This package already includes PostGIS 2.1, so you just need to enable it, which we will introduce later.</p>

<p>And since we use the <a href="https://github.com/rgeo/rgeo">RGeo</a> and some of its addons, you need to install <a href="http://trac.osgeo.org/geos">GEOS</a> and <a href="http://trac.osgeo.org/proj">Proj</a>, which RGeo depends on. For Mac users the easiest way is to install the frameworks <a href="http://www.kyngchaos.com/software:frameworks">here</a></p>

<h2>Create the application</h2>

<p>Now let&rsquo;s create a rails application and use PostgreSQL database (I use Rails 4.1).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rails new schoolpro --database==postgresql</span></code></pre></td></tr></table></div></figure>


<p>Here my application name is schoolpro. Now open the Gemfile and add the <em>activerecord-postgis-adapter</em> gem.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;activerecord-postgis-adapter&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then in the database.yml, let&rsquo;s change the adapter from postgresql to postgis</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgis</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s create the database by running <strong>rake db:create</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rake db:create</span></code></pre></td></tr></table></div></figure>


<p>After the database is created, we need to enable the PostGIS extension by running following command</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake db:gis:setup</span></code></pre></td></tr></table></div></figure>




</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2014/05/18/postgis-and-google-maps-in-rails-part-1/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/">Deploy Rails Application on Ubuntu 14.04 Part 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/08/deploy-rails-application-on-ubuntu-14-dot-04/">Deploy Rails application on Ubuntu 14.04 Part 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/07/install-and-configure-postgresql-on-ubuntu-14-dot-04/">Change data files location on Ubuntu 14.04</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/22/capybara-integration-tests-with-jquery-selectize/">Capybara integration tests with JQuery selectize</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/07/depoly-a-rails-4-application-on-an-amazon-ec2-server/">Depoly a rails 4 application on an Amazon EC2 server</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Andy Wang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'climber2002';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
