
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Deploy Rails Application on Ubuntu 14.04 Part 2 - AprilTouch</title>
  <meta name="author" content="Andy Wang">

  
  <meta name="description" content="In Part 1 we have installed Nginx PostgreSQL, and also Monit. In this part I will show how to deploy the application through capistrano. In this part &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://climber2002.github.io/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="AprilTouch" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-51109944-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">AprilTouch</a></h1>
  
    <h2>My blog about Ruby and iOS development</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:climber2002.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-me">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Deploy Rails Application on Ubuntu 14.04 Part 2</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-09T21:27:23+10:30" pubdate data-updated="true">Feb 9<span>th</span>, 2015</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>In <a href="http://climber2002.github.io/blog/2015/02/08/deploy-rails-application-on-ubuntu-14-dot-04/">Part 1</a> we have installed Nginx PostgreSQL, and also Monit. In this part I will show how to deploy the application through capistrano.</p>

<p>In this part we will execute many commands, some will be executed in the host machine (our Laptop or iMac for example), and some will be executed in the Vagrant VM. I will show different prompt when executing. On host machine the prompt will be like <strong>host:~/rails_projects/deploy_sample$</strong>, and on VM the prompt will be <strong>vagrant@vagrant-ubuntu-trusty-64:~$</strong>, or if we su as deploy, it will be <strong>deploy@vagrant-ubuntu-trusty-64:~$</strong></p>

<h2>Create deploy user</h2>

<p>Just like we use an user <em>postgres</em> to manage our database, we should also use a standalone user to manage our application. We name this user <em>deploy</em>. And now let&rsquo;s create this user.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo adduser --ingroup sudo deploy
</span><span class='line'>Adding user <span class="sb">`</span>deploy<span class="s1">&#39; ...</span>
</span><span class='line'><span class="s1">Adding new user `deploy&#39;</span> <span class="o">(</span>1002<span class="o">)</span> with group <span class="sb">`</span>sudo<span class="s1">&#39; ...</span>
</span><span class='line'><span class="s1">Creating home directory `/home/deploy&#39;</span> ...
</span><span class='line'>Copying files from <span class="sb">`</span>/etc/skel<span class="err">&#39;</span> ...
</span><span class='line'>Enter new UNIX password:
</span><span class='line'>Retype new UNIX password:
</span><span class='line'>passwd: password updated successfully
</span><span class='line'>Changing the user information <span class="k">for </span>deploy
</span><span class='line'>Enter the new value, or press ENTER <span class="k">for </span>the default
</span><span class='line'>  Full Name <span class="o">[]</span>:
</span><span class='line'>  Room Number <span class="o">[]</span>:
</span><span class='line'>  Work Phone <span class="o">[]</span>:
</span><span class='line'>  Home Phone <span class="o">[]</span>:
</span><span class='line'>  Other <span class="o">[]</span>:
</span><span class='line'>Is the information correct? <span class="o">[</span>Y/n<span class="o">]</span> Y
</span></code></pre></td></tr></table></div></figure>


<p>Set a password for <em>deploy</em> user and accept all default options.</p>

<p>Since we already add <em>deploy</em> user to sudo group. It can run sudo commands. However the user needs to input his password when sudo. When we run the capistrano deploy command later, it will run sudo commands. So I want to update this user so that he doesn&rsquo;t need to type password when running sodo commands. For this we need to update the <strong>/etc/sudoers</strong> file. It&rsquo;s recommended to use the application <strong>visudo</strong> to update it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo visodu
</span></code></pre></td></tr></table></div></figure>


<p>Add the following line to this file, and then type <em>Ctrl + O</em> to save it as /etc/sudoers, and type <em>Ctrl + X</em> to exit.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy  <span class="nv">ALL</span><span class="o">=(</span>ALL:ALL<span class="o">)</span> NOPASSWD:ALL
</span></code></pre></td></tr></table></div></figure>


<p>Notice that since we already add <em>deploy</em> user to sudo group, this line should be added under the line <strong>%sudo   ALL=(ALL:ALL) ALL</strong> so it will take effect.</p>

<p>Our deployment organization is like following figure,</p>

<p><img src="/images/deploy_structure.png"></p>

<p>Our host communicates with VM by SSH, and also when the VM sync code from github, it also uses SSH. So we need two public/private keypairs here. One will be generated in VM and used to communicate with Github. And One will be generated in host machine and used to communicate with VM during deployment.</p>

<p>Let&rsquo;s firstly generate a keypair for <em>deploy</em> user in VM. The public key for this keypair will be configured in github so the VM can download code from github.</p>

<p>Let&rsquo;s firstly su as deploy</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>su deploy
</span><span class='line'>Password:
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:/home/vagrant<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we go to the ~/.ssh folder and create a keypair.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:/home/vagrant<span class="nv">$ </span><span class="nb">cd</span> ~
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>mkdir .ssh
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span><span class="nb">cd</span> .ssh
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>ssh-keygen -t rsa -b 4096 -C climber2002@gmail.com
</span></code></pre></td></tr></table></div></figure>


<p>The <em>climber2002@gmail.com</em> is my email, and you should use your email here.</p>

<p>Accept default options, and after generation two files should be created, <strong>id_rsa</strong> and <strong>id_rsa.pub</strong>.</p>

<p>We can run <strong>cat id_rsa.pub</strong> and copy its content, and then configure this key in github.</p>

<p>In github, choose Settings &ndash;> SSH keys &ndash;> Add SSH key, and paste the public key, as the following snapshot.</p>

<p><img src="/images/github_add_ssh_key.png"></p>

<p>Now we need to add the key of our host to the Vagrant VM. Let&rsquo;s see if a key already existed.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host<span class="nv">$ </span>ls -l ~/.ssh
</span><span class='line'>-rw-------  1 andywang  staff  1679 Jun 25  2014 id_rsa
</span><span class='line'>-rw-r--r--  1 andywang  staff   403 Jun 25  2014 id_rsa.pub
</span></code></pre></td></tr></table></div></figure>


<p>Normally you should already have <strong>id_rsa</strong> and <strong>id_rsa.pub</strong>. If not run the <em>ssh-keygen</em> again in host to generate the SSH key.</p>

<p>And then lets copy the content of id_rsa.pub and copy it to VM&rsquo;s <strong>~/.ssh/authorized_keys</strong>. If this file doesn&rsquo;t exist, create it. And then paste the content in id_rsa.pub in this file as a standalone line.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~/.ssh<span class="nv">$ </span>vi authorized_keys
</span></code></pre></td></tr></table></div></figure>


<p>And also I updated the ssh config file <strong>/etc/ssh/sshd_config</strong> and changed the <strong>PasswordAuthentication yes</strong> to <strong>PasswordAuthentication no</strong> so we disable the password authentication, and only use Publickey authentication which is more secure.</p>

<p>After that let&rsquo;s restart ssh service</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~/.ssh<span class="nv">$ </span>sudo service ssh restart
</span></code></pre></td></tr></table></div></figure>


<p>Now from your host server, you should be able to ssh into the Vagrant VM.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host<span class="nv">$ </span>ssh deploy@192.168.22.10
</span><span class='line'>
</span><span class='line'>The authenticity of host <span class="s1">&#39;192.168.22.10 (192.168.22.10)&#39;</span> can<span class="s1">&#39;t be established.</span>
</span><span class='line'><span class="s1">RSA key fingerprint is b1:e4:e0:42:a1:37:0b:04:d3:88:8c:42:15:aa:00:b4.</span>
</span><span class='line'><span class="s1">Are you sure you want to continue connecting (yes/no)? yes</span>
</span><span class='line'><span class="s1">Warning: Permanently added &#39;</span>192.168.22.10<span class="err">&#39;</span> <span class="o">(</span>RSA<span class="o">)</span> to the list of known hosts.
</span><span class='line'>Welcome to Ubuntu 14.04.1 LTS <span class="o">(</span>GNU/Linux 3.13.0-45-generic x86_64<span class="o">)</span>
</span><span class='line'>
</span><span class='line'> * Documentation:  https://help.ubuntu.com/
</span><span class='line'>
</span><span class='line'>  System information as of Mon Feb  9 12:25:47 UTC 2015
</span><span class='line'>
</span><span class='line'>  System load:  0.0               Processes:           96
</span><span class='line'>  Usage of /:   3.1% of 39.34GB   Users logged in:     2
</span><span class='line'>  Memory usage: 33%               IP address <span class="k">for </span>eth0: 10.0.2.15
</span><span class='line'>  Swap usage:   0%                IP address <span class="k">for </span>eth1: 192.168.22.10
</span><span class='line'>
</span><span class='line'>  Graph this data and manage this system at:
</span><span class='line'>    https://landscape.canonical.com/
</span><span class='line'>
</span><span class='line'>  Get cloud support with Ubuntu Advantage Cloud Guest:
</span><span class='line'>    http://www.ubuntu.com/business/services/cloud
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Last login: Mon Feb  9 12:25:48 2015 from 192.168.22.1
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo ls
</span></code></pre></td></tr></table></div></figure>


<h2>Rbenv</h2>

<p>Now we install the Rbenv. We will use <a href="https://github.com/fesplugas/rbenv-installer">Rbenv installer</a> to ease our installation. Since we will use <em>deploy</em> user as our application owner. Make sure you firstly su as <em>deploy</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>curl https://raw.githubusercontent.com/fesplugas/rbenv-installer/master/bin/rbenv-installer | bash
</span></code></pre></td></tr></table></div></figure>


<p>After the installation is complete, add following lines to <em>~/.bashrc</em>, pay attention that you need to add it at the top of the file. Since the script will return if it&rsquo;s not running interactively.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">RBENV_ROOT</span><span class="o">=</span><span class="s2">&quot;${HOME}/.rbenv&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;${RBENV_ROOT}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;${RBENV_ROOT}/bin:${PATH}&quot;</span>
</span><span class='line'>  <span class="nb">eval</span> <span class="s2">&quot;$(rbenv init -)&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>After we run <strong>. ~/.bashrc</strong> to take the change into effect.</p>

<p>Now we need to install some required packages on Ubuntu.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>rbenv bootstrap-ubuntu-12-04
</span></code></pre></td></tr></table></div></figure>


<p>After the necessary packages are installed, lets install Ruby 2.1.4</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>rbenv install 2.1.4
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>rbenv global 2.1.4
</span></code></pre></td></tr></table></div></figure>


<p>This will download and compile Ruby 2.1.4 so it will take some time. Let&rsquo;s grab a cup of coffee~~</p>

<h2>Install bundler</h2>

<p>After installed ruby 2.1.4 let&rsquo;s install bundler</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>gem install bundler
</span></code></pre></td></tr></table></div></figure>


<h2>Create the application directory</h2>

<p>For my application, I want to deploy the application in <strong>/product</strong> folder, so let&rsquo;s create that folder and change the owner to <em>deploy</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo mkdir /product
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>sudo chown -R deploy:sudo /product
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy with Capistrano</h2>

<p>Now we will try to deploy with Capistrano. We will use the <a href="https://github.com/TalkingQuickly/capistrano-3-rails-template">capistrano 3 template</a> to help us. Don&rsquo;t worry if you don&rsquo;t fully understand, I will explain it in next part.</p>

<p>Now firstly let&rsquo;s clone the capistrano template in our host station. For me, both this project and the <em>deploy_sample</em> project are in the same folder which is <em>~/rails_projects</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects<span class="nv">$ </span>git clone https://github.com/TalkingQuickly/capistrano-3-rails-template.git
</span></code></pre></td></tr></table></div></figure>


<p>And then in <em>Gemfile</em> of our <em>deploy_sample</em> project, let&rsquo;s add the necessary gems.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Use Unicorn as the app server</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;unicorn&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.1.0&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># rails specific capistrano funcitons</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 1.1.0&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># integrate bundler with capistrano</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-bundler&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># if you are using RBENV</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;capistrano-rbenv&#39;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 2.0&quot;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:development</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that let&rsquo;s run <strong>bundle install</strong> to install all the gems.</p>

<p>The capistrano 3 templates added some customized tasks, so lets copy all the files from the template to our project.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp ../capistrano-3-rails-template/Capfile .
</span><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp -r ../capistrano-3-rails-template/config/ ./config
</span><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp -r ../capistrano-3-rails-template/lib/ ./lib
</span></code></pre></td></tr></table></div></figure>


<h3>Copy secrets.yml</h3>

<p>The Capistrano templates has some template files in <em>config/shared</em> folder, these files will be copied to a shared folder in VM when we run the task <strong>deploy:setup_config</strong>. Notice that we also want <em>secrets.yml</em> to be in the shared folder, so it won&rsquo;t be committed in our git repository. So let&rsquo;s copy this file into shared folder also. We change the filename to secrets.yml.erb as the task will render the erb file to secrets.yml during setup.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>cp config/secrets.yml config/deploy/shared/secrets.yml.erb
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to update the <em>config/deploy.rb</em> file as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s1">&#39;deploy_sample&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_user</span><span class="p">,</span> <span class="s1">&#39;deploy&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># setup repo details</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span> <span class="ss">:git</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:repo_url</span><span class="p">,</span> <span class="s1">&#39;git@github.com:climber2002/deploy_sample.git&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># setup rbenv.</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_type</span><span class="p">,</span> <span class="ss">:user</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_ruby</span><span class="p">,</span> <span class="s1">&#39;2.1.4&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_prefix</span><span class="p">,</span> <span class="s2">&quot;RBENV_ROOT=</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> RBENV_VERSION=</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_ruby</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rbenv_path</span><span class="p">)</span><span class="si">}</span><span class="s2">/bin/rbenv exec&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rbenv_map_bins</span><span class="p">,</span> <span class="sx">%w{rake gem bundle ruby rails}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># how many old releases do we want to keep, not much</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:keep_releases</span><span class="p">,</span> <span class="mi">5</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># files we want symlinking to specific entries in shared</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:linked_files</span><span class="p">,</span> <span class="sx">%w{config/database.yml config/secrets.yml}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># dirs we want symlinking to shared</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:linked_dirs</span><span class="p">,</span> <span class="sx">%w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># what specs should be run before deployment is allowed to</span>
</span><span class='line'><span class="c1"># continue, see lib/capistrano/tasks/run_tests.cap</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:tests</span><span class="p">,</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># which config files should be copied by deploy:setup_config</span>
</span><span class='line'><span class="c1"># see documentation in lib/capistrano/tasks/setup_config.cap</span>
</span><span class='line'><span class="c1"># for details of operations</span>
</span><span class='line'><span class="n">set</span><span class="p">(</span><span class="ss">:config_files</span><span class="p">,</span> <span class="sx">%w(</span>
</span><span class='line'><span class="sx">  nginx.conf</span>
</span><span class='line'><span class="sx">  database.example.yml</span>
</span><span class='line'><span class="sx">  log_rotation</span>
</span><span class='line'><span class="sx">  monit</span>
</span><span class='line'><span class="sx">  unicorn.rb</span>
</span><span class='line'><span class="sx">  unicorn_init.sh</span>
</span><span class='line'><span class="sx">  secrets.yml</span>
</span><span class='line'><span class="sx">)</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># which config files should be made executable after copying</span>
</span><span class='line'><span class="c1"># by deploy:setup_config</span>
</span><span class='line'><span class="n">set</span><span class="p">(</span><span class="ss">:executable_config_files</span><span class="p">,</span> <span class="sx">%w(</span>
</span><span class='line'><span class="sx">  unicorn_init.sh</span>
</span><span class='line'><span class="sx">)</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1"># files which need to be symlinked to other parts of the</span>
</span><span class='line'><span class="c1"># filesystem. For example nginx virtualhosts, log rotation</span>
</span><span class='line'><span class="c1"># init scripts etc. The full_app_name variable isn&#39;t</span>
</span><span class='line'><span class="c1"># available at this point so we use a custom template </span>
</span><span class='line'><span class="c1"># tag and then add it at run time.</span>
</span><span class='line'><span class="n">set</span><span class="p">(</span><span class="ss">:symlinks</span><span class="p">,</span> <span class="o">[</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;nginx.conf&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/nginx/sites-enabled/&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;unicorn_init.sh&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/init.d/unicorn_&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;log_rotation&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/logrotate.d/&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;monit&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">link</span><span class="p">:</span> <span class="s2">&quot;/etc/monit/conf.d/.conf&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># this:</span>
</span><span class='line'><span class="c1"># http://www.capistranorb.com/documentation/getting-started/flow/</span>
</span><span class='line'><span class="c1"># is worth reading for a quick overview of what tasks are called</span>
</span><span class='line'><span class="c1"># and when for `cap stage deploy`</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># make sure we&#39;re deploying what we think we&#39;re deploying</span>
</span><span class='line'>  <span class="n">before</span> <span class="ss">:deploy</span><span class="p">,</span> <span class="s2">&quot;deploy:check_revision&quot;</span>
</span><span class='line'>  <span class="c1"># only allow a deploy with passing tests to deployed</span>
</span><span class='line'>  <span class="n">before</span> <span class="ss">:deploy</span><span class="p">,</span> <span class="s2">&quot;deploy:run_tests&quot;</span>
</span><span class='line'>  <span class="c1"># compile assets locally then rsync</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:symlink:shared&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:compile_assets_locally&#39;</span>
</span><span class='line'>  <span class="n">after</span> <span class="ss">:finishing</span><span class="p">,</span> <span class="s1">&#39;deploy:cleanup&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># remove the default nginx configuration as it will tend</span>
</span><span class='line'>  <span class="c1"># to conflict with our configs.</span>
</span><span class='line'>  <span class="n">before</span> <span class="s1">&#39;deploy:setup_config&#39;</span><span class="p">,</span> <span class="s1">&#39;nginx:remove_default_vhost&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># reload nginx to it will pick up any modified vhosts from</span>
</span><span class='line'>  <span class="c1"># setup_config</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:setup_config&#39;</span><span class="p">,</span> <span class="s1">&#39;nginx:reload&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Restart monit so it will pick up any monit configurations</span>
</span><span class='line'>  <span class="c1"># we&#39;ve added</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:setup_config&#39;</span><span class="p">,</span> <span class="s1">&#39;monit:restart&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># As of Capistrano 3.1, the `deploy:restart` task is not called</span>
</span><span class='line'>  <span class="c1"># automatically.</span>
</span><span class='line'>  <span class="n">after</span> <span class="s1">&#39;deploy:publishing&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:restart&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We changed the following things,
1. We changed the <em>application</em> to <strong>deploy_sample</strong>, which is our application name
2. We changed <em>repo_url</em> to <strong>git@github.com:climber2002/deploy_sample.git</strong>, which is our git repository
3. We changed the <em>rbenv_type</em> from <strong>:system</strong> to <strong>:user</strong>, and <em>rbenv_ruby</em> to <strong>2.1.4</strong>, which is the version we installed just now
4. We changed the <em>linked_files</em> to add secrets.yml, the linked files will be stored in share folder but they will be created a symbolic link in config folder.
5. We changed the config_files to add secrets.yml, since we also want to copy this file to shared folder.</p>

<p>Now let&rsquo;s update <em>config/deploy/production.rb</em> file as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:stage</span><span class="p">,</span> <span class="ss">:production</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This is used in the Nginx VirtualHost to specify which domains</span>
</span><span class='line'><span class="c1"># the app should appear on. If you don&#39;t yet have DNS setup, you&#39;ll</span>
</span><span class='line'><span class="c1"># need to create entries in your local Hosts file for testing.</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:server_name</span><span class="p">,</span> <span class="s2">&quot;www.example.com example.com&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># used in case we&#39;re deploying multiple versions of the same</span>
</span><span class='line'><span class="c1"># app side by side. Also provides quick sanity checks when looking</span>
</span><span class='line'><span class="c1"># at filepaths</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:full_app_name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:application</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:stage</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">server</span> <span class="s1">&#39;192.168.22.10&#39;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="sx">%w{web app db}</span><span class="p">,</span> <span class="ss">primary</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/product/</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:full_app_name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># dont try and infer something as important as environment from</span>
</span><span class='line'><span class="c1"># stage name.</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rails_env</span><span class="p">,</span> <span class="ss">:production</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># number of unicorn workers, this will be reflected in</span>
</span><span class='line'><span class="c1"># the unicorn.rb and the monit configs</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:unicorn_worker_count</span><span class="p">,</span> <span class="mi">5</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># whether we&#39;re using ssl or not, used for building nginx</span>
</span><span class='line'><span class="c1"># config file</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:enable_ssl</span><span class="p">,</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>We changed following things for this file
1. We changed the <em>server</em> to <strong>192.168.22.10</strong>, which is our VM IP address.
2. We changed <em>deploy_to</em> to <strong>/product/#{fetch(:full_app_name)}</strong> since we want to deploy to <strong>/product</strong> folder.</p>

<p>During real deployment you should also change the <em>server_name</em> to the correct domain name for your server.</p>

<p>Now let&rsquo;s run the command to setup deploy.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>bundle <span class="nb">exec </span>cap production deploy:setup_config
</span></code></pre></td></tr></table></div></figure>


<p>This step will copy all shared folders to <strong>/product/deploy_sample_production/shared/config</strong> folder, let&rsquo;s check that folder in our VM,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:~/.ssh<span class="nv">$ </span><span class="nb">cd</span> /product/deploy_sample_production/shared/config
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:/product/deploy_sample_production/shared/config<span class="nv">$ </span>ls -l
</span><span class='line'>total 28
</span><span class='line'>-rw-r----- 1 deploy sudo  203 Feb 10 04:45 database.example.yml
</span><span class='line'>-rw-r----- 1 deploy sudo  188 Feb 10 04:45 log_rotation
</span><span class='line'>-rw-r----- 1 deploy sudo 2629 Feb 10 04:45 monit
</span><span class='line'>-rw-r----- 1 deploy sudo  645 Feb 10 04:45 nginx.conf
</span><span class='line'>-rw-r----- 1 deploy sudo  935 Feb 10 04:45 secrets.yml
</span><span class='line'>-rwxr-x--x 1 deploy sudo 2001 Feb 10 04:45 unicorn_init.sh
</span><span class='line'>-rw-r----- 1 deploy sudo 1333 Feb 10 04:45 unicorn.rb
</span></code></pre></td></tr></table></div></figure>


<p>We can see that some files are copied to the <strong>/product/deploy_sample_production/shared/config</strong> folder. Now we need to update the database.yml and secrets.yml.</p>

<p>For database.yml, let&rsquo;s firstly copy the database.example.yml to database.yml</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deploy@vagrant-ubuntu-trusty-64:/product/deploy_sample_production/shared/config<span class="nv">$ </span>cp database.example.yml database.yml
</span><span class='line'>deploy@vagrant-ubuntu-trusty-64:/product/deploy_sample_production/shared/config<span class="nv">$ </span>vi database.yml
</span></code></pre></td></tr></table></div></figure>


<p>We changed the content as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgresql</span>
</span><span class='line'>  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5000</span>
</span><span class='line'>  <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">utf8</span>
</span><span class='line'>  <span class="l-Scalar-Plain">reconnect</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deploy_sample_production</span>
</span><span class='line'>  <span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deploy_sample</span>
</span><span class='line'>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">secret</span>
</span><span class='line'>  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>  <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5432</span>
</span></code></pre></td></tr></table></div></figure>


<p>We set the username and password to the value we created in Part 1, and also we set host to localhost since we installed database and application on same server.</p>

<p>Now we need to update secrets.yml, firstly lets generate a secret from our project folder</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>rake secret
</span><span class='line'>9f529340b1a34f223cb7a6fd2cf0d0d039ed5d03fe3d2b2787cc712585ffcee22e14e6136486356b12f383bc48f231896d556da131bd8c8d8bcf17bbc9ef7048
</span></code></pre></td></tr></table></div></figure>


<p>Now we copy this value to secrets.yml, of course you can also use an environment variable. After update our secrets.yml look like this,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">75b397c3479019e0d5b2c7e3f57660c501369ffa4232958bcde366dc08e86b2f227fb1a57e172eccafc37fcfd5616909d4105d0d07069a4d061abf58a5745eef</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">351180e5d983a83fa207f7df16e8509ad55910bab6d4e7a9e94dd3e80f8385fc8d8f5b1101fd2e565d2a0afb340917ac245d2ef69e00686e6eb6044ad92b3104</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Do not keep production secrets in the repository,</span>
</span><span class='line'><span class="c1"># instead read values from the environment.</span>
</span><span class='line'><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9f529340b1a34f223cb7a6fd2cf0d0d039ed5d03fe3d2b2787cc712585ffcee22e14e6136486356b12f383bc48f231896d556da131bd8c8d8bcf17bbc9ef7048</span>
</span></code></pre></td></tr></table></div></figure>


<p>the production:secret_key_base is set to the value we just created.</p>

<p>Now all preparation has been done, now let&rsquo;s do the deploy!</p>

<p>Let&rsquo;s run following command,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>host:~/rails_projects/deploy_sample<span class="nv">$ </span>bundle <span class="nb">exec </span>cap production deploy
</span></code></pre></td></tr></table></div></figure>


<p>If everything runs correctly, after a long logs the deployment should be successful. And from your browser you can access <a href="http://192.168.22.10/articles">http://192.168.22.10/articles</a> to see the Article scaffold we&rsquo;ve created.</p>

<p><img src="/images/deploy_sample.png"></p>

<h2>Summary</h2>

<p>In this part we&rsquo;ve introduced the steps to deploy by using Capistrano 3. And we utilized a Capistrano template. But you may be wondering what Capistrano has done for us. So in next part I will introduct what has been done in this template.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Andy Wang</span></span>

      








  


<time datetime="2015-02-09T21:27:23+10:30" pubdate data-updated="true">Feb 9<span>th</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/capistrano/'>capistrano</a>, <a class='category' href='/blog/categories/deploy/'>deploy</a>, <a class='category' href='/blog/categories/postgresql/'>postgresql</a>, <a class='category' href='/blog/categories/unicorn/'>unicorn</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://climber2002.github.io/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/" data-via="" data-counturl="http://climber2002.github.io/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/02/08/deploy-rails-application-on-ubuntu-14-dot-04/" title="Previous Post: Deploy Rails application on Ubuntu 14.04 Part 1">&laquo; Deploy Rails application on Ubuntu 14.04 Part 1</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/02/16/deploy-rails-application-on-ubuntu-14-dot-04-part-3/" title="Next Post: Deploy Rails Application on Ubuntu 14.04 Part 3">Deploy Rails Application on Ubuntu 14.04 Part 3 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/02/16/deploy-rails-application-on-ubuntu-14-dot-04-part-3/">Deploy Rails Application on Ubuntu 14.04 Part 3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/">Deploy Rails Application on Ubuntu 14.04 Part 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/08/deploy-rails-application-on-ubuntu-14-dot-04/">Deploy Rails application on Ubuntu 14.04 Part 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/07/install-and-configure-postgresql-on-ubuntu-14-dot-04/">Configure Customized data directory for Postgresql on Ubuntu 14.04</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/22/capybara-integration-tests-with-jquery-selectize/">Capybara integration tests with JQuery selectize</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Andy Wang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'climber2002';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://climber2002.github.io/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/';
        var disqus_url = 'http://climber2002.github.io/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
