
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Digging Rails : How Rails initializes itself Part 2 - AprilTouch</title>
  <meta name="author" content="Andy Wang">

  
  <meta name="description" content="In last post we discussed the initialization process when a Rails application starts. And we disucssed in config/environment.rb it calls Rails. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://climber2002.github.io/blog/2014/08/26/digging-rails-how-rails-initializes-itself-part-2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="AprilTouch" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-51109944-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">AprilTouch</a></h1>
  
    <h2>My blog about Ruby and iOS development</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:climber2002.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-me">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Digging Rails : How Rails Initializes Itself Part 2</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-26T19:51:23+09:30" pubdate data-updated="true">Aug 26<span>th</span>, 2014</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>In <a href="/blog/2014/08/24/digging-rails-how-rails-initializes-itself/">last post</a> we discussed the initialization process when a Rails application starts. And we disucssed in <em>config/environment.rb</em> it calls <code>Rails.application.initialize!</code> to initialize the application. And in this blog we will have a detailed examination what has been done in this method.</p>

<p>Let&rsquo;s have a look what&rsquo;s in that method,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/application.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Engine</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Initialize the application passing the given group. By default, the</span>
</span><span class='line'>    <span class="c1"># group is :default</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize!</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="ss">:default</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>      <span class="k">raise</span> <span class="s2">&quot;Application has been already initialized.&quot;</span> <span class="k">if</span> <span class="vi">@initialized</span>
</span><span class='line'>      <span class="n">run_initializers</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@initialized</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>      <span class="nb">self</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>we can see that it just calls the <code>run_initializers</code> method, this method is actually an instance method in a module called <em>Rails::Initializable</em>. The <em>Rails::Application</em> has following hirarchy,</p>

<p><img src="/images/initializable.png" width="200" height="250"></p>

<p>At the bottom is our Sample::Application class defined in config/application.rb. Its super class is Rails::Application which inherits from Rails::Engine. And Rails::Engine&rsquo;s parent is Rails::Railtie. The <em>Rails::Railtie</em> includes the module <em>Rails::Initializable</em>. The <code>run_initializers</code> method is defined in that module. The Railtie is to manage the initialization and configuration of each module. In Rails each module such as Active Record, Active Support has its own Railtie class which inherits from <em>Rails::Railtie</em>. After this blog you should understand the main functionality of the Railtie.</p>

<p>Let&rsquo;s have a look at the module <em>Rails::Initializable</em>. This module provides a set of methods to manage the order of initialization.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Initializable</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>      <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="no">ClassMethods</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">run_initializers</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="ss">:default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@ran</span><span class="p">)</span>
</span><span class='line'>      <span class="n">initializers</span><span class="o">.</span><span class="n">tsort_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">initializer</span><span class="o">|</span>
</span><span class='line'>        <span class="n">initializer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">initializer</span><span class="o">.</span><span class="n">belongs_to?</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="vi">@ran</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initializers</span>
</span><span class='line'>      <span class="vi">@initializers</span> <span class="o">||=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">initializers_for</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initializers</span>
</span><span class='line'>        <span class="vi">@initializers</span> <span class="o">||=</span> <span class="no">Collection</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initializers_chain</span>
</span><span class='line'>        <span class="n">initializers</span> <span class="o">=</span> <span class="no">Collection</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>        <span class="nb">ancestors</span><span class="o">.</span><span class="n">reverse_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span>
</span><span class='line'>          <span class="k">next</span> <span class="k">unless</span> <span class="n">klass</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:initializers</span><span class="p">)</span>
</span><span class='line'>          <span class="n">initializers</span> <span class="o">=</span> <span class="n">initializers</span> <span class="o">+</span> <span class="n">klass</span><span class="o">.</span><span class="n">initializers</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">initializers</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initializers_for</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
</span><span class='line'>        <span class="no">Collection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">initializers_chain</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span> <span class="p">})</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initializer</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
</span><span class='line'>        <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;A block must be passed when defining an initializer&quot;</span> <span class="k">unless</span> <span class="n">blk</span>
</span><span class='line'>        <span class="n">opts</span><span class="o">[</span><span class="ss">:after</span><span class="o">]</span> <span class="o">||=</span> <span class="n">initializers</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">name</span> <span class="k">unless</span> <span class="n">initializers</span><span class="o">.</span><span class="n">empty?</span> <span class="o">||</span> <span class="n">initializers</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">opts</span><span class="o">[</span><span class="ss">:before</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">initializers</span> <span class="o">&lt;&lt;</span> <span class="no">Initializer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If a class includes this module, it can call the class method <code>initializer</code> to register a initializer to a class instance variable <code>@initializers</code>. This method accepts three parameters: the name, an option hash which you can define the order of the initializer, and a block, this block accepts one parameter which is normally our <code>Rails.application</code> instance.</p>

<p>Let&rsquo;s check the definition of the <em>Initializer</em> class.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Initializable</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Initializer</span>
</span><span class='line'>      <span class="kp">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:block</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>        <span class="n">options</span><span class="o">[</span><span class="ss">:group</span><span class="o">]</span> <span class="o">||=</span> <span class="ss">:default</span>
</span><span class='line'>        <span class="vi">@name</span><span class="p">,</span> <span class="vi">@context</span><span class="p">,</span> <span class="vi">@options</span><span class="p">,</span> <span class="vi">@block</span> <span class="o">=</span> <span class="nb">name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">block</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">before</span>
</span><span class='line'>        <span class="vi">@options</span><span class="o">[</span><span class="ss">:before</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">after</span>
</span><span class='line'>        <span class="vi">@options</span><span class="o">[</span><span class="ss">:after</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">belongs_to?</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@options</span><span class="o">[</span><span class="ss">:group</span><span class="o">]</span> <span class="o">==</span> <span class="n">group</span> <span class="o">||</span> <span class="vi">@options</span><span class="o">[</span><span class="ss">:group</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:all</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@context</span><span class="o">.</span><span class="n">instance_exec</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">self</span> <span class="k">if</span> <span class="vi">@context</span>
</span><span class='line'>        <span class="no">Initializer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="vi">@options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the <code>initialize</code> method, it accepts a <em>context</em> object, notice that in <em>Rails::Initializable</em>, the <code>initializer</code> class method pass context as nil. But later a initializer could call <code>bind</code> to generate a new initializer with the context bind to an object. So if a class includes Rails::Initializable, its <code>@initializers</code> class instance variable contains a list of <em>initializer templates</em>. And these initializer templates could be instantiated by bind to a context object. And then pay attention that when a class includes <em>Rails::Initializable</em> module, it also has a <code>initializers</code> instance method, this method actually gets all initializer templates from itself and its ancestors and pass itself as the context.</p>

<p>Let&rsquo;s write some classes to verify how <em>Rails::Initializable</em> works. I created a file <em>parent.rb</em> in app/models which has following contents,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/parent.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Parent</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Initializable</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">initializer</span> <span class="s1">&#39;config2&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">config2</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">initializer</span> <span class="s1">&#39;config1&#39;</span><span class="p">,</span> <span class="ss">before</span><span class="p">:</span> <span class="s1">&#39;config2&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">config1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">config2</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;config2 in </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">config1</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;config1 in </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inspect</span>
</span><span class='line'>    <span class="s1">&#39;parent&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This class Parent is a normal class which includes <em>Rails::Initializable</em>. Two initializers are defined: <em>config2</em> and <em>config1</em>. Although we defined <em>config1</em> after <em>config2</em>, but we passed <code>before: 'config2'</code> when initialize <em>config1</em>.</p>

<p>Now let&rsquo;s open a rails console. The Parent should have a class method which returns all initializers. Let&rsquo;s print the names of the initializers.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>andywang@Andys-MacBook-Pro sample$ rails c
</span><span class='line'>Loading development environment (Rails 4.2.0.beta1)
</span><span class='line'>2.0.0-p353 :001 > Parent.initializers.map(&:name)
</span><span class='line'> => ["config2", "config1"]</span></code></pre></td></tr></table></div></figure>


<p>And the initializers in the class act as a template, their instance variable <em>@context</em> is nil. Let&rsquo;s verify that by printing the <em>@context</em> instance variable, we can see they are nil.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :006 >   Parent.initializers.map { |initializer| initializer.instance_variable_get('@context') }
</span><span class='line'> => [nil, nil]</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s create an instance of Parent. We can see that the instance also has an instance method called <em>initializers</em>. Let&rsquo;s print the name,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :008 >   parent = Parent.new
</span><span class='line'> => parent 
</span><span class='line'>2.0.0-p353 :009 > parent.initializers.map(&:name)
</span><span class='line'> => ["config2", "config1"]</span></code></pre></td></tr></table></div></figure>


<p>Just now we said that the initializers in the class are like a template, and for the initializers in the object instance, we can think that the initializers are <em>instantiated</em> by setting the <em>@context</em> instance variable. We can verify that by printing the instance variable of all initializers.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :011 >   parent.initializers.map { |initializer| initializer.instance_variable_get('@context') }
</span><span class='line'> => [parent, parent]</span></code></pre></td></tr></table></div></figure>


<p>We can see that the <em>@context</em> has been set to the <em>parent</em> object.</p>

<p>And if we call the <em>run_initializers</em> method,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :013 >   parent.run_initializers
</span><span class='line'>config1 in Parent
</span><span class='line'>config2 in Parent
</span><span class='line'> => true</span></code></pre></td></tr></table></div></figure>


<p>Notice two things here, first the config1 is executed before the config2. And secondly notice why we can call the <em>config1</em> and <em>config2</em> methods in the initializer block? Because when the initializers are run, the <em>self</em> object in the block is set to the <em>@context</em> instance variable. Since our context object is <em>parent</em>, and <em>config1</em> and <em>config2</em> are instance methods of this object, of course we can call it.</p>

<p>Now let&rsquo;s create a subclass Child1 which inherits from Parent, and in this class it defines another initializer whose name is <em>config_in_child1</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/child1.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Child1</span> <span class="o">&lt;</span> <span class="no">Parent</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">initializer</span> <span class="s1">&#39;config_in_child1&#39;</span><span class="p">,</span> <span class="ss">after</span><span class="p">:</span> <span class="s1">&#39;config2&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;config in child1&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inspect</span>
</span><span class='line'>    <span class="s2">&quot;child1&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s restart our console and try to create an instance of Child1 and call <em>run_initializers</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>andywang@Andys-MacBook-Pro sample$ rails c
</span><span class='line'>Loading development environment (Rails 4.2.0.beta1)
</span><span class='line'>2.0.0-p353 :001 > child1 = Child1.new
</span><span class='line'> => child1 
</span><span class='line'>2.0.0-p353 :002 > child1.run_initializers
</span><span class='line'>config1 in Child1
</span><span class='line'>config2 in Child1
</span><span class='line'>config in child1
</span><span class='line'> => true</span></code></pre></td></tr></table></div></figure>


<p>We can see that when an instance run its initializers, it will run the initializers in its ancestors first, from top to bottom. Here the two initializers <em>config1</em> and <em>config2</em> are executed first, then it&rsquo;s <em>config_in_child1</em> in Child1 class.</p>

<p>Now let&rsquo;s create another class Child2 also has an initializer, similar as Child1.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/child2.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Child2</span> <span class="o">&lt;</span> <span class="no">Parent</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">initializer</span> <span class="s1">&#39;config_in_child2&#39;</span><span class="p">,</span> <span class="ss">after</span><span class="p">:</span> <span class="s1">&#39;config2&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;config in child2&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inspect</span>
</span><span class='line'>    <span class="s2">&quot;child2&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then let&rsquo;s create one <em>App</em> class which combines one instance of Child1 and Child2.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/app.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">App</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Initializable</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="vi">@child1</span> <span class="o">=</span> <span class="no">Child1</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@child2</span> <span class="o">=</span> <span class="no">Child2</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initializers</span>
</span><span class='line'>    <span class="vi">@child1</span><span class="o">.</span><span class="n">initializers</span> <span class="o">+</span> <span class="vi">@child2</span><span class="o">.</span><span class="n">initializers</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This class has two instance variables <em>@child1</em> and <em>@child2</em>, which is an instance of Child1 and Child2 separately. This class also includes <em>Rails::Initializable</em>, but it overrides the <em>initializers</em> method to return the intializers of both <em>@child1</em> and <em>@child2</em>. Now let&rsquo;s open a new rails console, and create one instance of App and call <code>run_initializers</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>andywang@Andys-MacBook-Pro sample$ rails c
</span><span class='line'>Loading development environment (Rails 4.2.0.beta1)
</span><span class='line'>2.0.0-p353 :001 > app = App.new
</span><span class='line'> => #&lt;App:0x007fed06691540 @child1=child1, @child2=child2> 
</span><span class='line'>2.0.0-p353 :002 > app.run_initializers
</span><span class='line'>config1 in Child1
</span><span class='line'>config1 in Child2
</span><span class='line'>config2 in Child1
</span><span class='line'>config2 in Child2
</span><span class='line'>config in child1
</span><span class='line'>config in child2
</span><span class='line'> => true</span></code></pre></td></tr></table></div></figure>


<p>We can see that when we run <code>app.run_initializers</code>, it runs all initializers in @child1 and @child2. And also the order is maintained. All config1 initializers are executed before config2 initializers.</p>

<p>The <em>Rails::Application</em> class also overrides the <em>initializers</em> method like the <em>App</em> class above. It maintains a list of Railties and run the <code>Rails.application.initialize!</code> method is called, it run all Railties&#8217; initializers.</p>

<p>And we could open a rails console to display all initializers and its associated binding context.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2.0.0-p353 :003 > pp Rails.application.initializers.tsort.map {|initializer| [initializer.name, initializer.instance_variable_get("@context").class]}
</span><span class='line'>[[:set_load_path, Coffee::Rails::Engine],
</span><span class='line'> [:set_load_path, Jquery::Rails::Engine],
</span><span class='line'> [:set_load_path, Turbolinks::Engine],
</span><span class='line'> [:set_load_path, WebConsole::Engine],
</span><span class='line'> [:set_load_path, Sample::Application],
</span><span class='line'> [:set_autoload_paths, Coffee::Rails::Engine],
</span><span class='line'> [:set_autoload_paths, Jquery::Rails::Engine],
</span><span class='line'> [:set_autoload_paths, Turbolinks::Engine],
</span><span class='line'> [:set_autoload_paths, WebConsole::Engine],
</span><span class='line'> [:set_autoload_paths, Sample::Application],
</span><span class='line'> [:add_routing_paths, Coffee::Rails::Engine],
</span><span class='line'> [:add_routing_paths, Jquery::Rails::Engine],
</span><span class='line'> ....</span></code></pre></td></tr></table></div></figure>


<p>This is a very long list. Actually by default there is 108 initializers. If you are interested you can check the Rails source code to see which initializer does what. For example, the :set_load_path is to set the $LOAD_PATH global. So each engine has a chance to modify the load path.</p>

<p>So after this blog you should have a general idea what Rails has done when it calls <code>Rails.application.initialize!</code></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Andy Wang</span></span>

      








  


<time datetime="2014-08-26T19:51:23+09:30" pubdate data-updated="true">Aug 26<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/rails/'>rails</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://climber2002.github.io/blog/2014/08/26/digging-rails-how-rails-initializes-itself-part-2/" data-via="" data-counturl="http://climber2002.github.io/blog/2014/08/26/digging-rails-how-rails-initializes-itself-part-2/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/08/24/digging-rails-how-rails-initializes-itself/" title="Previous Post: Digging Rails - How Rails initializes itself">&laquo; Digging Rails - How Rails initializes itself</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/09/07/depoly-a-rails-4-application-on-an-amazon-ec2-server/" title="Next Post: Depoly a rails 4 application on an Amazon EC2 server">Depoly a rails 4 application on an Amazon EC2 server &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/">Deploy Rails Application on Ubuntu 14.04 Part 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/08/deploy-rails-application-on-ubuntu-14-dot-04/">Deploy Rails application on Ubuntu 14.04 Part 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/07/install-and-configure-postgresql-on-ubuntu-14-dot-04/">Install and configure Postgresql on Ubuntu 14.04</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/22/capybara-integration-tests-with-jquery-selectize/">Capybara integration tests with JQuery selectize</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/07/depoly-a-rails-4-application-on-an-amazon-ec2-server/">Depoly a rails 4 application on an Amazon EC2 server</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Andy Wang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'climber2002';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://climber2002.github.io/blog/2014/08/26/digging-rails-how-rails-initializes-itself-part-2/';
        var disqus_url = 'http://climber2002.github.io/blog/2014/08/26/digging-rails-how-rails-initializes-itself-part-2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
