<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Postgis | AprilTouch]]></title>
  <link href="http://climber2002.github.io/blog/categories/postgis/atom.xml" rel="self"/>
  <link href="http://climber2002.github.io/"/>
  <updated>2014-09-14T22:45:29+09:30</updated>
  <id>http://climber2002.github.io/</id>
  <author>
    <name><![CDATA[Andy Wang]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Integrate PostGIS and Google Maps in Rails Part 2]]></title>
    <link href="http://climber2002.github.io/blog/2014/05/26/integrate-postgis-and-google-maps-in-rails-part-2/"/>
    <updated>2014-05-26T00:19:16+09:30</updated>
    <id>http://climber2002.github.io/blog/2014/05/26/integrate-postgis-and-google-maps-in-rails-part-2</id>
    <content type="html"><![CDATA[<p>Here is the Part 2 of <em>Integrate PostGIS and Google maps in Rails</em>, in this part we will render the provinces of Gabon on Google map. Unlike Part 1 the GeoJSON data is fetched from a static file, in this part we will see how to fetch data from PostGIS and encode them into GeoJSON directly. The result is like the following figure, the 9 provinces are rendered on the map, and when the user put his mouse over one province, that area will be highlighted, and also on the top right there is a label which shows the name of the province that is highlighted.</p>

<p><img src="/images/province_highlighted.png"></p>

<h2>Create the Province model</h2>

<p>The first thing we need to do is to create a <strong>Province</strong> model. Like how we created the <strong>Country</strong> model in part 1, we create a <strong>Province</strong> model, and then import the data in shape file into our PostGIS database. The main part in the migration is as following,</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ImportProvincesFromShp</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;from_shp_sql = `shp2pgsql -c -g geom -W LATIN1 -s 4326 </span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;shpfiles&#39;</span><span class="p">,</span> <span class="s1">&#39;GAB_adm1.shp&#39;</span><span class="p">)</span><span class="si">}</span><span class="sr"> provinces_ref`</span>
</span><span class='line'>
</span><span class='line'><span class="sr">Province.transaction do</span>
</span><span class='line'><span class="sr">  execute from_shp_sql</span>
</span><span class='line'>
</span><span class='line'><span class="sr">  execute &amp;lt;&amp;lt;-SQL</span>
</span><span class='line'><span class="sr">      insert into provinces(name, geom) </span>
</span><span class='line'><span class="sr">        select name_1, geom from provinces_ref</span>
</span><span class='line'><span class="sr">  SQL</span>
</span><span class='line'>
</span><span class='line'><span class="sr">  drop_table :provinces_ref</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="nf">down</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;Province.delete_all</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The province data is in shape file <em>GAB_adm1.shp</em>, and we fetch the province name and geometry from the shape file and import them into <em>provinces</em> table (In the shape file province name is stored as attribute <em>name_1</em>).</p>

<h2>Encode the feature</h2>

<p>Now we need to fetch data from database and encode them as GeoJSON. GeoJSON is a JSON format for encoding geographic data structures. The following example is stolen from <a href="http://geojson.org/">the GeoJSON website</a>. We can see that in addition to the geometry data, the JSON can also encode additional properties.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">&amp;ldquo;type&amp;rdquo;:</span> <span class="err">&amp;ldquo;Feature&amp;rdquo;,</span>
</span><span class='line'>  <span class="err">&amp;ldquo;geometry&amp;rdquo;:</span> <span class="err">{&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;pre&gt;&lt;code&gt;</span><span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Point&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">125.6</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">]</span>
</span><span class='line'><span class="err">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span>  <span class="p">}</span><span class="err">,</span>
</span><span class='line'>  <span class="err">&amp;ldquo;properties&amp;rdquo;:</span> <span class="p">{</span><span class="err">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;pre&gt;&lt;code&gt;</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Dinagat Islands&quot;</span>
</span><span class='line'><span class="err">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span>  <span class="p">}</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>We will mainly use the <em>rgeo-geojson</em> gem to do the encoding. In <em>rgeo-geojson</em> gem, it converts a geometry type to a feature and then encode the feature to a hash, and then the hash can be rendered as a JSON.</p>

<p> <div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">province</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">factory</span> <span class="o">=</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">::</span><span class="no">EntityFactory</span><span class="o">.</span><span class="n">instance</span>
</span><span class='line'><span class="n">feature</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">feature</span> <span class="n">province</span><span class="o">.</span><span class="n">geom</span>
</span><span class='line'><span class="nb">hash</span> <span class="o">=</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">.</span><span class="n">encode</span> <span class="n">feature</span>
</span><span class='line'><span class="nb">puts</span> <span class="nb">hash</span><span class="o">.</span><span class="n">to_json</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>We create a Concern named <strong>Featurable</strong>, which will add a <em>featurable</em> class method into the class which includes it. So for example in <strong>Province</strong> class, we include the <strong>Featurable</strong> like following,</p>

<p> <div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Province</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Featurable</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  featurable :geom, [:name]</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The featurable accepts two parameters, the first is mandatory, which is the name of the attribute which contains the geometry data, the second parameter is an optional array of attribute names, when encoding it as GeoJSON, those attributes will be encoded as attributes. Here we encode the <em>name</em> attribute as the property of the feature. Now the <strong>Province</strong> class will have a instance method named <strong>to_feature</strong>, which returns a RGeo::GeoJSON::Feature.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">province</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">feature</span> <span class="o">=</span> <span class="n">province</span><span class="o">.</span><span class="n">to_feature</span>
</span><span class='line'><span class="nb">puts</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The result will display as following, it includes the name as its property and also has an id.
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">&amp;ldquo;type&amp;rdquo;:&amp;ldquo;Feature&amp;rdquo;,</span>
</span><span class='line'>  <span class="err">&amp;ldquo;geometry&amp;rdquo;:{&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;pre&gt;&lt;code&gt;</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;MultiPolygon&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nt">&quot;coordinates&quot;</span><span class="p">:[[[[</span><span class="mf">9.499305999999933</span><span class="p">,</span><span class="mf">0.10763800000000856</span><span class="p">],</span>
</span><span class='line'>    <span class="err">......</span><span class="p">,[</span><span class="mf">9.748417000000074</span><span class="p">,</span><span class="mf">1.0649910000000773</span><span class="p">]]]]</span>
</span><span class='line'><span class="p">}</span><span class="err">,</span>
</span><span class='line'><span class="err">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span>  <span class="err">&amp;ldquo;properties&amp;rdquo;:</span><span class="p">{</span><span class="err">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;pre&gt;&lt;code&gt;</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Estuaire&quot;</span>
</span><span class='line'><span class="err">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span>  <span class="p">}</span><span class="err">,</span>
</span><span class='line'>  <span class="err">&amp;ldquo;id&amp;rdquo;:</span> <span class="mi">1</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Now let&rsquo;s have a look at how <strong>Featurable</strong> is implemented.
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Featurable</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  module ClassMethods&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">featurable</span> <span class="n">geom_attr_name</span><span class="p">,</span> <span class="n">property_names</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">define_method</span> <span class="ss">:to_feature</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">factory</span> <span class="o">=</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">::</span><span class="no">EntityFactory</span><span class="o">.</span><span class="n">instance</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">property_names</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="n">property_names</span><span class="p">)</span>
</span><span class='line'>    <span class="n">properties</span> <span class="o">=</span> <span class="n">property_names</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">property_name</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">hash</span><span class="o">[</span><span class="n">property_name</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span> <span class="o">=</span> <span class="n">read_attribute</span><span class="p">(</span><span class="n">property_name</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">hash</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">factory</span><span class="o">.</span><span class="n">feature</span> <span class="n">read_attribute</span><span class="p">(</span><span class="n">geom_attr_name</span><span class="p">),</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">properties</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1"># turns a collection of models to a feature collection</span>
</span><span class='line'><span class="c1"># All models in the collection should implement the to_feature method</span>
</span><span class='line'><span class="k">def</span> <span class="nf">to_feature_collection</span> <span class="n">models</span>
</span><span class='line'>  <span class="n">factory</span> <span class="o">=</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">::</span><span class="no">EntityFactory</span><span class="o">.</span><span class="n">instance</span>
</span><span class='line'>  <span class="n">features</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="ss">:to_feature</span><span class="p">)</span>
</span><span class='line'>  <span class="n">factory</span><span class="o">.</span><span class="n">feature_collection</span> <span class="n">features</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>In the implementation of <em>featurable</em> class method, when this method is called, the class will call <em>define_method</em> to define an instance method called <em>to_feature</em> and from line 9 to 13 it will generates a hash named <em>properties</em> whose key is the property name and value is the property value. And then on line 14 it calls the <em>RGeo::GeoJSON::EntityFactory#feature</em> method to create the feature and return it.</p>

<p>On line 21 it defines another class method called <em>to_feature_collection</em>, this is to convert a collection of models to a feature collection, for example the following code shows how to encode all 9 provinces as a feature collection.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">provinces</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'><span class="n">feature_collection</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">to_feature_collection</span> <span class="n">provinces</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>Provinces Controller</h2>

<p>Now let&rsquo;s create a <strong>ProvincesController</strong> to render all 9 provinces as GeoJSON.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;class ProvincesController &amp;lt; ApplicationController&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="nf">index</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;  @provinces = Province.all</span>
</span><span class='line'>
</span><span class='line'><span class="sr">  respond_to do |format|</span>
</span><span class='line'><span class="sr">    format.json do  </span>
</span><span class='line'><span class="sr">      feature_collection = Province.to_feature_collection @provinces</span>
</span><span class='line'><span class="sr">      render json: RGeo::GeoJSON.encode(feature_collection)</span>
</span><span class='line'><span class="sr">    end</span>
</span><span class='line'>
</span><span class='line'><span class="sr">    format.html</span>
</span><span class='line'><span class="sr">  end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>We can see that the <em>index</em> method responds to two formats, in the json format it will call <em>Province.to_feature_collection</em> to create the feature collection, and then calls <em>RGeo::GeoJSON.encode(feature_collection)</em> to encode the feature as a hash, and last calls <em>render</em> to render the hash as a JSON string.</p>

<p>In the <em>views/provinces/index.html.erb</em>, the main part is as following,</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//Create an info box for displaying names</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">infoBox</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">div</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;);</span>
</span><span class='line'><span class="nx">infoBox</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s1">&#39;info-box&#39;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;&amp;rdquo;;</span>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">ControlPosition</span><span class="p">.</span><span class="nx">RIGHT_TOP</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">infoBox</span><span class="p">);</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">mouseover</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">revertStyle</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="err">#</span><span class="nx">info</span><span class="o">-</span><span class="nx">box</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;).</span><span class="nx">text</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">feature</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">name</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;));</span>
</span><span class='line'>  <span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">overrideStyle</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">feature</span><span class="p">,</span> <span class="p">{</span> <span class="nx">fillColor</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">red</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;</span> <span class="p">});</span>
</span><span class='line'><span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">mouseout</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
</span><span class='line'>  <span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">revertStyle</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">feature</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span> <span class="nx">fillColor</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">green</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span>      <span class="nx">strokeWeight</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>From line 2 to line 4 it creates an info box at the RIGHT TOP to display province name. And from line 6 to line 10 it adds a <em>mouseover</em> event listener, so when the mouse is over the province region, it set the text of the info box to the <em>name</em> property of the feature. And on line 12 it defines a <em>mouseout</em> event listener so the style is reverted when the mouse is out of the province region.</p>

<p>So in this part we showed how to fetch geometry data from PostGIS database and render them on google map. The source code for this part is at <a href="https://github.com/climber2002/schoolpro/tree/part2">github</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PostGIS and Google Maps in Rails Part 1]]></title>
    <link href="http://climber2002.github.io/blog/2014/05/18/postgis-and-google-maps-in-rails-part-1/"/>
    <updated>2014-05-18T23:23:32+09:30</updated>
    <id>http://climber2002.github.io/blog/2014/05/18/postgis-and-google-maps-in-rails-part-1</id>
    <content type="html"><![CDATA[<p>Recently I need to work on a Rails project which is to manage the public and private schools in Gabon, a small country in Africa. And I need to integrate PostGIS and Google maps. I will create a series of blogs to share what I have done, and I will point out some common gotchas while integrate Rails with PostGIS and Google maps.</p>

<h2>Books and Blogs</h2>

<p>To work on PostGIS and Google Maps of course you need to learn them. This series is not a complete tutorial. To study PostGIS, the definite reference is <em>PostGIS in Action</em> by Regina O. Obe and Leo S. Hsu. Currently the second edition is in MEAP state and you can buy the ebook at <a href="http://manning.com/obe2/">manning website</a>. To study Google maps, the documentation at <a href="https://developers.google.com/maps/documentation/javascript/tutorial">google website</a> is already awesome, but if you prefer a book form, the book <em>Google Maps JavaScript API Cookbook</em> by Alper Dincer and Balkan Uraz is a good choice, which you can buy the kindle version at <a href="http://www.amazon.com/Google-Maps-JavaScript-API-Cookbook-ebook/dp/B00HJR6RD6">amazon</a></p>

<p>In the project to integrate PostGIS with Rails, I utilized some rubygems from RGeo. The original author of those rubygems, Daniel Azuma, has created a series of articles on <a href="http://daniel-azuma.com/articles/georails">his website</a>, which is very helpful. Actually this series has been inspired from his works.</p>

<h2>Let&rsquo;s start</h2>

<p>In this first blog I&rsquo;ll describe how to create a rails project and how to create migrations to import GIS data from shape files to our database.</p>

<h2>Install</h2>

<p>To work on PostGIS of course you need to install it first. If you work on a Mac OS environment like me, using the <a href="http://postgresapp.com/">PostgreSQL App</a> is the easiest way. This package already includes PostGIS 2.1, so you just need to enable it, which we will introduce later.</p>

<p>And since we use the <a href="https://github.com/rgeo/rgeo">RGeo</a> and some of its addons, you need to install <a href="http://trac.osgeo.org/geos">GEOS</a> and <a href="http://trac.osgeo.org/proj">Proj</a>, which RGeo depends on. For Mac users the easiest way is to install the frameworks <a href="http://www.kyngchaos.com/software:frameworks">here</a></p>

<h2>Create the application</h2>

<p>Now let&rsquo;s create a rails application and use PostgreSQL database (I use Rails 4.1).</p>

<p><code>
$ rails new schoolpro --database==postgresql
</code></p>

<p>Here my application name is schoolpro. Now open the Gemfile and add the <em>activerecord-postgis-adapter</em> gem.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">activerecord</span><span class="o">-</span><span class="n">postgis</span><span class="o">-</span><span class="n">adapter</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>And then in the database.yml, let&rsquo;s change the adapter from postgresql to postgis</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgis</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Now let&rsquo;s create the database by running <strong>rake db:create</strong>
<code>
$ rake db:create
</code></p>

<p>After the database is created, we need to enable the PostGIS extension by running following command
<code>
rake db:gis:setup
</code></p>

<!-- more -->


<h2>Get the shape files</h2>

<p>In this application I need to import some data from shape files to the database. The shapefile is a flat file format for geospatial data originally developed by ESRI for storing sets of geographic features. It supports certain vector shapes&mdash; points, lines, and polygons&mdash; along with associated attributes. Although shapefile began as a proprietary format, the format specification is readily available, and it is now a de facto standard for large datasets. A shapefile actually consists of three (and sometimes more) related files, each with the same base filename but different extensions. The main file has the extension &ldquo;.shp&rdquo; and contains the geometric data itself in a binary format. An auxiliary &ldquo;.shx&rdquo; file provides a simple flat index allowing random access into the shapefile. A second auxiliary &ldquo;.dbf&rdquo; file provides the attribute data in dBASE format. All shapefiles should have those three core files, although some shapefiles may include additional files containing coordinate system, spatial index, or other related information.</p>

<p>The shape files I got is from <a href="http://www.gadm.org/">gdam</a>, which is a spatial database of the locations of the world&rsquo;s administration areas. What I need is the shape files of Gabon. Just go to <a href="http://www.gadm.org/country">the download page</a>, select <em>Gabon</em> and File format as <em>Shapefile</em> and download it. The downloaded is a zip file, unzip it you will get 3 sets of shapefiles:</p>

<ul>
<li>GAB_adm0: This contains country data</li>
<li>GAB_adm1: This contains provinces data</li>
<li>GAB_adm2: This contains cities data</li>
</ul>


<p>Let&rsquo;s create a folder <em>shpfiles</em> under #{Rails.root}/db and copy all these files there. These files will be used in our migrations.</p>

<h2>Create the country model</h2>

<p>My goal is to import the country polygon data from a shape file into the database in rails migrations. Now let&rsquo;s import the countries shapefile. Firstly we need to create a <strong>Country</strong> model. So let&rsquo;s create a model <strong>Country</strong> and add following content in the migration file,</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateCountries</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;create_table :countries do |t|</span>
</span><span class='line'><span class="sr">  t.string :name, :unique =&amp;gt; true</span>
</span><span class='line'><span class="sr">  t.string :iso_code, :unique =&amp;gt; true</span>
</span><span class='line'><span class="sr">  t.multi_polygon :geom, :srid =&amp;gt; 4326</span>
</span><span class='line'><span class="sr">  t.timestamps</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'>
</span><span class='line'><span class="sr">change_table :countries do |t|</span>
</span><span class='line'><span class="sr">  t.index :geom, :spatial =&amp;gt; true</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Here we specified 3 attributes, <em>name</em> is country name, the <em>iso_code</em> is 3 letter code, for Gabon it&rsquo;s <strong>GAB</strong>. The <strong>t.multi_polygon</strong> is to create a multipolygon geometry column named <em>geom</em>, which represents that this column can store multipolygon type in PostGIS. And we set the SRID to 4326, which is most common in shape files. Although when Google maps displays its maps, it uses SRID 3857 however when draw vectors on it it still expects the vector data to be SRID to 4326. For a more explanation of SRID, consult <a href="http://daniel-azuma.com/articles/georails/part-4">Daniel&rsquo;s article</a></p>

<h2>Import the shape file</h2>

<p>Now let&rsquo;s import the data from the shape file into our new created <em>countries</em> table. We will use the <em>shp2pgsql</em> tool, which is already included in Postgres App. I assume that you already add the bin path into your PATH environment variable, if not, you can add them in your ~/.bash_profile</p>

<p><code>
export PATH=$PATH:/Applications/Postgres.app/Contents/Versions/9.3/bin
</code>
Now you can open a new terminal and run <em>shp2pgsql</em> to check its usage,</p>

<p>```
$ shp2pgsql
RELEASE: 2.1.1 (r12113)
USAGE: shp2pgsql [<options>] <shapefile> [[<schema>.]<table>]
OPTIONS:
  -s [<from>:]<srid> Set the SRID field. Defaults to 0.</p>

<pre><code>  Optionally reprojects from given SRID (cannot be used with -D).
</code></pre>

<p> (-d|a|c|p) These are mutually exclusive options:</p>

<pre><code> -d  Drops the table, then recreates it and populates
     it with current shape file data.
 -a  Appends shape file into current table, must be
     exactly the same table schema.
 -c  Creates a new table and populates it, this is the
     default if you do not specify any options.
 -p  Prepare mode, only creates the table.
</code></pre>

<p>  -g <geocolumn> Specify the name of the geometry/geography column</p>

<pre><code>  (mostly useful in append mode).
</code></pre>

<p>  -D  Use postgresql dump format (defaults to SQL insert statements).
  -e  Execute each statement individually, do not use a transaction.</p>

<pre><code>  Not compatible with -D.
</code></pre>

<p>  -G  Use geography type (requires lon/lat data or -s to reproject).
  -k  Keep postgresql identifiers case.
  -i  Use int4 type for all integer dbf fields.
  -I  Create a spatial index on the geocolumn.
  -S  Generate simple geometries instead of MULTI geometries.
  -t <dimensionality> Force geometry to be one of &lsquo;2D&rsquo;, &lsquo;3DZ&rsquo;, &lsquo;3DM&rsquo;, or &lsquo;4D&rsquo;
  -w  Output WKT instead of WKB.  Note that this can result in</p>

<pre><code>  coordinate drift.
</code></pre>

<p>  -W <encoding> Specify the character encoding of Shape&rsquo;s</p>

<pre><code>  attribute column. (default: "UTF-8")
</code></pre>

<p>  -N <policy> NULL geometries handling policy (insert*,skip,abort).
  -n  Only import DBF file.
  -T <tablespace> Specify the tablespace for the new table.</p>

<pre><code>  Note that indexes will still use the default tablespace unless the
  -X flag is also used.
</code></pre>

<p>  -X <tablespace> Specify the tablespace for the table&rsquo;s indexes.</p>

<pre><code>  This applies to the primary key, and the spatial index if
  the -I flag is used.
</code></pre>

<p>  &ndash;?  Display this help screen.
```</p>

<p>Now let&rsquo;s create another migration to import the shapefile,</p>

<p><code>
$ rails g migration import_countries_from_shp
</code></p>

<p>And in the migration file we have following contents,</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ImportCountriesFromShp</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;from_shp_sql = `shp2pgsql -c -g geom -W LATIN1 -s 4326 </span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;shpfiles&#39;</span><span class="p">,</span> <span class="s1">&#39;GAB_adm0.shp&#39;</span><span class="p">)</span><span class="si">}</span><span class="sr"> countries_ref`</span>
</span><span class='line'>
</span><span class='line'><span class="sr">Country.transaction do</span>
</span><span class='line'><span class="sr">  execute from_shp_sql</span>
</span><span class='line'>
</span><span class='line'><span class="sr">  execute &amp;lt;&amp;lt;-SQL</span>
</span><span class='line'><span class="sr">      insert into countries(name, iso_code, geom) </span>
</span><span class='line'><span class="sr">        select name_engli, iso, geom from countries_ref</span>
</span><span class='line'><span class="sr">  SQL</span>
</span><span class='line'>
</span><span class='line'><span class="sr">  drop_table :countries_ref</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="nf">down</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;Country.delete_all</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>In the <em>up</em> method of the migration, we first run the <em>shp2pgsql</em> in shell command by using Backticks(`) (check <a href="http://tech.natemurray.com/2007/03/ruby-shell-commands.html">this nice blog</a>). The output of shp2pgsql is the SQL scripts and it will be returned from the result of the shell command, and then we store it in variable <em>from_shp_sql</em>. We pass following parameters to the <em>shp2pgsql</em>:</p>

<ul>
<li><strong>-c</strong> Creates a new table and populates it</li>
<li><strong>-g geom</strong> Specify the geometry column name as <em>geom</em></li>
<li><strong>-W LATIN1</strong> Set the encoding to LATIN1</li>
<li><strong>-s 4326</strong> set the SRID to 4326, since this is the SRID of the shape file</li>
</ul>


<p>And then at last we pass the path of the shape file and name the generated table name as <em>countries_ref</em>.</p>

<p>And then we run this SQL in a transation to create the <em>countries_ref</em> table and import the data. And then run the following SQL to copy the data from table <em>countries_ref</em> to <em>countries</em>.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">insert</span> <span class="k">into</span> <span class="n">countries</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">iso_code</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">select</span> <span class="n">name_engli</span><span class="p">,</span> <span class="n">iso</span><span class="p">,</span> <span class="n">geom</span> <span class="k">from</span> <span class="n">countries_ref</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p> In the <em>countries_ref</em> table we already named the geometry column as <em>geom</em>. The <em>name_engli</em> and <em>iso</em> are attributes from the shape file and when shp2pgsql generate the table, it will name the column name the same as attribute name. At last since we already done the import we call <em>drop_table </em>countries_ref<em> to delete the </em>countries_ref* table.</p>

<p> In the <em>down</em> method, we just delete all data in the <em>countries</em> table.</p>

<p> Generate GeoJSON</p>

<hr />

<p> <a href="http://geojson.org/">GeoJSON</a> is a format for encoding a variety of geographic data structures. Google maps already has native support for it. In this blog let&rsquo;s create a static geojson file and render it in google map. In later blogs we will generate geojson format from database directly.</p>

<p> RGeo has a nice addon <a href="https://github.com/rgeo/rgeo-geojson">rgeo-geojson</a> which provides GeoJSON encoding and decoding services. Let&rsquo;s add it in Gemfile:</p>

<p> <div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">gem</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">rgeo</span><span class="o">-</span><span class="n">geojson</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p> After bundle install, we can open the rails console (I have installed pry-rails to use pry instead of irb),</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='irb'><span class='line'><span class="go"> pry(main)&gt; gabon = Country.first</span>
</span><span class='line'><span class="go"> pry(main)&gt;</span>
</span><span class='line'><span class="go"> pry(main)&gt; factory = RGeo::GeoJSON::EntityFactory.instance</span>
</span><span class='line'><span class="go">=&gt; #&amp;lt;RGeo::GeoJSON::EntityFactory:0x007ffe2c7265c8&gt;</span>
</span><span class='line'><span class="go"> pry(main)&gt; feature = factory.feature gabon.geom</span>
</span><span class='line'><span class="go"> pry(main)&gt; hash = RGeo::GeoJSON.encode feature</span>
</span><span class='line'><span class="go"> pry(main)&gt; File.open(&amp;lsquo;gabon.json&amp;rsquo;, &amp;lsquo;w&amp;rsquo;) {|file| file.write hash.to_json}</span>
</span><span class='line'><span class="go">  </span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p> Firstly we get the gabon model by calling <em>Country.first</em> since there is only one row in <em>countries</em> table. For rgeo-geojson, it uses a factory to generate the feature, so we get a factory and then calls the <em>feature</em> method and passes <em>gabon.geom</em>. This <em>geom</em> property is a RGeo geometry instance, and it&rsquo;s wrapped in <em>feature</em>. Then we call the <em>RGeo::GeoJson.encode feature</em> to encode it to a hash object, then at last we write the content of this hash to a file named <em>gabon.json</em>.</p>

<p> Now let&rsquo;s move this <em>gabon.json</em> to the public folder so the browser can access it directly.</p>

<p> When we start the server and access <a href="http://localhost:3000/gabon.json">http://localhost:3000/gabon.json</a> we should be able to see the content of this file in browser.</p>

<p> Render in google maps</p>

<hr />

<p> Now let&rsquo;s render this GeoJSON file on google maps. I have created a MapsController for that, and in the view it will create a <em>google.maps.Map</em> instance and render it. I won&rsquo;t explain all and you can check the source code in app/views/maps/index.html.erb. (Yeah I know it&rsquo;s very bad behavior to embed javascript in erb files directly, let&rsquo;s refactor it later.)</p>

<p> The most important part is to call *map.data.loadGeoJson to load GeoJSON data,</p>

<p> <div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'> <span class="kd">var</span> <span class="nx">mapOptions</span> <span class="o">=</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span>      <span class="nx">zoom</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">mapTypeControlOptions</span><span class="o">:</span> <span class="p">{</span><span class="nx">mapTypeIds</span><span class="o">:</span>
</span><span class='line'>           <span class="p">[</span><span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">MapTypeId</span><span class="p">.</span><span class="nx">ROADMAP</span><span class="p">]}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="kd">var</span> <span class="nx">mapElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">mapDiv</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;);</span>
</span><span class='line'><span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">Map</span><span class="p">(</span><span class="nx">mapElement</span><span class="p">,</span> <span class="nx">mapOptions</span><span class="p">);</span>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">setMapTypeId</span><span class="p">(</span><span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">MapTypeId</span><span class="p">.</span><span class="nx">ROADMAP</span><span class="p">);</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="c1">//Load GeoJSON</span>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">loadGeoJson</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="err">/gabon.json&amp;rdquo;);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Now when we access <a href="http://localhost:3000/maps">http://localhost:3000/maps</a> we can see that the the gabon area is filled with black color, as following figure,</p>

<p><img src="/images/gabon.png"></p>

<p>The repository of this project is at <a href="https://github.com/climber2002/schoolpro">https://github.com/climber2002/schoolpro</a> . The source code of each blog has its own tag so it&rsquo;s easy to get it. For this part the source code is at <a href="https://github.com/climber2002/schoolpro/tree/part1">https://github.com/climber2002/schoolpro/tree/part1</a> .</p>

<p>In this part we load the GeoJSON in a static file. In next part we will see how to generate the GeoJSON dynamically.</p>
]]></content>
  </entry>
  
</feed>
