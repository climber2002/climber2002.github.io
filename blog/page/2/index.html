
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>AprilTouch</title>
  <meta name="author" content="Andy Wang">

  
  <meta name="description" content="Recently I&rsquo;m reading the Rails source code and I wanna create a series of blogs to talk about it. Today I&rsquo;m going to introduct the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://climber2002.github.io/blog/page/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="AprilTouch" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-51109944-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">AprilTouch</a></h1>
  
    <h2>My blog about Ruby and iOS development</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:climber2002.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-me">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/24/digging-rails-how-rails-initializes-itself/">Digging Rails - How Rails Initializes Itself</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-24T17:35:26+09:30" pubdate data-updated="true">Aug 24<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/08/24/digging-rails-how-rails-initializes-itself/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I&rsquo;m reading the Rails source code and I wanna create a series of blogs to talk about it. Today I&rsquo;m going to introduct the initialization process of Rails. Just notice that I use the latest Rails 4.2.0 beta1 code for analysis. If you use Rails 4.1 or earlier, the code may be different (actually it is).</p>

<h2>bin/rails</h2>

<p>When we run <em>rails s</em> in a Rails application folder, it will call into the bin/rails script. This script has following contents,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'><span class="k">begin</span>
</span><span class='line'>  <span class="nb">load</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;../spring&quot;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">LoadError</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="no">APP_PATH</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../../config/application&#39;</span><span class="p">,</span>  <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../config/boot&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails/commands&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Firstly it tries to call the <em>spring</em> script which is an application preloader to speed up development by keeping our application in the background. And then it defines the APP_PATH constant, which points to the <strong>&lt;app_root>/config/application</strong>, and next it requires the config/boot.rb.</p>

<h2>config/boot.rb</h2>

<p>The config/boot.rb has following contents,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;BUNDLE_GEMFILE&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../../Gemfile&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;bundler/setup&#39;</span> <span class="c1"># Set up gems listed in the Gemfile.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since Rails uses <a href="http://bundler.io/">Bundler</a> to manage the rubygems, it defines a Gemfile which declares all dependencies of the application. The <code>ENV['BUNDLE_GEMFILE']</code> is set to the path of this Gemfile, and <code>require 'bundler/setup'</code> is calling Bundler to resolve the load paths of your Gem dependencies.</p>

<h2>rails/command.rb</h2>

<p>The <em>rails</em> next requires &lsquo;rails/commands&rsquo;, and let&rsquo;s have a look at that file,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/commands.rb</span>
</span><span class='line'>
</span><span class='line'><span class="no">ARGV</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;--help&#39;</span> <span class="k">if</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>
</span><span class='line'><span class="n">aliases</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;g&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;generate&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;d&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;destroy&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;c&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;console&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;s&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;db&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;dbconsole&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;r&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;runner&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">command</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">shift</span>
</span><span class='line'><span class="n">command</span> <span class="o">=</span> <span class="n">aliases</span><span class="o">[</span><span class="n">command</span><span class="o">]</span> <span class="o">||</span> <span class="n">command</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails/commands/commands_tasks&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="ss">Rails</span><span class="p">:</span><span class="ss">:CommandsTasks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="p">)</span><span class="o">.</span><span class="n">run_command!</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that when we pass <em>s</em> or <em>server</em> to the <em>rails</em> script, it will set <em>command</em> to <em>server</em> and then create an instance of Rails::CommandsTasks and call its <code>run_command!</code> instance method.</p>

<h2>rails/commands/commands_tasks.rb</h2>

<p>The rails/commands/commands_tasks defines the <code>Rails::CommandsTasks</code> class, let&rsquo;s check the important part of this class,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/commands/commands_tasks.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">CommandsTasks</span>
</span><span class='line'>    <span class="kp">attr_reader</span> <span class="ss">:argv</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">COMMAND_WHITELIST</span> <span class="o">=</span> <span class="sx">%w(plugin generate destroy console server dbconsole runner new version help)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@argv</span> <span class="o">=</span> <span class="n">argv</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">run_command!</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="n">command</span> <span class="o">=</span> <span class="n">parse_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="no">COMMAND_WHITELIST</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">send</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">write_error_message</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">parse_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">command</span>
</span><span class='line'>        <span class="k">when</span> <span class="s1">&#39;--version&#39;</span><span class="p">,</span> <span class="s1">&#39;-v&#39;</span>
</span><span class='line'>          <span class="s1">&#39;version&#39;</span>
</span><span class='line'>        <span class="k">when</span> <span class="s1">&#39;--help&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span>
</span><span class='line'>          <span class="s1">&#39;help&#39;</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">command</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the <code>run_command!</code> instance method, it checks that if the COMMAND_WHITELIST includes the command passed, then it will just invoke an instance method whose method name matches the <em>command</em> parameter. So in our case, if we passed <em>server</em> it will invoke the <code>server</code> method, which we show below,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/commands/commands_tasks.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">CommandsTasks</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">server</span>
</span><span class='line'>      <span class="n">set_application_directory!</span>
</span><span class='line'>      <span class="n">require_command!</span><span class="p">(</span><span class="s2">&quot;server&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Server</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
</span><span class='line'>        <span class="c1"># We need to require application after the server sets environment,</span>
</span><span class='line'>        <span class="c1"># otherwise the --environment option given to the server won&#39;t propagate.</span>
</span><span class='line'>        <span class="nb">require</span> <span class="no">APP_PATH</span>
</span><span class='line'>        <span class="no">Dir</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
</span><span class='line'>        <span class="n">server</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that it creates a Rails::Server instance and then require our application file which is already defined in APP_PATH.</p>

<p>Let&rsquo;s first have a look at the config/application.rb</p>

<h2>config/application.rb</h2>

<p>The config/application.rb has following contents,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config/application.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../boot&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails/all&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Require the gems listed in Gemfile, including any gems</span>
</span><span class='line'><span class="c1"># you&#39;ve limited to :test, :development, or :production.</span>
</span><span class='line'><span class="no">Bundler</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="o">*</span><span class="no">Rails</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Sample</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Application</span>
</span><span class='line'>    <span class="c1"># Settings in config/environments/* take precedence over those specified here.</span>
</span><span class='line'>    <span class="c1"># Application configuration should go into files in config/initializers</span>
</span><span class='line'>    <span class="c1"># -- all .rb files in that directory are automatically loaded.</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Set Time.zone default to the specified zone and make Active Record auto-convert to this zone.</span>
</span><span class='line'>    <span class="c1"># Run &quot;rake -D time&quot; for a list of tasks for finding time zone names. Default is UTC.</span>
</span><span class='line'>    <span class="c1"># config.time_zone = &#39;Central Time (US &amp; Canada)&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># The default locale is :en and all translations from config/locales/*.rb,yml are auto loaded.</span>
</span><span class='line'>    <span class="c1"># config.i18n.load_path += Dir[Rails.root.join(&#39;my&#39;, &#39;locales&#39;, &#39;*.{rb,yml}&#39;).to_s]</span>
</span><span class='line'>    <span class="c1"># config.i18n.default_locale = :de</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># For not swallow errors in after_commit/after_rollback callbacks.</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">raise_in_transactional_callbacks</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Firstly it requires the config/boot.rb, since above this file is already required by rails script, the require has no effect here.</p>

<p>Next it requires the &lsquo;rails/all&rsquo;, this file has following contents, it just load the railtie of each module. Each module has its own railtie, which is to manage the initialization and configuration. We will talk about railties in another blog so I&rsquo;ll not explain here.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/all.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;rails&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">%w(</span>
</span><span class='line'><span class="sx">  active_record</span>
</span><span class='line'><span class="sx">  action_controller</span>
</span><span class='line'><span class="sx">  action_view</span>
</span><span class='line'><span class="sx">  action_mailer</span>
</span><span class='line'><span class="sx">  active_job</span>
</span><span class='line'><span class="sx">  rails/test_unit</span>
</span><span class='line'><span class="sx">  sprockets</span>
</span><span class='line'><span class="sx">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">framework</span><span class="o">|</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">framework</span><span class="si">}</span><span class="s2">/railtie&quot;</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="no">LoadError</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then next it requires the gems we defined in Gemfile by calling <code>Bundler.require</code>. And next our application class is defined. Since I named my application as <em>sample</em>, the class is in <code>Sample</code> Module.</p>

<p>The Sample::Application extends from Rails::Application. After this class is defined the <code>Rails.application</code> will be set to an instance of Sample::Application. Why? Let&rsquo;s have a look at <code>Rails</code> module.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="vi">@application</span> <span class="o">=</span> <span class="vi">@app_class</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">attr_writer</span> <span class="ss">:application</span>
</span><span class='line'>    <span class="kp">attr_accessor</span> <span class="ss">:app_class</span><span class="p">,</span> <span class="ss">:cache</span><span class="p">,</span> <span class="ss">:logger</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">application</span>
</span><span class='line'>      <span class="vi">@application</span> <span class="o">||=</span> <span class="p">(</span><span class="n">app_class</span><span class="o">.</span><span class="n">instance</span> <span class="k">if</span> <span class="n">app_class</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that it defines two instance variables in Rails&rsquo;s singleton class, <em>@application</em> and <em>@app_class</em>. And after the app_class is defined, the <em>Rails.application</em> returns the <em>@application</em> if it&rsquo;s already defined, if not, it will call <em>app_class.instance</em> to create an instance.</p>

<p>So when does the Rails.app_class is defined? Let&rsquo;s have a look at the Rails::Application class.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/application.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Engine</span>
</span><span class='line'>    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">inherited</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>        <span class="k">super</span>
</span><span class='line'>        <span class="no">Rails</span><span class="o">.</span><span class="n">app_class</span> <span class="o">=</span> <span class="n">base</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that if there is a class inherits it, it will set the Rails.app_class to the inherited class, in our case Sample::Application. So after class Sample::Application is defined, the Rails.app_class is set, and then if we call <code>Rails.application</code>, the application instance will be initialized.</p>

<p>Notice that the <code>new</code> method in Rails::Application is set to private, so we can only call <code>instance</code> to generate an instance. And this instance is a singleton, which is reasonable since one Rails application should have only one application instance.</p>

<h2>Rails::Server</h2>

<p>After the application instance is instantiated, we go back to Rails::CommandsTasks#server method, it will call <code>Dir.chdir(Rails.application.root)</code> to go to application root folder, and then call <code>server.start</code>. Let&rsquo;s have a look how the Rails::Server is defined.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># rails/railties/lib/rails/commands/server.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Server</span> <span class="o">&lt;</span> <span class="o">::</span><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Server</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
</span><span class='line'>      <span class="k">super</span>
</span><span class='line'>      <span class="n">set_environment</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">start</span>
</span><span class='line'>      <span class="n">print_boot_information</span>
</span><span class='line'>      <span class="nb">trap</span><span class="p">(</span><span class="ss">:INT</span><span class="p">)</span> <span class="p">{</span> <span class="nb">exit</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">create_tmp_directories</span>
</span><span class='line'>      <span class="n">log_to_stdout</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:log_stdout</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">super</span>
</span><span class='line'>    <span class="k">ensure</span>
</span><span class='line'>      <span class="c1"># The &#39;-h&#39; option calls exit before @options is set.</span>
</span><span class='line'>      <span class="c1"># If we call &#39;options&#39; with it unset, we get double help banners.</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s1">&#39;Exiting&#39;</span> <span class="k">unless</span> <span class="vi">@options</span> <span class="o">&amp;&amp;</span> <span class="n">options</span><span class="o">[</span><span class="ss">:daemonize</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># TODO: this is no longer required but we keep it for the moment to support older config.ru files.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">app</span>
</span><span class='line'>      <span class="vi">@app</span> <span class="o">||=</span> <span class="k">begin</span>
</span><span class='line'>        <span class="n">app</span> <span class="o">=</span> <span class="k">super</span>
</span><span class='line'>        <span class="n">app</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:to_app</span><span class="p">)</span> <span class="p">?</span> <span class="n">app</span><span class="o">.</span><span class="n">to_app</span> <span class="p">:</span> <span class="n">app</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that Rails::Server extends from ::Rack::Server. <a href="http://rack.github.io/">Rack</a> is a specification which defines an interface between the web server and application. To support Rack, you need to define an <em>app</em> object, it has a <code>call</code> method, which takes the environment hash as a parameter, and returning an Array with three elements:</p>

<ul>
<li>The HTTP response code</li>
<li>A Hash of headers</li>
<li>The response body, which must respond to each</li>
</ul>


<p>Although this interface is very simple, you can configure middleware around the app and intercept the request and response.</p>

<p>Rack is also a <a href="https://github.com/rack/rack">rubygem</a>. It provides a set of middleware such as logging, set content length in HTTP response, etc. And it also defines a simple DSL to configure the middleware and app, the config file has <em>ru</em> extension and Rack will load a file called <em>config.ru</em> by default.</p>

<p>Let&rsquo;s have a look at the ::Rack::Server class,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Rack</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Server</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">attr_writer</span> <span class="ss">:options</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@options</span> <span class="o">=</span> <span class="n">options</span>
</span><span class='line'>      <span class="vi">@app</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:app</span><span class="o">]</span> <span class="k">if</span> <span class="n">options</span> <span class="o">&amp;&amp;</span> <span class="n">options</span><span class="o">[</span><span class="ss">:app</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">app</span>
</span><span class='line'>      <span class="vi">@app</span> <span class="o">||=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:builder</span><span class="o">]</span> <span class="p">?</span> <span class="n">build_app_from_string</span> <span class="p">:</span> <span class="n">build_app_and_options_from_config</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">start</span> <span class="o">&amp;</span><span class="n">blk</span>
</span><span class='line'>      <span class="c1"># ...</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">server</span><span class="o">.</span><span class="n">run</span> <span class="n">wrapped_app</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">server</span>
</span><span class='line'>      <span class="vi">@_server</span> <span class="o">||=</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">options</span><span class="o">[</span><span class="ss">:server</span><span class="o">]</span><span class="p">)</span> <span class="o">||</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">build_app_and_options_from_config</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">!::</span><span class="no">File</span><span class="o">.</span><span class="n">exist?</span> <span class="n">options</span><span class="o">[</span><span class="ss">:config</span><span class="o">]</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;configuration </span><span class="si">#{</span><span class="n">options</span><span class="o">[</span><span class="ss">:config</span><span class="o">]</span><span class="si">}</span><span class="s2"> not found&quot;</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">app</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Builder</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">options</span><span class="o">[</span><span class="ss">:config</span><span class="o">]</span><span class="p">,</span> <span class="n">opt_parser</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">merge!</span> <span class="n">options</span>
</span><span class='line'>        <span class="n">app</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">build_app_from_string</span>
</span><span class='line'>        <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Builder</span><span class="o">.</span><span class="n">new_from_string</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">options</span><span class="o">[</span><span class="ss">:builder</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">wrapped_app</span>
</span><span class='line'>        <span class="vi">@wrapped_app</span> <span class="o">||=</span> <span class="n">build_app</span> <span class="n">app</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I only leave the relevant code here and omitted some parts such as option parsing. We can see that the <code>start</code> method creates a <code>@_server</code> instance variable which is a handler represents the web server interface, it has a <code>run</code> method which accepts the <em>app</em>. The <em>app</em> is the Rack app object we mentioned above, it&rsquo;s an object which reponds to <code>call</code> method which accepts an environment hash and returns an array with 3 elements: the HTTP status code, response HTTP headers and the body.</p>

<p>The <code>wrapped_app</code> calls the <code>build_app</code> method which just wraps some default middleware around the app. And the <code>app</code> method actually sets the <code>@app</code> instance variable, which is actually read from the config.ru file (by <code>build_app_from_string</code> method).</p>

<h2>config.ru</h2>

<p>Every rails application has a <em>config.ru</em> file at root folder. Let&rsquo;s have a look at that file,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># This file is used by Rack-based servers to start the application.</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../config/environment&#39;</span><span class="p">,</span>  <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'><span class="n">run</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span>
</span></code></pre></td></tr></table></div></figure>


<p>This file is actually a ruby file, it first requires the <em>config/environment.rb</em> file and then calls <code>run Rails.application</code>. The <code>run</code> method is defined in Rack DSL, and it accepts the app object. So we can imagine that if we call <code>Rails.application.respond_to?(:call)</code> it should return true.</p>

<h2>config/environment.rb</h2>

<p>Let&rsquo;s have a look what&rsquo;s inside config/environment.rb.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Load the Rails application.</span>
</span><span class='line'><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../application&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Initialize the Rails application.</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">initialize!</span>
</span></code></pre></td></tr></table></div></figure>


<p>It just requires <em>config/application.rb</em> (which we already required) and then initialize the application by calling <code>Rails.application.initialize!</code>. After that the initialization process is finished and the <code>Rails.application</code> could be used as Rack application.</p>

<p>In this part we had a detailed look at the Rails initialization process and we will dig into Railties and <code>Rails.application.initialize!</code> in following series.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/17/using-index-files-in-rails-4-assets-pipeline/">Using Index Files in Rails 4 Assets Pipeline</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-17T21:15:28+09:30" pubdate data-updated="true">Aug 17<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/08/17/using-index-files-in-rails-4-assets-pipeline/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I bought a website template from <a href="https://wrapbootstrap.com/theme/tshop-responsive-e-commerce-template-WB002S263">WrapBootstrap</a> and I wanna itegrate this into a Spree website I&rsquo;m working on. According to the documents of <a href="http://edgeguides.rubyonrails.org/asset_pipeline.html">Asset Pipeline</a> and the <a href="http://railscasts.com/episodes/279-understanding-the-asset-pipeline">RailsCasts</a>. I put the stylesheets and javascripts of this template into the folder #{Rails.root}/vendor/assets/tshop. So for example, I can access a stylesheet at #{Rails.root}/vendor/assets/tshop/stylesheets/style.css from the url <a href="http://localhost:3000/assets/stylesheets/style.css">http://localhost:3000/assets/stylesheets/style.css</a></p>

<p>My folder structure is like following figure,</p>

<p><img src="/images/rails_vendor_folder.png"></p>

<p>According to the <a href="http://edgeguides.rubyonrails.org/asset_pipeline.html#using-index-files">Rails documents</a>, I should create a file index.js and index.css under #{Rails.root}/vendor/assets/tshop, but that doesn&rsquo;t work for me. Actually I named the files as tshop.js and tshop.css.scss, as the figure above. So in the application.css and application.js I chould load the tshop library by calling,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="c">/*</span>
</span><span class='line'><span class="c"> ...</span>
</span><span class='line'><span class="c"> *= require tshop</span>
</span><span class='line'><span class="c"> ...</span>
</span><span class='line'><span class="c"> */</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p> and</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'> <span class="c1">//= require tshop</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in the tshop.css.scss, I could load the file #{Rails.root}/vendor/assets/tshop/stylesheets/style.css by using following code,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="c">/*</span>
</span><span class='line'><span class="c"> ...</span>
</span><span class='line'><span class="c"> *= require stylesheets/style</span>
</span><span class='line'><span class="c"> ...</span>
</span><span class='line'><span class="c"> */</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p> And in tshop.js, the file #{Rails.root}/vendor/assets/tshop/javascripts/script.js could be loaded by following code,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'> <span class="c1">//= require javascripts/script</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the templates, I need to change the background image url, for example, in style.css,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.parallax-image-2</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">background</span><span class="o">:</span> <span class="sx">url(&quot;/assets/stylesheets/parallax/people-collage.jpg&quot;)</span> <span class="k">fixed</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-attachment</span><span class="o">:</span> <span class="k">fixed</span><span class="p">;</span><span class="c">/* IE FIX */</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This image file will be in #{Rails.root}/vendor/assets/tshop/stylesheets/parallax/people-collage.jpg.</p>

<p>Here are the organization I used for my Rails 4 application. The point is to use <em>library.css</em> and <em>library.js</em> to name the index files instead of index.css and index.js.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/26/integrate-postgis-and-google-maps-in-rails-part-2/">Integrate PostGIS and Google Maps in Rails Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-26T00:19:16+09:30" pubdate data-updated="true">May 26<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/05/26/integrate-postgis-and-google-maps-in-rails-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here is the Part 2 of <em>Integrate PostGIS and Google maps in Rails</em>, in this part we will render the provinces of Gabon on Google map. Unlike Part 1 the GeoJSON data is fetched from a static file, in this part we will see how to fetch data from PostGIS and encode them into GeoJSON directly. The result is like the following figure, the 9 provinces are rendered on the map, and when the user put his mouse over one province, that area will be highlighted, and also on the top right there is a label which shows the name of the province that is highlighted.</p>

<p><img src="/images/province_highlighted.png"></p>

<h2>Create the Province model</h2>

<p>The first thing we need to do is to create a <strong>Province</strong> model. Like how we created the <strong>Country</strong> model in part 1, we create a <strong>Province</strong> model, and then import the data in shape file into our PostGIS database. The main part in the migration is as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ImportProvincesFromShp</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">up</span>
</span><span class='line'>    <span class="n">from_shp_sql</span> <span class="o">=</span> <span class="sb">`shp2pgsql -c -g geom -W LATIN1 -s 4326 </span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;shpfiles&#39;</span><span class="p">,</span> <span class="s1">&#39;GAB_adm1.shp&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb"> provinces_ref`</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Province</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">execute</span> <span class="n">from_shp_sql</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span>
</span><span class='line'><span class="sh">          insert into provinces(name, geom) </span>
</span><span class='line'><span class="sh">            select name_1, geom from provinces_ref</span>
</span><span class='line'><span class="no">      SQL</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">drop_table</span> <span class="ss">:provinces_ref</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">down</span>
</span><span class='line'>    <span class="no">Province</span><span class="o">.</span><span class="n">delete_all</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The province data is in shape file <em>GAB_adm1.shp</em>, and we fetch the province name and geometry from the shape file and import them into <em>provinces</em> table (In the shape file province name is stored as attribute <em>name_1</em>).</p>

<h2>Encode the feature</h2>

<p>Now we need to fetch data from database and encode them as GeoJSON. GeoJSON is a JSON format for encoding geographic data structures. The following example is stolen from <a href="http://geojson.org/">the GeoJSON website</a>. We can see that in addition to the geometry data, the JSON can also encode additional properties.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Point&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">125.6</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">]</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Dinagat Islands&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will mainly use the <em>rgeo-geojson</em> gem to do the encoding. In <em>rgeo-geojson</em> gem, it converts a geometry type to a feature and then encode the feature to a hash, and then the hash can be rendered as a JSON.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">province</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">factory</span> <span class="o">=</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">::</span><span class="no">EntityFactory</span><span class="o">.</span><span class="n">instance</span>
</span><span class='line'><span class="n">feature</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">feature</span> <span class="n">province</span><span class="o">.</span><span class="n">geom</span>
</span><span class='line'><span class="nb">hash</span> <span class="o">=</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">.</span><span class="n">encode</span> <span class="n">feature</span>
</span><span class='line'><span class="nb">puts</span> <span class="nb">hash</span><span class="o">.</span><span class="n">to_json</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>We create a Concern named <strong>Featurable</strong>, which will add a <em>featurable</em> class method into the class which includes it. So for example in <strong>Province</strong> class, we include the <strong>Featurable</strong> like following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Province</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Featurable</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">featurable</span> <span class="ss">:geom</span><span class="p">,</span> <span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The featurable accepts two parameters, the first is mandatory, which is the name of the attribute which contains the geometry data, the second parameter is an optional array of attribute names, when encoding it as GeoJSON, those attributes will be encoded as attributes. Here we encode the <em>name</em> attribute as the property of the feature. Now the <strong>Province</strong> class will have a instance method named <strong>to_feature</strong>, which returns a RGeo::GeoJSON::Feature.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">province</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">feature</span> <span class="o">=</span> <span class="n">province</span><span class="o">.</span><span class="n">to_feature</span>
</span><span class='line'><span class="nb">puts</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result will display as following, it includes the name as its property and also has an id.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;geometry&quot;</span><span class="p">:{</span>
</span><span class='line'>    <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;MultiPolygon&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;coordinates&quot;</span><span class="p">:[[[[</span><span class="mf">9.499305999999933</span><span class="p">,</span><span class="mf">0.10763800000000856</span><span class="p">],</span>
</span><span class='line'>        <span class="err">......</span><span class="p">,[</span><span class="mf">9.748417000000074</span><span class="p">,</span><span class="mf">1.0649910000000773</span><span class="p">]]]]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;properties&quot;</span><span class="p">:{</span>
</span><span class='line'>    <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Estuaire&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s have a look at how <strong>Featurable</strong> is implemented.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Featurable</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">featurable</span> <span class="n">geom_attr_name</span><span class="p">,</span> <span class="n">property_names</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>      <span class="n">define_method</span> <span class="ss">:to_feature</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">factory</span> <span class="o">=</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">::</span><span class="no">EntityFactory</span><span class="o">.</span><span class="n">instance</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">property_names</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="n">property_names</span><span class="p">)</span>
</span><span class='line'>        <span class="n">properties</span> <span class="o">=</span> <span class="n">property_names</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">property_name</span><span class="o">|</span>
</span><span class='line'>          <span class="nb">hash</span><span class="o">[</span><span class="n">property_name</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span> <span class="o">=</span> <span class="n">read_attribute</span><span class="p">(</span><span class="n">property_name</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">hash</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">factory</span><span class="o">.</span><span class="n">feature</span> <span class="n">read_attribute</span><span class="p">(</span><span class="n">geom_attr_name</span><span class="p">),</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">properties</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># turns a collection of models to a feature collection</span>
</span><span class='line'>    <span class="c1"># All models in the collection should implement the to_feature method</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">to_feature_collection</span> <span class="n">models</span>
</span><span class='line'>      <span class="n">factory</span> <span class="o">=</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">::</span><span class="no">EntityFactory</span><span class="o">.</span><span class="n">instance</span>
</span><span class='line'>      <span class="n">features</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_feature</span><span class="p">)</span>
</span><span class='line'>      <span class="n">factory</span><span class="o">.</span><span class="n">feature_collection</span> <span class="n">features</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the implementation of <em>featurable</em> class method, when this method is called, the class will call <em>define_method</em> to define an instance method called <em>to_feature</em> and from line 9 to 13 it will generates a hash named <em>properties</em> whose key is the property name and value is the property value. And then on line 14 it calls the <em>RGeo::GeoJSON::EntityFactory#feature</em> method to create the feature and return it.</p>

<p>On line 21 it defines another class method called <em>to_feature_collection</em>, this is to convert a collection of models to a feature collection, for example the following code shows how to encode all 9 provinces as a feature collection.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">provinces</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'><span class="n">feature_collection</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">to_feature_collection</span> <span class="n">provinces</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Provinces Controller</h2>

<p>Now let&rsquo;s create a <strong>ProvincesController</strong> to render all 9 provinces as GeoJSON.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ProvincesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>      <span class="vi">@provinces</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>        <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">feature_collection</span> <span class="o">=</span> <span class="no">Province</span><span class="o">.</span><span class="n">to_feature_collection</span> <span class="vi">@provinces</span>
</span><span class='line'>          <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="ss">RGeo</span><span class="p">:</span><span class="ss">:GeoJSON</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">feature_collection</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">format</span><span class="o">.</span><span class="n">html</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see that the <em>index</em> method responds to two formats, in the json format it will call <em>Province.to_feature_collection</em> to create the feature collection, and then calls <em>RGeo::GeoJSON.encode(feature_collection)</em> to encode the feature as a hash, and last calls <em>render</em> to render the hash as a JSON string.</p>

<p>In the <em>views/provinces/index.html.erb</em>, the main part is as following,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//Create an info box for displaying names</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">infoBox</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">infoBox</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;div id=&#39;info-box&#39;&gt;&lt;/div&gt;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">ControlPosition</span><span class="p">.</span><span class="nx">RIGHT_TOP</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">infoBox</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;mouseover&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">revertStyle</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#info-box&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">feature</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">));</span>
</span><span class='line'>  <span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">overrideStyle</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">feature</span><span class="p">,</span> <span class="p">{</span> <span class="nx">fillColor</span><span class="o">:</span> <span class="s1">&#39;red&#39;</span> <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;mouseout&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
</span><span class='line'>  <span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">revertStyle</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">map</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">setStyle</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">feature</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span> <span class="nx">fillColor</span><span class="o">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">strokeWeight</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>From line 2 to line 4 it creates an info box at the RIGHT TOP to display province name. And from line 6 to line 10 it adds a <em>mouseover</em> event listener, so when the mouse is over the province region, it set the text of the info box to the <em>name</em> property of the feature. And on line 12 it defines a <em>mouseout</em> event listener so the style is reverted when the mouse is out of the province region.</p>

<p>So in this part we showed how to fetch geometry data from PostGIS database and render them on google map. The source code for this part is at <a href="https://github.com/climber2002/schoolpro/tree/part2">github</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/18/postgis-and-google-maps-in-rails-part-1/">PostGIS and Google Maps in Rails Part 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-18T23:23:32+09:30" pubdate data-updated="true">May 18<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/05/18/postgis-and-google-maps-in-rails-part-1/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I need to work on a Rails project which is to manage the public and private schools in Gabon, a small country in Africa. And I need to integrate PostGIS and Google maps. I will create a series of blogs to share what I have done, and I will point out some common gotchas while integrate Rails with PostGIS and Google maps.</p>

<h2>Books and Blogs</h2>

<p>To work on PostGIS and Google Maps of course you need to learn them. This series is not a complete tutorial. To study PostGIS, the definite reference is <em>PostGIS in Action</em> by Regina O. Obe and Leo S. Hsu. Currently the second edition is in MEAP state and you can buy the ebook at <a href="http://manning.com/obe2/">manning website</a>. To study Google maps, the documentation at <a href="https://developers.google.com/maps/documentation/javascript/tutorial">google website</a> is already awesome, but if you prefer a book form, the book <em>Google Maps JavaScript API Cookbook</em> by Alper Dincer and Balkan Uraz is a good choice, which you can buy the kindle version at <a href="http://www.amazon.com/Google-Maps-JavaScript-API-Cookbook-ebook/dp/B00HJR6RD6">amazon</a></p>

<p>In the project to integrate PostGIS with Rails, I utilized some rubygems from RGeo. The original author of those rubygems, Daniel Azuma, has created a series of articles on <a href="http://daniel-azuma.com/articles/georails">his website</a>, which is very helpful. Actually this series has been inspired from his works.</p>

<h2>Let&rsquo;s start</h2>

<p>In this first blog I&rsquo;ll describe how to create a rails project and how to create migrations to import GIS data from shape files to our database.</p>

<h2>Install</h2>

<p>To work on PostGIS of course you need to install it first. If you work on a Mac OS environment like me, using the <a href="http://postgresapp.com/">PostgreSQL App</a> is the easiest way. This package already includes PostGIS 2.1, so you just need to enable it, which we will introduce later.</p>

<p>And since we use the <a href="https://github.com/rgeo/rgeo">RGeo</a> and some of its addons, you need to install <a href="http://trac.osgeo.org/geos">GEOS</a> and <a href="http://trac.osgeo.org/proj">Proj</a>, which RGeo depends on. For Mac users the easiest way is to install the frameworks <a href="http://www.kyngchaos.com/software:frameworks">here</a></p>

<h2>Create the application</h2>

<p>Now let&rsquo;s create a rails application and use PostgreSQL database (I use Rails 4.1).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rails new schoolpro --database==postgresql</span></code></pre></td></tr></table></div></figure>


<p>Here my application name is schoolpro. Now open the Gemfile and add the <em>activerecord-postgis-adapter</em> gem.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;activerecord-postgis-adapter&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then in the database.yml, let&rsquo;s change the adapter from postgresql to postgis</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgis</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s create the database by running <strong>rake db:create</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rake db:create</span></code></pre></td></tr></table></div></figure>


<p>After the database is created, we need to enable the PostGIS extension by running following command</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake db:gis:setup</span></code></pre></td></tr></table></div></figure>




</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2014/05/18/postgis-and-google-maps-in-rails-part-1/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/09/create-development-environment-for-postgresql-on-mavericks/">Create Development Environment for PostgreSQL on Mavericks</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-09T01:10:04+10:30" pubdate data-updated="true">Dec 9<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/12/09/create-development-environment-for-postgresql-on-mavericks/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I bought a new MacBook Pro Retina with Mevericks installed. And here are the steps that I configure the development environment for PostgreSQL on this OS for my Ruby on Rails projects.</p>

<h2>Download Postgres App</h2>

<p>Download the Postgres App <a href="http://postgresapp.com/">here</a>, which is the quickest way to install PostgreSQL on Mac OS. My version is the latest version Postgres93.</p>

<h2>Install XCode command line tools</h2>

<p>Install XCode, and in the menu XCode &ndash;> &lsquo;Open Developer Tool&rsquo; &ndash;> &lsquo;More Developer Tool&rsquo;, Choose the &lsquo;Command Line Tools(OS X Mavericks) for Xcode&rsquo;, download the dmg file and install it.</p>

<h2>Install pg gem</h2>

<p>Install the pg gem with the following command,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem install pg -- --with-pg-config=/Applications/Postgres93.app/Contents/MacOS/bin/pg_config</span></code></pre></td></tr></table></div></figure>


<p>Notice the &mdash;with-pg-config params, otherwise you may get the following errors,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Building native extensions.  This could take a while...
</span><span class='line'>ERROR:  Error installing pg:
</span><span class='line'>  ERROR: Failed to build gem native extension.
</span><span class='line'>
</span><span class='line'>    /Users/andywang/.rvm/rubies/ruby-2.0.0-p353/bin/ruby extconf.rb
</span><span class='line'>checking for pg_config... no
</span><span class='line'>No pg_config... trying anyway. If building fails, please try again with
</span><span class='line'> --with-pg-config=/path/to/pg_config
</span><span class='line'>checking for libpq-fe.h... no
</span><span class='line'>Can't find the 'libpq-fe.h header
</span><span class='line'>*** extconf.rb failed ***
</span><span class='line'>Could not create Makefile due to some reason, probably lack of necessary
</span><span class='line'>libraries and/or headers.  Check the mkmf.log file for more details.  You may
</span><span class='line'>need configuration options.
</span><span class='line'>
</span><span class='line'>Provided configuration options:
</span><span class='line'>  --with-opt-dir
</span><span class='line'>  --with-opt-include
</span><span class='line'>  --without-opt-include=${opt-dir}/include
</span><span class='line'>  --with-opt-lib
</span><span class='line'>  --without-opt-lib=${opt-dir}/lib
</span><span class='line'>  --with-make-prog
</span><span class='line'>  --without-make-prog
</span><span class='line'>  --srcdir=.
</span><span class='line'>  --curdir
</span><span class='line'>  --ruby=/Users/andywang/.rvm/rubies/ruby-2.0.0-p353/bin/ruby
</span><span class='line'>  --with-pg
</span><span class='line'>  --without-pg
</span><span class='line'>  --with-pg-config
</span><span class='line'>  --without-pg-config
</span><span class='line'>  --with-pg_config
</span><span class='line'>  --without-pg_config
</span><span class='line'>  --with-pg-dir
</span><span class='line'>  --without-pg-dir
</span><span class='line'>  --with-pg-include
</span><span class='line'>  --without-pg-include=${pg-dir}/include
</span><span class='line'>  --with-pg-lib
</span><span class='line'>  --without-pg-lib=${pg-dir}/
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Gem files will remain installed in /Users/andywang/.rvm/gems/ruby-2.0.0-p353/gems/pg-0.17.0 for inspection.
</span><span class='line'>Results logged to /Users/andywang/.rvm/gems/ruby-2.0.0-p353/gems/pg-0.17.0/ext/gem_make.out</span></code></pre></td></tr></table></div></figure>


<h2>Create role in PostgreSQL</h2>

<p>Normally I want to create a specific role in the database and don&rsquo;t like the anonymous access. So in my database.yml, I have the following snippets,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgresql</span>
</span><span class='line'>  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ebilling_development</span>
</span><span class='line'>  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>  <span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5000</span>
</span><span class='line'>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ebilling</span>
</span><span class='line'>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ebilling</span>
</span></code></pre></td></tr></table></div></figure>


<p>So here for this project I have a user ebilling whose password is also ebilling, so I created the ebilling user with the following command,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">/Applications/Postgres93.app/Contents/MacOS/bin/createuser ebilling</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then open the psql console, and assign the user as superuser and password</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">andywang=# alter user ebilling superuser password &#39;ebilling&#39;;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now after bundle install, you can create the database with the rake command,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">rake db:create</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/02/my-first-post/">My First Post</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-02T02:29:57+10:30" pubdate data-updated="true">Dec 2<span>nd</span>, 2013</time>
        
         | <a href="/blog/2013/12/02/my-first-post/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>My name is Andy Wang and this is my personal blog. I&rsquo;ll try to blog about my experience on Ruby and iOS programming. Hello world!</p>

<p>This site is generated by <a href="http://octopress.org/">Octopress</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/02/26/integrate-web-template-into-rails-4-application/">integrate web template into rails 4 application</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/22/digging-rails-how-rails-finds-your-templates-part-2/">Digging Rails: How Rails finds your templates Part 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/21/how-rails-finds-your-templates-part-1/">Digging Rails: How Rails finds your templates Part 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/16/deploy-rails-application-on-ubuntu-14-dot-04-part-3/">Deploy Rails Application on Ubuntu 14.04 Part 3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/09/deploy-rails-application-on-ubuntu-14-dot-04-part-2/">Deploy Rails Application on Ubuntu 14.04 Part 2</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Andy Wang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'climber2002';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
